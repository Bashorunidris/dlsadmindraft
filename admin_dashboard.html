<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DLS Draft</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #0a0e27;
            --secondary-dark: #151930;
            --accent-gold: #ffd700;
            --accent-green: #00ff88;
            --text-white: #ffffff;
            --text-gray: #b8b8b8;
            --hover-glow: rgba(255, 215, 0, 0.4);
            --card-bg: rgba(21, 25, 48, 0.85);
            --error-red: #ff6b6b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--primary-dark);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* HEADER */
        .admin-header {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding: 20px 6%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-logo {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px var(--hover-glow);
            letter-spacing: 2px;
        }

        .admin-badge {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: var(--accent-gold);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-email {
            font-size: 0.95em;
            color: var(--text-gray);
        }

        .logout-btn {
            padding: 10px 25px;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--error-red);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            border-color: var(--error-red);
        }

        /* MAIN CONTAINER */
        .admin-container {
            padding: 40px 6%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-title {
            font-size: 2.5em;
            font-weight: 900;
            margin-bottom: 10px;
            color: var(--accent-gold);
            text-shadow: 0 0 20px var(--hover-glow);
        }

        .admin-subtitle {
            font-size: 1.1em;
            color: var(--text-gray);
            margin-bottom: 40px;
        }

        /* GRID LAYOUT */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .admin-card {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
            }
        }

        .admin-card:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 15px 50px var(--hover-glow);
            transform: translateY(-5px);
        }

        .card-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-white);
        }

        .card-number {
            font-size: 2.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .card-label {
            font-size: 0.9em;
            color: var(--text-gray);
        }

        /* ACTION BUTTONS */
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-btn {
            padding: 20px;
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            font-weight: 600;
        }

        .action-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--hover-glow);
        }

        .action-icon {
            font-size: 2em;
        }

        /* TABLE SECTION */
        .admin-section {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            animation: slideIn 0.5s ease forwards 0.2s;
            opacity: 0;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .info-box {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            color: var(--accent-green);
        }

        .info-box strong {
            color: var(--text-white);
        }

        /* NOTIFICATION CONTAINER */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            pointer-events: auto;
        }

        .notification {
            padding: 16px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            animation: slideInRight 0.3s ease forwards;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(400px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .notification.removing {
            animation: slideOutRight 0.3s ease forwards;
        }

        .notification-success {
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
        }

        .notification-error {
            background: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
        }

        .notification-info {
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.4);
            color: #00d4ff;
        }

        .notification-loading {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.4);
            color: var(--accent-gold);
        }

        .notification-icon {
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
            font-size: 0.95em;
        }

        .notification-close {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* WATCH FEE STYLES */
        .watch-fee-btn {
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid rgba(255, 215, 0, 0.3);
            color: var(--accent-gold);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
        }

        .watch-fee-btn:hover {
            background: rgba(255, 215, 0, 0.25);
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .watch-fee-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .watch-fee-modal.active {
            display: flex;
        }

        .watch-fee-content {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .watch-fee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .watch-fee-title {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .watch-fee-close {
            font-size: 2em;
            cursor: pointer;
            color: var(--text-gray);
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .watch-fee-close:hover {
            background: rgba(255, 215, 0, 0.1);
            color: var(--accent-gold);
        }

        .watch-fee-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
        }

        .watch-fee-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .watch-fee-tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .watch-fee-tab-content {
            display: none;
        }

        .watch-fee-tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 900;
            color: var(--accent-green);
        }

        .viewers-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .viewer-item {
            background: rgba(0, 255, 136, 0.15);
            border-left: 4px solid rgba(0, 255, 136, 0.5);
            padding: 15px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .viewer-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .viewer-name {
            font-weight: 600;
            color: var(--text-white);
            font-size: 0.95em;
        }

        .viewer-detail {
            font-size: 0.85em;
            color: var(--text-gray);
        }

        .viewer-code {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 10px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--accent-gold);
            text-align: center;
            font-size: 0.9em;
        }

        .viewer-actions {
            display: flex;
            gap: 8px;
        }

        .copy-btn {
            padding: 8px 12px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(0, 212, 255, 0.3);
            border-color: #00d4ff;
        }

        .remove-viewer-btn {
            padding: 8px 12px;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: var(--error-red);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .remove-viewer-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            border-color: var(--error-red);
        }

        .no-viewers-message {
            text-align: center;
            padding: 30px;
            color: var(--text-gray);
            font-size: 1em;
        }

        /* LOADING SPINNER */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 215, 0, 0.2);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .admin-info {
                flex-direction: column;
                width: 100%;
            }

            .admin-title {
                font-size: 2em;
            }

            .admin-container {
                padding: 20px 15px;
            }

            .admin-grid {
                grid-template-columns: 1fr;
            }

            .admin-actions {
                grid-template-columns: 1fr;
            }
        }

        /* TRANSACTIONS MODAL */
        .transactions-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            overflow: hidden;
            padding: 0;
        }

        .transactions-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 0;
        }

        .transactions-modal {
            background: var(--card-bg);
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .transactions-modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 14, 39, 0.9);
            flex-shrink: 0;
        }

        .transactions-modal-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            margin: 0;
        }

        .transactions-modal-close {
            font-size: 2.5em;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .transactions-modal-close:hover {
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .transactions-modal-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Tabs */
        .tx-status-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
            padding: 0;
            background: rgba(10, 14, 39, 0.5);
        }

        .tx-status-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            position: relative;
        }

        .tx-status-tab.active {
            color: var(--accent-gold);
        }

        .tx-status-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .tx-status-tab:hover {
            color: var(--accent-gold);
        }

        /* Filter Section */
        .tx-filters-section {
            padding: 20px 25px;
            background: rgba(10, 14, 39, 0.3);
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .tx-filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tx-filter-label {
            font-size: 0.85em;
            color: var(--text-gray);
            font-weight: 600;
        }

        .tx-filter-select {
            padding: 10px 12px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .tx-search-input {
            padding: 10px 12px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            font-size: 0.95em;
        }

        .tx-search-input::placeholder {
            color: rgba(184, 184, 184, 0.5);
        }

        /* Type Tabs (Deposit/Withdrawal) */
        .tx-type-tabs {
            display: flex;
            gap: 15px;
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            background: rgba(10, 14, 39, 0.2);
        }

        .tx-type-tab {
            padding: 8px 16px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-gray);
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .tx-type-tab.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .tx-type-tab:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent-gold);
        }

        /* Transactions List */
        .tx-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }

        .tx-item {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .tx-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .tx-info-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tx-label {
            font-size: 0.75em;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* FINANCIAL REPORTS MODAL */
        .reports-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            overflow: hidden;
            padding: 0;
        }

        .reports-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 0;
        }

        .reports-modal {
            background: var(--card-bg);
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .reports-modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 14, 39, 0.9);
            flex-shrink: 0;
        }

        .reports-modal-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            margin: 0;
        }

        .reports-modal-close {
            font-size: 2.5em;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .reports-modal-close:hover {
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .reports-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px 25px;
        }

        /* Report Tabs */
        .report-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
            margin-bottom: 30px;
            background: rgba(10, 14, 39, 0.5);
            margin: -30px -25px 30px -25px;
            padding: 0 25px;
        }

        .report-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            position: relative;
        }

        .report-tab.active {
            color: var(--accent-gold);
        }

        .report-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .report-tab:hover {
            color: var(--accent-gold);
        }

        /* Report Grid */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .report-card-label {
            font-size: 0.85em;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
        }

        .report-card-value {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
        }

        .report-card-change {
            font-size: 0.85em;
            color: var(--accent-green);
            font-weight: 600;
        }

        .report-card-change.negative {
            color: #ff6b6b;
        }

        .report-section {
            margin-bottom: 40px;
        }

        .report-section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .report-table th {
            background: rgba(255, 215, 0, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 0.9em;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .report-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            color: var(--text-white);
        }

        .report-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        /* LOCATION PERMISSION MODAL */
        .location-permission-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .location-permission-overlay.active {
            display: flex;
        }

        .location-permission-modal {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            animation: slideInUp 0.4s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .location-permission-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .location-permission-subtitle {
            font-size: 0.95em;
            color: var(--text-gray);
            margin-bottom: 25px;
            line-height: 1.6;
            text-align: center;
        }

        .location-permission-benefits {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .location-permission-benefits ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .location-permission-benefits li {
            color: var(--accent-green);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .location-permission-benefits li::before {
            content: '‚úì';
            font-weight: bold;
            color: var(--accent-green);
        }

        .location-permission-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .location-btn {
            flex: 1;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .location-btn-allow {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
        }

        .location-btn-allow:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .location-btn-skip {
            background: transparent;
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--text-gray);
        }

        .location-btn-skip:hover {
            border-color: rgba(255, 107, 107, 0.6);
            color: var(--error-red);
        }

        .location-status {
            text-align: center;
            margin-top: 15px;
            font-size: 0.85em;
            color: var(--text-gray);
        }

        .location-status.active {
            color: var(--accent-green);
        }

        /* MATCH CREATION POPUP */
        .creation-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .creation-popup-overlay.active {
            display: flex;
        }

        .creation-popup {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            animation: slideInUp 0.4s ease;
            text-align: center;
        }

        .creation-popup-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 30px;
        }

        .creation-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .creation-option-btn {
            padding: 15px 30px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            color: var(--accent-gold);
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .creation-option-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent-gold);
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .creation-close-btn {
            margin-top: 20px;
            padding: 10px 25px;
            background: transparent;
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--text-gray);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .creation-close-btn:hover {
            border-color: var(--error-red);
            color: var(--error-red);
        }

        /* MATCH CREATION MODAL */
        .match-creation-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            padding: 0;
            overflow: hidden;
        }

        .match-creation-overlay.active {
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }

        .match-creation-modal {
            background: var(--card-bg);
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .match-creation-header {
            padding: 25px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 14, 39, 0.9);
        }

        .match-creation-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin: 0;
        }

        .match-creation-close {
            font-size: 2.5em;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .match-creation-close:hover {
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        /* MATCH TABS */
        .match-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
            background: rgba(10, 14, 39, 0.5);
            padding: 0;
            overflow-x: auto;
        }

        .match-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
        }

        .match-tab.active {
            color: var(--accent-gold);
        }

        .match-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .match-tab:hover {
            color: var(--accent-gold);
        }

        /* MATCH FORM */
        .match-form-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }

        .match-form-section {
            margin-bottom: 30px;
        }

        .match-form-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 0.9em;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
        }

        .form-input {
            padding: 10px 15px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            font-size: 0.95em;
        }

        .form-input::placeholder {
            color: rgba(184, 184, 184, 0.5);
        }

        .form-textarea {
            padding: 10px 15px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            font-size: 0.95em;
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-gold);
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-white);
        }

        .players-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .player-list {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(255, 215, 0, 0.1);
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
        }

        .remove-btn {
            background: rgba(255, 107, 107, 0.3);
            border: none;
            color: var(--error-red);
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .add-btn {
            padding: 10px 20px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .add-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
        }

        .submit-btn {
            padding: 15px 40px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .empty-tab {
            padding: 50px;
            text-align: center;
            color: var(--text-gray);
        }

        /* Chart Containers */
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 40px;
            background: rgba(255, 215, 0, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 20px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .small-chart-container {
            position: relative;
            height: 250px;
            background: rgba(255, 215, 0, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 15px;
        }

        .tx-value {
            font-size: 0.95em;
            color: var(--text-white);
            font-weight: 600;
        }

        .tx-amount {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .tx-amount.red {
            color: var(--error-red);
        }

        .tx-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
        }

        .tx-status-badge.successful {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
        }

        .tx-status-badge.pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }

        .tx-status-badge.failed {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--error-red);
        }

        .tx-status-badge.rejected {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--error-red);
        }

        .tx-no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-gray);
            font-size: 1em;
        }

        @media (max-width: 1024px) {
            .tx-item {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .tx-filters-section {
                grid-template-columns: 1fr;
            }
        }

        /* PREDICTIONS & FEATURES STYLES */
        .predictions-section {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .prediction-card {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prediction-card:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent-gold);
            transform: translateY(-3px);
        }

        .prediction-card.selected {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .goal-scorers-section {
            margin-top: 15px;
        }

        .goal-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .goal-list-item {
            background: rgba(0, 255, 136, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .events-timeline {
            background: rgba(255, 215, 0, 0.05);
            border-left: 3px solid rgba(255, 215, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .timeline-event {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 5px;
            font-size: 0.85em;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .event-icon {
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .event-details {
            flex: 1;
        }

        .event-time {
            color: var(--text-gray);
            font-size: 0.8em;
        }

        .substitutions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .substitution-item {
            background: rgba(100, 200, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid rgba(100, 200, 255, 0.5);
        }

        .player-in-out {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .player-label {
            padding: 6px 10px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 4px;
            font-size: 0.8em;
            text-align: center;
        }

        .player-label.in {
            background: rgba(0, 255, 136, 0.2);
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <header class="admin-header">
        <div class="admin-logo">üèÜ DLS DRAFT</div>
        <div class="admin-info">
            <div class="admin-badge">‚≠ê ADMIN PANEL</div>
            <span class="admin-email" id="adminEmailDisplay">Admin</span>
            <button class="logout-btn" onclick="handleLogout()">üö™ Logout</button>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="admin-container">
        <h1 class="admin-title">Admin Dashboard</h1>
        <p class="admin-subtitle">Welcome to DLS Draft Administration Panel</p>

        <!-- STATS GRID -->
        <div class="admin-grid">
            <div class="admin-card" style="animation-delay: 0s;">
                <div class="card-icon">üë•</div>
                <div class="card-title">Total Users</div>
                <div class="card-number" id="totalUsers">-</div>
                <div class="card-label">Active players registered</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.1s;">
                <div class="card-icon">üí∞</div>
                <div class="card-title">Total Wallet Balance</div>
                <div class="card-number" id="totalBalance">-</div>
                <div class="card-label">Across all accounts</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.3s;">
                <div class="card-icon">üìä</div>
                <div class="card-title">Total Transactions</div>
                <div class="card-number" id="totalTransactions">-</div>
                <div class="card-label">Deposits & Withdrawals</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.4s;">
                <div class="card-icon">‚úÖ</div>
                <div class="card-title">Verified Accounts</div>
                <div class="card-number" id="verifiedAccounts">-</div>
                <div class="card-label">Bank accounts linked</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.5s;">
                <div class="card-icon">‚è≥</div>
                <div class="card-title">Pending Withdrawals</div>
                <div class="card-number" id="pendingWithdrawals">-</div>
                <div class="card-label">Awaiting processing</div>
            </div>
        </div>

        <!-- ACTION BUTTONS -->
        <h2 class="section-title" style="border: none; padding: 0; margin: 40px 0 25px 0;">Quick Actions</h2>
        <div class="admin-actions">
            <button class="action-btn" onclick="navigateTo('manage-users')">
                <span class="action-icon">üë•</span>
                <span>Manage Users</span>
            </button>
            <button class="action-btn" onclick="openTransactionsModal()">
                <span class="action-icon">üí≥</span>
                <span>View Transactions</span>
            </button>
            <button class="action-btn" onclick="navigateTo('bank-accounts')">
                <span class="action-icon">üè¶</span>
                <span>Bank Accounts</span>
            </button>
            <button class="action-btn" onclick="openFinancialReportsModal()">
                <span class="action-icon">üìà</span>
                <span>Financial Reports</span>
            </button>
            <button class="action-btn" onclick="navigateTo('settings')">
                <span class="action-icon">‚öôÔ∏è</span>
                <span>System Settings</span>
            </button>
            <button class="action-btn" onclick="openCreationPopup()">
                <span class="action-icon">üéÆ</span>
                <span>Match Creation</span>
            </button>
        </div>

        <!-- PENDING WITHDRAWALS SECTION -->
        <div class="admin-section">
            <h2 class="section-title">üîî Pending Withdrawals</h2>

            <!-- Tabs -->
            <div
                style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(255,215,0,0.2); padding-bottom: 15px;">
                <button class="withdrawal-tab active" onclick="filterWithdrawals('all')"
                    style="padding: 10px 20px; background: transparent; border: none; color: var(--accent-gold); cursor: pointer; font-weight: 600; border-bottom: 3px solid var(--accent-gold); font-size: 0.95em;">üìä
                    All</button>
                <button class="withdrawal-tab" onclick="filterWithdrawals('normal')"
                    style="padding: 10px 20px; background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-weight: 600; font-size: 0.95em;">üöó
                    Normal</button>
                <button class="withdrawal-tab" onclick="filterWithdrawals('speed')"
                    style="padding: 10px 20px; background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-weight: 600; font-size: 0.95em;">‚ö°
                    Speed</button>
            </div>

            <!-- Withdrawals List -->
            <div style="display: flex; flex-direction: column; gap: 15px;" id="pendingWithdrawalsList">
                <div style="text-align: center; color: var(--text-gray); padding: 30px;">Loading pending withdrawals...
                </div>
            </div>
        </div>
    </div>

    <!-- MANAGE USERS MODAL -->
    <div id="manageUsersModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; overflow-y: auto; padding: 20px;"
        onclick="if(event.target.id === 'manageUsersModal') closeManageUsersModal()">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; position: sticky; top: 20px; background: rgba(10,14,39,0.95); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,215,0,0.2); z-index: 3001;">
                <div style="flex: 1;">
                    <h2 style="color: var(--accent-gold); margin: 0; font-size: 1.8em;">üë• Manage Users</h2>
                </div>
                <div style="display: flex; gap: 15px; align-items: center; flex: 2;">
                    <input type="text" id="userSearchInput" placeholder="Search by name or email..."
                        style="padding: 12px 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.3); border-radius: 20px; color: var(--text-white); width: 100%; font-size: 0.95em;"
                        oninput="filterUsers()">
                </div>
                <button onclick="closeManageUsersModal()"
                    style="padding: 10px 20px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 20px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 15px;">‚úï
                    Close</button>
            </div>

            <div id="usersGridContainer"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding-bottom: 30px;">
                <div style="text-align: center; color: var(--text-gray); padding: 30px; grid-column: 1 / -1;">Loading
                    users...</div>
            </div>
        </div>
    </div>

    <!-- CREDIT/TAKEBACK MODAL -->
    <div id="creditModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; justify-content: center; align-items: center; padding: 20px;">
        <div
            style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px; max-width: 500px; width: 100%;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;" id="creditModalTitle">Credit Account</h2>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">User</label>
                <input type="text" id="creditUserName" readonly
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; cursor: not-allowed;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Wallet Account Number</label>
                <input type="text" id="creditWalletAccount" readonly
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; cursor: not-allowed;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (‚Ç¶)</label>
                <input type="number" id="creditAmount" placeholder="Enter amount"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Admin Password</label>
                <input type="password" id="creditPassword" placeholder="Enter admin password"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
            </div>

            <div id="creditMessage" style="margin-bottom: 15px;"></div>

            <div style="display: flex; gap: 10px;">
                <button onclick="processCreditTransaction()"
                    style="flex: 1; padding: 12px; background: var(--accent-green); border: none; border-radius: 8px; color: var(--primary-dark); font-weight: 600; cursor: pointer;">Send</button>
                <button onclick="closeCreditModal()"
                    style="flex: 1; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); border-radius: 8px; color: #ff6b6b; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- RESTRICT MODAL -->
    <div id="restrictModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; justify-content: center; align-items: center; padding: 20px;">
        <div
            style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px; max-width: 500px; width: 100%;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;">Restrict User Access</h2>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">User</label>
                <input type="text" id="restrictUserName" readonly
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; cursor: not-allowed;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Restriction Duration</label>
                <select id="restrictDuration"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
                    <option value="">Select duration</option>
                    <option value="1">1 Hour</option>
                    <option value="24">24 Hours</option>
                    <option value="48">2 Days</option>
                    <option value="72">3 Days</option>
                    <option value="96">4 Days</option>
                    <option value="120">5 Days</option>
                    <option value="144">6 Days</option>
                    <option value="168">7 Days</option>
                </select>
            </div>

            <div id="restrictMessage" style="margin-bottom: 15px;"></div>

            <div style="display: flex; gap: 10px;">
                <button onclick="processRestriction()"
                    style="flex: 1; padding: 12px; background: var(--accent-gold); border: none; border-radius: 8px; color: var(--primary-dark); font-weight: 600; cursor: pointer;">Restrict</button>
                <button onclick="closeRestrictModal()"
                    style="flex: 1; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); border-radius: 8px; color: #ff6b6b; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- REJECTION REASON MODAL -->
    <div id="rejectModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; justify-content: center; align-items: center; padding: 20px;">
        <div
            style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px; max-width: 500px; width: 100%;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;">Reject Withdrawal</h2>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rejection Reason</label>
                <select id="rejectionReason"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
                    <option value="">Select a reason...</option>
                    <option value="insufficient">Insufficient Balance</option>
                    <option value="max_requests">Max Requests Per Day Exceeded</option>
                    <option value="not_paying">Not Paying Out Now</option>
                    <option value="other">Other Reason</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Additional Notes (Optional)</label>
                <textarea id="rejectionNotes" placeholder="Add notes..."
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em; min-height: 80px; resize: vertical;"></textarea>
            </div>

            <div id="rejectMessage" style="margin-bottom: 15px;"></div>

            <div style="display: flex; gap: 10px;">
                <button onclick="confirmReject()"
                    style="flex: 1; padding: 12px; background: #ff6b6b; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Reject</button>
                <button onclick="closeRejectModal()"
                    style="flex: 1; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); border-radius: 8px; color: #ff6b6b; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDW8V2SjNITrA4LcdmeILh944mTbOKnM0c",
            authDomain: "rewarderhub.firebaseapp.com",
            projectId: "rewarderhub",
            storageBucket: "rewarderhub.appspot.com",
            messagingSenderId: "85965945106",
            appId: "1:85965945106:web:fa0a57d8968926e1041bcb",
            measurementId: "G-F2ERB5NGN0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== ADMIN SESSION CHECK =====
        function checkAdminSession() {
            const isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';

            if (!isAdminLoggedIn) {
                window.location.href = 'admin_login.html';
                return false;
            }

            return true;
        }

        if (!checkAdminSession()) {
            throw new Error('Admin session required');
        }

        // Store current user for modal operations
        let currentUserData = null;
        let currentOperationType = null;
        let allUsers = [];

        // Navigation function
        function navigateTo(page) {
            const pages = {
                'manage-users': 'User Management',
                'manage-withdrawals': 'Withdrawal Approvals',
                'transactions': 'Transaction History',
                'bank-accounts': 'Bank Account Verification',
                'reports': 'Financial Reports',
                'settings': 'System Settings'
            };

            if (page === 'manage-users') {
                loadManageUsersPage();
            } else if (page === 'transactions') {
                openTransactionsModal();
            } else {
                const pageName = pages[page] || page;
                alert(`${pageName} feature will be available soon.`);
            }
        }

        // Display admin email
        window.addEventListener('load', () => {
            const adminEmail = sessionStorage.getItem('adminEmail');
            if (adminEmail) {
                document.getElementById('adminEmailDisplay').textContent = adminEmail;
            }
            // Load all stats
            loadAdminStats();
            // Check location permission
            checkLocationPermission();
        });

        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('adminLoggedIn');
                sessionStorage.removeItem('adminEmail');
                sessionStorage.removeItem('loginTime');
                window.location.href = 'admin_login.html';
            }
        }

        // ===== LOAD ADMIN STATS =====
        async function loadAdminStats() {
            try {
                // Get total users count
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;

                // Get wallet and transaction data
                let totalBalance = 0;
                let totalTransactions = 0;
                let verifiedCount = 0;
                let pendingWithdrawalsCount = 0;
                const pendingWithdrawals = [];

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();

                    // Count wallet balance
                    if (userData.wallet && userData.wallet.balance) {
                        totalBalance += userData.wallet.balance;
                    }

                    // Count verified accounts (has bank code in wallet or root level)
                    if ((userData.wallet && userData.wallet.bankCode) || userData.bankCode) {
                        verifiedCount++;
                    }

                    // Count transactions and find pending withdrawals
                    if (userData.transactions && Array.isArray(userData.transactions)) {
                        totalTransactions += userData.transactions.length;

                        // Find pending withdrawal transactions
                        userData.transactions.forEach(tx => {
                            if (tx.type === 'withdrawal' && tx.status === 'pending') {
                                pendingWithdrawalsCount++;
                                pendingWithdrawals.push({
                                    userId: doc.id,
                                    userName: userData.fullName || 'Unknown',
                                    userEmail: userData.email || 'N/A',
                                    amount: tx.amount,
                                    fee: tx.fee,
                                    net: tx.net,
                                    requestType: tx.requestType,
                                    date: tx.date,
                                    reference: tx.id,
                                    bankAccount: userData.wallet ? userData.wallet.bankAccountNumber : 'N/A',
                                    userBalance: tx.balanceAtRequest || (userData.wallet ? userData.wallet.balance : 0),  // Use balance at request time
                                    currentBalance: userData.wallet ? userData.wallet.balance : 0  // Current balance
                                });
                            }
                        });
                    }
                });

                // Update stats
                document.getElementById('totalBalance').textContent = '‚Ç¶' + totalBalance.toLocaleString();
                document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
                document.getElementById('verifiedAccounts').textContent = verifiedCount;
                document.getElementById('pendingWithdrawals').textContent = pendingWithdrawalsCount;

                // Display pending withdrawals
                renderPendingWithdrawals(pendingWithdrawals);

            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        // Current withdrawal filter
        let currentWithdrawalFilter = 'all';

        // Filter withdrawals by type
        function filterWithdrawals(type) {
            currentWithdrawalFilter = type;

            // Update tab buttons
            document.querySelectorAll('.withdrawal-tab').forEach(tab => {
                tab.style.color = 'var(--text-gray)';
                tab.style.borderBottom = 'none';
            });
            event.target.style.color = 'var(--accent-gold)';
            event.target.style.borderBottom = '3px solid var(--accent-gold)';

            // Re-render
            loadAdminStats();
        }

        // Render pending withdrawals
        function renderPendingWithdrawals(withdrawals) {
            const container = document.getElementById('pendingWithdrawalsList');

            // Filter by current tab
            let filtered = withdrawals;
            if (currentWithdrawalFilter === 'normal') {
                filtered = withdrawals.filter(w => w.requestType === 'normal');
            } else if (currentWithdrawalFilter === 'speed') {
                filtered = withdrawals.filter(w => w.requestType === 'speed');
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--accent-green); padding: 30px;">‚úÖ No pending withdrawals</div>';
                return;
            }

            container.innerHTML = filtered.map(wd => {
                const date = new Date(wd.date);
                const timeAgo = getTimeAgo(date);
                const typeIcon = wd.requestType === 'normal' ? 'üöó' : '‚ö°';
                const typeBg = wd.requestType === 'normal' ? 'rgba(100, 180, 255, 0.2)' : 'rgba(255, 150, 0, 0.2)';
                const typeBorder = wd.requestType === 'normal' ? 'rgba(100, 180, 255, 0.4)' : 'rgba(255, 150, 0, 0.4)';

                return `
                    <div style="padding: 20px; background: ${typeBg}; border: 2px solid ${typeBorder}; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <div style="font-weight: 700; color: var(--accent-gold); font-size: 1.1em;">
                                    ${typeIcon} ${wd.requestType === 'normal' ? 'Normal' : 'Speed'} Withdrawal
                                </div>
                                <div style="font-size: 2em; font-weight: 900; color: var(--accent-gold); margin-top: 5px;">
                                    ‚Ç¶${wd.amount.toLocaleString()}
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 0.9em;">
                                <div style="color: var(--accent-green); font-weight: 600;">Reference</div>
                                <div style="color: var(--text-white);">${wd.reference}</div>
                            </div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85em; line-height: 1.7;">
                            <div>üë§ User: <strong>${wd.userName}</strong></div>
                            <div>üìß Email: <strong>${wd.userEmail}</strong></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 8px 0;">
                                <div style="background: rgba(0,255,136,0.15); padding: 8px; border-radius: 5px;">
                                    <div style="font-size: 0.75em; color: var(--text-gray);">Balance at Request</div>
                                    <div style="color: var(--accent-green); font-weight: 600;">‚Ç¶${wd.userBalance ? wd.userBalance.toLocaleString() : '0'}</div>
                                </div>
                                <div style="background: rgba(255,215,0,0.15); padding: 8px; border-radius: 5px;">
                                    <div style="font-size: 0.75em; color: var(--text-gray);">Current Balance</div>
                                    <div style="color: var(--accent-gold); font-weight: 600;">‚Ç¶${wd.currentBalance ? wd.currentBalance.toLocaleString() : '0'}</div>
                                </div>
                            </div>
                            <div>üè¶ Account: <strong>${wd.bankAccount}</strong></div>
                            <div>üí∏ Amount: ‚Ç¶${wd.amount.toLocaleString()} | Fee: ‚Ç¶${wd.fee.toLocaleString()} | Net: ‚Ç¶${wd.net.toLocaleString()}</div>
                            <div>üìÖ ${date.toLocaleDateString()} at ${date.toLocaleTimeString()} (${timeAgo})</div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="approveWithdrawal('${wd.userId}', '${wd.reference}', ${wd.amount}, ${wd.fee})" style="flex: 1; padding: 10px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">‚úÖ Approve</button>
                            <button onclick="openRejectModal('${wd.userId}', '${wd.reference}', ${wd.amount})" style="flex: 1; padding: 10px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">‚ùå Reject</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [name, value] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / value);
                if (interval >= 1) {
                    return interval === 1 ? `${interval} ${name} ago` : `${interval} ${name}s ago`;
                }
            }
            return 'just now';
        }

        // Close manage users modal
        function closeManageUsersModal() {
            document.getElementById('manageUsersModal').style.display = 'none';
            document.getElementById('userSearchInput').value = '';
        }

        // Filter users by search
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const filtered = allUsers.filter(user => {
                const name = (user.fullName || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });
            renderUserCards(filtered);
        }

        // Render user cards
        function renderUserCards(users) {
            const container = document.getElementById('usersGridContainer');

            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 30px; grid-column: 1 / -1;">No users found</div>';
                return;
            }

            container.innerHTML = users.map(user => {
                const isRemoved = user.removed === true;
                const isRestricted = user.restricted && new Date(user.restrictedUntil) > new Date();
                const restrictedTime = isRestricted ? new Date(user.restrictedUntil).toLocaleString() : null;

                // Get bank details from wallet object
                const walletObj = user.wallet || {};

                // Generate DLS account number if missing
                let dlsAccountNumber = walletObj.dlsAccountNumber;
                if (!dlsAccountNumber) {
                    const randomNum = Math.floor(Math.random() * 100000);
                    dlsAccountNumber = 'DLS' + String(randomNum).padStart(5, '0');
                    // Save generated DLS account to Firebase
                    db.collection('users').doc(user.id).set({ wallet: { dlsAccountNumber } }, { merge: true }).catch(e => console.error('Error saving DLS:', e));
                }

                const bankCode = walletObj.bankCode || null;
                const bankAccountNumber = walletObj.bankAccountNumber || null;
                const accountName = walletObj.accountName || null;
                const balance = walletObj.balance || 0;

                console.log(`User ${user.email}:`, {
                    dlsAccountNumber,
                    bankCode,
                    bankAccountNumber,
                    accountName,
                    balance,
                    rawWallet: walletObj
                });

                return `
                   <div style="background: var(--card-bg); border: 2px solid rgba(255,215,0,0.2); border-radius: 15px; padding: 20px; position: relative;">
                       ${isRemoved ? '<div style="position: absolute; top: 10px; right: 10px; background: rgba(255,107,107,0.3); color: #ff6b6b; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; font-weight: 600;">REMOVED</div>' : ''}
                       ${isRestricted ? `<div style="position: absolute; top: 10px; right: 10px; background: rgba(255,215,0,0.3); color: var(--accent-gold); padding: 5px 10px; border-radius: 5px; font-size: 0.8em; font-weight: 600;">RESTRICTED</div>` : ''}
                       
                       <div style="margin-bottom: 12px;">
                           <div style="font-weight: 700; color: var(--text-white); font-size: 1.1em;">${user.fullName || 'No Name'}</div>
                           <div style="font-size: 0.85em; color: var(--text-gray);">${user.email || 'No Email'}</div>
                       </div>

                       <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85em; line-height: 1.6;">
                           <div>üí∞ Balance: <strong style="color: var(--accent-gold);">‚Ç¶${balance ? balance.toLocaleString() : '0'}</strong></div>
                           <div>üè¶ DLS Account: <strong style="color: ${dlsAccountNumber ? 'var(--accent-green)' : '#ff6b6b'}">${dlsAccountNumber ? dlsAccountNumber : '‚ùå Not Set'}</strong></div>
                           <div>üèõÔ∏è Bank: <strong style="color: ${bankCode ? 'var(--accent-green)' : '#ff6b6b'}">${bankCode ? bankCode : '‚ùå Not Set'}</strong></div>
                           <div>üìù Account #: <strong style="color: ${bankAccountNumber ? 'var(--accent-green)' : '#ff6b6b'}">${bankAccountNumber ? bankAccountNumber : '‚ùå Not Set'}</strong></div>
                           <div>üë§ A/C Name: <strong style="color: ${accountName ? 'var(--accent-green)' : '#ff6b6b'}">${accountName ? accountName : '‚ùå Not Set'}</strong></div>
                           ${isRestricted ? `<div style="color: var(--accent-gold); margin-top: 5px;">‚è≥ Restricted until: ${restrictedTime}</div>` : ''}
                       </div>

                       <div style="display: flex; flex-direction: column; gap: 8px;">
                           <button onclick="openCreditModal('${user.id}', 'credit')" style="width: 100%; padding: 8px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">üíö Credit</button>
                           <button onclick="openCreditModal('${user.id}', 'takeback')" style="width: 100%; padding: 8px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">üìâ Take Back</button>
                           ${!isRestricted ? `<button onclick="openRestrictModal('${user.id}')" style="width: 100%; padding: 8px; background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.4); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">‚è∏Ô∏è Restrict</button>` : `<button onclick="unrestrict('${user.id}')" style="width: 100%; padding: 8px; background: rgba(100,200,100,0.2); border: 1px solid rgba(100,200,100,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">‚úÖ Unrestrict</button>`}
                           ${!isRemoved ? `<button onclick="removeUser('${user.id}')" style="width: 100%; padding: 8px; background: rgba(255,107,107,0.3); border: 1px solid rgba(255,107,107,0.6); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">üóëÔ∏è Remove</button>` : `<button onclick="retrieveUser('${user.id}')" style="width: 100%; padding: 8px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">‚Ü©Ô∏è Retrieve</button>`}
                       </div>
                   </div>
               `;
            }).join('');
        }

        // Open credit/takeback modal
        function openCreditModal(userId, type) {
            db.collection('users').doc(userId).get().then(doc => {
                if (doc.exists) {
                    currentUserData = { id: userId, ...doc.data() };
                    currentOperationType = type;

                    const title = type === 'credit' ? 'Credit Account' : 'Take Back Funds';
                    document.getElementById('creditModalTitle').textContent = title;
                    document.getElementById('creditUserName').value = currentUserData.fullName || 'Unknown';
                    document.getElementById('creditWalletAccount').value = currentUserData.wallet?.dlsAccountNumber || 'Not Set';
                    document.getElementById('creditAmount').value = '';
                    document.getElementById('creditPassword').value = '';
                    document.getElementById('creditMessage').innerHTML = '';

                    document.getElementById('creditModal').style.display = 'flex';
                }
            });
        }

        // Close credit modal
        function closeCreditModal() {
            document.getElementById('creditModal').style.display = 'none';
            currentUserData = null;
        }

        // Process credit transaction
        async function processCreditTransaction() {
            const amount = parseFloat(document.getElementById('creditAmount').value);
            const password = document.getElementById('creditPassword').value;
            const msgDiv = document.getElementById('creditMessage');

            if (!amount || amount <= 0) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">‚ùå Please enter a valid amount</div>';
                return;
            }

            if (password !== '1234ABCD') {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">‚ùå Invalid admin password</div>';
                return;
            }

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">‚è≥ Processing...</div>';

                const newBalance = currentOperationType === 'credit'
                    ? (currentUserData.wallet?.balance || 0) + amount
                    : (currentUserData.wallet?.balance || 0) - amount;

                if (newBalance < 0 && currentOperationType === 'takeback') {
                    msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">‚ùå Insufficient balance</div>';
                    return;
                }

                // Update wallet balance
                await db.collection('users').doc(currentUserData.id).update({
                    'wallet.balance': newBalance
                });

                // Add transaction record
                const transaction = {
                    id: (currentOperationType === 'credit' ? 'ADM-CRE-' : 'ADM-TKB-') + Date.now(),
                    type: currentOperationType === 'credit' ? 'deposit' : 'withdrawal',
                    amount: amount,
                    status: 'successful',
                    date: new Date().toISOString(),
                    description: currentOperationType === 'credit' ? 'Admin Credit' : 'Admin Take Back',
                    adminCredited: true
                };

                await db.collection('users').doc(currentUserData.id).update({
                    transactions: firebase.firestore.FieldValue.arrayUnion(transaction)
                });

                msgDiv.innerHTML = `<div style="color: var(--accent-green); font-weight: 600;">‚úÖ ${currentOperationType === 'credit' ? 'Credited' : 'Taken back'} ‚Ç¶${amount.toLocaleString()} successfully!</div>`;

                setTimeout(() => {
                    closeCreditModal();
                    loadManageUsersPage();
                    loadAdminStats();
                }, 1500);
            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Open restrict modal
        function openRestrictModal(userId) {
            db.collection('users').doc(userId).get().then(doc => {
                if (doc.exists) {
                    currentUserData = { id: userId, ...doc.data() };
                    document.getElementById('restrictUserName').value = currentUserData.fullName || 'Unknown';
                    document.getElementById('restrictDuration').value = '';
                    document.getElementById('restrictMessage').innerHTML = '';
                    document.getElementById('restrictModal').style.display = 'flex';
                }
            });
        }

        // Close restrict modal
        function closeRestrictModal() {
            document.getElementById('restrictModal').style.display = 'none';
            currentUserData = null;
        }

        // Process restriction
        async function processRestriction() {
            const duration = parseInt(document.getElementById('restrictDuration').value);
            const msgDiv = document.getElementById('restrictMessage');

            if (!duration) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">‚ùå Please select a duration</div>';
                return;
            }

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">‚è≥ Restricting...</div>';

                const restrictedUntil = new Date(Date.now() + duration * 60 * 60 * 1000).toISOString();

                await db.collection('users').doc(currentUserData.id).update({
                    restricted: true,
                    restrictedUntil: restrictedUntil
                });

                msgDiv.innerHTML = '<div style="color: var(--accent-green); font-weight: 600;">‚úÖ User restricted successfully!</div>';

                setTimeout(() => {
                    closeRestrictModal();
                    loadManageUsersPage();
                    loadAdminStats();
                }, 1500);
            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Unrestrict user
        async function unrestrict(userId) {
            if (confirm('Are you sure you want to remove the restriction from this user?')) {
                try {
                    await db.collection('users').doc(userId).update({
                        restricted: false,
                        restrictedUntil: null
                    });
                    loadManageUsersPage();
                    loadAdminStats();
                } catch (error) {
                    alert('Error unrestricting user: ' + error.message);
                }
            }
        }

        // Remove user
        async function removeUser(userId) {
            if (confirm('Are you sure you want to permanently remove this user? They will never be able to sign in again.')) {
                try {
                    await db.collection('users').doc(userId).update({
                        removed: true,
                        removedAt: new Date().toISOString()
                    });
                    loadManageUsersPage();
                    loadAdminStats();
                } catch (error) {
                    alert('Error removing user: ' + error.message);
                }
            }
        }

        // Retrieve (restore) removed user
        async function retrieveUser(userId) {
            if (confirm('Are you sure you want to retrieve this user and restore their access?')) {
                try {
                    await db.collection('users').doc(userId).update({
                        removed: false,
                        removedAt: null
                    });
                    loadManageUsersPage();
                    loadAdminStats();
                } catch (error) {
                    alert('Error retrieving user: ' + error.message);
                }
            }
        }

        // Load manage users page
        async function loadManageUsersPage() {
            document.getElementById('manageUsersModal').style.display = 'block';
            const container = document.getElementById('usersGridContainer');
            container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 30px; grid-column: 1 / -1;">Loading users...</div>';

            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    // Ensure wallet object exists
                    if (!userData.wallet) {
                        userData.wallet = {
                            dlsAccountNumber: null,
                            bankCode: null,
                            bankAccountNumber: null,
                            accountName: null,
                            balance: 0
                        };
                    }
                    allUsers.push({
                        id: doc.id,
                        ...userData
                    });
                });

                console.log('Loaded users:', allUsers);
                renderUserCards(allUsers);
                document.getElementById('userSearchInput').value = '';
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 30px; grid-column: 1 / -1;">Error loading users</div>';
            }
        }

        // TEST FUNCTION: Add sample bank data to a user
        function addTestBankData(userId) {
            db.collection('users').doc(userId).set({
                wallet: {
                    dlsAccountNumber: 'DLS' + String(Math.floor(Math.random() * 100000)).padStart(5, '0'),
                    bankCode: 'GTB',
                    bankAccountNumber: '0123456789',
                    accountName: 'John Doe',
                    balance: 50000,
                    bankAddedDate: new Date().toISOString()
                }
            }, { merge: true }).then(() => {
                alert('Test bank data added successfully!');
                loadManageUsersPage();
            }).catch(error => {
                alert('Error adding test data: ' + error.message);
            });
        }

        // Approve withdrawal
        async function approveWithdrawal(userId, reference, amount, fee) {
            if (!confirm(`Approve withdrawal of ‚Ç¶${amount.toLocaleString()}? (Fee: ‚Ç¶${fee.toLocaleString()})\n\nBalance will be deducted now.`)) {
                return;
            }

            try {
                // Get user document
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('User not found');
                    return;
                }

                const userData = userDoc.data();
                const transactions = userData.transactions || [];
                const currentBalance = (userData.wallet && userData.wallet.balance) || 0;

                // Find and update the transaction
                const txIndex = transactions.findIndex(tx => tx.id === reference);
                if (txIndex !== -1) {
                    transactions[txIndex].status = 'successful';
                    transactions[txIndex].approvedAt = new Date().toISOString();
                    transactions[txIndex].approvedBy = 'admin';

                    // Deduct the amount from current balance
                    const newBalance = currentBalance - amount;

                    // Update user document with new balance and transaction
                    await db.collection('users').doc(userId).set({
                        wallet: {
                            ...userData.wallet,
                            balance: newBalance
                        },
                        transactions: transactions,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });

                    alert('‚úÖ Withdrawal approved!\nBalance deducted: ‚Ç¶' + amount.toLocaleString() + '\nNew balance: ‚Ç¶' + newBalance.toLocaleString());
                    loadAdminStats();
                }
            } catch (error) {
                alert('Error approving withdrawal: ' + error.message);
            }
        }

        // Store withdrawal data for rejection
        let pendingReject = { userId: null, reference: null, amount: null };

        // Open rejection modal
        function openRejectModal(userId, reference, amount) {
            pendingReject = { userId, reference, amount };
            document.getElementById('rejectModal').style.display = 'flex';
            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectionNotes').value = '';
            document.getElementById('rejectMessage').innerHTML = '';
        }

        // Close rejection modal
        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
            pendingReject = { userId: null, reference: null, amount: null };
        }

        // Confirm rejection
        async function confirmReject() {
            const reason = document.getElementById('rejectionReason').value;
            const notes = document.getElementById('rejectionNotes').value;
            const msgDiv = document.getElementById('rejectMessage');

            if (!reason) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">‚ùå Please select a rejection reason</div>';
                return;
            }

            const { userId, reference, amount } = pendingReject;

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">‚è≥ Processing...</div>';

                // Get user document
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">‚ùå User not found</div>';
                    return;
                }

                const userData = userDoc.data();
                const transactions = userData.transactions || [];

                // Find and update the transaction
                const txIndex = transactions.findIndex(tx => tx.id === reference);
                if (txIndex !== -1) {
                    transactions[txIndex].status = 'rejected';
                    transactions[txIndex].rejectedAt = new Date().toISOString();
                    transactions[txIndex].rejectedBy = 'admin';
                    transactions[txIndex].rejectionReason = reason;
                    transactions[txIndex].rejectionNotes = notes || null;

                    // NO balance change - user keeps their money

                    // Update user document
                    await db.collection('users').doc(userId).set({
                        transactions: transactions,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });

                    msgDiv.innerHTML = '<div style="color: var(--accent-green); font-weight: 600;">‚úÖ Withdrawal rejected!</div>';
                    setTimeout(() => {
                        closeRejectModal();
                        loadAdminStats();
                    }, 1500);
                }
            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">‚ùå Error: ${error.message}</div>`;
            }
        }

        // ===== MATCH CREATION SYSTEM =====
        let isEditMode = false;
        let editingMatchId = null;

        let matchCreationData = {
            teamA: {
                name: '',
                logo: '',
                players: [],
                captain: '',
                clubOwner: '',
                dlsPlayer: ''
            },
            teamB: {
                name: '',
                logo: '',
                players: [],
                captain: '',
                clubOwner: '',
                dlsPlayer: ''
            },
            dlsPlayers: [],
            sponsors: [],
            matchDate: '',
            matchTime: '',
            stats: {
                score: true,
                corners: false,
                possession: false,
                passes: false,
                shotOnTarget: false,
                shots: false,
                shotsOffTarget: false,
                bookings: false
            },
            predictions: {
                enabled: false,
                scoreOnly: false,
                teamToScore: false,
                numberOfGoals: false
            },
            winningChances: {
                teamA: 0,
                teamB: 0
            },
            livestream: {
                enabled: false,
                isPaid: false,
                price: 0
            }
        };

        // Open creation popup
        function openCreationPopup() {
            document.querySelector('.creation-popup-overlay').classList.add('active');
        }

        // Close creation popup
        function closeCreationPopup() {
            document.querySelector('.creation-popup-overlay').classList.remove('active');
        }

        // Select Single Match
        function selectSingleMatch() {
            closeCreationPopup();
            openMatchCreationModal();
        }

        // Select Tournament
        function selectTournament() {
            alert('Tournament creation coming soon!');
            closeCreationPopup();
        }

        // Open match creation modal
        function openMatchCreationModal() {
            document.querySelector('.match-creation-overlay').classList.add('active');
            switchMatchTab('setMatch');
        }

        // Close match creation modal
        function closeMatchCreationModal() {
            document.querySelector('.match-creation-overlay').classList.remove('active');
        }

        // Switch match tabs
        function switchMatchTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.match-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.match-tab-content').forEach(content => content.style.display = 'none');

            const contentId = tabName + 'Content';
            const content = document.getElementById(contentId);
            if (content) {
                content.style.display = 'block';
            }
        }

        // Add player to team
        function addPlayerToTeam(team) {
            const playerNameInput = document.getElementById(team + 'PlayerName');
            const playerNumberInput = document.getElementById(team + 'PlayerNumber');
            const playerRoleInput = document.getElementById(team + 'PlayerRole');

            if (!playerNameInput.value || !playerNumberInput.value || !playerRoleInput.value) {
                alert('Please enter player name, number, and role');
                return;
            }

            if (matchCreationData[team].players.length >= 17) {
                alert('Maximum 17 players per team');
                return;
            }

            const player = {
                name: playerNameInput.value,
                number: playerNumberInput.value,
                role: playerRoleInput.value,
                id: Date.now()
            };

            matchCreationData[team].players.push(player);
            playerNameInput.value = '';
            playerNumberInput.value = '';
            playerRoleInput.value = '';

            updatePlayerList(team);
        }

        // Remove player from team
        function removePlayer(team, playerId) {
            matchCreationData[team].players = matchCreationData[team].players.filter(p => p.id !== playerId);
            updatePlayerList(team);
        }

        // Update player list display
        function updatePlayerList(team) {
            const listId = team + 'PlayerList';
            const playerList = document.getElementById(listId);
            const playerCount = document.getElementById(team + 'PlayerCount');

            playerCount.textContent = matchCreationData[team].players.length + '/17';

            playerList.innerHTML = matchCreationData[team].players.map(player => `
                <div class="player-item">
                    <span>${player.number} - ${player.name} (${player.role})</span>
                    <button class="remove-btn" onclick="removePlayer('${team}', ${player.id})">Remove</button>
                </div>
            `).join('');
        }

        // Add sponsor
        function addSponsor() {
            const nameInput = document.getElementById('sponsorName');
            const logoUrlInput = document.getElementById('sponsorLogo');
            const logoFileInput = document.getElementById('sponsorLogoFile');

            if (!nameInput.value) {
                alert('Please enter sponsor name');
                return;
            }

            // Check if either URL or file is provided
            if (!logoUrlInput.value && !logoFileInput.files.length) {
                alert('Please enter sponsor logo URL or upload a file');
                return;
            }

            const sponsor = {
                name: nameInput.value,
                logo: logoUrlInput.value || '',
                id: Date.now()
            };

            // Handle file upload if provided
            if (logoFileInput.files.length > 0) {
                const file = logoFileInput.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    sponsor.logo = e.target.result;
                    matchCreationData.sponsors.push(sponsor);
                    nameInput.value = '';
                    logoUrlInput.value = '';
                    logoFileInput.value = '';
                    updateSponsorList();
                };
                reader.readAsDataURL(file);
            } else {
                matchCreationData.sponsors.push(sponsor);
                nameInput.value = '';
                logoUrlInput.value = '';
                logoFileInput.value = '';
                updateSponsorList();
            }
        }

        // Remove sponsor
        function removeSponsor(sponsorId) {
            matchCreationData.sponsors = matchCreationData.sponsors.filter(s => s.id !== sponsorId);
            updateSponsorList();
        }

        // Update sponsor list display
        function updateSponsorList() {
            const sponsorList = document.getElementById('sponsorsList');
            const sponsorCount = document.getElementById('sponsorCount');

            sponsorCount.textContent = matchCreationData.sponsors.length;

            sponsorList.innerHTML = matchCreationData.sponsors.map(sponsor => `
                <div class="player-item">
                    <span>üè¢ ${sponsor.name}</span>
                    <button class="remove-btn" onclick="removeSponsor(${sponsor.id})">Remove</button>
                </div>
            `).join('');
        }

        // Update stats selection
        function updateStats() {
            matchCreationData.stats.corners = document.getElementById('statCorners').checked;
            matchCreationData.stats.possession = document.getElementById('statPossession').checked;
            matchCreationData.stats.passes = document.getElementById('statPasses').checked;
            matchCreationData.stats.shotOnTarget = document.getElementById('statShotOnTarget').checked;
            matchCreationData.stats.shots = document.getElementById('statShots').checked;
            matchCreationData.stats.shotsOffTarget = document.getElementById('statShotsOffTarget').checked;
            matchCreationData.stats.bookings = document.getElementById('statBookings').checked;
        }

        // Update predictions
        function updatePredictions() {
            matchCreationData.predictions.enabled = document.getElementById('predictionsEnabled').checked;
            if (matchCreationData.predictions.enabled) {
                matchCreationData.predictions.scoreOnly = document.getElementById('predictScore').checked;
                matchCreationData.predictions.teamToScore = document.getElementById('predictTeamToScore').checked;
                matchCreationData.predictions.numberOfGoals = document.getElementById('predictNumberOfGoals').checked;
            }
        }

        // Handle logo file upload
        function handleLogoUpload(team, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    matchCreationData[team].logo = e.target.result;
                    console.log(`Logo uploaded for ${team}`);
                };
                reader.readAsDataURL(file);
            }
        }

        // Update livestream
        function updateLivestream() {
            matchCreationData.livestream.enabled = document.getElementById('livestreamEnabled').checked;
            const livestreamOptions = document.getElementById('livestreamOptions');

            if (matchCreationData.livestream.enabled) {
                livestreamOptions.style.display = 'block';
                // Ensure radio buttons are visible for selection
                const freeRadio = document.querySelector('input[name="livestreamType"][value="free"]');
                const paidRadio = document.querySelector('input[name="livestreamType"][value="paid"]');
                const priceInput = document.getElementById('livestreamPrice');

                if (freeRadio && paidRadio) {
                    freeRadio.disabled = false;
                    paidRadio.disabled = false;
                    matchCreationData.livestream.isPaid = paidRadio.checked;
                    if (priceInput) {
                        priceInput.disabled = !paidRadio.checked;
                    }
                }
            } else {
                livestreamOptions.style.display = 'none';
                matchCreationData.livestream.enabled = false;
            }
        }

        // ===== NOTIFICATION SYSTEM =====
        let notificationCounter = 0;

        function showNotification(message, type = 'info', duration = 4000, icon = null) {
            const container = document.getElementById('notificationContainer') || createNotificationContainer();
            const notifId = `notif-${notificationCounter++}`;

            // Default icons
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                loading: '<div class="spinner"></div>'
            };

            const notif = document.createElement('div');
            notif.id = notifId;
            notif.className = `notification notification-${type}`;
            notif.innerHTML = `
                <span class="notification-icon">${icon || icons[type] || icons.info}</span>
                <span class="notification-text">${message}</span>
                <span class="notification-close" onclick="removeNotification('${notifId}')">√ó</span>
            `;

            container.appendChild(notif);

            if (type !== 'loading' && duration > 0) {
                setTimeout(() => {
                    removeNotification(notifId);
                }, duration);
            }

            return notifId;
        }

        function createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'notificationContainer';
            container.className = 'notification-container';
            document.body.appendChild(container);
            return container;
        }

        function removeNotification(notifId) {
            const notif = document.getElementById(notifId);
            if (notif) {
                notif.classList.add('removing');
                setTimeout(() => {
                    notif.remove();
                }, 300);
            }
        }

        function resetMatchForm() {
            // Reset match creation data
            matchCreationData = {
                teamA: { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                teamB: { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                dlsPlayers: [],
                sponsors: [],
                matchDate: '',
                matchTime: '',
                stats: {
                    score: true, corners: false, possession: false, passes: false,
                    shotOnTarget: false, shots: false, shotsOffTarget: false, bookings: false
                },
                predictions: { enabled: false, scoreOnly: false, teamToScore: false, numberOfGoals: false },
                winningChances: { teamA: 0, teamB: 0 },
                livestream: { enabled: false, isPaid: false, price: 0 }
            };

            // Reset all form inputs
            const inputs = document.querySelectorAll('.match-form-container input, .match-form-container select, .match-form-container textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });

            // Reset player lists
            document.getElementById('teamAPlayerList').innerHTML = '';
            document.getElementById('teamBPlayerList').innerHTML = '';
            document.getElementById('teamAPlayerCount').textContent = '0/17';
            document.getElementById('teamBPlayerCount').textContent = '0/17';

            // Reset sponsor list
            document.getElementById('sponsorsList').innerHTML = '';
            document.getElementById('sponsorCount').textContent = '0';

            // Reset checkbox states
            document.getElementById('livestreamEnabled').checked = false;
            document.getElementById('predictionsEnabled').checked = false;
            document.getElementById('livestreamOptions').style.display = 'none';
            document.getElementById('predictionsOptions').style.display = 'none';
        }

        // Load matches for editing
        async function loadMatchesForEdit() {
            try {
                const matchesSnapshot = await db.collection('matches').where('status', 'in', ['upcoming', 'live']).get();
                const matches = [];

                matchesSnapshot.forEach(doc => {
                    matches.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Display matches in a selection modal
                showEditMatchSelector(matches);
            } catch (error) {
                showNotification(`‚ùå Error loading matches: ${error.message}`, 'error', 4000);
            }
        }

        // Show match selector modal
        function showEditMatchSelector(matches) {
            if (matches.length === 0) {
                showNotification('‚ùå No matches available to edit', 'error', 3000);
                return;
            }

            // Create simple selector
            let options = '<div style="display: grid; gap: 10px; max-height: 400px; overflow-y: auto;">';
            matches.forEach(match => {
                const matchDate = new Date(match.createdAt).toLocaleDateString();
                const matchTime = match.matchTime || 'TBD';
                options += `
                    <div onclick="editMatch('${match.id}')" style="padding: 12px; background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; cursor: pointer; color: var(--text-white); transition: all 0.3s;">
                        <strong>${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}</strong>
                        <div style="font-size: 0.85em; color: var(--text-gray); margin-top: 5px;">
                            üìÖ ${matchDate} | üïê ${matchTime}
                        </div>
                    </div>
                `;
            });
            options += '</div>';

            // Simple prompt-like dialog
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 5000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            container.innerHTML = `
                <div style="background: var(--card-bg); border: 2px solid rgba(255,215,0,0.3); border-radius: 15px; padding: 30px; max-width: 500px; width: 100%;">
                    <h2 style="color: var(--accent-gold); margin-bottom: 20px;">üìã Select Match to Edit</h2>
                    ${options}
                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                </div>
            `;

            document.body.appendChild(container);
        }

        // Edit a specific match
        async function editMatch(matchId) {
            try {
                // Remove selector modal
                document.querySelector('div[style*="position: fixed"][style*="background: rgba(0,0,0,0.9)"]')?.remove();

                const matchDoc = await db.collection('matches').doc(matchId).get();
                if (!matchDoc.exists) {
                    showNotification('‚ùå Match not found', 'error', 3000);
                    return;
                }

                // Load match data into form
                const data = matchDoc.data();
                isEditMode = true;
                editingMatchId = matchId;

                // Populate matchCreationData
                matchCreationData = {
                    teamA: data.teamA || { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                    teamB: data.teamB || { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                    dlsPlayers: data.dlsPlayers || [],
                    sponsors: data.sponsors || [],
                    matchDate: data.matchDate || '',
                    matchTime: data.matchTime || '',
                    stats: data.stats || { score: true, corners: false, possession: false, passes: false, shotOnTarget: false, shots: false, shotsOffTarget: false, bookings: false },
                    predictions: data.predictions || { enabled: false, scoreOnly: false, teamToScore: false, numberOfGoals: false },
                    winningChances: data.winningChances || { teamA: 0, teamB: 0 },
                    livestream: data.livestream || { enabled: false, isPaid: false, price: 0 }
                };

                // Open modal and populate form
                openMatchCreationModal();
                populateMatchFormWithData();

                showNotification('üìù Match loaded for editing', 'info', 2000);
            } catch (error) {
                showNotification(`‚ùå Error loading match: ${error.message}`, 'error', 4000);
            }
        }

        // Populate form with existing match data
        function populateMatchFormWithData() {
            // Team names
            document.querySelectorAll('.match-form-container input[placeholder*="team name"]')[0].value = matchCreationData.teamA.name;
            document.querySelectorAll('.match-form-container input[placeholder*="team name"]')[1].value = matchCreationData.teamB.name;

            // DLS Players
            const dlsInputs = document.querySelectorAll('.match-form-container input[placeholder*="DLS"]');
            if (dlsInputs[0]) dlsInputs[0].value = matchCreationData.teamA.dlsPlayer;
            if (dlsInputs[1]) dlsInputs[1].value = matchCreationData.teamB.dlsPlayer;

            // Club Owners
            const clubInputs = document.querySelectorAll('.match-form-container input[placeholder*="club"]');
            if (clubInputs[0]) clubInputs[0].value = matchCreationData.teamA.clubOwner;
            if (clubInputs[1]) clubInputs[1].value = matchCreationData.teamB.clubOwner;

            // Captains
            const captainInputs = document.querySelectorAll('.match-form-container input[placeholder*="Captain"]');
            if (captainInputs[0]) captainInputs[0].value = matchCreationData.teamA.captain;
            if (captainInputs[1]) captainInputs[1].value = matchCreationData.teamB.captain;

            // Date and Time
            document.querySelector('input[type="date"]').value = matchCreationData.matchDate;
            document.querySelector('input[type="time"]').value = matchCreationData.matchTime;

            // Players - rebuild lists
            document.getElementById('teamAPlayerList').innerHTML = '';
            document.getElementById('teamBPlayerList').innerHTML = '';

            matchCreationData.teamA.players.forEach(() => updatePlayerList('teamA'));
            matchCreationData.teamB.players.forEach(() => updatePlayerList('teamB'));

            // Sponsors - rebuild list
            document.getElementById('sponsorsList').innerHTML = '';
            document.getElementById('sponsorCount').textContent = matchCreationData.sponsors.length;
            updateSponsorList();

            // Stats checkboxes
            Object.entries(matchCreationData.stats).forEach(([key, value]) => {
                const elem = document.getElementById('stat' + key.charAt(0).toUpperCase() + key.slice(1));
                if (elem) elem.checked = value;
            });

            // Livestream
            document.getElementById('livestreamEnabled').checked = matchCreationData.livestream.enabled;
            if (matchCreationData.livestream.enabled) {
                document.getElementById('livestreamOptions').style.display = 'block';
                const isPaid = matchCreationData.livestream.isPaid;
                document.querySelector('input[name="livestreamType"][value="' + (isPaid ? 'paid' : 'free') + '"]').checked = true;
                const priceInput = document.getElementById('livestreamPrice');
                if (isPaid && priceInput) priceInput.value = matchCreationData.livestream.price;
                if (priceInput) priceInput.disabled = !isPaid;
            }

            // Predictions
            document.getElementById('predictionsEnabled').checked = matchCreationData.predictions.enabled;
            if (matchCreationData.predictions.enabled) {
                document.getElementById('predictionsOptions').style.display = 'block';
                document.getElementById('predictScore').checked = matchCreationData.predictions.scoreOnly;
                document.getElementById('predictTeamToScore').checked = matchCreationData.predictions.teamToScore;
                document.getElementById('predictNumberOfGoals').checked = matchCreationData.predictions.numberOfGoals;
            }

            // Winning chances
            document.querySelectorAll('input[placeholder*="0-100"]')[0].value = matchCreationData.winningChances.teamA;
            document.querySelectorAll('input[placeholder*="0-100"]')[1].value = matchCreationData.winningChances.teamB;
        }

        // Submit match creation
        async function submitMatchCreation() {
            // Validate required fields
            if (!matchCreationData.teamA.name || !matchCreationData.teamB.name) {
                showNotification('‚ùå Please enter both team names', 'error', 3000);
                return;
            }

            if (matchCreationData.teamA.players.length === 0 || matchCreationData.teamB.players.length === 0) {
                showNotification('‚ùå Please add at least one player to each team', 'error', 3000);
                return;
            }

            // Show loading notification
            const actionText = isEditMode ? 'Updating match' : 'Creating match';
            const loadingNotif = showNotification(`${actionText}...`, 'loading', 0, '<div class="spinner"></div>');

            try {
                // Get admin email from session or use default admin email
                const adminEmail = sessionStorage.getItem('adminEmail') || 'bashorunidris01@gmail.com';

                if (!adminEmail) {
                    removeNotification(loadingNotif);
                    showNotification('‚ùå Admin user not logged in', 'error', 3000);
                    return;
                }

                if (isEditMode) {
                    // Update existing match
                    await db.collection('matches').doc(editingMatchId).update({
                        ...matchCreationData,
                        updatedBy: adminEmail,
                        updatedAt: new Date().toISOString()
                    });

                    removeNotification(loadingNotif);
                    showNotification('‚úÖ Match updated successfully!', 'success', 4000);
                } else {
                    // Create new match document in Firebase
                    const matchRef = await db.collection('matches').add({
                        ...matchCreationData,
                        createdBy: adminEmail,
                        createdByType: 'admin',
                        createdAt: new Date().toISOString(),
                        status: 'upcoming',
                        matchType: 'singleMatch'
                    });

                    removeNotification(loadingNotif);
                    showNotification('‚úÖ Match created successfully!', 'success', 4000);
                }

                // Reset form and mode
                resetMatchForm();
                isEditMode = false;
                editingMatchId = null;

                // Close modal after short delay
                setTimeout(() => {
                    closeMatchCreationModal();
                }, 500);

            } catch (error) {
                console.error('Error with match:', error);
                removeNotification(loadingNotif);
                showNotification(`‚ùå Error: ${error.message}`, 'error', 5000);
            }
        }

        // ===== DEVICE TRACKING SYSTEM =====
        let userDeviceInfo = {
            deviceType: 'Unknown',
            browser: 'Unknown',
            browserVersion: 'Unknown',
            operatingSystem: 'Unknown',
            osVersion: 'Unknown',
            screenResolution: '',
            screenWidth: 0,
            screenHeight: 0,
            userAgent: navigator.userAgent,
            lastActive: null,
            firstSeen: null
        };

        // Get device information
        function detectDeviceInfo() {
            const ua = navigator.userAgent;
            let browserName = 'Unknown';
            let browserVersion = 'Unknown';
            let osName = 'Unknown';
            let osVersion = 'Unknown';
            let deviceType = 'Desktop';

            // Detect Browser
            if (ua.indexOf('Firefox') > -1) browserName = 'Firefox';
            else if (ua.indexOf('SamsungBrowser') > -1) browserName = 'Samsung Internet';
            else if (ua.indexOf('Opera') > -1 || ua.indexOf('OPR') > -1) browserName = 'Opera';
            else if (ua.indexOf('Trident') > -1) browserName = 'Internet Explorer';
            else if (ua.indexOf('Edge') > -1) browserName = 'Edge';
            else if (ua.indexOf('Chrome') > -1) browserName = 'Chrome';
            else if (ua.indexOf('Safari') > -1) browserName = 'Safari';

            // Get Browser Version
            if (browserName === 'Chrome') {
                const match = ua.match(/Chrome\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            } else if (browserName === 'Firefox') {
                const match = ua.match(/Firefox\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            } else if (browserName === 'Safari') {
                const match = ua.match(/Version\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            } else if (browserName === 'Edge') {
                const match = ua.match(/Edge\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            }

            // Detect OS
            if (ua.indexOf('Win') > -1) {
                osName = 'Windows';
                if (ua.indexOf('Windows NT 10.0') > -1) osVersion = '10';
                else if (ua.indexOf('Windows NT 6.3') > -1) osVersion = '8.1';
                else if (ua.indexOf('Windows NT 6.2') > -1) osVersion = '8';
                else if (ua.indexOf('Windows NT 6.1') > -1) osVersion = '7';
            } else if (ua.indexOf('Mac') > -1) {
                osName = 'macOS';
                const match = ua.match(/Mac OS X (\d+[._]\d+)/);
                osVersion = match ? match[1].replace('_', '.') : 'Unknown';
            } else if (ua.indexOf('Android') > -1) {
                osName = 'Android';
                const match = ua.match(/Android (\d+)/);
                osVersion = match ? match[1] : 'Unknown';
                deviceType = 'Mobile';
            } else if (ua.indexOf('iPhone') > -1 || ua.indexOf('iPad') > -1) {
                osName = 'iOS';
                const match = ua.match(/OS (\d+)_(\d+)/);
                osVersion = match ? `${match[1]}.${match[2]}` : 'Unknown';
                deviceType = ua.indexOf('iPad') > -1 ? 'Tablet' : 'Mobile';
            } else if (ua.indexOf('Linux') > -1) {
                osName = 'Linux';
            }

            // Check for tablet
            if ((ua.indexOf('iPad') > -1) || (ua.indexOf('Android') > -1 && ua.indexOf('Mobile') === -1)) {
                deviceType = 'Tablet';
            } else if (ua.indexOf('Mobile') > -1 || ua.indexOf('Android') > -1) {
                deviceType = 'Mobile';
            }

            // Get screen resolution
            const screenResolution = `${window.screen.width}x${window.screen.height}`;

            userDeviceInfo = {
                deviceType,
                browser: browserName,
                browserVersion,
                operatingSystem: osName,
                osVersion,
                screenResolution,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                userAgent: ua,
                lastActive: new Date().toISOString(),
                firstSeen: new Date().toISOString()
            };

            return userDeviceInfo;
        }

        // Save device info to Firebase
        async function saveDeviceInfoToFirebase() {
            try {
                const userId = auth.currentUser?.uid;
                if (!userId) return;

                const deviceInfo = detectDeviceInfo();

                await db.collection('users').doc(userId).update({
                    deviceInfo: deviceInfo,
                    lastDeviceUpdate: new Date().toISOString(),
                    devices: firebase.firestore.FieldValue.arrayUnion({
                        ...deviceInfo,
                        detectedAt: new Date().toISOString()
                    })
                });

                console.log('Device info saved:', deviceInfo);
            } catch (error) {
                console.error('Error saving device info:', error);
            }
        }

        // Track device on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (auth.currentUser?.uid) {
                    saveDeviceInfoToFirebase();
                }
            }, 2000);
        });

        // ===== LOCATION PERMISSION SYSTEM =====
        let userLocationPermission = false;
        let userLocationData = {
            country: 'Unknown',
            state: 'Unknown',
            lga: 'Unknown',
            latitude: null,
            longitude: null,
            permissionGranted: false,
            permissionDate: null
        };

        // Check location permission on page load
        async function checkLocationPermission() {
            try {
                const userId = auth.currentUser?.uid;
                if (!userId) return;

                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userLocationPermission = userData.locationPermissionGranted || false;

                    // If user already granted permission, load their location
                    if (userLocationPermission && userData.userLocation) {
                        userLocationData = userData.userLocation;
                    } else if (!userLocationPermission && !userData.locationPermissionRejected) {
                        // Show permission modal if not granted or rejected
                        setTimeout(() => showLocationPermissionModal(), 1000);
                    }
                }
            } catch (error) {
                console.error('Error checking location permission:', error);
            }
        }

        // Show location permission modal
        function showLocationPermissionModal() {
            const overlay = document.querySelector('.location-permission-overlay');
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        // Close location permission modal
        function closeLocationPermissionModal() {
            const overlay = document.querySelector('.location-permission-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // Allow location access
        async function allowLocationAccess() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Browser popup opening...';

            try {
                if (!navigator.geolocation) {
                    alert('‚ùå Geolocation is not supported by your browser');
                    btn.disabled = false;
                    btn.textContent = 'üìç Enable Location (Browser Popup)';
                    return;
                }

                console.log('üìç Requesting geolocation from browser...');

                // This will trigger the browser's native location permission popup
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        console.log('‚úÖ Location permission granted by user');
                        const { latitude, longitude } = position.coords;

                        console.log(`üìç User coordinates: ${latitude}, ${longitude}`);

                        // Get location data from coordinates
                        const locationData = await reverseGeocodeLocation(latitude, longitude);
                        console.log('üìç Geocoded location:', locationData);

                        userLocationData = {
                            country: locationData.country,
                            state: locationData.state,
                            lga: locationData.lga,
                            latitude,
                            longitude,
                            permissionGranted: true,
                            permissionDate: new Date().toISOString()
                        };

                        // Save to Firebase
                        const userId = auth.currentUser?.uid;
                        console.log('üíæ Saving location to Firebase for user:', userId);

                        if (userId) {
                            await db.collection('users').doc(userId).update({
                                locationPermissionGranted: true,
                                locationPermissionDate: new Date().toISOString(),
                                userLocation: userLocationData,
                                country: locationData.country,
                                state: locationData.state,
                                lga: locationData.lga
                            });
                            console.log('‚úÖ Location saved to Firebase successfully');
                        }

                        btn.textContent = '‚úÖ Location Enabled!';
                        setTimeout(() => {
                            closeLocationPermissionModal();
                            btn.disabled = false;
                        }, 1500);
                    },
                    (error) => {
                        console.error('‚ùå Location permission denied or error:', error);

                        if (error.code === error.PERMISSION_DENIED) {
                            console.log('User denied location permission in browser popup');
                            btn.textContent = '‚ùå Permission Denied';
                            btn.disabled = false;
                            setTimeout(() => {
                                btn.textContent = 'üìç Enable Location (Browser Popup)';
                            }, 2000);
                        } else {
                            btn.textContent = '‚ùå Error Getting Location';
                            btn.disabled = false;
                            alert('Error getting location: ' + error.message);
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (error) {
                console.error('‚ùå Error in allowLocationAccess:', error);
                btn.disabled = false;
                btn.textContent = 'üìç Enable Location (Browser Popup)';
            }
        }

        // Skip location access
        async function skipLocationAccess() {
            const userId = auth.currentUser?.uid;
            if (userId) {
                try {
                    await db.collection('users').doc(userId).update({
                        locationPermissionRejected: true,
                        locationPermissionRejectedDate: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error saving location rejection:', error);
                }
            }
            closeLocationPermissionModal();
        }

        // Reverse geocode coordinates to get location data
        async function reverseGeocodeLocation(latitude, longitude) {
            try {
                // Using Open-Meteo API (free, no API key needed) for timezone and basic location
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
                );
                const data = await response.json();

                // Parse address components
                const address = data.address || {};

                // Try to get country
                const country = address.country || 'Nigeria';

                // Get state (admin_area or state)
                let state = address.state || address.admin_area || 'Unknown';

                // Get LGA (municipality or town)
                let lga = address.municipality || address.town || address.village || 'Unknown';

                // For Nigerian locations, try to map to proper state/LGA
                if (country.includes('Nigeria') || country.includes('NG')) {
                    // Use more detailed parsing for Nigeria
                    state = parseNigerianState(address);
                    lga = parseNigerianLGA(address, state);
                }

                return {
                    country: country,
                    state: state,
                    lga: lga
                };
            } catch (error) {
                console.error('Reverse geocode error:', error);
                return {
                    country: 'Nigeria',
                    state: 'Unknown',
                    lga: 'Unknown'
                };
            }
        }

        // Parse Nigerian state from address
        function parseNigerianState(address) {
            const stateNames = [
                'Abia', 'Adamawa', 'Akwa Ibom', 'Anambra', 'Bauchi', 'Bayelsa', 'Benue',
                'Borno', 'Cross River', 'Delta', 'Ebonyi', 'Edo', 'Ekiti', 'Enugu', 'FCT',
                'Gombe', 'Imo', 'Jigawa', 'Kaduna', 'Kano', 'Katsina', 'Kebbi', 'Kogi',
                'Kwara', 'Lagos', 'Nasarawa', 'Niger', 'Ogun', 'Ondo', 'Osun', 'Oyo',
                'Plateau', 'Rivers', 'Sokoto', 'Taraba', 'Yobe', 'Zamfara'
            ];

            const addressStr = JSON.stringify(address).toUpperCase();
            for (let state of stateNames) {
                if (addressStr.includes(state.toUpperCase())) {
                    return state;
                }
            }

            return address.state || address.admin_area || 'Unknown';
        }

        // Parse Nigerian LGA from address
        function parseNigerianLGA(address, state) {
            // Common LGA patterns
            let lga = address.municipality || address.town || address.village || '';

            if (lga) {
                // Remove state name if included
                lga = lga.replace(new RegExp(state, 'i'), '').trim();
                // Remove "LGA" suffix
                lga = lga.replace(/\s+LGA\s*/i, '').trim();
            }

            return lga || 'Unknown';
        }

        // ===== FINANCIAL REPORTS MODAL =====
        let currentReportTab = 'overview';
        let reportData = {
            overview: {},
            users: [],
            daily: [],
            hourly: [],
            geographic: {
                byCountry: {},
                byState: {},
                byLGA: {},
                locations: []
            },
            devices: {
                byType: {},
                byBrowser: {},
                byOS: {},
                byResolution: {},
                allDevices: []
            }
        };
        let charts = {};

        // Open financial reports modal
        function openFinancialReportsModal() {
            document.querySelector('.reports-modal-overlay').classList.add('active');
            currentReportTab = 'overview';
            loadFinancialReports();
        }

        // Close financial reports modal
        function closeFinancialReportsModal() {
            document.querySelector('.reports-modal-overlay').classList.remove('active');
        }

        // Load financial data
        async function loadFinancialReports() {
            try {
                const usersSnapshot = await db.collection('users').get();
                let allTx = [];
                let userStats = [];
                let depositsByType = { deposits: 0, withdrawals: 0 };
                let statusBreakdown = { successful: 0, pending: 0, rejected: 0 };
                let hourlyData = {};
                let byCountry = {};
                let byState = {};
                let byLGA = {};
                let byDeviceType = {};
                let byBrowser = {};
                let byOS = {};
                let byResolution = {};
                let allDevices = [];

                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userEmail = userData.email || 'N/A';
                    const userName = userData.name || 'N/A';
                    const transactions = userData.transactions || [];

                    // Geographic data from user profile
                    const userCountry = userData.country || 'Unknown';
                    const userState = userData.state || 'Unknown';
                    const userLGA = userData.lga || 'Unknown';

                    // Device data from user profile
                    const deviceInfo = userData.deviceInfo || {};
                    const deviceType = deviceInfo.deviceType || 'Unknown';
                    const browser = deviceInfo.browser || 'Unknown';
                    const os = deviceInfo.operatingSystem || 'Unknown';
                    const resolution = deviceInfo.screenResolution || 'Unknown';

                    // Track device info
                    if (deviceInfo && deviceInfo.deviceType) {
                        byDeviceType[deviceType] = (byDeviceType[deviceType] || 0) + 1;
                        byBrowser[browser] = (byBrowser[browser] || 0) + 1;
                        byOS[os] = (byOS[os] || 0) + 1;
                        byResolution[resolution] = (byResolution[resolution] || 0) + 1;

                        allDevices.push({
                            userName: userData.name || 'N/A',
                            userEmail: userData.email || 'N/A',
                            ...deviceInfo
                        });
                    }

                    let userDeposits = 0, userWithdrawals = 0, userFees = 0;

                    transactions.forEach(tx => {
                        allTx.push({
                            ...tx,
                            userCountry,
                            userState,
                            userLGA,
                            userName,
                            userEmail
                        });

                        if (tx.type === 'deposit') {
                            userDeposits += tx.amount;
                            depositsByType.deposits += tx.amount;
                        }
                        if (tx.type === 'withdrawal') {
                            userWithdrawals += tx.amount;
                            depositsByType.withdrawals += tx.amount;
                            userFees += tx.fee || 0;
                        }

                        // Track by hour
                        if (tx.date) {
                            const date = new Date(tx.date);
                            const hour = date.getHours() + ':00';
                            hourlyData[hour] = (hourlyData[hour] || 0) + 1;
                        }

                        // Track by geography
                        byCountry[userCountry] = (byCountry[userCountry] || 0) + tx.amount;
                        byState[userState] = (byState[userState] || 0) + tx.amount;
                        byLGA[userLGA] = (byLGA[userLGA] || 0) + tx.amount;

                        // Track status
                        if (tx.type === 'withdrawal') {
                            if (tx.status === 'successful') statusBreakdown.successful += tx.amount;
                            else if (tx.status === 'pending') statusBreakdown.pending += tx.amount;
                            else if (tx.status === 'rejected') statusBreakdown.rejected += tx.amount;
                        }
                    });

                    if (transactions.length > 0) {
                        userStats.push({
                            email: userEmail,
                            name: userName,
                            country: userCountry,
                            state: userState,
                            lga: userLGA,
                            deposits: userDeposits,
                            withdrawals: userWithdrawals,
                            fees: userFees,
                            netFlow: userDeposits - userWithdrawals,
                            txCount: transactions.length
                        });
                    }
                });

                // Calculate overview stats
                let totalDeposits = 0, totalWithdrawals = 0, totalFees = 0, totalApproved = 0, totalPending = 0, totalRejected = 0;

                allTx.forEach(tx => {
                    if (tx.type === 'deposit') totalDeposits += tx.amount;
                    if (tx.type === 'withdrawal') {
                        totalWithdrawals += tx.amount;
                        totalFees += tx.fee || 0;
                        if (tx.status === 'successful') totalApproved += tx.amount;
                        else if (tx.status === 'pending') totalPending += tx.amount;
                        else if (tx.status === 'rejected') totalRejected += tx.amount;
                    }
                });

                const netFlow = totalDeposits - totalWithdrawals;

                reportData.overview = {
                    totalDeposits,
                    totalWithdrawals,
                    totalFees,
                    netFlow,
                    totalApproved,
                    totalPending,
                    totalRejected,
                    totalTransactions: allTx.length,
                    uniqueUsers: usersSnapshot.size,
                    approvalRate: allTx.filter(tx => tx.type === 'withdrawal').length > 0
                        ? ((totalApproved / allTx.filter(tx => tx.type === 'withdrawal' && (tx.status === 'successful' || tx.status === 'pending' || tx.status === 'rejected')).reduce((sum, tx) => sum + tx.amount, 0)) * 100).toFixed(1)
                        : 0,
                    depositsByType,
                    statusBreakdown,
                    hourlyTransactions: hourlyData
                };

                reportData.users = userStats.sort((a, b) => b.netFlow - a.netFlow).slice(0, 20);

                // Process geographic data - sort by transaction volume
                reportData.geographic.byCountry = Object.entries(byCountry)
                    .map(([country, amount]) => ({ country, amount }))
                    .sort((a, b) => b.amount - a.amount);

                reportData.geographic.byState = Object.entries(byState)
                    .map(([state, amount]) => ({ state, amount }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 15);

                reportData.geographic.byLGA = Object.entries(byLGA)
                    .map(([lga, amount]) => ({ lga, amount }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 15);

                // Process device data
                reportData.devices.byType = Object.entries(byDeviceType)
                    .map(([type, count]) => ({ type, count }))
                    .sort((a, b) => b.count - a.count);

                reportData.devices.byBrowser = Object.entries(byBrowser)
                    .map(([browser, count]) => ({ browser, count }))
                    .sort((a, b) => b.count - a.count);

                reportData.devices.byOS = Object.entries(byOS)
                    .map(([os, count]) => ({ os, count }))
                    .sort((a, b) => b.count - a.count);

                reportData.devices.byResolution = Object.entries(byResolution)
                    .map(([resolution, count]) => ({ resolution, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);

                reportData.devices.allDevices = allDevices;

                renderReportsView();
            } catch (error) {
                console.error('Error loading financial reports:', error);
                alert('Error loading reports: ' + error.message);
            }
        }

        // Switch report tabs
        function switchReportTab(tab) {
            currentReportTab = tab;
            document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderReportsView();
        }

        // Render reports view
        function renderReportsView() {
            const container = document.getElementById('reportsContainer');

            if (currentReportTab === 'overview') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">üìä Overview Statistics</h3>
                        <div class="report-grid">
                            <div class="report-card">
                                <div class="report-card-label">Total Deposits</div>
                                <div class="report-card-value">‚Ç¶${reportData.overview.totalDeposits.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Total Withdrawals</div>
                                <div class="report-card-value">‚Ç¶${reportData.overview.totalWithdrawals.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Total Fees Collected</div>
                                <div class="report-card-value">‚Ç¶${reportData.overview.totalFees.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Net Flow</div>
                                <div class="report-card-value" style="color: ${reportData.overview.netFlow >= 0 ? 'var(--accent-green)' : '#ff6b6b'}">‚Ç¶${reportData.overview.netFlow.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üí≥ Withdrawal Status</h3>
                        <div class="report-grid">
                            <div class="report-card">
                                <div class="report-card-label">‚úÖ Approved</div>
                                <div class="report-card-value">‚Ç¶${reportData.overview.totalApproved.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">‚è≥ Pending</div>
                                <div class="report-card-value">‚Ç¶${reportData.overview.totalPending.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">‚ùå Rejected</div>
                                <div class="report-card-value">‚Ç¶${reportData.overview.totalRejected.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Approval Rate</div>
                                <div class="report-card-value">${reportData.overview.approvalRate}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üìà Platform Metrics</h3>
                        <div class="report-grid">
                            <div class="report-card">
                                <div class="report-card-label">Total Transactions</div>
                                <div class="report-card-value">${reportData.overview.totalTransactions}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Active Users</div>
                                <div class="report-card-value">${reportData.overview.uniqueUsers}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Avg per User</div>
                                <div class="report-card-value">‚Ç¶${(reportData.overview.totalTransactions > 0 ? (reportData.overview.netFlow / reportData.overview.uniqueUsers).toFixed(0) : 0).toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",")}</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üìä Detailed Charts</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">Deposits vs Withdrawals</div>
                                <div class="small-chart-container">
                                    <canvas id="depositWithdrawalChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">Withdrawal Status Breakdown</div>
                                <div class="small-chart-container">
                                    <canvas id="statusBreakdownChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Transaction Volume by Hour</div>
                            <canvas id="hourlyVolumeChart"></canvas>
                        </div>
                    </div>
                `;

                // Render charts after content is loaded
                setTimeout(() => {
                    createDepositWithdrawalChart();
                    createStatusBreakdownChart();
                    createHourlyVolumeChart();
                }, 100);

            } else if (currentReportTab === 'users') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">üë• Top Users by Net Flow</h3>
                        <div class="chart-container">
                            <div class="chart-title">Top 10 Users Net Flow Comparison</div>
                            <canvas id="topUsersChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>User Name</th>
                                    <th>Email</th>
                                    <th>Location</th>
                                    <th>Deposits</th>
                                    <th>Withdrawals</th>
                                    <th>Net Flow</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.users.map(user => `
                                    <tr>
                                        <td>${user.name}</td>
                                        <td>${user.email}</td>
                                        <td>${user.state} ${user.lga !== 'Unknown' ? '- ' + user.lga : ''}</td>
                                        <td style="color: var(--accent-green);">‚Ç¶${user.deposits.toLocaleString()}</td>
                                        <td style="color: #ff6b6b;">‚Ç¶${user.withdrawals.toLocaleString()}</td>
                                        <td style="color: ${user.netFlow >= 0 ? 'var(--accent-green)' : '#ff6b6b'};">‚Ç¶${user.netFlow.toLocaleString()}</td>
                                        <td>${user.txCount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                setTimeout(() => {
                    createTopUsersChart();
                }, 100);

            } else if (currentReportTab === 'geographic') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">üåç Transactions by Country</h3>
                        <div class="chart-container">
                            <div class="chart-title">Distribution by Country</div>
                            <canvas id="countryChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>Total Amount</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.geographic.byCountry.map(item => {
                    const percentage = ((item.amount / reportData.overview.totalDeposits) * 100).toFixed(2);
                    return `
                                        <tr>
                                            <td>${item.country}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">‚Ç¶${item.amount.toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üèõÔ∏è Transactions by State/Region</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">Top States - Bar Chart</div>
                                <div class="chart-container">
                                    <canvas id="stateChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">State Distribution</div>
                                <div class="chart-container">
                                    <canvas id="stateDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>State/Region</th>
                                    <th>Total Amount</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.geographic.byState.map(item => {
                    const percentage = ((item.amount / reportData.overview.totalDeposits) * 100).toFixed(2);
                    return `
                                        <tr>
                                            <td>${item.state}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">‚Ç¶${item.amount.toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üèòÔ∏è Transactions by Local Government Area (LGA)</h3>
                        <div class="chart-container">
                            <div class="chart-title">Top 15 LGAs</div>
                            <canvas id="lgaChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Local Government Area</th>
                                    <th>Total Amount</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.geographic.byLGA.map(item => {
                    const percentage = ((item.amount / reportData.overview.totalDeposits) * 100).toFixed(2);
                    return `
                                        <tr>
                                            <td>${item.lga}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">‚Ç¶${item.amount.toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                setTimeout(() => {
                    createCountryChart();
                    createStateChart();
                    createStateDistributionChart();
                    createLGAChart();
                }, 100);

            } else if (currentReportTab === 'devices') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">üì± Device Types Distribution</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">Device Type Pie Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="deviceTypeChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">Device Type Bar Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="deviceTypeBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Device Type</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byType.map(item => {
                    const total = reportData.devices.byType.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.type}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üåê Browser Distribution</h3>
                        <div class="chart-container">
                            <div class="chart-title">Users by Browser</div>
                            <canvas id="browserChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Browser</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byBrowser.map(item => {
                    const total = reportData.devices.byBrowser.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.browser}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üíª Operating System Distribution</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">OS Doughnut Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="osChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">OS Bar Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="osBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Operating System</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byOS.map(item => {
                    const total = reportData.devices.byOS.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.os}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">üñ•Ô∏è Screen Resolution Distribution</h3>
                        <div class="chart-container">
                            <div class="chart-title">Top 10 Screen Resolutions</div>
                            <canvas id="resolutionChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Screen Resolution</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byResolution.map(item => {
                    const total = reportData.devices.byResolution.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.resolution}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                setTimeout(() => {
                    createDeviceTypeChart();
                    createDeviceTypeBarChart();
                    createBrowserChart();
                    createOSChart();
                    createOSBarChart();
                    createResolutionChart();
                }, 100);
            }
        }

        // Chart creation functions
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#b8b8b8',
                        font: { family: "'Poppins', sans-serif", size: 12 }
                    }
                }
            },
            scales: {
                y: {
                    ticks: { color: '#b8b8b8' },
                    grid: { color: 'rgba(255, 215, 0, 0.1)' }
                },
                x: {
                    ticks: { color: '#b8b8b8' },
                    grid: { color: 'rgba(255, 215, 0, 0.1)' }
                }
            }
        };

        function createDepositWithdrawalChart() {
            const ctx = document.getElementById('depositWithdrawalChart');
            if (!ctx) return;

            if (charts.depositWithdrawal) charts.depositWithdrawal.destroy();

            charts.depositWithdrawal = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Deposits', 'Withdrawals'],
                    datasets: [{
                        data: [reportData.overview.depositsByType.deposits, reportData.overview.depositsByType.withdrawals],
                        backgroundColor: ['#00ff88', '#ff6b6b'],
                        borderColor: ['#00ff88', '#ff6b6b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => '‚Ç¶' + context.parsed.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createStatusBreakdownChart() {
            const ctx = document.getElementById('statusBreakdownChart');
            if (!ctx) return;

            if (charts.statusBreakdown) charts.statusBreakdown.destroy();

            const statuses = reportData.overview.statusBreakdown;
            charts.statusBreakdown = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Approved', 'Pending', 'Rejected'],
                    datasets: [{
                        data: [statuses.successful || 0, statuses.pending || 0, statuses.rejected || 0],
                        backgroundColor: ['#00ff88', '#ffd700', '#ff6b6b'],
                        borderColor: ['#00ff88', '#ffd700', '#ff6b6b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => '‚Ç¶' + (context.parsed || 0).toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createHourlyVolumeChart() {
            const ctx = document.getElementById('hourlyVolumeChart');
            if (!ctx) return;

            if (charts.hourlyVolume) charts.hourlyVolume.destroy();

            const hours = Object.keys(reportData.overview.hourlyTransactions).sort();
            const volumes = hours.map(h => reportData.overview.hourlyTransactions[h]);

            charts.hourlyVolume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Transactions',
                        data: volumes,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: '#ffd700',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createTopUsersChart() {
            const ctx = document.getElementById('topUsersChart');
            if (!ctx) return;

            if (charts.topUsers) charts.topUsers.destroy();

            const top10Users = reportData.users.slice(0, 10);
            const names = top10Users.map(u => u.name.substring(0, 15));
            const deposits = top10Users.map(u => u.deposits);
            const withdrawals = top10Users.map(u => u.withdrawals);

            charts.topUsers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [
                        {
                            label: 'Deposits',
                            data: deposits,
                            backgroundColor: 'rgba(0, 255, 136, 0.7)',
                            borderColor: '#00ff88',
                            borderWidth: 2
                        },
                        {
                            label: 'Withdrawals',
                            data: withdrawals,
                            backgroundColor: 'rgba(255, 107, 107, 0.7)',
                            borderColor: '#ff6b6b',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#b8b8b8' },
                            grid: { color: 'rgba(255, 215, 0, 0.1)' },
                            stacked: false
                        },
                        y: {
                            ticks: { color: '#b8b8b8' },
                            grid: { color: 'rgba(255, 215, 0, 0.1)' },
                            stacked: false
                        }
                    }
                }
            });
        }

        function createCountryChart() {
            const ctx = document.getElementById('countryChart');
            if (!ctx) return;

            if (charts.country) charts.country.destroy();

            const countries = reportData.geographic.byCountry.map(c => c.country);
            const amounts = reportData.geographic.byCountry.map(c => c.amount);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b', '#00d4ff', '#ff9f43'];

            charts.country = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: countries,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors.concat(['#8b5cf6', '#ec4899']),
                        borderColor: colors.concat(['#8b5cf6', '#ec4899']),
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => '‚Ç¶' + (context.parsed || 0).toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createStateChart() {
            const ctx = document.getElementById('stateChart');
            if (!ctx) return;

            if (charts.state) charts.state.destroy();

            const states = reportData.geographic.byState.slice(0, 10).map(s => s.state);
            const amounts = reportData.geographic.byState.slice(0, 10).map(s => s.amount);

            charts.state = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: states,
                    datasets: [{
                        label: 'Transaction Amount',
                        data: amounts,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createStateDistributionChart() {
            const ctx = document.getElementById('stateDistributionChart');
            if (!ctx) return;

            if (charts.stateDistribution) charts.stateDistribution.destroy();

            const states = reportData.geographic.byState.slice(0, 8).map(s => s.state);
            const amounts = reportData.geographic.byState.slice(0, 8).map(s => s.amount);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b', '#00d4ff', '#ff9f43', '#8b5cf6', '#ec4899', '#14b8a6'];

            charts.stateDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: states,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => '‚Ç¶' + (context.parsed || 0).toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createLGAChart() {
            const ctx = document.getElementById('lgaChart');
            if (!ctx) return;

            if (charts.lga) charts.lga.destroy();

            const lgas = reportData.geographic.byLGA.map(l => l.lga.substring(0, 20));
            const amounts = reportData.geographic.byLGA.map(l => l.amount);

            charts.lga = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lgas,
                    datasets: [{
                        label: 'Transaction Amount',
                        data: amounts,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: '#ffd700',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createDeviceTypeChart() {
            const ctx = document.getElementById('deviceTypeChart');
            if (!ctx) return;

            if (charts.deviceType) charts.deviceType.destroy();

            const types = reportData.devices.byType.map(d => d.type);
            const counts = reportData.devices.byType.map(d => d.count);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b'];

            charts.deviceType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: types,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => (context.parsed || 0) + ' users'
                            }
                        }
                    }
                }
            });
        }

        function createDeviceTypeBarChart() {
            const ctx = document.getElementById('deviceTypeBarChart');
            if (!ctx) return;

            if (charts.deviceTypeBar) charts.deviceTypeBar.destroy();

            const types = reportData.devices.byType.map(d => d.type);
            const counts = reportData.devices.byType.map(d => d.count);

            charts.deviceTypeBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: types,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createBrowserChart() {
            const ctx = document.getElementById('browserChart');
            if (!ctx) return;

            if (charts.browser) charts.browser.destroy();

            const browsers = reportData.devices.byBrowser.map(b => b.browser);
            const counts = reportData.devices.byBrowser.map(b => b.count);

            charts.browser = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: browsers,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: '#ffd700',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createOSChart() {
            const ctx = document.getElementById('osChart');
            if (!ctx) return;

            if (charts.os) charts.os.destroy();

            const oses = reportData.devices.byOS.map(o => o.os);
            const counts = reportData.devices.byOS.map(o => o.count);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b', '#00d4ff', '#ff9f43'];

            charts.os = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: oses,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => (context.parsed || 0) + ' users'
                            }
                        }
                    }
                }
            });
        }

        function createOSBarChart() {
            const ctx = document.getElementById('osBarChart');
            if (!ctx) return;

            if (charts.osBar) charts.osBar.destroy();

            const oses = reportData.devices.byOS.map(o => o.os);
            const counts = reportData.devices.byOS.map(o => o.count);

            charts.osBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: oses,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(0, 212, 255, 0.7)',
                        borderColor: '#00d4ff',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createResolutionChart() {
            const ctx = document.getElementById('resolutionChart');
            if (!ctx) return;

            if (charts.resolution) charts.resolution.destroy();

            const resolutions = reportData.devices.byResolution.map(r => r.resolution);
            const counts = reportData.devices.byResolution.map(r => r.count);

            charts.resolution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: resolutions,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(139, 92, 246, 0.7)',
                        borderColor: '#8b5cf6',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        // ===== TRANSACTIONS VIEW MODAL =====
        let allTransactions = [];
        let currentStatusFilter = 'all';
        let currentTypeFilter = 'all';
        let currentDayFilter = '7days';
        let currentSearchQuery = '';

        // Open transactions modal
        function openTransactionsModal() {
            document.querySelector('.transactions-modal-overlay').classList.add('active');
            currentStatusFilter = 'all';
            currentTypeFilter = 'all';
            currentDayFilter = '7days';
            currentSearchQuery = '';
            document.getElementById('txSearchInput').value = '';
            loadAllTransactions();
        }

        // Close transactions modal
        function closeTransactionsModal() {
            document.querySelector('.transactions-modal-overlay').classList.remove('active');
        }

        // ========== WATCH FEE MANAGEMENT FUNCTIONS ==========
        let currentWatchFeeMatch = null;
        let paidViewersData = [];

        function openWatchFeeModal(matchId) {
            if (!matchId) {
                showNotification('No match selected', 'error');
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const matchData = doc.data();

                    // Check if livestream is paid
                    if (!matchData.livestream || !matchData.livestream.isPaid) {
                        showNotification('This match does not have a paid livestream', 'error');
                        return;
                    }

                    currentWatchFeeMatch = { id: doc.id, ...matchData };

                    // Display match info
                    const matchInfo = document.getElementById('watchFeeMatchInfo');
                    matchInfo.style.display = 'block';
                    document.getElementById('watchFeeMatchName').textContent =
                        `${matchData.teamA?.name || 'Team A'} vs ${matchData.teamB?.name || 'Team B'}`;
                    document.getElementById('watchFeePrice').textContent =
                        `‚Ç¶${matchData.livestream.price?.toLocaleString() || 'N/A'}`;

                    // Load paid viewers
                    loadPaidViewersData(matchId);

                    // Open modal
                    document.getElementById('watchFeeModal').classList.add('active');
                    switchWatchFeeTab('stats');
                }
            }).catch(err => showNotification('Error loading match: ' + err.message, 'error'));
        }

        function closeWatchFeeModal() {
            document.getElementById('watchFeeModal').classList.remove('active');
            currentWatchFeeMatch = null;
            paidViewersData = [];
        }

        function switchWatchFeeTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.watch-fee-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.watch-fee-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        async function loadPaidViewersData(matchId) {
            try {
                paidViewersData = [];
                const usersSnapshot = await db.collection('users').get();

                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const purchases = userData.livestreamPurchases || [];

                    purchases.forEach(purchase => {
                        if (purchase.matchId === matchId) {
                            paidViewersData.push({
                                userId: userDoc.id,
                                name: userData.name || 'Unknown',
                                email: userData.email || 'N/A',
                                accessCode: purchase.accessCode || generateAccessCode(),
                                purchaseDate: purchase.purchaseDate || new Date().toISOString(),
                                watchTime: purchase.watchTime || 0,
                                status: purchase.status || 'active'
                            });
                        }
                    });
                });

                updateWatchFeeStatistics();
                displayPaidViewers();
            } catch (err) {
                showNotification('Error loading paid viewers: ' + err.message, 'error');
            }
        }

        function updateWatchFeeStatistics() {
            if (!currentWatchFeeMatch) return;

            const totalViewers = paidViewersData.length;
            const totalRevenue = totalViewers * (currentWatchFeeMatch.livestream?.price || 0);
            const avgWatchTime = totalViewers > 0
                ? Math.round(paidViewersData.reduce((sum, v) => sum + v.watchTime, 0) / totalViewers)
                : 0;

            document.getElementById('totalViewers').textContent = totalViewers.toString();
            document.getElementById('paidViewersCount').textContent = totalViewers.toString();
            document.getElementById('totalRevenue').textContent = `‚Ç¶${totalRevenue.toLocaleString()}`;
            document.getElementById('avgWatchTime').textContent = `${avgWatchTime}m`;
            document.getElementById('peakViewers').textContent = totalViewers.toString();

            // Calculate stream duration if match is live/finished
            const duration = currentWatchFeeMatch.timeElapsed || currentWatchFeeMatch.duration || 90;
            document.getElementById('streamDuration').textContent = `${duration}m`;
        }

        function displayPaidViewers() {
            const container = document.getElementById('paidViewersList');

            if (paidViewersData.length === 0) {
                container.innerHTML = '<div class="no-viewers-message">No paid viewers yet</div>';
                return;
            }

            container.innerHTML = paidViewersData.map(viewer => `
                <div class="viewer-item">
                    <div class="viewer-info">
                        <div class="viewer-name">${viewer.name}</div>
                        <div class="viewer-detail">${viewer.email}</div>
                    </div>
                    <div class="viewer-detail" style="text-align: left;">
                        <div style="color: var(--text-gray); font-size: 0.8em;">Purchased</div>
                        <div style="color: var(--text-white); font-weight: 600;">${new Date(viewer.purchaseDate).toLocaleDateString()}</div>
                    </div>
                    <div class="viewer-detail" style="text-align: left;">
                        <div style="color: var(--text-gray); font-size: 0.8em;">Watch Time</div>
                        <div style="color: var(--accent-green); font-weight: 600;">${viewer.watchTime}m</div>
                    </div>
                    <div class="viewer-actions">
                        <button class="copy-btn" onclick="copyToClipboard('${viewer.accessCode}')">üìã Code</button>
                        <button class="remove-viewer-btn" onclick="removeViewer('${viewer.userId}')">‚úï Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Access code copied to clipboard', 'success');
            }).catch(err => {
                showNotification('Failed to copy: ' + err.message, 'error');
            });
        }

        function removeViewer(userId) {
            if (confirm('Remove this viewer from the paid list?')) {
                paidViewersData = paidViewersData.filter(v => v.userId !== userId);
                displayPaidViewers();
                showNotification('Viewer removed', 'success');
            }
        }

        // Load all transactions from Firebase
        async function loadAllTransactions() {
            try {
                allTransactions = [];
                const usersSnapshot = await db.collection('users').get();

                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userId = userDoc.id;
                    const userEmail = userData.email || 'N/A';
                    const userName = userData.name || 'N/A';
                    const dlsAccount = userData.wallet?.dlsAccountNumber || 'N/A';
                    const userTransactions = userData.transactions || [];

                    userTransactions.forEach(tx => {
                        allTransactions.push({
                            ...tx,
                            userId: userId,
                            userEmail: userEmail,
                            userName: userName,
                            dlsAccount: dlsAccount
                        });
                    });
                });

                // Sort by date, newest first
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderTransactionsTable();
            } catch (error) {
                console.error('Error loading transactions:', error);
                alert('Error loading transactions: ' + error.message);
            }
        }

        // Filter transactions
        function filterTransactionsByDate(days) {
            currentDayFilter = days;
            renderTransactionsTable();
        }

        function filterTransactionsByStatus(status) {
            currentStatusFilter = status;
            renderTransactionsTable();
        }

        function filterTransactionsByType(type) {
            currentTypeFilter = type;
            renderTransactionsTable();
        }

        function searchTransactions(query) {
            currentSearchQuery = query.toLowerCase();
            renderTransactionsTable();
        }

        // Get filtered transactions
        function getFilteredTransactions() {
            let filtered = allTransactions;

            // Date filter
            if (currentDayFilter !== 'all') {
                const now = new Date();
                let filterDate;

                switch (currentDayFilter) {
                    case '1hr':
                        filterDate = new Date(now.getTime() - 60 * 60 * 1000);
                        break;
                    case '2hrs':
                        filterDate = new Date(now.getTime() - 2 * 60 * 60 * 1000);
                        break;
                    case '3days':
                        filterDate = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
                        break;
                    case '7days':
                        filterDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '30days':
                        filterDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                }

                filtered = filtered.filter(tx => new Date(tx.date) >= filterDate);
            }

            // Status filter
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(tx => {
                    // Handle 'failed' tab showing both 'failed' and 'rejected' statuses
                    if (currentStatusFilter === 'failed') {
                        return tx.status === 'failed' || tx.status === 'rejected';
                    }
                    return tx.status === currentStatusFilter;
                });
            }

            // Type filter
            if (currentTypeFilter !== 'all') {
                filtered = filtered.filter(tx => tx.type === currentTypeFilter);
            }

            // Search filter
            if (currentSearchQuery) {
                filtered = filtered.filter(tx =>
                    tx.userName.toLowerCase().includes(currentSearchQuery) ||
                    tx.userEmail.toLowerCase().includes(currentSearchQuery) ||
                    tx.dlsAccount.toLowerCase().includes(currentSearchQuery)
                );
            }

            return filtered;
        }

        // Render transactions table
        function renderTransactionsTable() {
            const filtered = getFilteredTransactions();
            const container = document.getElementById('transactionsListContainer');

            if (filtered.length === 0) {
                container.innerHTML = '<div class="tx-no-results">No transactions found</div>';
                return;
            }

            container.innerHTML = filtered.map(tx => {
                const date = new Date(tx.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const amountClass = tx.type === 'deposit' ? '' : 'red';
                const typeIcon = tx.type === 'deposit' ? 'üì•' : 'üì§';
                const statusIcon = tx.status === 'successful' ? '‚úÖ' : tx.status === 'pending' ? '‚è≥' : tx.status === 'rejected' ? '‚ùå' : '‚ùì';

                return `
                     <div class="tx-item">
                         <div class="tx-info-group">
                             <span class="tx-label">User</span>
                             <span class="tx-value">${tx.userName}</span>
                         </div>
                         <div class="tx-info-group">
                             <span class="tx-label">Email</span>
                             <span class="tx-value">${tx.userEmail}</span>
                         </div>
                         <div class="tx-info-group">
                             <span class="tx-label">DLS Account</span>
                             <span class="tx-value">${tx.dlsAccount}</span>
                         </div>
                         <div class="tx-info-group">
                             <span class="tx-label">${tx.type === 'deposit' ? 'Deposit' : 'Withdrawal'}</span>
                             <span class="tx-amount ${amountClass}">${typeIcon} ‚Ç¶${tx.amount.toLocaleString()}</span>
                         </div>
                         <div class="tx-info-group" style="text-align: right;">
                             <span class="tx-label">Status</span>
                             <span class="tx-status-badge ${tx.status}">${statusIcon} ${tx.status.toUpperCase()}</span>
                             <span class="tx-label" style="margin-top: 5px; font-size: 0.7em;">${dateStr}</span>
                         </div>
                     </div>
                 `;
            }).join('');
        }

        // ===== MATCH TABS FUNCTIONALITY =====

        let liveMatchData = {};
        let activeMatches = [];
        let finishedMatches = [];
        let upcomingMatches = [];

        // Switch between tabs in match creation modal
        function switchMatchTab(tab) {
            document.querySelectorAll('.match-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.match-tab').forEach(el => el.classList.remove('active'));

            if (tab === 'setMatch') {
                document.getElementById('setMatchContent').style.display = 'block';
            } else if (tab === 'liveMatch') {
                document.getElementById('liveMatchContent').style.display = 'block';
                loadLiveMatchesDropdown();
            } else if (tab === 'finishedMatch') {
                document.getElementById('finishedMatchContent').style.display = 'block';
                loadFinishedMatchesDropdown();
            } else if (tab === 'upcomingMatch') {
                document.getElementById('upcomingMatchContent').style.display = 'block';
                loadUpcomingMatchesDropdown();
            }

            event.target.classList.add('active');
        }

        // Load active matches for live match dropdown
        function loadLiveMatchesDropdown() {
            db.collection('matches').where('status', '==', 'live').get().then(snapshot => {
                const select = document.getElementById('liveMatchSelect');
                select.innerHTML = '<option value="">-- Select a match --</option>';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}`;
                    select.appendChild(option);
                });

                activeMatches = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }

        // Load a live match
        function loadLiveMatch(matchId) {
            loadLiveMatchWithData(matchId);

            // Show watch fee button if livestream is paid
            if (matchId) {
                db.collection('matches').doc(matchId).get().then(doc => {
                    if (doc.exists) {
                        const matchData = doc.data();
                        const watchFeeBtn = document.getElementById('watchFeeButton');
                        if (matchData.livestream && matchData.livestream.isPaid) {
                            watchFeeBtn.style.display = 'block';
                        } else {
                            watchFeeBtn.style.display = 'none';
                        }
                    }
                });
            } else {
                document.getElementById('watchFeeButton').style.display = 'none';
            }
        }

        // Update live score
        function updateLiveScore(team, change) {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const currentScore = liveMatchData.currentScore || { teamA: 0, teamB: 0 };
            currentScore[team] = Math.max(0, (currentScore[team] || 0) + change);

            // Update display
            document.getElementById('live' + (team === 'teamA' ? 'TeamA' : 'TeamB') + 'Score').textContent = currentScore[team];

            // Update Firebase
            db.collection('matches').doc(liveMatchData.id).update({
                currentScore: currentScore
            }).catch(err => showNotification('Error updating score: ' + err.message, 'error'));
        }

        // Update live stats
        function updateLiveStat(statType, team, value) {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const liveStats = liveMatchData.liveStats || {};
            if (!liveStats[statType]) liveStats[statType] = {};
            liveStats[statType][team] = parseFloat(value) || 0;

            db.collection('matches').doc(liveMatchData.id).update({
                liveStats: liveStats
            }).catch(err => showNotification('Error updating stats: ' + err.message, 'error'));
        }

        // Update live match minute
        function updateLiveMinute(minute) {
            if (!liveMatchData.id) return;
            db.collection('matches').doc(liveMatchData.id).update({
                timeElapsed: parseInt(minute)
            }).catch(err => showNotification('Error updating minute: ' + err.message, 'error'));
        }

        // Update live match status
        function updateLiveStatus(status) {
            if (!liveMatchData.id) return;
            db.collection('matches').doc(liveMatchData.id).update({
                status: status
            }).catch(err => showNotification('Error updating status: ' + err.message, 'error'));
        }

        // Finish live match and move to finished
        function finishLiveMatch() {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            // Collect all stats including cards
            const finalStats = liveMatchData.liveStats || {};
            finalStats.corners = finalStats.corners || { teamA: 0, teamB: 0 };
            finalStats.possession = finalStats.possession || { teamA: 50, teamB: 50 };
            finalStats.shots = finalStats.shots || { teamA: 0, teamB: 0 };
            finalStats.yellowCards = finalStats.yellowCards || { teamA: 0, teamB: 0 };
            finalStats.redCards = finalStats.redCards || { teamA: 0, teamB: 0 };

            db.collection('matches').doc(liveMatchData.id).update({
                status: 'finished',
                finishedAt: new Date().toISOString(),
                finalScore: liveMatchData.currentScore || { teamA: 0, teamB: 0 },
                finalStats: finalStats,
                goalScorers: currentLiveGoalScorers,
                events: matchEvents,
                substitutions: matchSubstitutions
            }).then(() => {
                showNotification('Match finished successfully!', 'success');
                loadLiveMatchesDropdown();
                document.getElementById('liveMatchSelect').value = '';
                document.getElementById('liveMatchContainer').style.display = 'none';
            }).catch(err => showNotification('Error finishing match: ' + err.message, 'error'));
        }

        // Load finished matches dropdown
        function loadFinishedMatchesDropdown() {
            db.collection('matches').where('status', '==', 'finished').get().then(snapshot => {
                const select = document.getElementById('finishedMatchSelect');
                select.innerHTML = '<option value="">-- Select a match --</option>';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}`;
                    select.appendChild(option);
                });

                finishedMatches = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }

        // Load finished match details
        function loadFinishedMatchDetails(matchId) {
            if (!matchId) {
                document.getElementById('finishedMatchContainer').style.display = 'none';
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const match = doc.data();
                    document.getElementById('finishedMatchContainer').style.display = 'block';

                    // Update header
                    document.getElementById('finishedTeamAName').textContent = match.teamA?.name || 'Team A';
                    document.getElementById('finishedTeamBName').textContent = match.teamB?.name || 'Team B';
                    const scoreA = match.finalScore?.teamA || 0;
                    const scoreB = match.finalScore?.teamB || 0;
                    document.getElementById('finishedScore').textContent = `${scoreA} - ${scoreB}`;
                    document.getElementById('finishedMatchDate').textContent = match.matchDate || '';

                    // Display stats
                    const statsHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Corners:</strong> ${match.finalStats?.corners?.teamA || 0} - ${match.finalStats?.corners?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Possession:</strong> ${match.finalStats?.possession?.teamA || 50}% - ${match.finalStats?.possession?.teamB || 50}%
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Shots:</strong> ${match.finalStats?.shots?.teamA || 0} - ${match.finalStats?.shots?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>üü® Yellow:</strong> ${match.finalStats?.yellowCards?.teamA || 0} - ${match.finalStats?.yellowCards?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>üü• Red:</strong> ${match.finalStats?.redCards?.teamA || 0} - ${match.finalStats?.redCards?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Status:</strong> FINISHED ‚úÖ
                            </div>
                        </div>
                    `;
                    document.getElementById('finishedStatsContainer').innerHTML = statsHtml;

                    // Display goal scorers (placeholder - add actual data structure)
                    document.getElementById('finishedGoalScorersContainer').innerHTML = '<p style="color: var(--text-gray);">Goal scorers data coming soon</p>';
                }
            });
        }

        // Download match report as PDF
        let editingUpcomingId = null;

        function downloadMatchReportPDF() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const match = doc.data();
                    generatePDF(match, matchId);
                }
            }).catch(err => showNotification('Error generating report: ' + err.message, 'error'));
        }

        function generatePDF(match, matchId) {
            showNotification('Generating PDF report...', 'loading');

            try {
                // Check if jsPDF is available
                if (!window.jspdf) {
                    throw new Error('jsPDF library not loaded. Please refresh the page.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPosition = 20;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);

                // ========== BACKGROUND ==========
                doc.setFillColor(10, 14, 39); // Dark blue #0a0e27
                doc.rect(0, 0, pageWidth, pageHeight, 'F');

                // ========== HEADER ==========
                doc.setFillColor(255, 215, 0); // Gold
                doc.rect(0, 0, pageWidth, 35, 'F');

                // Title
                doc.setTextColor(10, 14, 39); // Dark blue
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('DLS DRAFT LEAGUE', pageWidth / 2, 15, { align: 'center' });

                // Subtitle
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('MATCH REPORT', pageWidth / 2, 25, { align: 'center' });

                yPosition = 45;

                // ========== MATCH DETAILS ==========
                doc.setTextColor(255, 215, 0); // Gold
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('MATCH DETAILS', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                doc.setTextColor(255, 255, 255); // White
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');

                const matchDate = match.matchDate ? new Date(match.matchDate).toLocaleDateString() : 'N/A';
                doc.text(`Date: ${matchDate}`, margin, yPosition + 5);
                doc.text(`Time: ${match.matchTime || 'N/A'}`, margin, yPosition + 12);
                doc.text(`Status: FINISHED ‚úì`, margin, yPosition + 19);

                yPosition += 30;

                // ========== TEAMS ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('TEAMS', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                doc.setTextColor(255, 255, 255); // White
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');

                const teamAName = match.teamA?.name || 'Team A';
                const teamBName = match.teamB?.name || 'Team B';
                doc.text(`Team A: ${teamAName}`, margin, yPosition + 5);
                doc.text(`Team B: ${teamBName}`, margin, yPosition + 12);

                yPosition += 25;

                // ========== FINAL SCORE ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('FINAL SCORE', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                // Large score display - use finalScore or currentScore as fallback
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                const scoreA = match.finalScore?.teamA || match.currentScore?.teamA || 0;
                const scoreB = match.finalScore?.teamB || match.currentScore?.teamB || 0;
                const scoreText = `${scoreA} - ${scoreB}`;
                doc.text(scoreText, pageWidth / 2, yPosition + 12, { align: 'center' });

                doc.setTextColor(255, 255, 255); // White
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold'); // Bold
                doc.text(`${teamAName} vs ${teamBName}`, pageWidth / 2, yPosition + 22, { align: 'center' });

                yPosition += 35;

                // ========== FINAL STATISTICS ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('FINAL STATISTICS', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                // Stats table
                const statsTableData = [
                    ['Statistic', 'Team A', 'Team B'],
                    ['Corners', `${match.finalStats?.corners?.teamA || 0}`, `${match.finalStats?.corners?.teamB || 0}`],
                    ['Possession', `${match.finalStats?.possession?.teamA || 50}%`, `${match.finalStats?.possession?.teamB || 50}%`],
                    ['Shots', `${match.finalStats?.shots?.teamA || 0}`, `${match.finalStats?.shots?.teamB || 0}`],
                    ['Yellow Cards', `${match.finalStats?.yellowCards?.teamA || 0}`, `${match.finalStats?.yellowCards?.teamB || 0}`],
                    ['Red Cards', `${match.finalStats?.redCards?.teamA || 0}`, `${match.finalStats?.redCards?.teamB || 0}`]
                ];

                try {
                    if (doc.autoTable) {
                        doc.autoTable({
                            head: [statsTableData[0]],
                            body: statsTableData.slice(1),
                            startY: yPosition + 5,
                            margin: { left: margin, right: margin },
                            headStyles: {
                                fillColor: [255, 215, 0],
                                textColor: [10, 14, 39],
                                fontStyle: 'bold',
                                fontSize: 10
                            },
                            bodyStyles: {
                                textColor: [255, 255, 255], // White
                                fontSize: 10
                            },
                            alternateRowStyles: {
                                fillColor: [21, 25, 48]
                            },
                            columnStyles: {
                                0: { cellWidth: contentWidth * 0.5 },
                                1: { cellWidth: contentWidth * 0.25, halign: 'center' },
                                2: { cellWidth: contentWidth * 0.25, halign: 'center' }
                            }
                        });

                        yPosition = doc.lastAutoTable.finalY + 15;
                    } else {
                        console.warn('autoTable plugin not loaded, skipping table');
                        yPosition += 30;
                    }
                } catch (tableError) {
                    console.warn('Table generation error:', tableError);
                    yPosition += 30;
                }

                // ========== WATCH FEE & VIEWERS STATS ==========
                if (match.livestream && match.livestream.isPaid) {
                    yPosition += 5;
                    doc.setTextColor(255, 215, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('WATCH FEE & VIEWERS', margin, yPosition);
                    yPosition += 8;

                    doc.setDrawColor(255, 215, 0);
                    doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');

                    const watchPrice = match.livestream?.price || 0;
                    const watchViewers = match.livestreamViewers || 0;
                    const watchRevenue = watchViewers * watchPrice;

                    doc.text(`Fee: ‚Ç¶${watchPrice.toLocaleString()}`, margin, yPosition + 5);
                    doc.text(`Viewers: ${watchViewers}`, margin, yPosition + 12);
                    doc.text(`Revenue: ‚Ç¶${watchRevenue.toLocaleString()}`, margin, yPosition + 19);

                    yPosition += 30;
                }

                // ========== MAN OF THE MATCH ==========
                if (match.manOfMatch) {
                    doc.setTextColor(255, 215, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('‚≠ê MAN OF THE MATCH', margin, yPosition);
                    yPosition += 8;

                    doc.setDrawColor(255, 215, 0);
                    doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                    doc.setTextColor(255, 255, 255); // White
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');

                    const teamName = match.manOfMatch.team === 'teamA' ? match.teamA?.name : match.teamB?.name;
                    doc.text(`Player: ${match.manOfMatch.playerName}`, margin, yPosition + 5);
                    doc.text(`Team: ${teamName}`, margin, yPosition + 12);
                    doc.text(`Rating: ${match.manOfMatch.rating}/10`, margin, yPosition + 19);
                    if (match.manOfMatch.notes) {
                        doc.text(`Notes: ${match.manOfMatch.notes}`, margin, yPosition + 26);
                    }

                    yPosition += 35;
                }

                // ========== FOOTER ==========
                try {
                    // Handle both old and new jsPDF API
                    let pageCount = 1;
                    if (doc.internal.pages) {
                        pageCount = doc.internal.pages.length - 1; // -1 because pages array has null at index 0
                    } else if (doc.getPages) {
                        pageCount = doc.getPages().length;
                    }

                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);

                        // Bottom line
                        doc.setDrawColor(255, 215, 0);
                        doc.line(margin, pageHeight - 20, pageWidth - margin, pageHeight - 20);

                        // Footer text
                        doc.setTextColor(255, 255, 255); // White
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Generated: ${new Date().toLocaleString()}`, margin, pageHeight - 13);

                        // Powered by iSmart DC - Bold, Yellow, Center
                        doc.setTextColor(255, 215, 0); // Gold/Yellow
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.text('Powered by iSmart DC', pageWidth / 2, pageHeight - 13, { align: 'center' });
                    }
                } catch (footerError) {
                    console.warn('Footer generation skipped:', footerError);
                }

                // ========== SAVE PDF ==========
                const pdfTeamA = match.teamA?.name || 'TeamA';
                const pdfTeamB = match.teamB?.name || 'TeamB';
                const timestamp = new Date().getTime();
                const filename = `Match_Report_${pdfTeamA}_vs_${pdfTeamB}_${timestamp}.pdf`;

                doc.save(filename);

                showNotification('PDF report downloaded successfully!', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                console.error('Match data:', match);
                showNotification('Error generating PDF: ' + error.message, 'error');
            }
        }

        // Archive finished match
        function archiveFinishedMatch() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            if (confirm('Archive this match?')) {
                db.collection('matches').doc(matchId).update({
                    archived: true
                }).then(() => {
                    showNotification('Match archived successfully', 'success');
                    loadFinishedMatchesDropdown();
                    document.getElementById('finishedMatchSelect').value = '';
                    document.getElementById('finishedMatchContainer').style.display = 'none';
                }).catch(err => showNotification('Error archiving match: ' + err.message, 'error'));
            }
        }

        // Load upcoming matches dropdown
        function loadUpcomingMatchesDropdown() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            db.collection('matches').where('status', '==', 'upcoming').get().then(snapshot => {
                const select = document.getElementById('upcomingFilterFrom');

                upcomingMatches = snapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => new Date(a.matchDate) - new Date(b.matchDate));

                filterUpcomingMatches();
            });
        }

        // Filter upcoming matches
        function filterUpcomingMatches() {
            const fromDate = document.getElementById('upcomingFilterFrom').value;
            const toDate = document.getElementById('upcomingFilterTo').value;
            const searchTeam = document.getElementById('upcomingSearchTeam').value.toLowerCase();

            let filtered = upcomingMatches;

            if (fromDate) {
                filtered = filtered.filter(m => new Date(m.matchDate) >= new Date(fromDate));
            }
            if (toDate) {
                filtered = filtered.filter(m => new Date(m.matchDate) <= new Date(toDate));
            }
            if (searchTeam) {
                filtered = filtered.filter(m =>
                    (m.teamA?.name || '').toLowerCase().includes(searchTeam) ||
                    (m.teamB?.name || '').toLowerCase().includes(searchTeam)
                );
            }

            const container = document.getElementById('upcomingMatchesContainer');
            if (filtered.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-gray);">No matches found</div>';
                return;
            }

            container.innerHTML = filtered.map(match => `
                <div style="background: var(--card-bg); border: 1px solid rgba(255,215,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: var(--text-white);">${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}</div>
                            <div style="color: var(--text-gray); font-size: 0.9em; margin-top: 5px;">üìÖ ${match.matchDate} ${match.matchTime || ''}</div>
                            ${match.livestream?.isPaid ? `<div style="color: var(--accent-gold); font-size: 0.85em; margin-top: 5px;">üí≥ Paid Livestream: ‚Ç¶${match.livestream.price?.toLocaleString() || 'N/A'}</div>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 8px;">
                                <button class="add-btn" onclick="editUpcomingMatch('${match.id}')" style="padding: 8px 12px; background: rgba(255,215,0,0.2);">‚úèÔ∏è Edit</button>
                                <button class="add-btn" onclick="startUpcomingMatch('${match.id}')" style="padding: 8px 12px;">‚ñ∂Ô∏è Start</button>
                            </div>
                            ${match.livestream?.isPaid ? `<button class="watch-fee-btn" onclick="openWatchFeeModal('${match.id}')" style="padding: 8px 12px; font-size: 0.8em; margin-top: 0;">üí≥ Watch Fee</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Start upcoming match (move to live)
        function startUpcomingMatch(matchId) {
            if (confirm('Start this match now?')) {
                db.collection('matches').doc(matchId).update({
                    status: 'live',
                    startedAt: new Date().toISOString(),
                    currentScore: { teamA: 0, teamB: 0 },
                    timeElapsed: 0,
                    liveStats: {}
                }).then(() => {
                    showNotification('Match started!', 'success');
                    loadUpcomingMatchesDropdown();
                }).catch(err => showNotification('Error starting match: ' + err.message, 'error'));
            }
        }

        // Edit upcoming match
        function editUpcomingMatch(matchId) {
            const match = upcomingMatches.find(m => m.id === matchId);
            if (!match) {
                showNotification('Match not found', 'error');
                return;
            }

            editingUpcomingId = matchId;
            document.getElementById('upcomingMatchesContainer').style.display = 'none';
            document.getElementById('editUpcomingSection').style.display = 'block';

            // Populate form with existing data
            document.getElementById('editUpcomingDate').value = match.matchDate || '';
            document.getElementById('editUpcomingTime').value = match.matchTime || '';
            document.getElementById('editTeamAName').value = match.teamA?.name || '';
            document.getElementById('editTeamBName').value = match.teamB?.name || '';
            document.getElementById('editWinChanceA').value = match.winningChances?.teamA || 50;
            document.getElementById('editWinChanceB').value = match.winningChances?.teamB || 50;
        }

        // Save upcoming match edits
        function saveUpcomingMatchEdit() {
            if (!editingUpcomingId) {
                showNotification('No match selected', 'error');
                return;
            }

            const updates = {
                matchDate: document.getElementById('editUpcomingDate').value,
                matchTime: document.getElementById('editUpcomingTime').value,
                'teamA.name': document.getElementById('editTeamAName').value,
                'teamB.name': document.getElementById('editTeamBName').value,
                'winningChances.teamA': parseFloat(document.getElementById('editWinChanceA').value) || 50,
                'winningChances.teamB': parseFloat(document.getElementById('editWinChanceB').value) || 50
            };

            db.collection('matches').doc(editingUpcomingId).update(updates).then(() => {
                showNotification('Match updated successfully!', 'success');
                editingUpcomingId = null;
                cancelUpcomingMatchEdit();
                loadUpcomingMatchesDropdown();
            }).catch(err => showNotification('Error updating match: ' + err.message, 'error'));
        }

        // Cancel upcoming match edit
        function cancelUpcomingMatchEdit() {
            editingUpcomingId = null;
            document.getElementById('editUpcomingSection').style.display = 'none';
            document.getElementById('upcomingMatchesContainer').style.display = 'block';
        }

        // Save Man of the Match
        function saveManOfMatch() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const playerName = document.getElementById('manOfMatchName').value.trim();
            const team = document.getElementById('manOfMatchTeam').value;
            const rating = parseFloat(document.getElementById('manOfMatchRating').value);
            const notes = document.getElementById('manOfMatchNotes').value.trim();

            if (!playerName || !team || !rating) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (rating < 1 || rating > 10) {
                showNotification('Rating must be between 1 and 10', 'error');
                return;
            }

            db.collection('matches').doc(matchId).update({
                manOfMatch: {
                    playerName: playerName,
                    team: team,
                    rating: rating,
                    notes: notes
                }
            }).then(() => {
                showNotification('Man of the Match saved!', 'success');
                displayManOfMatch(playerName, team, rating, notes);
            }).catch(err => showNotification('Error saving: ' + err.message, 'error'));
        }

        // Display Man of the Match
        function displayManOfMatch(playerName, team, rating, notes) {
            const teamName = team === 'teamA' ?
                (document.getElementById('finishedTeamAName').textContent) :
                (document.getElementById('finishedTeamBName').textContent);

            const display = `
                <div style="background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.4); border-radius: 10px; padding: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2em;">‚≠ê</div>
                        <div>
                            <div style="font-size: 1.1em; font-weight: bold; color: var(--accent-gold);">${playerName}</div>
                            <div style="color: var(--text-gray); font-size: 0.9em;">Team: ${teamName}</div>
                            <div style="color: var(--accent-gold); font-weight: 600;">Rating: ${rating}/10</div>
                            ${notes ? `<div style="color: var(--text-gray); font-size: 0.85em; margin-top: 5px;">üìù ${notes}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('manOfMatchDisplay').innerHTML = display;
        }

        // Load finished match and display Man of the Match
        function loadFinishedMatchDetailsWithManOfMatch(matchId) {
            loadFinishedMatchDetails(matchId);

            if (matchId) {
                db.collection('matches').doc(matchId).get().then(doc => {
                    if (doc.exists && doc.data().manOfMatch) {
                        const mom = doc.data().manOfMatch;
                        document.getElementById('manOfMatchName').value = mom.playerName || '';
                        document.getElementById('manOfMatchTeam').value = mom.team || '';
                        document.getElementById('manOfMatchRating').value = mom.rating || '';
                        document.getElementById('manOfMatchNotes').value = mom.notes || '';
                        displayManOfMatch(mom.playerName, mom.team, mom.rating, mom.notes);
                    }
                    // Load goal scorers
                    if (doc.exists && doc.data().goalScorers) {
                        displayFinishedGoalScorers(doc.data().goalScorers);
                    }
                    // Show/hide watch fee button for paid livestreams
                    const watchFeeBtn = document.getElementById('finishedWatchFeeButton');
                    const matchData = doc.data();
                    if (matchData.livestream && matchData.livestream.isPaid) {
                        watchFeeBtn.style.display = 'block';
                    } else {
                        watchFeeBtn.style.display = 'none';
                    }
                });
            } else {
                document.getElementById('finishedWatchFeeButton').style.display = 'none';
            }
        }

        // ===== GOAL SCORERS FUNCTIONALITY =====
        let currentLiveGoalScorers = [];
        let currentFinishedGoalScorers = [];

        // Add goal scorer to finished match
        function addGoalScorer() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const name = document.getElementById('goalScorerName').value.trim();
            const team = document.getElementById('goalScorerTeam').value;
            const minute = parseInt(document.getElementById('goalScorerMinute').value);

            if (!name || !team || !minute && minute !== 0) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const goalScorer = {
                playerName: name,
                team: team,
                minute: minute,
                id: Date.now()
            };

            currentFinishedGoalScorers.push(goalScorer);
            displayFinishedGoalScorers(currentFinishedGoalScorers);

            // Save to Firebase
            db.collection('matches').doc(matchId).update({
                goalScorers: currentFinishedGoalScorers
            }).catch(err => showNotification('Error saving goal scorer: ' + err.message, 'error'));

            // Clear inputs
            document.getElementById('goalScorerName').value = '';
            document.getElementById('goalScorerTeam').value = '';
            document.getElementById('goalScorerMinute').value = '';
        }

        // Display finished match goal scorers
        function displayFinishedGoalScorers(scorers) {
            const container = document.getElementById('goalScorersList');
            if (!scorers || scorers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No goal scorers added yet</p>';
                return;
            }

            const sortedScorers = [...scorers].sort((a, b) => a.minute - b.minute);
            container.innerHTML = sortedScorers.map(scorer => `
                 <div class="goal-list-item">
                     <div>
                         <strong>${scorer.playerName}</strong>
                         <div style="font-size: 0.8em; color: var(--text-gray);">
                             ${scorer.team === 'teamA' ? document.getElementById('goalTeamAOption')?.textContent || 'Team A' : document.getElementById('goalTeamBOption')?.textContent || 'Team B'} | ${scorer.minute}'
                         </div>
                     </div>
                     <button class="remove-btn" onclick="removeGoalScorer(${scorer.id})">Delete</button>
                 </div>
             `).join('');
        }

        // Remove goal scorer
        function removeGoalScorer(id) {
            currentFinishedGoalScorers = currentFinishedGoalScorers.filter(g => g.id !== id);
            displayFinishedGoalScorers(currentFinishedGoalScorers);
        }

        // Add live goal scorer
        function addLiveGoalScorer() {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const name = document.getElementById('liveGoalScorerName').value.trim();
            const team = document.getElementById('liveGoalScorerTeam').value;
            const minute = parseInt(document.getElementById('liveGoalScorerMinute').value);

            if (!name || !team || !minute && minute !== 0) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const goalScorer = {
                playerName: name,
                team: team,
                minute: minute,
                id: Date.now()
            };

            currentLiveGoalScorers.push(goalScorer);
            addEventToTimeline(`‚öΩ Goal: ${name} (${minute}')`, 'goal');
            displayLiveGoalScorers();

            // Save to Firebase
            db.collection('matches').doc(liveMatchData.id).update({
                goalScorers: firebase.firestore.FieldValue.arrayUnion(goalScorer)
            }).catch(err => showNotification('Error saving goal: ' + err.message, 'error'));

            // Clear inputs
            document.getElementById('liveGoalScorerName').value = '';
            document.getElementById('liveGoalScorerTeam').value = '';
            document.getElementById('liveGoalScorerMinute').value = '';
        }

        // Display live goal scorers
        function displayLiveGoalScorers() {
            const container = document.getElementById('liveGoalScorersList');
            if (!currentLiveGoalScorers || currentLiveGoalScorers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No goals scored yet</p>';
                return;
            }

            const sortedScorers = [...currentLiveGoalScorers].sort((a, b) => a.minute - b.minute);
            container.innerHTML = sortedScorers.map(scorer => `
                 <div class="goal-list-item">
                     <div>
                         <strong>‚öΩ ${scorer.playerName}</strong>
                         <div style="font-size: 0.8em; color: var(--text-gray);">
                             ${scorer.team === 'teamA' ? 'Team A' : 'Team B'} | ${scorer.minute}'
                         </div>
                     </div>
                     <button class="remove-btn" onclick="removeLiveGoalScorer(${scorer.id})">Delete</button>
                 </div>
             `).join('');
        }

        // Remove live goal scorer
        function removeLiveGoalScorer(id) {
            currentLiveGoalScorers = currentLiveGoalScorers.filter(g => g.id !== id);
            displayLiveGoalScorers();
        }

        // ===== MATCH EVENTS TIMELINE =====
        let matchEvents = [];

        function addEventToTimeline(eventText, eventType) {
            const minute = parseInt(document.getElementById('liveMinute').value) || 0;
            const event = {
                text: eventText,
                type: eventType,
                minute: minute,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                id: Date.now()
            };

            matchEvents.push(event);
            displayTimeline();

            // Save to Firebase
            if (liveMatchData.id) {
                db.collection('matches').doc(liveMatchData.id).update({
                    events: firebase.firestore.FieldValue.arrayUnion(event)
                }).catch(err => console.error('Error saving event:', err));
            }
        }

        function displayTimeline() {
            const container = document.getElementById('liveEventsTimeline');
            if (!matchEvents || matchEvents.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; margin: 0;">No events recorded yet</p>';
                return;
            }

            const eventIcons = {
                goal: '‚öΩ',
                yellowCard: 'üü®',
                redCard: 'üü•',
                substitution: 'üîÑ',
                default: 'üìå'
            };

            container.innerHTML = matchEvents.map(event => `
                 <div class="timeline-event">
                     <div class="event-icon">${eventIcons[event.type] || eventIcons.default}</div>
                     <div class="event-details">
                         <div style="font-weight: 600; color: var(--text-white);">${event.text}</div>
                         <div class="event-time">${event.minute}' | ${event.timestamp}</div>
                     </div>
                 </div>
             `).join('');
        }

        // ===== PLAYER SUBSTITUTIONS =====
        let matchSubstitutions = [];

        function addSubstitution() {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const playerOut = document.getElementById('playerOut').value.trim();
            const playerIn = document.getElementById('playerIn').value.trim();
            const team = document.getElementById('substitutionTeam').value;
            const minute = parseInt(document.getElementById('substitutionMinute').value);

            if (!playerOut || !playerIn || !team || !minute && minute !== 0) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const substitution = {
                playerOut: playerOut,
                playerIn: playerIn,
                team: team,
                minute: minute,
                id: Date.now()
            };

            matchSubstitutions.push(substitution);
            addEventToTimeline(`üîÑ Sub: ${playerOut} ‚Üí ${playerIn} (${minute}')`, 'substitution');
            displaySubstitutions();

            // Save to Firebase
            db.collection('matches').doc(liveMatchData.id).update({
                substitutions: firebase.firestore.FieldValue.arrayUnion(substitution)
            }).catch(err => showNotification('Error saving substitution: ' + err.message, 'error'));

            // Clear inputs
            document.getElementById('playerOut').value = '';
            document.getElementById('playerIn').value = '';
            document.getElementById('substitutionTeam').value = '';
            document.getElementById('substitutionMinute').value = '';
        }

        function displaySubstitutions() {
            const container = document.getElementById('substitutionsList');
            if (!matchSubstitutions || matchSubstitutions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em; text-align: center;">No substitutions yet</p>';
                return;
            }

            const sortedSubs = [...matchSubstitutions].sort((a, b) => a.minute - b.minute);
            container.innerHTML = `
                 <div class="substitutions-list">
                     ${sortedSubs.map(sub => `
                         <div class="substitution-item">
                             <div style="font-weight: 600; color: var(--text-white); margin-bottom: 8px;">
                                 ${sub.team === 'teamA' ? 'Team A' : 'Team B'} | ${sub.minute}'
                             </div>
                             <div class="player-in-out">
                                 <div style="text-align: right;">
                                     <div style="font-size: 0.9em; color: var(--text-white);">${sub.playerOut}</div>
                                     <span class="player-label">OUT</span>
                                 </div>
                                 <div style="text-align: center; color: var(--text-gray);">‚áÑ</div>
                                 <div>
                                     <div style="font-size: 0.9em; color: var(--text-white);">${sub.playerIn}</div>
                                     <span class="player-label in">IN</span>
                                 </div>
                             </div>
                             <button class="remove-btn" onclick="removeSubstitution(${sub.id})" style="margin-top: 8px; width: 100%;">Delete</button>
                         </div>
                     `).join('')}
                 </div>
             `;
        }

        function removeSubstitution(id) {
            matchSubstitutions = matchSubstitutions.filter(s => s.id !== id);
            displaySubstitutions();
        }

        // Load live match with all data
        function loadLiveMatchWithData(matchId) {
            if (!matchId) {
                document.getElementById('liveMatchContainer').style.display = 'none';
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    liveMatchData = { id: doc.id, ...data };

                    document.getElementById('liveMatchContainer').style.display = 'block';

                    // Populate basic info
                    document.getElementById('liveTeamAName').textContent = liveMatchData.teamA?.name || 'Team A';
                    document.getElementById('liveTeamBName').textContent = liveMatchData.teamB?.name || 'Team B';
                    document.getElementById('liveTeamAScore').textContent = liveMatchData.currentScore?.teamA || 0;
                    document.getElementById('liveTeamBScore').textContent = liveMatchData.currentScore?.teamB || 0;

                    // Populate stats
                    document.getElementById('liveCornerA').value = liveMatchData.liveStats?.corners?.teamA || 0;
                    document.getElementById('liveCornerB').value = liveMatchData.liveStats?.corners?.teamB || 0;
                    document.getElementById('livePossessionA').value = liveMatchData.liveStats?.possession?.teamA || 50;
                    document.getElementById('livePossessionB').value = liveMatchData.liveStats?.possession?.teamB || 50;
                    document.getElementById('liveShotsA').value = liveMatchData.liveStats?.shots?.teamA || 0;
                    document.getElementById('liveShotsB').value = liveMatchData.liveStats?.shots?.teamB || 0;
                    document.getElementById('liveYellowA').value = liveMatchData.liveStats?.yellowCards?.teamA || 0;
                    document.getElementById('liveYellowB').value = liveMatchData.liveStats?.yellowCards?.teamB || 0;
                    document.getElementById('liveRedA').value = liveMatchData.liveStats?.redCards?.teamA || 0;
                    document.getElementById('liveRedB').value = liveMatchData.liveStats?.redCards?.teamB || 0;

                    // Load goal scorers
                    currentLiveGoalScorers = data.goalScorers || [];
                    displayLiveGoalScorers();

                    // Load events
                    matchEvents = data.events || [];
                    displayTimeline();

                    // Load substitutions
                    matchSubstitutions = data.substitutions || [];
                    displaySubstitutions();

                    // Populate match control
                    document.getElementById('liveMinute').value = liveMatchData.timeElapsed || '0';
                    document.getElementById('liveStatus').value = liveMatchData.status || 'live';
                }
            });
        }
    </script>

    <!-- MATCH CREATION POPUP -->
    <div class="creation-popup-overlay" id="creationPopupOverlay">
        <div class="creation-popup">
            <div class="creation-popup-title">üéÆ Create Match</div>

            <div class="creation-options">
                <button class="creation-option-btn" onclick="selectSingleMatch()">
                    ‚öΩ Single Match
                </button>
                <button class="creation-option-btn" onclick="selectTournament()">
                    üèÜ Tournament
                </button>
            </div>

            <button class="creation-close-btn" onclick="closeCreationPopup()">Close</button>
        </div>
    </div>

    <!-- MATCH CREATION MODAL -->
    <div class="match-creation-overlay" id="matchCreationOverlay">
        <div class="match-creation-modal">
            <div class="match-creation-header">
                <h2 class="match-creation-title">‚öΩ Create Single Match</h2>
                <span class="match-creation-close" onclick="closeMatchCreationModal()">√ó</span>
            </div>

            <div class="match-tabs">
                <button class="match-tab active" onclick="switchMatchTab('setMatch')">1Ô∏è‚É£ Set Match</button>
                <button class="match-tab" onclick="switchMatchTab('liveMatch')">2Ô∏è‚É£ Live Match</button>
                <button class="match-tab" onclick="switchMatchTab('finishedMatch')">3Ô∏è‚É£ Finished Match</button>
                <button class="match-tab" onclick="switchMatchTab('upcomingMatch')">4Ô∏è‚É£ Upcoming Match</button>
            </div>

            <div class="match-form-container">
                <!-- TAB 1: SET MATCH -->
                <div id="setMatchContent" class="match-tab-content">
                    <!-- TEAMS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">‚öΩ Teams</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A Name</label>
                                <input type="text" class="form-input" placeholder="Enter team name"
                                    onchange="matchCreationData.teamA.name = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team A Logo (URL or File)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-input" style="flex: 1;" placeholder="Enter logo URL"
                                        onchange="matchCreationData.teamA.logo = this.value">
                                    <input type="file" id="teamALogoFile" accept="image/*" class="form-input"
                                        style="flex: 1;" onchange="handleLogoUpload('teamA', this)">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team B Name</label>
                                <input type="text" class="form-input" placeholder="Enter team name"
                                    onchange="matchCreationData.teamB.name = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B Logo (URL or File)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-input" style="flex: 1;" placeholder="Enter logo URL"
                                        onchange="matchCreationData.teamB.logo = this.value">
                                    <input type="file" id="teamBLogoFile" accept="image/*" class="form-input"
                                        style="flex: 1;" onchange="handleLogoUpload('teamB', this)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MANAGEMENT SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üë• Management</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A - DLS Player</label>
                                <input type="text" class="form-input" placeholder="Enter DLS player name"
                                    onchange="matchCreationData.teamA.dlsPlayer = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team A - Club Owner</label>
                                <input type="text" class="form-input" placeholder="Enter club owner"
                                    onchange="matchCreationData.teamA.clubOwner = this.value">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team B - DLS Player</label>
                                <input type="text" class="form-input" placeholder="Enter DLS player name"
                                    onchange="matchCreationData.teamB.dlsPlayer = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B - Club Owner</label>
                                <input type="text" class="form-input" placeholder="Enter club owner"
                                    onchange="matchCreationData.teamB.clubOwner = this.value">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A Captain</label>
                                <input type="text" class="form-input" placeholder="Captain name"
                                    onchange="matchCreationData.teamA.captain = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B Captain</label>
                                <input type="text" class="form-input" placeholder="Captain name"
                                    onchange="matchCreationData.teamB.captain = this.value">
                            </div>
                        </div>
                    </div>

                    <!-- PLAYERS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üë®‚Äçü¶≤ Players (Max 17 per team)</h3>
                        <div class="players-section">
                            <div>
                                <h4 style="color: var(--accent-gold); margin-bottom: 10px;">Team A - <span
                                        id="teamAPlayerCount">0/17</span></h4>
                                <div class="form-row">
                                    <input type="text" id="teamAPlayerName" class="form-input"
                                        placeholder="Player name">
                                    <input type="number" id="teamAPlayerNumber" class="form-input"
                                        placeholder="Jersey #" min="1" max="99">
                                </div>
                                <div class="form-row">
                                    <select id="teamAPlayerRole" class="form-input" style="width: 100%;">
                                        <option value="">Select Player Role</option>
                                        <option value="Goalkeeper">ü•Ö Goalkeeper</option>
                                        <option value="Defender">üõ°Ô∏è Defender</option>
                                        <option value="Midfielder">üéØ Midfielder</option>
                                        <option value="Forward">‚ö° Forward</option>
                                        <option value="Striker">‚öΩ Striker</option>
                                    </select>
                                </div>
                                <button class="add-btn" onclick="addPlayerToTeam('teamA')" style="width: 100%;">+ Add
                                    Player</button>
                                <div class="player-list" id="teamAPlayerList"></div>
                            </div>
                            <div>
                                <h4 style="color: var(--accent-gold); margin-bottom: 10px;">Team B - <span
                                        id="teamBPlayerCount">0/17</span></h4>
                                <div class="form-row">
                                    <input type="text" id="teamBPlayerName" class="form-input"
                                        placeholder="Player name">
                                    <input type="number" id="teamBPlayerNumber" class="form-input"
                                        placeholder="Jersey #" min="1" max="99">
                                </div>
                                <div class="form-row">
                                    <select id="teamBPlayerRole" class="form-input" style="width: 100%;">
                                        <option value="">Select Player Role</option>
                                        <option value="Goalkeeper">ü•Ö Goalkeeper</option>
                                        <option value="Defender">üõ°Ô∏è Defender</option>
                                        <option value="Midfielder">üéØ Midfielder</option>
                                        <option value="Forward">‚ö° Forward</option>
                                        <option value="Striker">‚öΩ Striker</option>
                                    </select>
                                </div>
                                <button class="add-btn" onclick="addPlayerToTeam('teamB')" style="width: 100%;">+ Add
                                    Player</button>
                                <div class="player-list" id="teamBPlayerList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- SPONSORS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üè¢ Sponsors</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Sponsor Name</label>
                                <input type="text" id="sponsorName" class="form-input" placeholder="Sponsor name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sponsor Logo (URL or File)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="sponsorLogo" class="form-input" style="flex: 1;"
                                        placeholder="Enter logo URL">
                                    <input type="file" id="sponsorLogoFile" accept="image/*" class="form-input"
                                        style="flex: 1;" placeholder="Or upload file">
                                </div>
                            </div>
                        </div>
                        <button class="add-btn" onclick="addSponsor()">+ Add Sponsor</button>
                        <div style="margin-top: 15px;">
                            <p style="color: var(--text-gray); font-size: 0.9em;">Added Sponsors: <span
                                    id="sponsorCount">0</span></p>
                            <div class="player-list" id="sponsorsList"></div>
                        </div>
                    </div>

                    <!-- STATS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üìä Match Stats to Display</h3>
                        <div
                            style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="margin: 0; font-size: 0.85em; color: var(--accent-green);">‚úì Score - Required
                                (always shown)</p>
                        </div>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="statCorners" onchange="updateStats()">
                                <label for="statCorners">Corners</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statPossession" onchange="updateStats()">
                                <label for="statPossession">Possession</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statPasses" onchange="updateStats()">
                                <label for="statPasses">Passes</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statShotOnTarget" onchange="updateStats()">
                                <label for="statShotOnTarget">Shot on Target</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statShots" onchange="updateStats()">
                                <label for="statShots">Shots</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statShotsOffTarget" onchange="updateStats()">
                                <label for="statShotsOffTarget">Shots Off Target</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statBookings" onchange="updateStats()">
                                <label for="statBookings">Bookings</label>
                            </div>
                        </div>
                    </div>

                    <!-- PREDICTIONS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üéØ Predictions (Optional)</h3>
                        <div class="checkbox-item" style="margin-bottom: 15px;">
                            <input type="checkbox" id="predictionsEnabled" onchange="updatePredictions()">
                            <label for="predictionsEnabled">Enable Predictions</label>
                        </div>
                        <div id="predictionsOptions" style="display: none;">
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="predictScore">
                                    <label for="predictScore">Predict Score</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="predictTeamToScore">
                                    <label for="predictTeamToScore">Team to Score</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="predictNumberOfGoals">
                                    <label for="predictNumberOfGoals">Number of Goals Only</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WINNING CHANCES SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üèÜ Winning Chances (Optional)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A Winning Chance (%)</label>
                                <input type="number" class="form-input" min="0" max="100" placeholder="0-100"
                                    onchange="matchCreationData.winningChances.teamA = parseFloat(this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B Winning Chance (%)</label>
                                <input type="number" class="form-input" min="0" max="100" placeholder="0-100"
                                    onchange="matchCreationData.winningChances.teamB = parseFloat(this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- DATE & TIME SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üìÖ Match Date & Time</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Match Date</label>
                                <input type="date" class="form-input"
                                    onchange="matchCreationData.matchDate = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Match Time</label>
                                <input type="time" class="form-input"
                                    onchange="matchCreationData.matchTime = this.value">
                            </div>
                        </div>
                    </div>

                    <!-- LIVESTREAM SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">üìπ Livestream</h3>
                        <div class="checkbox-item" style="margin-bottom: 15px;">
                            <input type="checkbox" id="livestreamEnabled" onchange="updateLivestream()">
                            <label for="livestreamEnabled">Enable Livestream</label>
                        </div>
                        <div id="livestreamOptions" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="radio" name="livestreamType" value="free" checked
                                            onchange="matchCreationData.livestream.isPaid = false; document.getElementById('livestreamPrice').disabled = true;">
                                        Free Livestream
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="radio" name="livestreamType" value="paid"
                                            onchange="matchCreationData.livestream.isPaid = true; document.getElementById('livestreamPrice').disabled = false;">
                                        Paid Livestream
                                    </label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Price (‚Ç¶) - Only for Paid</label>
                                    <input type="number" id="livestreamPrice" class="form-input" min="0"
                                        placeholder="Enter price in Naira"
                                        onchange="matchCreationData.livestream.price = parseFloat(this.value) || 0;"
                                        disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SUBMIT BUTTON -->
                    <div style="display: flex; gap: 10px; width: 100%; margin-top: 20px;">
                        <button class="submit-btn" id="submitBtn" onclick="submitMatchCreation()" style="flex: 1;">‚úÖ
                            Create Match</button>
                        <button class="submit-btn"
                            style="flex: 0.3; background: rgba(255,107,107,0.2); border-color: rgba(255,107,107,0.4); color: #ff6b6b;"
                            onclick="cancelEdit()">Cancel</button>
                    </div>
                </div>

                <!-- TAB 2: LIVE MATCH -->
                <div id="liveMatchContent" class="match-tab-content" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">üìπ Select Active Match</h3>
                        <div class="form-row">
                            <select id="liveMatchSelect" class="form-input" style="width: 100%;"
                                onchange="loadLiveMatch(this.value)">
                                <option value="">-- Select a match to manage --</option>
                            </select>
                        </div>
                        <button class="watch-fee-btn" id="watchFeeButton" style="display: none;"
                            onclick="openWatchFeeModal(document.getElementById('liveMatchSelect').value)">üí≥ Watch Fee
                            Management</button>
                    </div>

                    <div id="liveMatchContainer" style="display: none;">
                        <!-- Live Score Update -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">‚öΩ Live Score Update</h3>
                            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 3em; font-weight: bold; color: var(--accent-gold);"
                                        id="liveTeamAScore">0</div>
                                    <div style="color: var(--text-gray); margin-top: 5px;" id="liveTeamAName">Team A
                                    </div>
                                </div>
                                <div style="font-size: 2em; color: var(--text-gray);">vs</div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 3em; font-weight: bold; color: var(--accent-gold);"
                                        id="liveTeamBScore">0</div>
                                    <div style="color: var(--text-gray); margin-top: 5px;" id="liveTeamBName">Team B
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <button class="add-btn" onclick="updateLiveScore('teamA', 1)" style="flex: 1;">Team A
                                    +1</button>
                                <button class="add-btn" onclick="updateLiveScore('teamB', 1)" style="flex: 1;">Team B
                                    +1</button>
                            </div>
                            <div class="form-row">
                                <button class="add-btn" onclick="updateLiveScore('teamA', -1)"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">Team A -1</button>
                                <button class="add-btn" onclick="updateLiveScore('teamB', -1)"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">Team B -1</button>
                            </div>
                        </div>

                        <!-- Real-time Stats -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">üìä Real-time Stats</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Corners</label>
                                    <input type="number" class="form-input" id="liveCornerA" min="0"
                                        onchange="updateLiveStat('corners', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Corners</label>
                                    <input type="number" class="form-input" id="liveCornerB" min="0"
                                        onchange="updateLiveStat('corners', 'teamB', this.value)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Possession (%)</label>
                                    <input type="number" class="form-input" id="livePossessionA" min="0" max="100"
                                        onchange="updateLiveStat('possession', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Possession (%)</label>
                                    <input type="number" class="form-input" id="livePossessionB" min="0" max="100"
                                        onchange="updateLiveStat('possession', 'teamB', this.value)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Shots</label>
                                    <input type="number" class="form-input" id="liveShotsA" min="0"
                                        onchange="updateLiveStat('shots', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Shots</label>
                                    <input type="number" class="form-input" id="liveShotsB" min="0"
                                        onchange="updateLiveStat('shots', 'teamB', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Cards & Bookings -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">üü® Cards & Bookings</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Yellow Cards</label>
                                    <input type="number" class="form-input" id="liveYellowA" min="0"
                                        onchange="updateLiveStat('yellowCards', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Yellow Cards</label>
                                    <input type="number" class="form-input" id="liveYellowB" min="0"
                                        onchange="updateLiveStat('yellowCards', 'teamB', this.value)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Red Cards</label>
                                    <input type="number" class="form-input" id="liveRedA" min="0"
                                        onchange="updateLiveStat('redCards', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Red Cards</label>
                                    <input type="number" class="form-input" id="liveRedB" min="0"
                                        onchange="updateLiveStat('redCards', 'teamB', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Goal Scorers Live -->
                        <div class="match-form-section goal-scorers-section">
                            <h3 class="match-form-title">‚öΩ Goal Scorers (Live)</h3>
                            <div class="goal-input-row">
                                <div class="form-group">
                                    <label class="form-label">Player Name</label>
                                    <input type="text" id="liveGoalScorerName" class="form-input"
                                        placeholder="Player name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="liveGoalScorerTeam" class="form-input">
                                        <option value="">Select team</option>
                                        <option value="teamA">Team A</option>
                                        <option value="teamB">Team B</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minute</label>
                                    <input type="number" id="liveGoalScorerMinute" class="form-input" placeholder="45"
                                        min="0" max="120">
                                </div>
                                <button class="add-btn" onclick="addLiveGoalScorer()"
                                    style="height: 40px; align-self: flex-end;">Add Goal</button>
                            </div>
                            <div id="liveGoalScorersList" style="margin-top: 10px;"></div>
                        </div>

                        <!-- Match Events Timeline -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">üìä Match Events Timeline</h3>
                            <div id="liveEventsTimeline" class="events-timeline">
                                <p style="color: var(--text-gray); text-align: center; margin: 0;">No events recorded
                                    yet</p>
                            </div>
                        </div>

                        <!-- Player Substitutions -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">üîÑ Player Substitutions</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Player Out</label>
                                    <input type="text" id="playerOut" class="form-input"
                                        placeholder="Player leaving field">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Player In</label>
                                    <input type="text" id="playerIn" class="form-input"
                                        placeholder="Player entering field">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="substitutionTeam" class="form-input">
                                        <option value="">Select team</option>
                                        <option value="teamA">Team A</option>
                                        <option value="teamB">Team B</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minute</label>
                                    <input type="number" id="substitutionMinute" class="form-input" placeholder="70"
                                        min="0" max="120">
                                </div>
                            </div>
                            <button class="add-btn" onclick="addSubstitution()" style="width: 100%;">+ Add
                                Substitution</button>
                            <div id="substitutionsList" style="margin-top: 15px;"></div>
                        </div>

                        <!-- Livestream & Camera -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">üìπ Livestream Camera</h3>
                            <div
                                style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 10px; padding: 20px; text-align: center;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üìπ</div>
                                <div style="color: var(--accent-green); font-weight: 600; margin-bottom: 10px;">Camera
                                    Feed Coming Soon</div>
                                <div style="color: var(--text-gray); font-size: 0.9em;">Live camera integration for
                                    broadcasting will be available in the next update</div>
                            </div>
                        </div>

                        <!-- Match Control -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">‚è±Ô∏è Match Control</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Current Minute</label>
                                    <input type="number" class="form-input" id="liveMinute" min="0" max="120"
                                        onchange="updateLiveMinute(this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Match Status</label>
                                    <select id="liveStatus" class="form-input" onchange="updateLiveStatus(this.value)">
                                        <option value="live">üî¥ LIVE</option>
                                        <option value="halftime">‚è∏Ô∏è Half-time</option>
                                        <option value="paused">‚è∏Ô∏è Paused</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <button class="add-btn" onclick="finishLiveMatch()"
                                    style="flex: 1; background: rgba(0,255,136,0.2);">‚úÖ Finish Match</button>
                                <button class="add-btn" onclick="closeMatchCreationModal()"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: FINISHED MATCH -->
                <div id="finishedMatchContent" class="match-tab-content" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">‚úÖ View Finished Matches</h3>
                        <div class="form-row">
                            <select id="finishedMatchSelect" class="form-input" style="width: 100%;"
                                onchange="loadFinishedMatchDetailsWithManOfMatch(this.value)">
                                <option value="">-- Select a finished match --</option>
                            </select>
                        </div>
                        <button class="watch-fee-btn" id="finishedWatchFeeButton" style="display: none;"
                            onclick="openWatchFeeModal(document.getElementById('finishedMatchSelect').value)">üí≥ Watch
                            Fee Management</button>
                    </div>

                    <div id="finishedMatchContainer" style="display: none;">
                        <!-- Match Header -->
                        <div class="match-form-section">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div
                                    style="display: flex; gap: 30px; align-items: center; justify-content: center; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.5em; color: var(--text-white);" id="finishedTeamAName">
                                            Team A</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 3em; font-weight: bold; color: var(--accent-gold);"
                                            id="finishedScore">0 - 0</div>
                                        <div style="font-size: 0.9em; color: var(--text-gray); text-align: center;">
                                            FINAL</div>
                                    </div>
                                    <div style="flex: 1; text-align: right;">
                                        <div style="font-size: 1.5em; color: var(--text-white);" id="finishedTeamBName">
                                            Team B</div>
                                    </div>
                                </div>
                                <div style="color: var(--text-gray); font-size: 0.9em;" id="finishedMatchDate">Date &
                                    Time</div>
                            </div>
                        </div>

                        <!-- Final Statistics -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">üìä Final Statistics</h3>
                            <div id="finishedStatsContainer"></div>
                        </div>

                        <!-- Goal Scorers -->
                        <div class="match-form-section goal-scorers-section">
                            <h3 class="match-form-title">‚öΩ Goal Scorers</h3>
                            <div class="goal-input-row">
                                <div class="form-group">
                                    <label class="form-label">Player Name</label>
                                    <input type="text" id="goalScorerName" class="form-input" placeholder="Player name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="goalScorerTeam" class="form-input">
                                        <option value="">Select team</option>
                                        <option value="teamA" id="goalTeamAOption">Team A</option>
                                        <option value="teamB" id="goalTeamBOption">Team B</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minute</label>
                                    <input type="number" id="goalScorerMinute" class="form-input" placeholder="45"
                                        min="0" max="120">
                                </div>
                                <button class="add-btn" onclick="addGoalScorer()"
                                    style="height: 40px; align-self: flex-end;">Add Goal</button>
                            </div>
                            <div id="goalScorersList" style="margin-top: 10px;"></div>
                            <div id="finishedGoalScorersContainer"></div>
                        </div>

                        <!-- Man of the Match -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">‚≠ê Man of the Match</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Player Name</label>
                                    <input type="text" id="manOfMatchName" class="form-input"
                                        placeholder="Enter player name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="manOfMatchTeam" class="form-input">
                                        <option value="">Select Team</option>
                                        <option value="teamA" id="manTeamAOption">Team A</option>
                                        <option value="teamB" id="manTeamBOption">Team B</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Rating (1-10)</label>
                                    <input type="number" id="manOfMatchRating" class="form-input" min="1" max="10"
                                        placeholder="e.g., 8.5">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Performance Notes</label>
                                    <input type="text" id="manOfMatchNotes" class="form-input"
                                        placeholder="e.g., Outstanding performance">
                                </div>
                            </div>
                            <button class="add-btn" onclick="saveManOfMatch()" style="width: 100%;">üíæ Save Man of
                                Match</button>
                            <div id="manOfMatchDisplay" style="margin-top: 15px;"></div>
                        </div>

                        <!-- Actions -->
                        <div style="display: flex; gap: 10px; width: 100%; margin-top: 20px;">
                            <button class="submit-btn" onclick="downloadMatchReportPDF()" style="flex: 1;">üì• Download
                                Report (PDF)</button>
                            <button class="submit-btn"
                                style="flex: 1; background: rgba(255,107,107,0.2); color: #ff6b6b;"
                                onclick="archiveFinishedMatch()">üóëÔ∏è Archive</button>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: UPCOMING MATCH -->
                <div id="upcomingMatchContent" class="match-tab-content" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">üìÖ Filter Upcoming Matches</h3>
                        <div class="form-row">
                            <input type="date" id="upcomingFilterFrom" class="form-input" placeholder="From Date"
                                onchange="filterUpcomingMatches()">
                            <input type="date" id="upcomingFilterTo" class="form-input" placeholder="To Date"
                                onchange="filterUpcomingMatches()">
                            <input type="text" id="upcomingSearchTeam" class="form-input" placeholder="Search team name"
                                onchange="filterUpcomingMatches()">
                        </div>
                    </div>

                    <div id="upcomingMatchesContainer">
                        <!-- Upcoming matches will be loaded here -->
                    </div>

                    <!-- Edit Upcoming Match Section -->
                    <div id="editUpcomingSection" style="display: none;">
                        <div class="match-form-section">
                            <h3 class="match-form-title">‚úèÔ∏è Edit Upcoming Match</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Match Date</label>
                                    <input type="date" id="editUpcomingDate" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Match Time</label>
                                    <input type="time" id="editUpcomingTime" class="form-input">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Name</label>
                                    <input type="text" id="editTeamAName" class="form-input" placeholder="Team A">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Name</label>
                                    <input type="text" id="editTeamBName" class="form-input" placeholder="Team B">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Winning Chance Team A (%)</label>
                                    <input type="number" id="editWinChanceA" class="form-input" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Winning Chance Team B (%)</label>
                                    <input type="number" id="editWinChanceB" class="form-input" min="0" max="100">
                                </div>
                            </div>

                            <div class="form-row">
                                <button class="add-btn" onclick="saveUpcomingMatchEdit()"
                                    style="flex: 1; background: rgba(0,255,136,0.2);">‚úÖ Save Changes</button>
                                <button class="add-btn" onclick="cancelUpcomingMatchEdit()"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOCATION PERMISSION MODAL -->
    <div class="location-permission-overlay" id="locationPermissionOverlay">
        <div class="location-permission-modal">
            <div class="location-permission-title">
                üìç Enable Location Access
            </div>

            <div class="location-permission-subtitle">
                Help us improve your experience and provide better regional insights by allowing location access.
            </div>

            <div
                style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 20px; font-size: 0.9em; color: var(--accent-green); text-align: center;">
                <strong>‚ö° A browser popup will appear</strong><br>
                Click "Allow" in the popup to enable location access
            </div>

            <div class="location-permission-benefits">
                <ul>
                    <li>Accurate geographic analytics in your profile</li>
                    <li>Better regional recommendations</li>
                    <li>Faster location-based services</li>
                    <li>Help improve platform statistics</li>
                </ul>
            </div>

            <div
                style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 25px; font-size: 0.85em; color: var(--text-gray); text-align: center;">
                Your location data is encrypted and stored securely. You can change this setting anytime in your
                profile.
            </div>

            <div class="location-permission-actions">
                <button class="location-btn location-btn-allow" onclick="allowLocationAccess()">
                    üìç Enable Location (Browser Popup)
                </button>
                <button class="location-btn location-btn-skip" onclick="skipLocationAccess()">
                    Skip for Now
                </button>
            </div>

            <div class="location-status" id="locationStatus"></div>
        </div>
    </div>

    <!-- FINANCIAL REPORTS MODAL -->
    <div class="reports-modal-overlay" id="reportsModalOverlay">
        <div class="reports-modal">
            <div class="reports-modal-header">
                <h2 class="reports-modal-title">üìà Financial Reports</h2>
                <span class="reports-modal-close" onclick="closeFinancialReportsModal()">√ó</span>
            </div>

            <div class="reports-modal-content">
                <!-- Report Tabs -->
                <div class="report-tabs">
                    <button class="report-tab active" onclick="switchReportTab('overview')">üìä Overview</button>
                    <button class="report-tab" onclick="switchReportTab('users')">üë• Top Users</button>
                    <button class="report-tab" onclick="switchReportTab('geographic')">üó∫Ô∏è Geographic</button>
                    <button class="report-tab" onclick="switchReportTab('devices')">üì± Devices</button>
                </div>

                <!-- Reports Container -->
                <div id="reportsContainer">
                    <!-- Reports will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTIONS MODAL -->
    <div class="transactions-modal-overlay" id="transactionsModalOverlay">
        <div class="transactions-modal">
            <div class="transactions-modal-header">
                <h2 class="transactions-modal-title">üí≥ Transaction History</h2>
                <span class="transactions-modal-close" onclick="closeTransactionsModal()">√ó</span>
            </div>

            <div class="transactions-modal-content">
                <!-- Status Tabs -->
                <div class="tx-status-tabs">
                    <button class="tx-status-tab active"
                        onclick="filterTransactionsByStatus('all'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">All
                        Transactions</button>
                    <button class="tx-status-tab"
                        onclick="filterTransactionsByStatus('successful'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">‚úÖ
                        Successful</button>
                    <button class="tx-status-tab"
                        onclick="filterTransactionsByStatus('pending'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">‚è≥
                        Pending</button>
                    <button class="tx-status-tab"
                        onclick="filterTransactionsByStatus('failed'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">‚ùå
                        Failed/Rejected</button>
                </div>

                <!-- Type Tabs (Deposit/Withdrawal) -->
                <div class="tx-type-tabs">
                    <button class="tx-type-tab active"
                        onclick="filterTransactionsByType('all'); this.parentElement.querySelectorAll('.tx-type-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">All
                        Types</button>
                    <button class="tx-type-tab"
                        onclick="filterTransactionsByType('deposit'); this.parentElement.querySelectorAll('.tx-type-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">üì•
                        Deposits</button>
                    <button class="tx-type-tab"
                        onclick="filterTransactionsByType('withdrawal'); this.parentElement.querySelectorAll('.tx-type-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">üì§
                        Withdrawals</button>
                </div>

                <!-- Filters Section -->
                <div class="tx-filters-section">
                    <div class="tx-filter-group">
                        <label class="tx-filter-label">Filter by Days</label>
                        <select class="tx-filter-select" onchange="filterTransactionsByDate(this.value)">
                            <option value="1hr">Last 1 Hour</option>
                            <option value="2hrs">Last 2 Hours</option>
                            <option value="3days">Last 3 Days</option>
                            <option value="7days" selected>Last 7 Days</option>
                            <option value="30days">Last 30 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>

                    <div class="tx-filter-group">
                        <label class="tx-filter-label">Search</label>
                        <input type="text" class="tx-search-input" id="txSearchInput"
                            placeholder="Username, Email, DLS Account..." oninput="searchTransactions(this.value)">
                    </div>
                </div>

                <!-- Transactions List -->
                <div class="tx-list-container" id="transactionsListContainer">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- PREDICTIONS MODAL -->
    <div class="transactions-modal-overlay" id="predictionsModalOverlay">
        <div class="transactions-modal">
            <div class="transactions-modal-header">
                <h2 class="transactions-modal-title">üéØ Manage Predictions</h2>
                <span class="transactions-modal-close" onclick="closePredictionsModal()">√ó</span>
            </div>
            <div class="transactions-modal-content" style="padding: 30px;">
                <div class="match-form-section">
                    <h3 class="match-form-title">Select Match for Predictions</h3>
                    <select id="predictionsMatchSelect" class="form-input" style="width: 100%;"
                        onchange="loadPredictionsForMatch(this.value)">
                        <option value="">-- Select a match --</option>
                    </select>
                </div>

                <div id="predictionsContainer" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">‚öΩ Prediction Types</h3>
                        <div class="predictions-section">
                            <h4 style="color: var(--accent-gold); margin-bottom: 15px;">Available Prediction Markets
                            </h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="pred_scoreEnabled" onchange="updatePredictionTypes()">
                                    <label for="pred_scoreEnabled">Predict Exact Score (e.g., 2-1)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="pred_teamEnabled" onchange="updatePredictionTypes()">
                                    <label for="pred_teamEnabled">Predict Team to Score</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="pred_goalsEnabled" onchange="updatePredictionTypes()">
                                    <label for="pred_goalsEnabled">Predict Number of Goals Only</label>
                                </div>
                            </div>
                        </div>

                        <div id="pred_scoreOptions" style="display: none;">
                            <h4 style="color: var(--accent-gold); margin-top: 20px; margin-bottom: 10px;">Exact Score
                                Predictions</h4>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label">Team A Score</label>
                                    <input type="number" id="predTeamAScore" class="form-input" min="0" max="20"
                                        placeholder="0">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button class="add-btn" onclick="addScorePrediction()"
                                        style="width: 100%; margin-bottom: 0;">Add Score</button>
                                </div>
                                <div>
                                    <label class="form-label">Team B Score</label>
                                    <input type="number" id="predTeamBScore" class="form-input" min="0" max="20"
                                        placeholder="0">
                                </div>
                            </div>
                            <div id="scorePredictionsList"></div>
                        </div>

                        <div id="pred_teamOptions" style="display: none;">
                            <h4 style="color: var(--accent-gold); margin-top: 20px; margin-bottom: 10px;">Team to Score
                                Predictions</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <button class="add-btn" onclick="addTeamPrediction('teamA')"
                                    style="background: rgba(100, 150, 255, 0.2); border-color: rgba(100, 150, 255, 0.4);">Team
                                    A Will Score</button>
                                <button class="add-btn" onclick="addTeamPrediction('teamB')"
                                    style="background: rgba(255, 150, 100, 0.2); border-color: rgba(255, 150, 100, 0.4);">Team
                                    B Will Score</button>
                            </div>
                            <div id="teamPredictionsList"></div>
                        </div>

                        <div id="pred_goalsOptions" style="display: none;">
                            <h4 style="color: var(--accent-gold); margin-top: 20px; margin-bottom: 10px;">Total Goals
                                Predictions</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label">Total Goals</label>
                                    <input type="number" id="predTotalGoals" class="form-input" min="0" max="30"
                                        placeholder="0">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button class="add-btn" onclick="addGoalsPrediction()"
                                        style="width: 100%; margin-bottom: 0;">Add Prediction</button>
                                </div>
                            </div>
                            <div id="goalsPredictionsList"></div>
                        </div>
                    </div>

                    <div class="match-form-section">
                        <h3 class="match-form-title">üíæ Save Predictions</h3>
                        <button class="submit-btn" onclick="savePredictions()" style="width: 100%;">‚úÖ Save All
                            Predictions</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GOAL SCORERS MODAL -->
    <div class="transactions-modal-overlay" id="goalScorersModalOverlay">
        <div class="transactions-modal">
            <div class="transactions-modal-header">
                <h2 class="transactions-modal-title">‚öΩ Goal Scorers</h2>
                <span class="transactions-modal-close" onclick="closeGoalScorersModal()">√ó</span>
            </div>
            <div class="transactions-modal-content" style="padding: 30px; overflow-y: auto;">
                <div class="match-form-section">
                    <h3 class="match-form-title">Select Match</h3>
                    <select id="goalScorersMatchSelect" class="form-input" style="width: 100%;"
                        onchange="loadGoalScorersForMatch(this.value)">
                        <option value="">-- Select a match --</option>
                    </select>
                </div>

                <div id="goalScorersContainer" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">‚ûï Add Goal Scorer</h3>
                        <div class="goal-input-row">
                            <select id="goalScorerTeam" class="form-input">
                                <option value="teamA">Team A</option>
                                <option value="teamB">Team B</option>
                            </select>
                            <input type="text" id="goalScorerName" class="form-input" placeholder="Player name">
                            <input type="number" id="goalScorerMinute" class="form-input" placeholder="Minute" min="0"
                                max="120">
                            <button class="add-btn" onclick="addGoalScorer()" style="padding: 10px 15px;">‚ûï Add</button>
                        </div>
                    </div>

                    <div class="match-form-section">
                        <h3 class="match-form-title">üìã Goal Scorers List</h3>
                        <div id="goalScorersList"></div>
                    </div>

                    <div class="match-form-section">
                        <button class="submit-btn" onclick="saveGoalScorers()" style="width: 100%;">üíæ Save Goal
                            Scorers</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WATCH FEE MODAL -->
    <div class="watch-fee-modal" id="watchFeeModal">
        <div class="watch-fee-content">
            <div class="watch-fee-header">
                <h2 class="watch-fee-title">üí≥ Watch Fee Management</h2>
                <button class="watch-fee-close" onclick="closeWatchFeeModal()">√ó</button>
            </div>

            <div id="watchFeeMatchInfo"
                style="background: rgba(0, 255, 136, 0.1); border-left: 4px solid rgba(0, 255, 136, 0.5); padding: 15px; border-radius: 8px; margin-bottom: 25px; display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 5px;">Match</div>
                        <div id="watchFeeMatchName"
                            style="font-weight: 600; color: var(--text-white); font-size: 1.1em;"></div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 5px;">Fee</div>
                        <div id="watchFeePrice" style="font-weight: 900; color: var(--accent-gold); font-size: 1.1em;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="watch-fee-tabs">
                <button class="watch-fee-tab active" onclick="switchWatchFeeTab('stats')">üìä Statistics</button>
                <button class="watch-fee-tab" onclick="switchWatchFeeTab('paidViewers')">üë• Paid Viewers</button>
            </div>

            <!-- Stats Tab -->
            <div id="statsTab" class="watch-fee-tab-content active">
                <h3 style="color: var(--accent-gold); margin-bottom: 20px; font-size: 1.3em;">üìà Audience Statistics
                </h3>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Viewers</div>
                        <div class="stat-value" id="totalViewers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Paid Viewers</div>
                        <div class="stat-value" id="paidViewersCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value" id="totalRevenue">‚Ç¶0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Watch Time</div>
                        <div class="stat-value" id="avgWatchTime">0m</div>
                    </div>
                </div>

                <div
                    style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #00d4ff; margin-bottom: 10px;">Viewing Platform Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em;">
                        <div>
                            <span style="color: var(--text-gray);">Peak Concurrent Viewers:</span>
                            <div style="color: var(--text-white); font-weight: 600; margin-top: 5px;" id="peakViewers">0
                            </div>
                        </div>
                        <div>
                            <span style="color: var(--text-gray);">Stream Duration:</span>
                            <div style="color: var(--text-white); font-weight: 600; margin-top: 5px;"
                                id="streamDuration">0m</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paid Viewers Tab -->
            <div id="paidViewersTab" class="watch-fee-tab-content">
                <h3 style="color: var(--accent-gold); margin-bottom: 20px; font-size: 1.3em;">üí∞ Paid Viewers List</h3>

                <div id="paidViewersList" class="viewers-list">
                    <div class="no-viewers-message">No paid viewers yet</div>
                </div>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(255, 215, 0, 0.1);">
                <button class="submit-btn" onclick="closeWatchFeeModal()" style="width: 100%;">‚úÖ Close</button>
            </div>
        </div>
    </div>

</body>

</html>
