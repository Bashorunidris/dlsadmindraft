<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DLS Draft</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #0a0e27;
            --secondary-dark: #151930;
            --accent-gold: #ffd700;
            --accent-green: #00ff88;
            --text-white: #ffffff;
            --text-gray: #b8b8b8;
            --hover-glow: rgba(255, 215, 0, 0.4);
            --card-bg: rgba(21, 25, 48, 0.85);
            --error-red: #ff6b6b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--primary-dark);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* HEADER */
        .admin-header {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding: 20px 6%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-logo {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px var(--hover-glow);
            letter-spacing: 2px;
        }

        .admin-badge {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: var(--accent-gold);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-email {
            font-size: 0.95em;
            color: var(--text-gray);
        }

        .logout-btn {
            padding: 10px 25px;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--error-red);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            border-color: var(--error-red);
        }

        /* MAIN CONTAINER */
        .admin-container {
            padding: 40px 6%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-title {
            font-size: 2.5em;
            font-weight: 900;
            margin-bottom: 10px;
            color: var(--accent-gold);
            text-shadow: 0 0 20px var(--hover-glow);
        }

        .admin-subtitle {
            font-size: 1.1em;
            color: var(--text-gray);
            margin-bottom: 40px;
        }

        /* GRID LAYOUT */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .admin-card {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
            }
        }

        .admin-card:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 15px 50px var(--hover-glow);
            transform: translateY(-5px);
        }

        .card-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-white);
        }

        .card-number {
            font-size: 2.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .card-label {
            font-size: 0.9em;
            color: var(--text-gray);
        }

        /* ACTION BUTTONS */
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-btn {
            padding: 20px;
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            font-weight: 600;
        }

        .action-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--hover-glow);
        }

        .action-icon {
            font-size: 2em;
        }

        /* TABLE SECTION */
        .admin-section {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            animation: slideIn 0.5s ease forwards 0.2s;
            opacity: 0;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .info-box {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            color: var(--accent-green);
        }

        .info-box strong {
            color: var(--text-white);
        }

        /* NOTIFICATION CONTAINER */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            pointer-events: auto;
        }

        .notification {
            padding: 16px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            animation: slideInRight 0.3s ease forwards;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(400px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .notification.removing {
            animation: slideOutRight 0.3s ease forwards;
        }

        .notification-success {
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
        }

        .notification-error {
            background: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
        }

        .notification-info {
            background: rgba(0, 212, 255, 0.15);
            border-color: rgba(0, 212, 255, 0.4);
            color: #00d4ff;
        }

        .notification-loading {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.4);
            color: var(--accent-gold);
        }

        .notification-icon {
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
            font-size: 0.95em;
        }

        .notification-close {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* WATCH FEE STYLES */
        .watch-fee-btn {
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid rgba(255, 215, 0, 0.3);
            color: var(--accent-gold);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
        }

        .watch-fee-btn:hover {
            background: rgba(255, 215, 0, 0.25);
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .watch-fee-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .watch-fee-modal.active {
            display: flex;
        }

        #tournamentOverlayModal {
            z-index: 6000;
        }

        .watch-fee-content {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        /* Tournament Modal - Full Page */
        #tournamentModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-dark);
            z-index: 5000;
            padding: 0;
        }

        #tournamentModal.active {
            display: block;
        }

        #tournamentModal .watch-fee-content {
            background: transparent;
            border: none;
            border-radius: 0;
            max-width: 100%;
            max-height: 100%;
            overflow-y: auto;
            padding: 40px 6%;
            box-shadow: none;
        }

        #tournamentModal .watch-fee-header {
            position: sticky;
            top: 0;
            background: rgba(10, 14, 39, 0.95);
            padding: 20px 0;
            margin: -40px -6% 30px -6%;
            padding-left: 6%;
            padding-right: 6%;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
            z-index: 10;
        }

        .watch-fee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .watch-fee-title {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .watch-fee-close {
            font-size: 2em;
            cursor: pointer;
            color: var(--text-gray);
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .watch-fee-close:hover {
            background: rgba(255, 215, 0, 0.1);
            color: var(--accent-gold);
        }


        /* LOADING SPINNER */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 215, 0, 0.2);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* WATCH FEE TABS */
        .watch-fee-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
            padding-bottom: 0;
        }

        .watch-fee-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .watch-fee-tab:hover {
            color: var(--accent-gold);
        }

        .watch-fee-tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .watch-fee-tab-content {
            display: none;
        }

        .watch-fee-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
        }

        /* VIEWERS LIST */
        .viewers-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .viewer-item {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viewer-info {
            flex: 1;
        }

        .viewer-name {
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 3px;
        }

        .viewer-detail {
            font-size: 0.85em;
            color: var(--text-gray);
        }

        .no-viewers-message {
            text-align: center;
            color: var(--text-gray);
            padding: 40px 20px;
            font-size: 0.95em;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .admin-info {
                flex-direction: column;
                width: 100%;
            }

            .admin-title {
                font-size: 2em;
            }

            .admin-container {
                padding: 20px 15px;
            }

            .admin-grid {
                grid-template-columns: 1fr;
            }

            .admin-actions {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .watch-fee-tabs {
                flex-wrap: wrap;
            }

            #tournamentModal .watch-fee-content {
                padding: 20px 15px;
            }

            #tournamentModal .watch-fee-header {
                margin: -20px -15px 20px -15px;
                padding-left: 15px;
                padding-right: 15px;
            }

            #tournamentModal .watch-fee-title {
                font-size: 1.5em;
            }

            .watch-fee-content {
                padding: 20px;
            }

            .watch-fee-modal {
                padding: 10px;
            }
        }

        /* TRANSACTIONS MODAL */
        .transactions-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            overflow: hidden;
            padding: 0;
        }

        .transactions-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 0;
        }

        .transactions-modal {
            background: var(--card-bg);
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .transactions-modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 14, 39, 0.9);
            flex-shrink: 0;
        }

        .transactions-modal-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            margin: 0;
        }

        .transactions-modal-close {
            font-size: 2.5em;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .transactions-modal-close:hover {
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .transactions-modal-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Tabs */
        .tx-status-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
            padding: 0;
            background: rgba(10, 14, 39, 0.5);
        }

        .tx-status-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            position: relative;
        }

        .tx-status-tab.active {
            color: var(--accent-gold);
        }

        .tx-status-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .tx-status-tab:hover {
            color: var(--accent-gold);
        }

        /* Filter Section */
        .tx-filters-section {
            padding: 20px 25px;
            background: rgba(10, 14, 39, 0.3);
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .tx-filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tx-filter-label {
            font-size: 0.85em;
            color: var(--text-gray);
            font-weight: 600;
        }

        .tx-filter-select {
            padding: 10px 12px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .tx-search-input {
            padding: 10px 12px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            font-size: 0.95em;
        }

        .tx-search-input::placeholder {
            color: rgba(184, 184, 184, 0.5);
        }

        /* Type Tabs (Deposit/Withdrawal) */
        .tx-type-tabs {
            display: flex;
            gap: 15px;
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            background: rgba(10, 14, 39, 0.2);
        }

        .tx-type-tab {
            padding: 8px 16px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-gray);
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .tx-type-tab.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .tx-type-tab:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent-gold);
        }

        /* Transactions List */
        .tx-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }

        .tx-item {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .tx-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .tx-info-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tx-label {
            font-size: 0.75em;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* FINANCIAL REPORTS MODAL */
        .reports-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            overflow: hidden;
            padding: 0;
        }

        .reports-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 0;
        }

        .reports-modal {
            background: var(--card-bg);
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .reports-modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 14, 39, 0.9);
            flex-shrink: 0;
        }

        .reports-modal-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            margin: 0;
        }

        .reports-modal-close {
            font-size: 2.5em;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .reports-modal-close:hover {
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .reports-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px 25px;
        }

        /* Report Tabs */
        .report-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
            margin-bottom: 30px;
            background: rgba(10, 14, 39, 0.5);
            margin: -30px -25px 30px -25px;
            padding: 0 25px;
        }

        .report-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            position: relative;
        }

        .report-tab.active {
            color: var(--accent-gold);
        }

        .report-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .report-tab:hover {
            color: var(--accent-gold);
        }

        /* Report Grid */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .report-card-label {
            font-size: 0.85em;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
        }

        .report-card-value {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
        }

        .report-card-change {
            font-size: 0.85em;
            color: var(--accent-green);
            font-weight: 600;
        }

        .report-card-change.negative {
            color: #ff6b6b;
        }

        .report-section {
            margin-bottom: 40px;
        }

        .report-section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .report-table th {
            background: rgba(255, 215, 0, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 0.9em;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .report-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            color: var(--text-white);
        }

        .report-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        /* LOCATION PERMISSION MODAL */
        .location-permission-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .location-permission-overlay.active {
            display: flex;
        }

        .location-permission-modal {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            animation: slideInUp 0.4s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .location-permission-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .location-permission-subtitle {
            font-size: 0.95em;
            color: var(--text-gray);
            margin-bottom: 25px;
            line-height: 1.6;
            text-align: center;
        }

        .location-permission-benefits {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .location-permission-benefits ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .location-permission-benefits li {
            color: var(--accent-green);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .location-permission-benefits li::before {
            content: 'âœ“';
            font-weight: bold;
            color: var(--accent-green);
        }

        .location-permission-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .location-btn {
            flex: 1;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .location-btn-allow {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
        }

        .location-btn-allow:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .location-btn-skip {
            background: transparent;
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--text-gray);
        }

        .location-btn-skip:hover {
            border-color: rgba(255, 107, 107, 0.6);
            color: var(--error-red);
        }

        .location-status {
            text-align: center;
            margin-top: 15px;
            font-size: 0.85em;
            color: var(--text-gray);
        }

        .location-status.active {
            color: var(--accent-green);
        }

        /* MATCH CREATION POPUP */
        .creation-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .creation-popup-overlay.active {
            display: flex;
        }

        .creation-popup {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            animation: slideInUp 0.4s ease;
            text-align: center;
        }

        .creation-popup-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 30px;
        }

        .creation-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .creation-option-btn {
            padding: 15px 30px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            color: var(--accent-gold);
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .creation-option-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent-gold);
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .creation-close-btn {
            margin-top: 20px;
            padding: 10px 25px;
            background: transparent;
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--text-gray);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .creation-close-btn:hover {
            border-color: var(--error-red);
            color: var(--error-red);
        }

        /* MATCH CREATION MODAL */
        .match-creation-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            padding: 0;
            overflow: hidden;
        }

        .match-creation-overlay.active {
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }

        .match-creation-modal {
            background: var(--card-bg);
            border: none;
            border-radius: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .match-creation-header {
            padding: 25px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 14, 39, 0.9);
        }

        .match-creation-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin: 0;
        }

        .match-creation-close {
            font-size: 2.5em;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .match-creation-close:hover {
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        /* MATCH TABS */
        .match-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.1);
            background: rgba(10, 14, 39, 0.5);
            padding: 0;
            overflow-x: auto;
        }

        .match-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
        }

        .match-tab.active {
            color: var(--accent-gold);
        }

        .match-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .match-tab:hover {
            color: var(--accent-gold);
        }

        /* MATCH FORM */
        .match-form-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }

        .match-form-section {
            margin-bottom: 30px;
        }

        .match-form-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 0.9em;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
        }

        .form-input {
            padding: 10px 15px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            font-size: 0.95em;
        }

        .form-input::placeholder {
            color: rgba(184, 184, 184, 0.5);
        }

        .form-textarea {
            padding: 10px 15px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: var(--text-white);
            border-radius: 8px;
            font-size: 0.95em;
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-gold);
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-white);
        }

        .players-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .player-list {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(255, 215, 0, 0.1);
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
        }

        .remove-btn {
            background: rgba(255, 107, 107, 0.3);
            border: none;
            color: var(--error-red);
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .add-btn {
            padding: 10px 20px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .add-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
        }

        .submit-btn {
            padding: 15px 40px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .empty-tab {
            padding: 50px;
            text-align: center;
            color: var(--text-gray);
        }

        /* Chart Containers */
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 40px;
            background: rgba(255, 215, 0, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 20px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .small-chart-container {
            position: relative;
            height: 250px;
            background: rgba(255, 215, 0, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            padding: 15px;
        }

        .tx-value {
            font-size: 0.95em;
            color: var(--text-white);
            font-weight: 600;
        }

        .tx-amount {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .tx-amount.red {
            color: var(--error-red);
        }

        .tx-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
        }

        .tx-status-badge.successful {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.4);
            color: var(--accent-green);
        }

        .tx-status-badge.pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }

        .tx-status-badge.failed {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--error-red);
        }

        .tx-status-badge.rejected {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: var(--error-red);
        }

        .tx-no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-gray);
            font-size: 1em;
        }

        @media (max-width: 1024px) {
            .tx-item {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .tx-filters-section {
                grid-template-columns: 1fr;
            }
        }

        /* PREDICTIONS & FEATURES STYLES */
        .predictions-section {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .prediction-card {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prediction-card:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent-gold);
            transform: translateY(-3px);
        }

        .prediction-card.selected {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .goal-scorers-section {
            margin-top: 15px;
        }

        .goal-input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .goal-list-item {
            background: rgba(0, 255, 136, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .events-timeline {
            background: rgba(255, 215, 0, 0.05);
            border-left: 3px solid rgba(255, 215, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .timeline-event {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 5px;
            font-size: 0.85em;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .event-icon {
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .event-details {
            flex: 1;
        }

        .event-time {
            color: var(--text-gray);
            font-size: 0.8em;
        }

        .substitutions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .substitution-item {
            background: rgba(100, 200, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid rgba(100, 200, 255, 0.5);
        }

        .player-in-out {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .player-label {
            padding: 6px 10px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 4px;
            font-size: 0.8em;
            text-align: center;
        }

        .player-label.in {
            background: rgba(0, 255, 136, 0.2);
        }

        /* CUSTOM CONFIRMATION MODAL */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirmation-overlay.active {
            display: flex;
        }

        .confirmation-modal {
            background: var(--card-bg);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideInUp 0.4s ease;
            text-align: center;
        }

        .confirmation-icon {
            font-size: 3.5em;
            margin-bottom: 20px;
        }

        .confirmation-title {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 15px;
        }

        .confirmation-message {
            font-size: 1em;
            color: var(--text-white);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .confirmation-message.warning {
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 15px;
            color: #ff6b6b;
        }

        .confirmation-message.info {
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            color: #00d4ff;
        }

        .confirmation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirmation-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 150px;
        }

        .confirmation-btn-confirm {
            background: rgba(255, 107, 107, 0.3);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
        }

        .confirmation-btn-confirm:hover {
            background: rgba(255, 107, 107, 0.5);
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
            transform: translateY(-2px);
        }

        .confirmation-btn-cancel {
            background: rgba(0, 255, 136, 0.15);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
        }

        .confirmation-btn-cancel:hover {
            background: rgba(0, 255, 136, 0.25);
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <header class="admin-header">
        <div class="admin-logo">ðŸ† DLS DRAFT</div>
        <div class="admin-info">
            <div class="admin-badge">â­ ADMIN PANEL</div>
            <span class="admin-email" id="adminEmailDisplay">Admin</span>
            <button class="logout-btn" onclick="handleLogout()">ðŸšª Logout</button>
        </div>
    </header>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="confirmationOverlay" class="confirmation-overlay"
        onclick="if(event.target.id === 'confirmationOverlay') cancelConfirmation()">
        <div class="confirmation-modal">
            <div class="confirmation-icon" id="confirmationIcon">âš ï¸</div>
            <div class="confirmation-title" id="confirmationTitle">Confirm Action</div>
            <div class="confirmation-message" id="confirmationMessage"></div>
            <div class="confirmation-actions">
                <button class="confirmation-btn confirmation-btn-cancel" onclick="cancelConfirmation()">ðŸ”™
                    Cancel</button>
                <button class="confirmation-btn confirmation-btn-confirm" onclick="submitConfirmation()">âœ…
                    Confirm</button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="admin-container">
        <h1 class="admin-title">Admin Dashboard</h1>
        <p class="admin-subtitle">Welcome to DLS Draft Administration Panel</p>

        <!-- STATS GRID -->
        <div class="admin-grid">
            <div class="admin-card" style="animation-delay: 0s;">
                <div class="card-icon">ðŸ‘¥</div>
                <div class="card-title">Total Users</div>
                <div class="card-number" id="totalUsers">-</div>
                <div class="card-label">Active players registered</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.1s;">
                <div class="card-icon">ðŸ’°</div>
                <div class="card-title">Total Wallet Balance</div>
                <div class="card-number" id="totalBalance">-</div>
                <div class="card-label">Across all accounts</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.3s;">
                <div class="card-icon">ðŸ“Š</div>
                <div class="card-title">Total Transactions</div>
                <div class="card-number" id="totalTransactions">-</div>
                <div class="card-label">Deposits & Withdrawals</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.4s;">
                <div class="card-icon">âœ…</div>
                <div class="card-title">Verified Accounts</div>
                <div class="card-number" id="verifiedAccounts">-</div>
                <div class="card-label">Bank accounts linked</div>
            </div>

            <div class="admin-card" style="animation-delay: 0.5s;">
                <div class="card-icon">â³</div>
                <div class="card-title">Pending Withdrawals</div>
                <div class="card-number" id="pendingWithdrawals">-</div>
                <div class="card-label">Awaiting processing</div>
            </div>
        </div>

        <!-- ACTION BUTTONS -->
        <h2 class="section-title" style="border: none; padding: 0; margin: 40px 0 25px 0;">Quick Actions</h2>
        <div class="admin-actions">
            <button class="action-btn" onclick="navigateTo('manage-users')">
                <span class="action-icon">ðŸ‘¥</span>
                <span>Manage Users</span>
            </button>
            <button class="action-btn" onclick="openTransactionsModal()">
                <span class="action-icon">ðŸ’³</span>
                <span>View Transactions</span>
            </button>
            <button class="action-btn" onclick="navigateTo('bank-accounts')">
                <span class="action-icon">ðŸ¦</span>
                <span>Bank Accounts</span>
            </button>
            <button class="action-btn" onclick="openFinancialReportsModal()">
                <span class="action-icon">ðŸ“ˆ</span>
                <span>Financial Reports</span>
            </button>
            <button class="action-btn" onclick="navigateTo('settings')">
                <span class="action-icon">âš™ï¸</span>
                <span>System Settings</span>
            </button>
            <button class="action-btn" onclick="openCreationPopup()">
                <span class="action-icon">ðŸŽ®</span>
                <span>Match Creation</span>
            </button>
            <button class="action-btn" onclick="openPredictionsModal()">
                <span class="action-icon">ðŸŽ¯</span>
                <span>Manage Predictions</span>
            </button>
            <button class="action-btn" onclick="openGoalScorersModal()">
                <span class="action-icon">âš½</span>
                <span>Goal Scorers</span>
            </button>
            <button class="action-btn" onclick="openLivestreamsModal()">
                <span class="action-icon">ðŸŽ¥</span>
                <span>View Livestreams</span>
            </button>
            <button class="action-btn" onclick="openRegisterPlayersModal()">
                <span class="action-icon">ðŸ“</span>
                <span>Register Players</span>
            </button>
        </div>

        <!-- PENDING WITHDRAWALS SECTION -->
        <div class="admin-section">
            <h2 class="section-title">ðŸ”” Pending Withdrawals</h2>

            <!-- Tabs -->
            <div
                style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(255,215,0,0.2); padding-bottom: 15px;">
                <button class="withdrawal-tab active" onclick="filterWithdrawals('all')"
                    style="padding: 10px 20px; background: transparent; border: none; color: var(--accent-gold); cursor: pointer; font-weight: 600; border-bottom: 3px solid var(--accent-gold); font-size: 0.95em;">ðŸ“Š
                    All</button>
                <button class="withdrawal-tab" onclick="filterWithdrawals('normal')"
                    style="padding: 10px 20px; background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-weight: 600; font-size: 0.95em;">ðŸš—
                    Normal</button>
                <button class="withdrawal-tab" onclick="filterWithdrawals('speed')"
                    style="padding: 10px 20px; background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-weight: 600; font-size: 0.95em;">âš¡
                    Speed</button>
            </div>

            <!-- Withdrawals List -->
            <div style="display: flex; flex-direction: column; gap: 15px;" id="pendingWithdrawalsList">
                <div style="text-align: center; color: var(--text-gray); padding: 30px;">Loading pending withdrawals...
                </div>
            </div>
        </div>
    </div>

    <!-- MANAGE USERS MODAL -->
    <div id="manageUsersModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; overflow-y: auto; padding: 20px;"
        onclick="if(event.target.id === 'manageUsersModal') closeManageUsersModal()">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; position: sticky; top: 20px; background: rgba(10,14,39,0.95); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,215,0,0.2); z-index: 3001;">
                <div style="flex: 1;">
                    <h2 style="color: var(--accent-gold); margin: 0; font-size: 1.8em;">ðŸ‘¥ Manage Users</h2>
                </div>
                <div style="display: flex; gap: 15px; align-items: center; flex: 2;">
                    <input type="text" id="userSearchInput" placeholder="Search by name or email..."
                        style="padding: 12px 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.3); border-radius: 20px; color: var(--text-white); width: 100%; font-size: 0.95em;"
                        oninput="filterUsers()">
                </div>
                <button onclick="closeManageUsersModal()"
                    style="padding: 10px 20px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 20px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 15px;">âœ•
                    Close</button>
            </div>

            <div id="usersGridContainer"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding-bottom: 30px;">
                <div style="text-align: center; color: var(--text-gray); padding: 30px; grid-column: 1 / -1;">Loading
                    users...</div>
            </div>
        </div>
    </div>

    <!-- CREDIT/TAKEBACK MODAL -->
    <div id="creditModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; justify-content: center; align-items: center; padding: 20px;">
        <div
            style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px; max-width: 500px; width: 100%;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;" id="creditModalTitle">Credit Account</h2>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">User</label>
                <input type="text" id="creditUserName" readonly
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; cursor: not-allowed;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Wallet Account Number</label>
                <input type="text" id="creditWalletAccount" readonly
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; cursor: not-allowed;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Amount (â‚¦)</label>
                <input type="number" id="creditAmount" placeholder="Enter amount"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Admin Password</label>
                <input type="password" id="creditPassword" placeholder="Enter admin password"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
            </div>

            <div id="creditMessage" style="margin-bottom: 15px;"></div>

            <div style="display: flex; gap: 10px;">
                <button onclick="processCreditTransaction()"
                    style="flex: 1; padding: 12px; background: var(--accent-green); border: none; border-radius: 8px; color: var(--primary-dark); font-weight: 600; cursor: pointer;">Send</button>
                <button onclick="closeCreditModal()"
                    style="flex: 1; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); border-radius: 8px; color: #ff6b6b; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- RESTRICT MODAL -->
    <div id="restrictModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; justify-content: center; align-items: center; padding: 20px;">
        <div
            style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px; max-width: 500px; width: 100%;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;">Restrict User Access</h2>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">User</label>
                <input type="text" id="restrictUserName" readonly
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; cursor: not-allowed;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Restriction Duration</label>
                <select id="restrictDuration"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
                    <option value="">Select duration</option>
                    <option value="1">1 Hour</option>
                    <option value="24">24 Hours</option>
                    <option value="48">2 Days</option>
                    <option value="72">3 Days</option>
                    <option value="96">4 Days</option>
                    <option value="120">5 Days</option>
                    <option value="144">6 Days</option>
                    <option value="168">7 Days</option>
                </select>
            </div>

            <div id="restrictMessage" style="margin-bottom: 15px;"></div>

            <div style="display: flex; gap: 10px;">
                <button onclick="processRestriction()"
                    style="flex: 1; padding: 12px; background: var(--accent-gold); border: none; border-radius: 8px; color: var(--primary-dark); font-weight: 600; cursor: pointer;">Restrict</button>
                <button onclick="closeRestrictModal()"
                    style="flex: 1; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); border-radius: 8px; color: #ff6b6b; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- REJECTION REASON MODAL -->
    <div id="rejectModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; justify-content: center; align-items: center; padding: 20px;">
        <div
            style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px; max-width: 500px; width: 100%;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;">Reject Withdrawal</h2>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rejection Reason</label>
                <select id="rejectionReason"
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em;">
                    <option value="">Select a reason...</option>
                    <option value="insufficient">Insufficient Balance</option>
                    <option value="max_requests">Max Requests Per Day Exceeded</option>
                    <option value="not_paying">Not Paying Out Now</option>
                    <option value="other">Other Reason</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Additional Notes (Optional)</label>
                <textarea id="rejectionNotes" placeholder="Add notes..."
                    style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; color: var(--text-white); width: 100%; font-size: 1em; min-height: 80px; resize: vertical;"></textarea>
            </div>

            <div id="rejectMessage" style="margin-bottom: 15px;"></div>

            <div style="display: flex; gap: 10px;">
                <button onclick="confirmReject()"
                    style="flex: 1; padding: 12px; background: #ff6b6b; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Reject</button>
                <button onclick="closeRejectModal()"
                    style="flex: 1; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); border-radius: 8px; color: #ff6b6b; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
    <!-- MATCH CREATION POPUP -->
    <div class="creation-popup-overlay" id="creationPopupOverlay">
        <div class="creation-popup">
            <div class="creation-popup-title">ðŸŽ® Create Match</div>

            <div class="creation-options">
                <button class="creation-option-btn" onclick="selectSingleMatch()">
                    âš½ Single Match
                </button>
                <button class="creation-option-btn" onclick="selectTournament()">
                    ðŸ† Tournament
                </button>
            </div>

            <button class="creation-close-btn" onclick="closeCreationPopup()">Close</button>
        </div>
    </div>

    <!-- MATCH CREATION MODAL -->
    <div class="match-creation-overlay" id="matchCreationOverlay">
        <div class="match-creation-modal">
            <div class="match-creation-header">
                <h2 class="match-creation-title">âš½ Create Single Match</h2>
                <span class="match-creation-close" onclick="closeMatchCreationModal()">Ã—</span>
            </div>

            <div class="match-tabs">
                <button class="match-tab active" onclick="switchMatchTab('setMatch')">1ï¸âƒ£ Set Match</button>
                <button class="match-tab" onclick="switchMatchTab('liveMatch')">2ï¸âƒ£ Live Match</button>
                <button class="match-tab" onclick="switchMatchTab('finishedMatch')">3ï¸âƒ£ Finished Match</button>
                <button class="match-tab" onclick="switchMatchTab('upcomingMatch')">4ï¸âƒ£ Upcoming Match</button>
            </div>

            <div class="match-form-container">
                <!-- TAB 1: SET MATCH -->
                <div id="setMatchContent" class="match-tab-content">
                    <!-- TEAMS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">âš½ Teams</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A Name</label>
                                <input type="text" class="form-input" placeholder="Enter team name"
                                    onchange="matchCreationData.teamA.name = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team A Logo (URL or File)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-input" style="flex: 1;" placeholder="Enter logo URL"
                                        onchange="matchCreationData.teamA.logo = this.value">
                                    <input type="file" id="teamALogoFile" accept="image/*" class="form-input"
                                        style="flex: 1;" onchange="handleLogoUpload('teamA', this)">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team B Name</label>
                                <input type="text" class="form-input" placeholder="Enter team name"
                                    onchange="matchCreationData.teamB.name = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B Logo (URL or File)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-input" style="flex: 1;" placeholder="Enter logo URL"
                                        onchange="matchCreationData.teamB.logo = this.value">
                                    <input type="file" id="teamBLogoFile" accept="image/*" class="form-input"
                                        style="flex: 1;" onchange="handleLogoUpload('teamB', this)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MANAGEMENT SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ‘¥ Management</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A - DLS Player</label>
                                <input type="text" class="form-input" placeholder="Enter DLS player name"
                                    onchange="matchCreationData.teamA.dlsPlayer = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team A - Club Owner</label>
                                <input type="text" class="form-input" placeholder="Enter club owner"
                                    onchange="matchCreationData.teamA.clubOwner = this.value">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team B - DLS Player</label>
                                <input type="text" class="form-input" placeholder="Enter DLS player name"
                                    onchange="matchCreationData.teamB.dlsPlayer = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B - Club Owner</label>
                                <input type="text" class="form-input" placeholder="Enter club owner"
                                    onchange="matchCreationData.teamB.clubOwner = this.value">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A Captain</label>
                                <input type="text" class="form-input" placeholder="Captain name"
                                    onchange="matchCreationData.teamA.captain = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B Captain</label>
                                <input type="text" class="form-input" placeholder="Captain name"
                                    onchange="matchCreationData.teamB.captain = this.value">
                            </div>
                        </div>
                    </div>

                    <!-- PLAYERS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ‘¨â€ðŸ¦² Players (Max 17 per team)</h3>
                        <div class="players-section">
                            <div>
                                <h4 style="color: var(--accent-gold); margin-bottom: 10px;">Team A - <span
                                        id="teamAPlayerCount">0/17</span></h4>
                                <div class="form-row">
                                    <input type="text" id="teamAPlayerName" class="form-input"
                                        placeholder="Player name">
                                    <input type="number" id="teamAPlayerNumber" class="form-input"
                                        placeholder="Jersey #" min="1" max="99">
                                </div>
                                <div class="form-row">
                                    <select id="teamAPlayerRole" class="form-input" style="width: 100%;">
                                        <option value="">Select Player Role</option>
                                        <option value="Goalkeeper">ðŸ¥… Goalkeeper</option>
                                        <option value="Defender">ðŸ›¡ï¸ Defender</option>
                                        <option value="Midfielder">ðŸŽ¯ Midfielder</option>
                                        <option value="Forward">âš¡ Forward</option>
                                        <option value="Striker">âš½ Striker</option>
                                    </select>
                                </div>
                                <button class="add-btn" onclick="addPlayerToTeam('teamA')" style="width: 100%;">+ Add
                                    Player</button>
                                <div class="player-list" id="teamAPlayerList"></div>
                            </div>
                            <div>
                                <h4 style="color: var(--accent-gold); margin-bottom: 10px;">Team B - <span
                                        id="teamBPlayerCount">0/17</span></h4>
                                <div class="form-row">
                                    <input type="text" id="teamBPlayerName" class="form-input"
                                        placeholder="Player name">
                                    <input type="number" id="teamBPlayerNumber" class="form-input"
                                        placeholder="Jersey #" min="1" max="99">
                                </div>
                                <div class="form-row">
                                    <select id="teamBPlayerRole" class="form-input" style="width: 100%;">
                                        <option value="">Select Player Role</option>
                                        <option value="Goalkeeper">ðŸ¥… Goalkeeper</option>
                                        <option value="Defender">ðŸ›¡ï¸ Defender</option>
                                        <option value="Midfielder">ðŸŽ¯ Midfielder</option>
                                        <option value="Forward">âš¡ Forward</option>
                                        <option value="Striker">âš½ Striker</option>
                                    </select>
                                </div>
                                <button class="add-btn" onclick="addPlayerToTeam('teamB')" style="width: 100%;">+ Add
                                    Player</button>
                                <div class="player-list" id="teamBPlayerList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- SPONSORS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ¢ Sponsors</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Sponsor Name</label>
                                <input type="text" id="sponsorName" class="form-input" placeholder="Sponsor name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sponsor Logo (URL or File)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="sponsorLogo" class="form-input" style="flex: 1;"
                                        placeholder="Enter logo URL">
                                    <input type="file" id="sponsorLogoFile" accept="image/*" class="form-input"
                                        style="flex: 1;" placeholder="Or upload file">
                                </div>
                            </div>
                        </div>
                        <button class="add-btn" onclick="addSponsor()">+ Add Sponsor</button>
                        <div style="margin-top: 15px;">
                            <p style="color: var(--text-gray); font-size: 0.9em;">Added Sponsors: <span
                                    id="sponsorCount">0</span></p>
                            <div class="player-list" id="sponsorsList"></div>
                        </div>
                    </div>

                    <!-- STATS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ“Š Match Stats to Display</h3>
                        <div
                            style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="margin: 0; font-size: 0.85em; color: var(--accent-green);">âœ“ Score - Required
                                (always shown)</p>
                        </div>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="statCorners" onchange="updateStats()">
                                <label for="statCorners">Corners</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statPossession" onchange="updateStats()">
                                <label for="statPossession">Possession</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statPasses" onchange="updateStats()">
                                <label for="statPasses">Passes</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statShotOnTarget" onchange="updateStats()">
                                <label for="statShotOnTarget">Shot on Target</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statShots" onchange="updateStats()">
                                <label for="statShots">Shots</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statShotsOffTarget" onchange="updateStats()">
                                <label for="statShotsOffTarget">Shots Off Target</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="statBookings" onchange="updateStats()">
                                <label for="statBookings">Bookings</label>
                            </div>
                        </div>
                    </div>

                    <!-- PREDICTIONS SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸŽ¯ Predictions (Optional)</h3>
                        <div class="checkbox-item" style="margin-bottom: 15px;">
                            <input type="checkbox" id="predictionsEnabled" onchange="updatePredictions()">
                            <label for="predictionsEnabled">Enable Predictions</label>
                        </div>
                        <div id="predictionsOptions" style="display: none;">
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="predictScore">
                                    <label for="predictScore">Predict Score</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="predictTeamToScore">
                                    <label for="predictTeamToScore">Team to Score</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="predictNumberOfGoals">
                                    <label for="predictNumberOfGoals">Number of Goals Only</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WINNING CHANCES SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ† Winning Chances (Optional)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team A Winning Chance (%)</label>
                                <input type="number" class="form-input" min="0" max="100" placeholder="0-100"
                                    onchange="matchCreationData.winningChances.teamA = parseFloat(this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Team B Winning Chance (%)</label>
                                <input type="number" class="form-input" min="0" max="100" placeholder="0-100"
                                    onchange="matchCreationData.winningChances.teamB = parseFloat(this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- DATE & TIME SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ“… Match Date & Time</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Match Date</label>
                                <input type="date" class="form-input"
                                    onchange="matchCreationData.matchDate = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Match Time</label>
                                <input type="time" class="form-input"
                                    onchange="matchCreationData.matchTime = this.value">
                            </div>
                        </div>
                    </div>

                    <!-- LIVESTREAM SECTION -->
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ“¹ Livestream Settings</h3>
                        <div class="checkbox-item" style="margin-bottom: 15px;">
                            <input type="checkbox" id="livestreamEnabled" onchange="updateMatchLivestream()">
                            <label for="livestreamEnabled">Enable Livestream for this match</label>
                        </div>
                        <div id="livestreamOptions" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Livestream Type</label>
                                    <select id="livestreamType" class="form-input" onchange="updateMatchLivestream()"
                                        style="width: 100%;">
                                        <option value="free">âœ… Free (No Charge)</option>
                                        <option value="paid">ðŸ’° Paid (With Watch Fee)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="livestreamPriceSection" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Watch Fee Price (â‚¦)</label>
                                        <input type="number" id="livestreamPrice" class="form-input"
                                            placeholder="e.g., 500" min="0"
                                            onchange="matchCreationData.livestream.price = parseFloat(this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Max Viewers Allowed</label>
                                        <input type="number" id="maxViewers" class="form-input" placeholder="e.g., 100"
                                            min="1"
                                            onchange="matchCreationData.livestream.maxViewers = parseInt(this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SUBMIT BUTTON -->
                    <div style="display: flex; gap: 10px; width: 100%; margin-top: 20px;">
                        <button type="button" class="submit-btn" id="submitBtn" onclick="submitMatchCreation()"
                            style="flex: 1;">âœ…
                            Create Match</button>
                        <button type="button" class="submit-btn"
                            style="flex: 0.3; background: rgba(255,107,107,0.2); border-color: rgba(255,107,107,0.4); color: #ff6b6b;"
                            onclick="cancelEdit()">Cancel</button>
                    </div>
                </div>

                <!-- TAB 2: LIVE MATCH -->
                <div id="liveMatchContent" class="match-tab-content" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ“¹ Select Active Match</h3>
                        <div class="form-row">
                            <select id="liveMatchSelect" class="form-input" style="width: 100%;"
                                onchange="loadLiveMatch(this.value)">
                                <option value="">-- Select a match to manage --</option>
                            </select>
                        </div>
                        <button class="watch-fee-btn" id="watchFeeButton" style="display: none;"
                            onclick="openWatchFeeModal(document.getElementById('liveMatchSelect').value)">ðŸ’³ Watch Fee
                            Management</button>
                    </div>

                    <div id="liveMatchContainer" style="display: none;">
                        <!-- Live Score Update -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">âš½ Live Score Update</h3>
                            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 3em; font-weight: bold; color: var(--accent-gold);"
                                        id="liveTeamAScore">0</div>
                                    <div style="color: var(--text-gray); margin-top: 5px;" id="liveTeamAName">Team A
                                    </div>
                                </div>
                                <div style="font-size: 2em; color: var(--text-gray);">vs</div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 3em; font-weight: bold; color: var(--accent-gold);"
                                        id="liveTeamBScore">0</div>
                                    <div style="color: var(--text-gray); margin-top: 5px;" id="liveTeamBName">Team B
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <button class="add-btn" onclick="updateLiveScore('teamA', 1)" style="flex: 1;">Team A
                                    +1</button>
                                <button class="add-btn" onclick="updateLiveScore('teamB', 1)" style="flex: 1;">Team B
                                    +1</button>
                            </div>
                            <div class="form-row">
                                <button class="add-btn" onclick="updateLiveScore('teamA', -1)"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">Team A -1</button>
                                <button class="add-btn" onclick="updateLiveScore('teamB', -1)"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">Team B -1</button>
                            </div>
                        </div>

                        <!-- Real-time Stats -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">ðŸ“Š Real-time Stats</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Corners</label>
                                    <input type="number" class="form-input" id="liveCornerA" min="0"
                                        onchange="updateLiveStat('corners', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Corners</label>
                                    <input type="number" class="form-input" id="liveCornerB" min="0"
                                        onchange="updateLiveStat('corners', 'teamB', this.value)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Possession (%)</label>
                                    <input type="number" class="form-input" id="livePossessionA" min="0" max="100"
                                        onchange="updateLiveStat('possession', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Possession (%)</label>
                                    <input type="number" class="form-input" id="livePossessionB" min="0" max="100"
                                        onchange="updateLiveStat('possession', 'teamB', this.value)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Shots</label>
                                    <input type="number" class="form-input" id="liveShotsA" min="0"
                                        onchange="updateLiveStat('shots', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Shots</label>
                                    <input type="number" class="form-input" id="liveShotsB" min="0"
                                        onchange="updateLiveStat('shots', 'teamB', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Cards & Bookings -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">ðŸŸ¨ Cards & Bookings</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Yellow Cards</label>
                                    <input type="number" class="form-input" id="liveYellowA" min="0"
                                        onchange="updateLiveStat('yellowCards', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Yellow Cards</label>
                                    <input type="number" class="form-input" id="liveYellowB" min="0"
                                        onchange="updateLiveStat('yellowCards', 'teamB', this.value)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Red Cards</label>
                                    <input type="number" class="form-input" id="liveRedA" min="0"
                                        onchange="updateLiveStat('redCards', 'teamA', this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Red Cards</label>
                                    <input type="number" class="form-input" id="liveRedB" min="0"
                                        onchange="updateLiveStat('redCards', 'teamB', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Goal Scorers Live -->
                        <div class="match-form-section goal-scorers-section">
                            <h3 class="match-form-title">âš½ Goal Scorers (Live)</h3>
                            <div class="goal-input-row">
                                <div class="form-group">
                                    <label class="form-label">Player Name</label>
                                    <input type="text" id="liveGoalScorerName" class="form-input"
                                        placeholder="Player name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="liveGoalScorerTeam" class="form-input">
                                        <option value="">Select team</option>
                                        <option value="teamA">Team A</option>
                                        <option value="teamB">Team B</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minute</label>
                                    <input type="number" id="liveGoalScorerMinute" class="form-input" placeholder="45"
                                        min="0" max="120">
                                </div>
                                <button class="add-btn" onclick="addLiveGoalScorer()"
                                    style="height: 40px; align-self: flex-end;">Add Goal</button>
                            </div>
                            <div id="liveGoalScorersList" style="margin-top: 10px;"></div>
                        </div>

                        <!-- Match Events Timeline -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">ðŸ“Š Match Events Timeline</h3>
                            <div id="liveEventsTimeline" class="events-timeline">
                                <p style="color: var(--text-gray); text-align: center; margin: 0;">No events recorded
                                    yet</p>
                            </div>
                        </div>

                        <!-- Player Substitutions -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">ðŸ”„ Player Substitutions</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Player Out</label>
                                    <input type="text" id="playerOut" class="form-input"
                                        placeholder="Player leaving field">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Player In</label>
                                    <input type="text" id="playerIn" class="form-input"
                                        placeholder="Player entering field">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="substitutionTeam" class="form-input">
                                        <option value="">Select team</option>
                                        <option value="teamA">Team A</option>
                                        <option value="teamB">Team B</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minute</label>
                                    <input type="number" id="substitutionMinute" class="form-input" placeholder="70"
                                        min="0" max="120">
                                </div>
                            </div>
                            <button class="add-btn" onclick="addSubstitution()" style="width: 100%;">+ Add
                                Substitution</button>
                            <div id="substitutionsList" style="margin-top: 15px;"></div>
                        </div>

                        <!-- Match Control -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">â±ï¸ Match Control</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Current Minute</label>
                                    <input type="number" class="form-input" id="liveMinute" min="0" max="120"
                                        onchange="updateLiveMinute(this.value)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Match Status</label>
                                    <select id="liveStatus" class="form-input" onchange="updateLiveStatus(this.value)">
                                        <option value="live">ðŸ”´ LIVE</option>
                                        <option value="halftime">â¸ï¸ Half-time</option>
                                        <option value="paused">â¸ï¸ Paused</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <button class="add-btn" onclick="finishLiveMatch()"
                                    style="flex: 1; background: rgba(0,255,136,0.2);">âœ… Finish Match</button>
                                <button class="add-btn" onclick="closeMatchCreationModal()"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">âŒ Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: FINISHED MATCH -->
                <div id="finishedMatchContent" class="match-tab-content" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">âœ… View Finished Matches</h3>
                        <div class="form-row">
                            <select id="finishedMatchSelect" class="form-input" style="width: 100%;"
                                onchange="loadFinishedMatchDetailsWithManOfMatch(this.value)">
                                <option value="">-- Select a finished match --</option>
                            </select>
                        </div>
                        <button class="watch-fee-btn" id="finishedWatchFeeButton" style="display: none;"
                            onclick="openWatchFeeModal(document.getElementById('finishedMatchSelect').value)">ðŸ’³ Watch
                            Fee Management</button>
                    </div>

                    <div id="finishedMatchContainer" style="display: none;">
                        <!-- Match Header -->
                        <div class="match-form-section">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div
                                    style="display: flex; gap: 30px; align-items: center; justify-content: center; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 1.5em; color: var(--text-white);" id="finishedTeamAName">
                                            Team A</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 3em; font-weight: bold; color: var(--accent-gold);"
                                            id="finishedScore">0 - 0</div>
                                        <div style="font-size: 0.9em; color: var(--text-gray); text-align: center;">
                                            FINAL</div>
                                    </div>
                                    <div style="flex: 1; text-align: right;">
                                        <div style="font-size: 1.5em; color: var(--text-white);" id="finishedTeamBName">
                                            Team B</div>
                                    </div>
                                </div>
                                <div style="color: var(--text-gray); font-size: 0.9em;" id="finishedMatchDate">Date &
                                    Time</div>
                            </div>
                        </div>

                        <!-- Final Statistics -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">ðŸ“Š Final Statistics</h3>
                            <div id="finishedStatsContainer"></div>
                        </div>

                        <!-- Goal Scorers -->
                        <div class="match-form-section goal-scorers-section">
                            <h3 class="match-form-title">âš½ Goal Scorers</h3>
                            <div class="goal-input-row">
                                <div class="form-group">
                                    <label class="form-label">Player Name</label>
                                    <input type="text" id="goalScorerName" class="form-input" placeholder="Player name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="goalScorerTeam" class="form-input">
                                        <option value="">Select team</option>
                                        <option value="teamA" id="goalTeamAOption">Team A</option>
                                        <option value="teamB" id="goalTeamBOption">Team B</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Minute</label>
                                    <input type="number" id="goalScorerMinute" class="form-input" placeholder="45"
                                        min="0" max="120">
                                </div>
                                <button class="add-btn" onclick="addGoalScorer()"
                                    style="height: 40px; align-self: flex-end;">Add Goal</button>
                            </div>
                            <div id="goalScorersList" style="margin-top: 10px;"></div>
                            <div id="finishedGoalScorersContainer"></div>
                        </div>

                        <!-- Man of the Match -->
                        <div class="match-form-section">
                            <h3 class="match-form-title">â­ Man of the Match</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Player Name</label>
                                    <input type="text" id="manOfMatchName" class="form-input"
                                        placeholder="Enter player name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team</label>
                                    <select id="manOfMatchTeam" class="form-input">
                                        <option value="">Select Team</option>
                                        <option value="teamA" id="manTeamAOption">Team A</option>
                                        <option value="teamB" id="manTeamBOption">Team B</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Rating (1-10)</label>
                                    <input type="number" id="manOfMatchRating" class="form-input" min="1" max="10"
                                        placeholder="e.g., 8.5">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Performance Notes</label>
                                    <input type="text" id="manOfMatchNotes" class="form-input"
                                        placeholder="e.g., Outstanding performance">
                                </div>
                            </div>
                            <button class="add-btn" onclick="saveManOfMatch()" style="width: 100%;">ðŸ’¾ Save Man of
                                Match</button>
                            <div id="manOfMatchDisplay" style="margin-top: 15px;"></div>
                        </div>

                        <!-- Actions -->
                        <div style="display: flex; gap: 10px; width: 100%; margin-top: 20px;">
                            <button class="submit-btn" onclick="downloadMatchReportPDF()" style="flex: 1;">ðŸ“¥ Admin
                                Report</button>
                            <button class="submit-btn" onclick="downloadUserReportPDF()"
                                style="flex: 1; background: rgba(0, 255, 136, 0.2); border-color: rgba(0, 255, 136, 0.4); color: var(--accent-green);">ðŸ‘¥
                                User Report</button>
                            <button class="submit-btn"
                                style="flex: 0.8; background: rgba(255,107,107,0.2); color: #ff6b6b;"
                                onclick="archiveFinishedMatch()">ðŸ—‘ï¸ Archive</button>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: UPCOMING MATCH -->
                <div id="upcomingMatchContent" class="match-tab-content" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ“… Filter Upcoming Matches</h3>
                        <div class="form-row">
                            <input type="date" id="upcomingFilterFrom" class="form-input" placeholder="From Date"
                                onchange="filterUpcomingMatches()">
                            <input type="date" id="upcomingFilterTo" class="form-input" placeholder="To Date"
                                onchange="filterUpcomingMatches()">
                            <input type="text" id="upcomingSearchTeam" class="form-input" placeholder="Search team name"
                                onchange="filterUpcomingMatches()">
                        </div>
                    </div>

                    <div id="upcomingMatchesContainer">
                        <!-- Upcoming matches will be loaded here -->
                    </div>

                    <!-- Edit Upcoming Match Section -->
                    <div id="editUpcomingSection" style="display: none;">
                        <div class="match-form-section">
                            <h3 class="match-form-title">âœï¸ Edit Upcoming Match</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Match Date</label>
                                    <input type="date" id="editUpcomingDate" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Match Time</label>
                                    <input type="time" id="editUpcomingTime" class="form-input">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Team A Name</label>
                                    <input type="text" id="editTeamAName" class="form-input" placeholder="Team A">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Team B Name</label>
                                    <input type="text" id="editTeamBName" class="form-input" placeholder="Team B">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Winning Chance Team A (%)</label>
                                    <input type="number" id="editWinChanceA" class="form-input" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Winning Chance Team B (%)</label>
                                    <input type="number" id="editWinChanceB" class="form-input" min="0" max="100">
                                </div>
                            </div>

                            <div class="form-row">
                                <button class="add-btn" onclick="saveUpcomingMatchEdit()"
                                    style="flex: 1; background: rgba(0,255,136,0.2);">âœ… Save Changes</button>
                                <button class="add-btn" onclick="cancelUpcomingMatchEdit()"
                                    style="flex: 1; background: rgba(255,107,107,0.2);">âŒ Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOCATION PERMISSION MODAL -->
    <div class="location-permission-overlay" id="locationPermissionOverlay">
        <div class="location-permission-modal">
            <div class="location-permission-title">
                ðŸ“ Enable Location Access
            </div>

            <div class="location-permission-subtitle">
                Help us improve your experience and provide better regional insights by allowing location access.
            </div>

            <div
                style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 20px; font-size: 0.9em; color: var(--accent-green); text-align: center;">
                <strong>âš¡ A browser popup will appear</strong><br>
                Click "Allow" in the popup to enable location access
            </div>

            <div class="location-permission-benefits">
                <ul>
                    <li>Accurate geographic analytics in your profile</li>
                    <li>Better regional recommendations</li>
                    <li>Faster location-based services</li>
                    <li>Help improve platform statistics</li>
                </ul>
            </div>

            <div
                style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 25px; font-size: 0.85em; color: var(--text-gray); text-align: center;">
                Your location data is encrypted and stored securely. You can change this setting anytime in your
                profile.
            </div>

            <div class="location-permission-actions">
                <button class="location-btn location-btn-allow" onclick="allowLocationAccess()">
                    ðŸ“ Enable Location (Browser Popup)
                </button>
                <button class="location-btn location-btn-skip" onclick="skipLocationAccess()">
                    Skip for Now
                </button>
            </div>

            <div class="location-status" id="locationStatus"></div>
        </div>
    </div>

    <!-- FINANCIAL REPORTS MODAL -->
    <div class="reports-modal-overlay" id="reportsModalOverlay">
        <div class="reports-modal">
            <div class="reports-modal-header">
                <h2 class="reports-modal-title">ðŸ“ˆ Financial Reports</h2>
                <span class="reports-modal-close" onclick="closeFinancialReportsModal()">Ã—</span>
            </div>

            <div class="reports-modal-content">
                <!-- Report Tabs -->
                <div class="report-tabs">
                    <button class="report-tab active" onclick="switchReportTab('overview')">ðŸ“Š Overview</button>
                    <button class="report-tab" onclick="switchReportTab('users')">ðŸ‘¥ Top Users</button>
                    <button class="report-tab" onclick="switchReportTab('geographic')">ðŸ—ºï¸ Geographic</button>
                    <button class="report-tab" onclick="switchReportTab('devices')">ðŸ“± Devices</button>
                    <button class="report-tab" onclick="switchReportTab('livestream')">ðŸ“¹ Livestream Revenue</button>
                </div>

                <!-- Reports Container -->
                <div id="reportsContainer">
                    <!-- Reports will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- TRANSACTIONS MODAL -->
    <div class="transactions-modal-overlay" id="transactionsModalOverlay">
        <div class="transactions-modal">
            <div class="transactions-modal-header">
                <h2 class="transactions-modal-title">ðŸ’³ Transaction History</h2>
                <span class="transactions-modal-close" onclick="closeTransactionsModal()">Ã—</span>
            </div>

            <div class="transactions-modal-content">
                <!-- Status Tabs -->
                <div class="tx-status-tabs">
                    <button class="tx-status-tab active"
                        onclick="filterTransactionsByStatus('all'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">All
                        Transactions</button>
                    <button class="tx-status-tab"
                        onclick="filterTransactionsByStatus('successful'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">âœ…
                        Successful</button>
                    <button class="tx-status-tab"
                        onclick="filterTransactionsByStatus('pending'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">â³
                        Pending</button>
                    <button class="tx-status-tab"
                        onclick="filterTransactionsByStatus('failed'); this.parentElement.querySelectorAll('.tx-status-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">âŒ
                        Failed/Rejected</button>
                </div>

                <!-- Type Tabs (Deposit/Withdrawal) -->
                <div class="tx-type-tabs">
                    <button class="tx-type-tab active"
                        onclick="filterTransactionsByType('all'); this.parentElement.querySelectorAll('.tx-type-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">All
                        Types</button>
                    <button class="tx-type-tab"
                        onclick="filterTransactionsByType('deposit'); this.parentElement.querySelectorAll('.tx-type-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">ðŸ“¥
                        Deposits</button>
                    <button class="tx-type-tab"
                        onclick="filterTransactionsByType('withdrawal'); this.parentElement.querySelectorAll('.tx-type-tab').forEach(b => b.classList.remove('active')); this.classList.add('active');">ðŸ“¤
                        Withdrawals</button>
                </div>

                <!-- Filters Section -->
                <div class="tx-filters-section">
                    <div class="tx-filter-group">
                        <label class="tx-filter-label">Filter by Days</label>
                        <select class="tx-filter-select" onchange="filterTransactionsByDate(this.value)">
                            <option value="1hr">Last 1 Hour</option>
                            <option value="2hrs">Last 2 Hours</option>
                            <option value="3days">Last 3 Days</option>
                            <option value="7days" selected>Last 7 Days</option>
                            <option value="30days">Last 30 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>

                    <div class="tx-filter-group">
                        <label class="tx-filter-label">Search</label>
                        <input type="text" class="tx-search-input" id="txSearchInput"
                            placeholder="Username, Email, DLS Account..." oninput="searchTransactions(this.value)">
                    </div>
                </div>

                <!-- Transactions List -->
                <div class="tx-list-container" id="transactionsListContainer">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- PREDICTIONS MODAL -->
    <div class="transactions-modal-overlay" id="predictionsModalOverlay">
        <div class="transactions-modal">
            <div class="transactions-modal-header">
                <h2 class="transactions-modal-title">ðŸŽ¯ Manage Predictions</h2>
                <span class="transactions-modal-close" onclick="closePredictionsModal()">Ã—</span>
            </div>
            <div class="transactions-modal-content" style="padding: 30px;">
                <div class="match-form-section">
                    <h3 class="match-form-title">Select Match for Predictions</h3>
                    <select id="predictionsMatchSelect" class="form-input" style="width: 100%;"
                        onchange="loadPredictionsForMatch(this.value)">
                        <option value="">-- Select a match --</option>
                    </select>
                </div>

                <div id="predictionsContainer" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">âš½ Prediction Types</h3>
                        <div class="predictions-section">
                            <h4 style="color: var(--accent-gold); margin-bottom: 15px;">Available Prediction Markets
                            </h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="pred_scoreEnabled" onchange="updatePredictionTypes()">
                                    <label for="pred_scoreEnabled">Predict Exact Score (e.g., 2-1)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="pred_teamEnabled" onchange="updatePredictionTypes()">
                                    <label for="pred_teamEnabled">Predict Team to Score</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="pred_goalsEnabled" onchange="updatePredictionTypes()">
                                    <label for="pred_goalsEnabled">Predict Number of Goals Only</label>
                                </div>
                            </div>
                        </div>

                        <div id="pred_scoreOptions" style="display: none;">
                            <h4 style="color: var(--accent-gold); margin-top: 20px; margin-bottom: 10px;">Exact Score
                                Predictions</h4>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label">Team A Score</label>
                                    <input type="number" id="predTeamAScore" class="form-input" min="0" max="20"
                                        placeholder="0">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button class="add-btn" onclick="addScorePrediction()"
                                        style="width: 100%; margin-bottom: 0;">Add Score</button>
                                </div>
                                <div>
                                    <label class="form-label">Team B Score</label>
                                    <input type="number" id="predTeamBScore" class="form-input" min="0" max="20"
                                        placeholder="0">
                                </div>
                            </div>
                            <div id="scorePredictionsList"></div>
                        </div>

                        <div id="pred_teamOptions" style="display: none;">
                            <h4 style="color: var(--accent-gold); margin-top: 20px; margin-bottom: 10px;">Team to Score
                                Predictions</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <button class="add-btn" onclick="addTeamPrediction('teamA')"
                                    style="background: rgba(100, 150, 255, 0.2); border-color: rgba(100, 150, 255, 0.4);">Team
                                    A Will Score</button>
                                <button class="add-btn" onclick="addTeamPrediction('teamB')"
                                    style="background: rgba(255, 150, 100, 0.2); border-color: rgba(255, 150, 100, 0.4);">Team
                                    B Will Score</button>
                            </div>
                            <div id="teamPredictionsList"></div>
                        </div>

                        <div id="pred_goalsOptions" style="display: none;">
                            <h4 style="color: var(--accent-gold); margin-top: 20px; margin-bottom: 10px;">Total Goals
                                Predictions</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label">Total Goals</label>
                                    <input type="number" id="predTotalGoals" class="form-input" min="0" max="30"
                                        placeholder="0">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button class="add-btn" onclick="addGoalsPrediction()"
                                        style="width: 100%; margin-bottom: 0;">Add Prediction</button>
                                </div>
                            </div>
                            <div id="goalsPredictionsList"></div>
                        </div>
                    </div>

                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ’¾ Save Predictions</h3>
                        <button class="submit-btn" onclick="savePredictions()" style="width: 100%;">âœ… Save All
                            Predictions</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GOAL SCORERS MODAL -->
    <div class="transactions-modal-overlay" id="goalScorersModalOverlay">
        <div class="transactions-modal">
            <div class="transactions-modal-header">
                <h2 class="transactions-modal-title">âš½ Goal Scorers</h2>
                <span class="transactions-modal-close" onclick="closeGoalScorersModal()">Ã—</span>
            </div>
            <div class="transactions-modal-content" style="padding: 30px; overflow-y: auto;">
                <div class="match-form-section">
                    <h3 class="match-form-title">Select Match</h3>
                    <select id="goalScorersMatchSelect" class="form-input" style="width: 100%;"
                        onchange="loadGoalScorersForMatch(this.value)">
                        <option value="">-- Select a match --</option>
                    </select>
                </div>

                <div id="goalScorersContainer" style="display: none;">
                    <div class="match-form-section">
                        <h3 class="match-form-title">âž• Add Goal Scorer</h3>
                        <div class="goal-input-row">
                            <select id="goalScorerTeam" class="form-input">
                                <option value="teamA">Team A</option>
                                <option value="teamB">Team B</option>
                            </select>
                            <input type="text" id="goalScorerName" class="form-input" placeholder="Player name">
                            <input type="number" id="goalScorerMinute" class="form-input" placeholder="Minute" min="0"
                                max="120">
                            <button class="add-btn" onclick="addGoalScorer()" style="padding: 10px 15px;">âž• Add</button>
                        </div>
                    </div>

                    <div class="match-form-section">
                        <h3 class="match-form-title">ðŸ“‹ Goal Scorers List</h3>
                        <div id="goalScorersList"></div>
                    </div>

                    <div class="match-form-section">
                        <button class="submit-btn" onclick="saveGoalScorers()" style="width: 100%;">ðŸ’¾ Save Goal
                            Scorers</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WATCH FEE MODAL -->
    <div class="watch-fee-modal" id="watchFeeModal">
        <div class="watch-fee-content">
            <div class="watch-fee-header">
                <h2 class="watch-fee-title">ðŸ’³ Watch Fee Management</h2>
                <button class="watch-fee-close" onclick="closeWatchFeeModal()">Ã—</button>
            </div>

            <div id="watchFeeMatchInfo"
                style="background: rgba(0, 255, 136, 0.1); border-left: 4px solid rgba(0, 255, 136, 0.5); padding: 15px; border-radius: 8px; margin-bottom: 25px; display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 5px;">Match</div>
                        <div id="watchFeeMatchName"
                            style="font-weight: 600; color: var(--text-white); font-size: 1.1em;"></div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 5px;">Fee</div>
                        <div id="watchFeePrice" style="font-weight: 900; color: var(--accent-gold); font-size: 1.1em;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="watch-fee-tabs">
                <button class="watch-fee-tab active" onclick="switchWatchFeeTab('stats')">ðŸ“Š Statistics</button>
                <button class="watch-fee-tab" onclick="switchWatchFeeTab('paidViewers')">ðŸ‘¥ Paid Viewers</button>
            </div>

            <!-- Stats Tab -->
            <div id="statsTab" class="watch-fee-tab-content active">
                <h3 style="color: var(--accent-gold); margin-bottom: 20px; font-size: 1.3em;">ðŸ“ˆ Audience Statistics
                </h3>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Viewers</div>
                        <div class="stat-value" id="totalViewers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Livestream Revenue</div>
                        <div class="stat-value" id="totalLivestreamRevenue">â‚¦0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Paid Viewers</div>
                        <div class="stat-value" id="paidViewersCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Watch Time</div>
                        <div class="stat-value" id="avgWatchTime">0m</div>
                    </div>
                </div>

                <div
                    style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #00d4ff; margin-bottom: 10px;">Viewing Platform Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em;">
                        <div>
                            <span style="color: var(--text-gray);">Peak Concurrent Viewers:</span>
                            <div style="color: var(--text-white); font-weight: 600; margin-top: 5px;" id="peakViewers">0
                            </div>
                        </div>
                        <div>
                            <span style="color: var(--text-gray);">Stream Duration:</span>
                            <div style="color: var(--text-white); font-weight: 600; margin-top: 5px;"
                                id="streamDuration">0m</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paid Viewers Tab -->
            <div id="paidViewersTab" class="watch-fee-tab-content">
                <h3 style="color: var(--accent-gold); margin-bottom: 20px; font-size: 1.3em;">ðŸ’° Paid Viewers List</h3>

                <div id="paidViewersList" class="viewers-list">
                    <div class="no-viewers-message">No paid viewers yet</div>
                </div>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(255, 215, 0, 0.1);">
                <button class="submit-btn" onclick="closeWatchFeeModal()" style="width: 100%;">âœ… Close</button>
            </div>
        </div>
    </div>

    <!-- TOURNAMENT MODAL -->
    <div class="watch-fee-modal" id="tournamentModal">
        <div class="watch-fee-content" style="position: relative;">
            <div class="watch-fee-header">
                <h2 class="watch-fee-title">ðŸ† Tournament Management</h2>
                <button class="watch-fee-close" onclick="closeTournamentModal()">Ã—</button>
            </div>

            <div id="tournamentMatchInfo"
                style="background: rgba(0, 255, 136, 0.1); border-left: 4px solid rgba(0, 255, 136, 0.5); padding: 15px; border-radius: 8px; margin-bottom: 25px; display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 5px;">Tournament</div>
                        <div id="tournamentName" style="font-weight: 600; color: var(--text-white); font-size: 1.1em;">
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 5px;">Status</div>
                        <div id="tournamentStatus"
                            style="font-weight: 900; color: var(--accent-gold); font-size: 1.1em;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tournament Overlay Modal -->
            <div class="watch-fee-modal" id="tournamentOverlayModal">
                <div class="watch-fee-content">
                    <!-- Header -->
                    <div class="watch-fee-header">
                        <h2 class="watch-fee-title" id="overlayTournamentName">ðŸ† Tournament</h2>
                        <button class="watch-fee-close" onclick="closeTournamentOverlay()">Ã—</button>
                    </div>

                    <!-- Main Tabs -->
                    <div class="watch-fee-tabs">
                        <button class="watch-fee-tab active" onclick="switchTournamentOverlayTab('createMatch')">âž•
                            Create Match</button>
                        <button class="watch-fee-tab" onclick="switchTournamentOverlayTab('matches')">âš½ Matches</button>
                        <button class="watch-fee-tab" onclick="switchTournamentOverlayTab('table')">ðŸ… Table</button>
                        <button class="watch-fee-tab" onclick="switchTournamentOverlayTab('overview')">ðŸ“Š
                            Overview</button>
                    </div>

                    <!-- Create Match Tab (Same as SET MATCH from single match) -->
                    <div id="overlayCreateMatchTab" class="watch-fee-tab-content active"
                        style="display: block; overflow-y: auto; max-height: calc(100vh - 300px);">
                        <form id="createTournamentMatchForm">
                            <!-- Match Name -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ“ Match Name</h3>
                                <div class="form-group">
                                    <label class="form-label">Match Name (e.g., Cup Final, League Match 1)</label>
                                    <input type="text" id="tournamentMatchName" class="form-input"
                                        placeholder="Enter match name" onchange="tournamentMatchData.name = this.value">
                                </div>
                            </div>

                            <!-- TEAMS SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">âš½ Teams</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Team A Name</label>
                                        <input type="text" class="form-input" placeholder="Enter team name"
                                            onchange="tournamentMatchData.teamA.name = this.value">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Team A Logo (URL or File)</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" class="form-input" style="flex: 1;"
                                                placeholder="Enter logo URL"
                                                onchange="tournamentMatchData.teamA.logo = this.value">
                                            <input type="file" id="tournamentTeamALogoFile" accept="image/*"
                                                class="form-input" style="flex: 1;"
                                                onchange="handleTournamentLogoUpload('teamA', this)">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Team B Name</label>
                                        <input type="text" class="form-input" placeholder="Enter team name"
                                            onchange="tournamentMatchData.teamB.name = this.value">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Team B Logo (URL or File)</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" class="form-input" style="flex: 1;"
                                                placeholder="Enter logo URL"
                                                onchange="tournamentMatchData.teamB.logo = this.value">
                                            <input type="file" id="tournamentTeamBLogoFile" accept="image/*"
                                                class="form-input" style="flex: 1;"
                                                onchange="handleTournamentLogoUpload('teamB', this)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MANAGEMENT SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ‘¥ Management</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Team A - DLS Player</label>
                                        <input type="text" class="form-input" placeholder="Enter DLS player name"
                                            onchange="tournamentMatchData.teamA.dlsPlayer = this.value">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Team A - Club Owner</label>
                                        <input type="text" class="form-input" placeholder="Enter club owner"
                                            onchange="tournamentMatchData.teamA.clubOwner = this.value">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Team B - DLS Player</label>
                                        <input type="text" class="form-input" placeholder="Enter DLS player name"
                                            onchange="tournamentMatchData.teamB.dlsPlayer = this.value">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Team B - Club Owner</label>
                                        <input type="text" class="form-input" placeholder="Enter club owner"
                                            onchange="tournamentMatchData.teamB.clubOwner = this.value">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Team A Captain</label>
                                        <input type="text" class="form-input" placeholder="Captain name"
                                            onchange="tournamentMatchData.teamA.captain = this.value">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Team B Captain</label>
                                        <input type="text" class="form-input" placeholder="Captain name"
                                            onchange="tournamentMatchData.teamB.captain = this.value">
                                    </div>
                                </div>
                            </div>

                            <!-- PLAYERS SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ‘¨â€ðŸ¦² Players (Max 17 per team)</h3>
                                <div class="players-section">
                                    <div>
                                        <h4 style="color: var(--accent-gold); margin-bottom: 10px;">Team A - <span
                                                id="tournamentTeamAPlayerCount">0/17</span></h4>
                                        <div class="form-row">
                                            <input type="text" id="tournamentTeamAPlayerName" class="form-input"
                                                placeholder="Player name">
                                            <input type="number" id="tournamentTeamAPlayerNumber" class="form-input"
                                                placeholder="Jersey #" min="1" max="99">
                                        </div>
                                        <div class="form-row">
                                            <select id="tournamentTeamAPlayerRole" class="form-input"
                                                style="width: 100%;">
                                                <option value="">Select Player Role</option>
                                                <option value="Goalkeeper">ðŸ¥… Goalkeeper</option>
                                                <option value="Defender">ðŸ›¡ï¸ Defender</option>
                                                <option value="Midfielder">ðŸŽ¯ Midfielder</option>
                                                <option value="Forward">âš¡ Forward</option>
                                                <option value="Striker">âš½ Striker</option>
                                            </select>
                                        </div>
                                        <button type="button" class="add-btn"
                                            onclick="addPlayerToTournamentTeam('teamA')" style="width: 100%;">+ Add
                                            Player</button>
                                        <div class="player-list" id="tournamentTeamAPlayerList"></div>
                                    </div>
                                    <div>
                                        <h4 style="color: var(--accent-gold); margin-bottom: 10px;">Team B - <span
                                                id="tournamentTeamBPlayerCount">0/17</span></h4>
                                        <div class="form-row">
                                            <input type="text" id="tournamentTeamBPlayerName" class="form-input"
                                                placeholder="Player name">
                                            <input type="number" id="tournamentTeamBPlayerNumber" class="form-input"
                                                placeholder="Jersey #" min="1" max="99">
                                        </div>
                                        <div class="form-row">
                                            <select id="tournamentTeamBPlayerRole" class="form-input"
                                                style="width: 100%;">
                                                <option value="">Select Player Role</option>
                                                <option value="Goalkeeper">ðŸ¥… Goalkeeper</option>
                                                <option value="Defender">ðŸ›¡ï¸ Defender</option>
                                                <option value="Midfielder">ðŸŽ¯ Midfielder</option>
                                                <option value="Forward">âš¡ Forward</option>
                                                <option value="Striker">âš½ Striker</option>
                                            </select>
                                        </div>
                                        <button type="button" class="add-btn"
                                            onclick="addPlayerToTournamentTeam('teamB')" style="width: 100%;">+ Add
                                            Player</button>
                                        <div class="player-list" id="tournamentTeamBPlayerList"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- SPONSORS SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ¢ Sponsors</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Sponsor Name</label>
                                        <input type="text" id="tournamentSponsorName" class="form-input"
                                            placeholder="Sponsor name">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Sponsor Logo (URL or File)</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="tournamentSponsorLogo" class="form-input"
                                                style="flex: 1;" placeholder="Enter logo URL">
                                            <input type="file" id="tournamentSponsorLogoFile" accept="image/*"
                                                class="form-input" style="flex: 1;"
                                                onchange="handleTournamentSponsorLogoUpload(this)">
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="add-btn" onclick="addTournamentSponsor()">+ Add
                                    Sponsor</button>
                                <div style="margin-top: 15px;">
                                    <p style="color: var(--text-gray); font-size: 0.9em;">Added Sponsors: <span
                                            id="tournamentSponsorCount">0</span></p>
                                    <div class="player-list" id="tournamentSponsorsList"></div>
                                </div>
                            </div>

                            <!-- STATS SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ“Š Match Stats to Display</h3>
                                <div
                                    style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                    <p style="margin: 0; font-size: 0.85em; color: var(--accent-green);">âœ“ Score -
                                        Required (always shown)</p>
                                </div>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tournamentStatCorners"
                                            onchange="updateTournamentStats()">
                                        <label for="tournamentStatCorners">Corners</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tournamentStatPossession"
                                            onchange="updateTournamentStats()">
                                        <label for="tournamentStatPossession">Possession</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tournamentStatPasses"
                                            onchange="updateTournamentStats()">
                                        <label for="tournamentStatPasses">Passes</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tournamentStatShotOnTarget"
                                            onchange="updateTournamentStats()">
                                        <label for="tournamentStatShotOnTarget">Shot on Target</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tournamentStatShots"
                                            onchange="updateTournamentStats()">
                                        <label for="tournamentStatShots">Shots</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tournamentStatShotsOffTarget"
                                            onchange="updateTournamentStats()">
                                        <label for="tournamentStatShotsOffTarget">Shots Off Target</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="tournamentStatBookings"
                                            onchange="updateTournamentStats()">
                                        <label for="tournamentStatBookings">Bookings</label>
                                    </div>
                                </div>
                            </div>

                            <!-- PREDICTIONS SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸŽ¯ Predictions (Optional)</h3>
                                <div class="checkbox-item" style="margin-bottom: 15px;">
                                    <input type="checkbox" id="tournamentPredictionsEnabled"
                                        onchange="updateTournamentPredictions()">
                                    <label for="tournamentPredictionsEnabled">Enable Predictions</label>
                                </div>
                                <div id="tournamentPredictionsOptions" style="display: none;">
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="tournamentPredictScore">
                                            <label for="tournamentPredictScore">Predict Score</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="tournamentPredictTeamToScore">
                                            <label for="tournamentPredictTeamToScore">Team to Score</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="tournamentPredictNumberOfGoals">
                                            <label for="tournamentPredictNumberOfGoals">Number of Goals Only</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- WINNING CHANCES SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ† Winning Chances (Optional)</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Team A Winning Chance (%)</label>
                                        <input type="number" class="form-input" min="0" max="100" placeholder="0-100"
                                            onchange="tournamentMatchData.winningChances.teamA = parseFloat(this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Team B Winning Chance (%)</label>
                                        <input type="number" class="form-input" min="0" max="100" placeholder="0-100"
                                            onchange="tournamentMatchData.winningChances.teamB = parseFloat(this.value)">
                                    </div>
                                </div>
                            </div>

                            <!-- DATE & TIME SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ“… Match Date & Time</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Match Date</label>
                                        <input type="date" class="form-input"
                                            onchange="tournamentMatchData.matchDate = this.value">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Match Time</label>
                                        <input type="time" class="form-input"
                                            onchange="tournamentMatchData.matchTime = this.value">
                                    </div>
                                </div>
                            </div>

                            <!-- LIVESTREAM SECTION -->
                            <div class="match-form-section">
                                <h3 class="match-form-title">ðŸ“¹ Livestream Settings</h3>
                                <div class="checkbox-item" style="margin-bottom: 15px;">
                                    <input type="checkbox" id="tournamentLivestreamsEnabled"
                                        onchange="updateTournamentLivestream()">
                                    <label for="tournamentLivestreamsEnabled">Enable Livestream for this match</label>
                                </div>
                                <div id="tournamentLivestreamOptions" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Livestream Type</label>
                                            <select id="tournamentLivestreamType" class="form-input"
                                                onchange="updateTournamentLivestream()" style="width: 100%;">
                                                <option value="free">âœ… Free (No Charge)</option>
                                                <option value="paid">ðŸ’° Paid (With Watch Fee)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="tournamentLivestreamPriceSection" style="display: none;">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label">Watch Fee Price (â‚¦)</label>
                                                <input type="number" id="tournamentLivestreamPrice" class="form-input"
                                                    placeholder="e.g., 500" min="0"
                                                    onchange="tournamentMatchData.livestream.price = parseFloat(this.value)">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Max Viewers Allowed</label>
                                                <input type="number" id="tournamentMaxViewers" class="form-input"
                                                    placeholder="e.g., 100" min="1"
                                                    onchange="tournamentMatchData.livestream.maxViewers = parseInt(this.value)">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Create Button -->
                            <div
                                style="position: sticky; bottom: 0; background: var(--primary-dark); padding: 20px 0; margin-top: 30px;">
                                <button type="button" onclick="createTournamentMatch()"
                                    style="width: 100%; padding: 15px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1em;">
                                    âœ… Create Match
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Matches Tab -->
                    <div id="overlayMatchesTab" class="watch-fee-tab-content" style="display: none;">
                        <div class="watch-fee-tabs" style="margin-bottom: 20px;">
                            <button class="watch-fee-tab active" onclick="switchTournamentMatchStatusTab('live')">ðŸ”´
                                Live</button>
                            <button class="watch-fee-tab" onclick="switchTournamentMatchStatusTab('upcoming')">â°
                                Upcoming</button>
                            <button class="watch-fee-tab" onclick="switchTournamentMatchStatusTab('finished')">âœ…
                                Finished</button>
                            <button class="watch-fee-tab" onclick="switchTournamentMatchStatusTab('cancelled')">âŒ
                                Cancelled</button>
                        </div>
                        <div id="overlayLiveMatchesContent" style="display: block;"></div>
                        <div id="overlayUpcomingMatchesContent" style="display: none;"></div>
                        <div id="overlayFinishedMatchesContent" style="display: none;"></div>
                        <div id="overlayCancelledMatchesContent" style="display: none;"></div>
                    </div>

                    <!-- Table Tab -->
                    <div id="overlayTableTab" class="watch-fee-tab-content" style="display: none;">
                        <div style="padding: 20px;">
                            <!-- Controls -->
                            <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                                <button onclick="openAddClubModal()"
                                    style="padding: 12px 20px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='rgba(0, 255, 136, 0.3)'"
                                    onmouseout="this.style.background='rgba(0, 255, 136, 0.2)'">âž• Add Club</button>
                                <button onclick="refreshTournamentStandings()"
                                    style="padding: 12px 20px; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--accent-gold); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='rgba(255, 215, 0, 0.25)'"
                                    onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'">ðŸ”„ Refresh</button>
                            </div>

                            <!-- Table -->
                            <div style="overflow-x: auto;">
                                <table id="tournamentStandingsTable"
                                    style="width: 100%; border-collapse: collapse; background: rgba(255, 215, 0, 0.02);">
                                    <thead>
                                        <tr
                                            style="background: rgba(255, 215, 0, 0.1); border-bottom: 2px solid rgba(255, 215, 0, 0.3);">
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                POS</th>
                                            <th
                                                style="padding: 12px; text-align: left; color: var(--accent-gold); font-weight: 700;">
                                                TEAM</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                PL</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                W</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                D</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                L</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                GF</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                GA</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                GD</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                FORM</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                PTS</th>
                                            <th
                                                style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">
                                                ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="standingsTableBody">
                                        <tr>
                                            <td colspan="11"
                                                style="text-align: center; padding: 40px; color: var(--text-gray);">
                                                Loading tournament standings...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Legend -->
                            <div
                                style="margin-top: 30px; padding: 15px; background: rgba(0, 255, 136, 0.05); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 8px; font-size: 0.9em;">
                                <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 10px;">ðŸ“Š
                                    Legend:</div>
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; color: var(--text-white);">
                                    <div>PL - Played</div>
                                    <div>W - Wins</div>
                                    <div>D - Draws</div>
                                    <div>L - Losses</div>
                                    <div>GF - Goals For</div>
                                    <div>GA - Goals Against</div>
                                    <div>GD - Goal Difference</div>
                                    <div>PTS - Points</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Overview Tab -->
                    <div id="overlayOverviewTab" class="watch-fee-tab-content" style="display: none;">
                        <div class="watch-fee-tabs" style="margin-bottom: 20px;">
                            <button class="watch-fee-tab active" onclick="switchTournamentAnalysisTab('finances')">ðŸ’°
                                Finances</button>
                            <button class="watch-fee-tab" onclick="switchTournamentAnalysisTab('matches')">âš½
                                Matches</button>
                            <button class="watch-fee-tab" onclick="switchTournamentAnalysisTab('livestreams')">ðŸ“¹
                                Livestreams</button>
                            <button class="watch-fee-tab" onclick="switchTournamentAnalysisTab('viewers')">ðŸ‘¥
                                Viewers</button>
                        </div>
                        <!-- Finances Tab Content -->
                        <div id="overlayFinancesContent" style="display: block;">
                            <div style="padding: 25px;">
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                                    <div
                                        style="background: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.4); border-radius: 15px; padding: 30px; text-align: center;">
                                        <div
                                            style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 10px; text-transform: uppercase; font-weight: 700;">
                                            Total Revenue</div>
                                        <div style="font-size: 3.5em; color: var(--accent-gold); font-weight: 900;">
                                            â‚¦0.00</div>
                                    </div>
                                    <div
                                        style="background: rgba(0, 255, 136, 0.1); border: 2px solid rgba(0, 255, 136, 0.4); border-radius: 15px; padding: 30px; text-align: center;">
                                        <div
                                            style="font-size: 0.9em; color: var(--text-gray); margin-bottom: 10px; text-transform: uppercase; font-weight: 700;">
                                            Watch Fee Revenue</div>
                                        <div style="font-size: 3.5em; color: var(--accent-green); font-weight: 900;">
                                            â‚¦0.00</div>
                                    </div>
                                </div>
                                <div
                                    style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 30px;">
                                    <div
                                        style="color: var(--accent-gold); font-weight: 700; margin-bottom: 20px; font-size: 1.2em;">
                                        ðŸ“Š Income Graph</div>
                                    <div id="incomeGraphContainer"
                                        style="height: 300px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; display: flex; align-items: flex-end; gap: 15px; padding: 20px; justify-content: center;">
                                        <div style="text-align: center; color: var(--text-gray);">Loading graph...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Matches Tab Content -->
                        <div id="overlayMatchesAnalysisContent" style="display: none;">
                            <div style="padding: 25px;">
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                                    <div
                                        style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Total Matches</div>
                                        <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">0
                                        </div>
                                    </div>
                                    <div
                                        style="background: rgba(255, 100, 100, 0.08); border: 2px solid rgba(255, 100, 100, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            ðŸ”´ Live</div>
                                        <div
                                            style="font-size: 2.2em; color: rgba(255, 100, 100, 0.8); font-weight: 700;">
                                            0</div>
                                    </div>
                                    <div
                                        style="background: rgba(0, 255, 136, 0.08); border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            âœ… Finished</div>
                                        <div style="font-size: 2.2em; color: var(--accent-green); font-weight: 700;">0
                                        </div>
                                    </div>
                                    <div
                                        style="background: rgba(100, 200, 255, 0.08); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            â° Upcoming</div>
                                        <div
                                            style="font-size: 2.2em; color: rgba(100, 200, 255, 0.8); font-weight: 700;">
                                            0</div>
                                    </div>
                                    <div
                                        style="background: rgba(255, 107, 107, 0.08); border: 2px solid rgba(255, 107, 107, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            âŒ Cancelled</div>
                                        <div
                                            style="font-size: 2.2em; color: rgba(255, 107, 107, 0.8); font-weight: 700;">
                                            0</div>
                                    </div>
                                </div>
                                <div
                                    style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                                    <div
                                        style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">
                                        âš½ Performance Statistics</div>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                        <div>
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">
                                                Total Goals</div>
                                            <div
                                                style="color: var(--accent-green); font-weight: 700; font-size: 1.6em;">
                                                0</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">
                                                Avg Goals/Match</div>
                                            <div
                                                style="color: var(--accent-green); font-weight: 700; font-size: 1.6em;">
                                                0.00</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">
                                                Wins</div>
                                            <div
                                                style="color: rgba(0, 255, 136, 0.8); font-weight: 700; font-size: 1.6em;">
                                                0</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">
                                                Draws</div>
                                            <div style="color: var(--accent-gold); font-weight: 700; font-size: 1.6em;">
                                                0</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">
                                                Losses</div>
                                            <div
                                                style="color: rgba(255, 100, 100, 0.8); font-weight: 700; font-size: 1.6em;">
                                                0</div>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px;">
                                    <div
                                        style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">
                                        ðŸ“‹ Match Results</div>
                                    <div
                                        style="max-height: 400px; overflow-y: auto; color: var(--text-gray); text-align: center; padding: 20px;">
                                        Loading match data...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Livestreams Tab Content -->
                        <div id="overlayLivestreamsContent" style="display: none;">
                            <div style="padding: 25px;">
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                                    <div
                                        style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Total Livestreams</div>
                                        <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">0
                                        </div>
                                    </div>
                                    <div
                                        style="background: rgba(100, 200, 255, 0.08); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Total Viewers</div>
                                        <div
                                            style="font-size: 2.2em; color: rgba(100, 200, 255, 0.8); font-weight: 700;">
                                            0</div>
                                    </div>
                                    <div
                                        style="background: rgba(255, 100, 100, 0.08); border: 2px solid rgba(255, 100, 100, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Peak Viewers</div>
                                        <div
                                            style="font-size: 2.2em; color: rgba(255, 100, 100, 0.8); font-weight: 700;">
                                            0</div>
                                    </div>
                                    <div
                                        style="background: rgba(0, 255, 136, 0.08); border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Avg Viewers</div>
                                        <div style="font-size: 2.2em; color: var(--accent-green); font-weight: 700;">0
                                        </div>
                                    </div>
                                    <div
                                        style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Avg Duration</div>
                                        <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">0
                                            min</div>
                                    </div>
                                </div>
                                <div
                                    style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px;">
                                    <div
                                        style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">
                                        ðŸ“¹ Livestream Details</div>
                                    <div
                                        style="max-height: 400px; overflow-y: auto; color: var(--text-gray); text-align: center; padding: 20px;">
                                        Loading livestream data...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Viewers Tab Content -->
                        <div id="overlayViewersContent" style="display: none;">
                            <div style="padding: 25px;">
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                                    <div
                                        style="background: rgba(100, 200, 255, 0.08); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Unique Viewers</div>
                                        <div
                                            style="font-size: 2.2em; color: rgba(100, 200, 255, 0.8); font-weight: 700;">
                                            0</div>
                                    </div>
                                    <div
                                        style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Total Viewership</div>
                                        <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">0
                                        </div>
                                    </div>
                                    <div
                                        style="background: rgba(255, 100, 100, 0.08); border: 2px solid rgba(255, 100, 100, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Peak Single Match</div>
                                        <div
                                            style="font-size: 2.2em; color: rgba(255, 100, 100, 0.8); font-weight: 700;">
                                            0</div>
                                    </div>
                                    <div
                                        style="background: rgba(0, 255, 136, 0.08); border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                        <div
                                            style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">
                                            Avg Engagement</div>
                                        <div style="font-size: 2.2em; color: var(--accent-green); font-weight: 700;">0
                                        </div>
                                        <div style="font-size: 0.75em; color: var(--text-gray);">Comments per Match
                                        </div>
                                    </div>
                                </div>
                                <div
                                    style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                                    <div
                                        style="color: var(--accent-gold); font-weight: 700; margin-bottom: 12px; font-size: 1.1em;">
                                        ðŸŒŸ Most Viewed Match</div>
                                    <div style="text-align: center; color: var(--text-gray); padding: 20px;">Loading
                                        viewer data...</div>
                                </div>
                                <div
                                    style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px;">
                                    <div
                                        style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">
                                        ðŸ‘¥ Viewer Distribution by Match</div>
                                    <div
                                        style="max-height: 400px; overflow-y: auto; color: var(--text-gray); text-align: center; padding: 20px;">
                                        Loading distribution data...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matches Tab -->
            <!-- Sub-tabs for Matches -->
            <div class="watch-fee-tabs" style="margin-bottom: 20px; border-bottom: 2px solid rgba(255, 215, 0, 0.1);">
                <button class="watch-fee-tab active" onclick="switchTournamentMatchTab('create')">âž• Create
                    Tournament</button>
                <button class="watch-fee-tab" onclick="switchTournamentMatchTab('live')">ðŸ”´ Live Tournament</button>
                <button class="watch-fee-tab" onclick="switchTournamentMatchTab('upcoming')">â° Upcoming</button>
                <button class="watch-fee-tab" onclick="switchTournamentMatchTab('finished')">âœ… Finished</button>
            </div>

            <!-- Sub-tab Contents -->
            <div id="createTournamentSubTab" class="watch-fee-tab-content active" style="display: block;">
                <form id="createTournamentForm" style="max-width: 800px; margin: 0 auto;">
                    <!-- Tournament Name -->
                    <div style="margin-bottom: 25px;">
                        <label
                            style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Tournament
                            Name</label>
                        <input type="text" id="tournamentNameInput" placeholder="Enter tournament name"
                            style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;">
                    </div>

                    <!-- Tournament Color and Logo -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            <label
                                style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Tournament
                                Color</label>
                            <input type="color" id="tournamentColor" value="#FFD700"
                                style="width: 100%; height: 50px; border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; cursor: pointer;">
                        </div>
                        <div>
                            <label
                                style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Tournament
                                Logo</label>
                            <input type="file" id="tournamentLogoInput" accept="image/*"
                                style="width: 100%; padding: 10px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white);">
                        </div>
                    </div>

                    <!-- Hosts (Multiple Input) -->
                    <div style="margin-bottom: 25px;">
                        <label
                            style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Tournament
                            Hosts</label>
                        <div id="hostsContainer"
                            style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="hostInput" placeholder="Enter host name"
                                style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;">
                        </div>
                        <button type="button" onclick="addHostInput()"
                            style="padding: 10px 20px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 600;">+
                            Add Host</button>
                    </div>

                    <!-- Tournament Start Date -->
                    <div style="margin-bottom: 25px;">
                        <label
                            style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Tournament
                            Start Date</label>
                        <input type="date" id="tournamentStartDate"
                            style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;">
                    </div>

                    <!-- Number of Teams Allowed -->
                    <div style="margin-bottom: 25px;">
                        <label
                            style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Number
                            of Teams Allowed</label>
                        <input type="number" id="teamsAllowedInput" min="2" placeholder="Enter number of teams"
                            style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;">
                    </div>

                    <!-- Sponsor Section -->
                    <div
                        style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h4 style="color: var(--accent-gold); margin-bottom: 15px; font-size: 1.1em;">Tournament Sponsor
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label
                                    style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Sponsor
                                    Name</label>
                                <input type="text" id="sponsorNameInput" placeholder="Enter sponsor name"
                                    style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;">
                            </div>
                            <div>
                                <label
                                    style="display: block; color: var(--accent-gold); font-weight: 600; margin-bottom: 8px;">Sponsor
                                    Logo</label>
                                <input type="file" id="sponsorLogoInput" accept="image/*"
                                    style="width: 100%; padding: 10px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white);">
                            </div>
                        </div>
                    </div>

                    <!-- Create Button -->
                    <button type="button" onclick="createTournament()"
                        style="width: 100%; padding: 15px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1em; transition: all 0.3s ease;">
                        âœ… Create Tournament
                    </button>
                </form>
            </div>
            <div id="liveTournamentSubTab" class="watch-fee-tab-content" style="display: none;">
                <div id="liveTournamentContent"></div>
            </div>
            <div id="upcomingTournamentSubTab" class="watch-fee-tab-content" style="display: none;">
                <div id="upcomingTournamentContent"></div>
            </div>
            <div id="finishedTournamentSubTab" class="watch-fee-tab-content" style="display: none;">
                <div id="finishedTournamentContent"></div>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(255, 215, 0, 0.1);">
                <button class="submit-btn" onclick="closeTournamentModal()" style="width: 100%;">âœ… Close</button>
            </div>
        </div>
    </div>

    <!-- ADD TEAMS TO STANDINGS MODAL -->
    <div id="addTeamsStandingsOverlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 5500; display: none; align-items: center; justify-content: center; padding: 20px;">
        <div
            style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid rgba(255, 215, 0, 0.2);">
                <h2 style="color: var(--accent-gold); margin: 0; font-size: 1.5em;">ðŸ† Add Teams to Standings</h2>
                <button onclick="closeAddTeamsStandingsModal()"
                    style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">Ã—</button>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="color: var(--text-gray); margin-bottom: 20px;">Select teams that participated in this
                    tournament to add them to the standings table:</p>

                <div id="teamsForStandingsContainer"
                    style="display: grid; grid-template-columns: 1fr; gap: 12px; max-height: 400px; overflow-y: auto; padding: 15px; background: rgba(255, 215, 0, 0.02); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 8px;">
                    <div style="color: var(--text-gray); text-align: center; padding: 20px;">Loading teams...</div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button onclick="closeAddTeamsStandingsModal()"
                    style="padding: 12px 25px; background: transparent; border: 1px solid rgba(255, 107, 107, 0.4); color: var(--text-gray); border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">Cancel</button>
                <button onclick="saveTeamsToStandings()"
                    style="padding: 12px 25px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                    onmouseover="this.style.background='rgba(0, 255, 136, 0.3)'"
                    onmouseout="this.style.background='rgba(0, 255, 136, 0.2)'">âœ… Save Teams</button>
            </div>
        </div>
    </div>


    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- LIVESTREAM VIEWER MODAL -->
    <div id="livestreamViewerModal"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 5000; display: none; flex-direction: column;">
        <div
            style="background: rgba(10, 14, 39, 0.95); border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: var(--accent-gold); margin: 0; font-size: 1.8em;">ðŸŽ¥ Livestream Viewer</h2>
            <button onclick="closeLivestreamsModal()"
                style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">Ã—</button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 40px;">
            <!-- Video Container -->
            <div
                style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.2); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
                <div id="livestreamVideoContainer"
                    style="background: #000; border-radius: 15px; overflow: hidden; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ðŸ“º</div>
                        <p style="color: var(--text-gray);">Select a livestream to view</p>
                    </div>
                </div>

                <!-- Video Controls -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button onclick="playLivestream()"
                        style="padding: 15px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">â–¶ï¸
                        Play</button>
                    <button onclick="stopLivestream()"
                        style="padding: 15px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">â¹ï¸
                        Stop</button>
                </div>

                <div
                    style="margin-top: 15px; padding: 15px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; color: #00d4ff; font-weight: 600;">
                    â±ï¸ Delay: <span id="delayDisplay">5s</span>
                </div>
            </div>

            <!-- Livestream List -->
            <div
                style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.2); border-radius: 20px; padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--accent-gold); margin: 0;">ðŸ“¹ Available Livestreams</h3>
                    <button onclick="loadLivestreams()"
                        style="padding: 8px 15px; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.3s ease;"
                        onmouseover="this.style.background='rgba(255, 215, 0, 0.25)'"
                        onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'">ðŸ”„ Refresh</button>
                </div>
                <div id="livestreamsList" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-gray); padding: 40px 20px;">
                        <p>Loading livestreams...</p>
                        <div class="spinner" style="margin-top: 15px; display: inline-block;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REGISTER PLAYERS MODAL -->
    <div id="registerPlayersModal"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 5000; display: none; flex-direction: column;">
        <div
            style="background: rgba(10, 14, 39, 0.95); border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: var(--accent-gold); margin: 0; font-size: 1.8em;">ðŸ“ Register Players</h2>
            <button onclick="closeRegisterPlayersModal()"
                style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">Ã—</button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 40px;">
            <!-- Tabs -->
            <div
                style="display: flex; gap: 15px; margin-bottom: 30px; border-bottom: 2px solid rgba(255,215,0,0.2); padding-bottom: 15px;">
                <button class="register-tab active" onclick="switchRegisterTab('create')"
                    style="padding: 12px 25px; background: transparent; border: none; color: var(--accent-gold); cursor: pointer; font-weight: 600; font-size: 1em; border-bottom: 3px solid var(--accent-gold);">âž•
                    Create Register</button>
                <button class="register-tab" onclick="switchRegisterTab('view')"
                    style="padding: 12px 25px; background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-weight: 600; font-size: 1em;">ðŸ“‹
                    View Registers</button>
            </div>

            <!-- Create Register Tab -->
            <div id="registerCreateTab" class="register-tab-content" style="display: block;">
                <div
                    style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.2); border-radius: 20px; padding: 30px; max-width: 700px;">
                    <h3 style="color: var(--accent-gold); margin-bottom: 25px; font-size: 1.3em;">Create New Register
                    </h3>

                    <!-- Register Name -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">Register
                            Name</label>
                        <input id="registerName" type="text" placeholder="e.g., Championship 2025, Premier League"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- Number of Players Allowed -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">Max
                            Players Allowed</label>
                        <input id="maxPlayersAllowed" type="number" placeholder="e.g., 20" min="1"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- Register Type Options -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 12px;">Register
                            Type</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label
                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-white); padding: 10px; background: rgba(0,255,136,0.08); border-radius: 6px; border: 1px solid rgba(0,255,136,0.3);">
                                <input type="radio" name="registerType" value="free" checked
                                    onchange="updateRegisterTypeDisplay()">
                                <span>âœ… <strong>Free</strong> - No payment required</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-white); padding: 10px; background: rgba(255,215,0,0.08); border-radius: 6px; border: 1px solid rgba(255,215,0,0.3);">
                                <input type="radio" name="registerType" value="paid"
                                    onchange="updateRegisterTypeDisplay()">
                                <span>ðŸ’³ <strong>Paid</strong> - Players pay to register</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-white); padding: 10px; background: rgba(0,212,255,0.08); border-radius: 6px; border: 1px solid rgba(0,212,255,0.3);">
                                <input type="radio" name="registerType" value="code"
                                    onchange="updateRegisterTypeDisplay()">
                                <span>ðŸ” <strong>Register Code</strong> - Requires unique registration code</span>
                            </label>
                        </div>
                    </div>

                    <!-- Amount Field (for Paid type) -->
                    <div id="amountSection" style="margin-bottom: 20px; display: none;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">Registration
                            Amount (â‚¦)</label>
                        <input id="registrationAmount" type="number" placeholder="e.g., 500" min="0" step="50"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- Code Field (for Code type) -->
                    <div id="codeSection" style="margin-bottom: 20px; display: none;">
                        <label style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">ðŸ”
                            Registration Code</label>
                        <input id="registrationCode" type="text" placeholder="Enter unique registration code"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- Time to Start -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">Start
                            Time</label>
                        <input id="startTime" type="datetime-local"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- Time to End -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">End
                            Time</label>
                        <input id="endTime" type="datetime-local"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- User Info Needed Checkboxes -->
                    <div style="margin-bottom: 25px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 12px;">User
                            Information Required</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label
                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-white);">
                                <input type="checkbox" id="needName" checked>
                                <span>Full Name</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-white);">
                                <input type="checkbox" id="needTeamName" checked>
                                <span>DLS Team Name</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-white);">
                                <input type="checkbox" id="needPlayerList">
                                <span>Player List</span>
                            </label>
                        </div>
                    </div>

                    <!-- Create Button -->
                    <button onclick="createRegister()"
                        style="width: 100%; padding: 15px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease;">âœ…
                        Create Register</button>

                    <div id="createRegisterMessage" style="margin-top: 15px; text-align: center;"></div>
                </div>
            </div>

            <!-- View Registers Tab -->
            <div id="registerViewTab" class="register-tab-content" style="display: none;">
                <div style="display: grid; gap: 20px;" id="registersGrid">
                    <div style="text-align: center; color: var(--text-gray); padding: 40px 20px;">Loading registers...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD CLUB WITH PLAYERS MODAL -->
    <div id="addClubModal"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 5000; display: none; flex-direction: column;">
        <div
            style="background: rgba(10, 14, 39, 0.95); border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: var(--accent-gold); margin: 0; font-size: 1.8em;">âš½ Add Club to Tournament</h2>
            <button onclick="closeAddClubModal()"
                style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">Ã—</button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 40px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1000px;">

                <!-- LEFT SIDE: CLUB CREATION -->
                <div
                    style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.2); border-radius: 20px; padding: 30px;">
                    <h3 style="color: var(--accent-gold); margin-top: 0; margin-bottom: 20px;">ðŸ“‹ Club Information</h3>

                    <!-- Club Owner Name -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">Club
                            Owner Name *</label>
                        <input id="clubOwnerName" type="text" placeholder="Enter club owner name"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- Club Name -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">Club
                            Name *</label>
                        <input id="clubName" type="text" placeholder="e.g., Manchester United, Liverpool FC"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em;">
                    </div>

                    <!-- Club Logo Upload -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 8px;">Club
                            Logo *</label>
                        <input id="clubLogoInput" type="file" accept="image/*"
                            style="width: 100%; padding: 12px 15px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; color: var(--text-white); font-size: 1em; cursor: pointer;">
                        <div id="logoPreview" style="margin-top: 15px; text-align: center; display: none;">
                            <img id="logoPreviewImg" src="" alt="Logo preview"
                                style="max-width: 120px; max-height: 120px; border-radius: 8px; border: 2px solid rgba(0,255,136,0.3);">
                        </div>
                    </div>

                    <div id="clubMessage" style="margin-top: 15px; text-align: center;"></div>
                </div>

                <!-- RIGHT SIDE: PLAYERS LIST -->
                <div
                    style="background: var(--card-bg); border: 2px solid rgba(0, 212, 255, 0.2); border-radius: 20px; padding: 30px;">
                    <h3 style="color: #00d4ff; margin-top: 0; margin-bottom: 20px;">ðŸ‘¥ Add Players</h3>

                    <!-- Player Name -->
                    <div style="margin-bottom: 15px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 6px;">Player
                            Name *</label>
                        <input id="playerName" type="text" placeholder="Player full name"
                            style="width: 100%; padding: 10px 12px; background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.3); border-radius: 6px; color: var(--text-white); font-size: 0.95em;">
                    </div>

                    <!-- Player Role -->
                    <div style="margin-bottom: 15px;">
                        <label
                            style="display: block; color: var(--text-gray); font-weight: 600; margin-bottom: 6px;">Player
                            Role *</label>
                        <select id="playerRole"
                            style="width: 100%; padding: 10px 12px; background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.3); border-radius: 6px; color: var(--text-white); font-size: 0.95em;">
                            <option value="">-- Select Role --</option>
                            <option value="Goalkeeper">ðŸ§¤ Goalkeeper</option>
                            <option value="Defender">ðŸ›¡ï¸ Defender</option>
                            <option value="Midfielder">ðŸŽ¯ Midfielder</option>
                            <option value="Forward">âš¡ Forward</option>
                        </select>
                    </div>

                    <!-- Add Player Button -->
                    <button onclick="addPlayerToClub()"
                        style="width: 100%; padding: 10px; background: rgba(0, 212, 255, 0.2); border: 1px solid rgba(0, 212, 255, 0.4); color: #00d4ff; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; margin-bottom: 20px; transition: all 0.3s ease;">âž•
                        Add Player</button>

                    <!-- Players List -->
                    <div style="max-height: 300px; overflow-y: auto;">
                        <div id="playersList" style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="text-align: center; color: var(--text-gray); padding: 20px; font-size: 0.9em;">
                                No players added yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Club Button -->
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="createClubWithPlayers()"
                    style="padding: 15px 40px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.1em; transition: all 0.3s ease;"
                    onmouseover="this.style.background='rgba(0, 255, 136, 0.3)'"
                    onmouseout="this.style.background='rgba(0, 255, 136, 0.2)'">âœ… Create Club & Save</button>
            </div>
        </div>
    </div>

    <!-- EDIT CLUB STATS MODAL -->
    <div id="editClubStatsModal"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 5000; display: none; flex-direction: column;">
        <div
            style="background: rgba(10, 14, 39, 0.95); border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: var(--accent-gold); margin: 0; font-size: 1.8em;">ðŸ“Š Edit Club Stats</h2>
            <button onclick="closeEditClubStatsModal()"
                style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">Ã—</button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 40px;">
            <div
                style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.2); border-radius: 20px; padding: 30px; max-width: 600px; margin: 0 auto;">

                <!-- Club Name Display -->
                <div style="margin-bottom: 30px; text-align: center;">
                    <div style="font-size: 1.5em; color: var(--accent-gold); font-weight: 700;"
                        id="editClubNameDisplay"></div>
                </div>

                <!-- Wins Section -->
                <div
                    style="margin-bottom: 25px; background: rgba(0,255,136,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(0,255,136,0.3);">
                    <label
                        style="display: block; color: var(--accent-green); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">ðŸ†
                        Wins</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="adjustStat('won', -1)"
                            style="padding: 10px 15px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž–</button>
                        <input type="number" id="editWins" readonly
                            style="flex: 1; padding: 12px 15px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 8px; text-align: center; font-weight: 700; font-size: 1.2em;">
                        <button onclick="adjustStat('won', 1)"
                            style="padding: 10px 15px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž•</button>
                    </div>
                </div>

                <!-- Draws Section -->
                <div
                    style="margin-bottom: 25px; background: rgba(255,215,0,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,215,0,0.3);">
                    <label
                        style="display: block; color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">ðŸ¤
                        Draws</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="adjustStat('drawn', -1)"
                            style="padding: 10px 15px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž–</button>
                        <input type="number" id="editDraws" readonly
                            style="flex: 1; padding: 12px 15px; background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.4); color: var(--accent-gold); border-radius: 8px; text-align: center; font-weight: 700; font-size: 1.2em;">
                        <button onclick="adjustStat('drawn', 1)"
                            style="padding: 10px 15px; background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.4); color: var(--accent-gold); border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž•</button>
                    </div>
                </div>

                <!-- Losses Section -->
                <div
                    style="margin-bottom: 25px; background: rgba(255,107,107,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,107,107,0.3);">
                    <label
                        style="display: block; color: #ff6b6b; font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">ðŸ˜”
                        Losses</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="adjustStat('lost', -1)"
                            style="padding: 10px 15px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž–</button>
                        <input type="number" id="editLosses" readonly
                            style="flex: 1; padding: 12px 15px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; text-align: center; font-weight: 700; font-size: 1.2em;">
                        <button onclick="adjustStat('lost', 1)"
                            style="padding: 10px 15px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž•</button>
                    </div>
                </div>

                <!-- Goals For Section -->
                <div
                    style="margin-bottom: 25px; background: rgba(0,212,255,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(0,212,255,0.3);">
                    <label
                        style="display: block; color: #00d4ff; font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">âš½
                        Goals For</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="adjustStat('goalsFor', -1)"
                            style="padding: 10px 15px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž–</button>
                        <input type="number" id="editGoalsFor" readonly
                            style="flex: 1; padding: 12px 15px; background: rgba(0,212,255,0.2); border: 1px solid rgba(0,212,255,0.4); color: #00d4ff; border-radius: 8px; text-align: center; font-weight: 700; font-size: 1.2em;">
                        <button onclick="adjustStat('goalsFor', 1)"
                            style="padding: 10px 15px; background: rgba(0,212,255,0.2); border: 1px solid rgba(0,212,255,0.4); color: #00d4ff; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž•</button>
                    </div>
                </div>

                <!-- Goals Against Section -->
                <div
                    style="margin-bottom: 25px; background: rgba(200,100,100,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(200,100,100,0.3);">
                    <label
                        style="display: block; color: #d4a574; font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">ðŸ›¡ï¸
                        Goals Against</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="adjustStat('goalsAgainst', -1)"
                            style="padding: 10px 15px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž–</button>
                        <input type="number" id="editGoalsAgainst" readonly
                            style="flex: 1; padding: 12px 15px; background: rgba(200,100,100,0.2); border: 1px solid rgba(200,100,100,0.4); color: #d4a574; border-radius: 8px; text-align: center; font-weight: 700; font-size: 1.2em;">
                        <button onclick="adjustStat('goalsAgainst', 1)"
                            style="padding: 10px 15px; background: rgba(200,100,100,0.2); border: 1px solid rgba(200,100,100,0.4); color: #d4a574; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2em;">âž•</button>
                    </div>
                </div>

                <!-- Save Button -->
                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="saveClubStatsChanges()"
                        style="padding: 15px 40px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.1em; transition: all 0.3s ease;"
                        onmouseover="this.style.background='rgba(0,255,136,0.3)'"
                        onmouseout="this.style.background='rgba(0,255,136,0.2)'">ðŸ’¾ Save Changes</button>
                </div>

                <!-- Message -->
                <div id="editClubMessage" style="margin-top: 15px; text-align: center;"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDW8V2SjNITrA4LcdmeILh944mTbOKnM0c",
            authDomain: "rewarderhub.firebaseapp.com",
            projectId: "rewarderhub",
            storageBucket: "rewarderhub.appspot.com",
            messagingSenderId: "85965945106",
            appId: "1:85965945106:web:fa0a57d8968926e1041bcb",
            measurementId: "G-F2ERB5NGN0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== ADMIN SESSION CHECK =====
        function checkAdminSession() {
            const isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';

            if (!isAdminLoggedIn) {
                window.location.href = 'admin_login.html';
                return false;
            }

            return true;
        }

        if (!checkAdminSession()) {
            throw new Error('Admin session required');
        }

        // Store current user for modal operations
        let currentUserData = null;
        let currentOperationType = null;
        let allUsers = [];

        // Navigation function
        function navigateTo(page) {
            const pages = {
                'manage-users': 'User Management',
                'manage-withdrawals': 'Withdrawal Approvals',
                'transactions': 'Transaction History',
                'bank-accounts': 'Bank Account Verification',
                'reports': 'Financial Reports',
                'settings': 'System Settings'
            };

            if (page === 'manage-users') {
                loadManageUsersPage();
            } else if (page === 'transactions') {
                openTransactionsModal();
            } else {
                const pageName = pages[page] || page;
                alert(`${pageName} feature will be available soon.`);
            }
        }

        // Display admin email
        window.addEventListener('load', () => {
            const adminEmail = sessionStorage.getItem('adminEmail');
            if (adminEmail) {
                document.getElementById('adminEmailDisplay').textContent = adminEmail;
            }
            // Load all stats
            loadAdminStats();
            // Check location permission
            checkLocationPermission();
        });

        // Logout function
        function handleLogout() {
            showConfirmation({
                title: 'ðŸšª Logout',
                message: 'Are you sure you want to logout?',
                icon: 'ðŸšª',
                messageType: 'info',
                confirmText: 'Logout',
                cancelText: 'Cancel',
                onConfirm: () => {
                    sessionStorage.removeItem('adminLoggedIn');
                    sessionStorage.removeItem('adminEmail');
                    sessionStorage.removeItem('loginTime');
                    window.location.href = 'admin_login.html';
                }
            });
        }

        // ===== LOAD ADMIN STATS =====
        async function loadAdminStats() {
            try {
                // Get total users count
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;

                // Get wallet and transaction data
                let totalBalance = 0;
                let totalTransactions = 0;
                let verifiedCount = 0;
                let pendingWithdrawalsCount = 0;
                const pendingWithdrawals = [];

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();

                    // Count wallet balance
                    if (userData.wallet && userData.wallet.balance) {
                        totalBalance += userData.wallet.balance;
                    }

                    // Count verified accounts (has bank code in wallet or root level)
                    if ((userData.wallet && userData.wallet.bankCode) || userData.bankCode) {
                        verifiedCount++;
                    }

                    // Count transactions and find pending withdrawals
                    if (userData.transactions && Array.isArray(userData.transactions)) {
                        totalTransactions += userData.transactions.length;

                        // Find pending withdrawal transactions
                        userData.transactions.forEach(tx => {
                            if (tx.type === 'withdrawal' && tx.status === 'pending') {
                                pendingWithdrawalsCount++;
                                pendingWithdrawals.push({
                                    userId: doc.id,
                                    userName: userData.fullName || 'Unknown',
                                    userEmail: userData.email || 'N/A',
                                    amount: tx.amount,
                                    fee: tx.fee,
                                    net: tx.net,
                                    requestType: tx.requestType,
                                    date: tx.date,
                                    reference: tx.id,
                                    bankAccount: userData.wallet ? userData.wallet.bankAccountNumber : 'N/A',
                                    userBalance: tx.balanceAtRequest || (userData.wallet ? userData.wallet.balance : 0),  // Use balance at request time
                                    currentBalance: userData.wallet ? userData.wallet.balance : 0  // Current balance
                                });
                            }
                        });
                    }
                });

                // Update stats
                document.getElementById('totalBalance').textContent = 'â‚¦' + totalBalance.toLocaleString();
                document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
                document.getElementById('verifiedAccounts').textContent = verifiedCount;
                document.getElementById('pendingWithdrawals').textContent = pendingWithdrawalsCount;

                // Display pending withdrawals
                renderPendingWithdrawals(pendingWithdrawals);

            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        // Current withdrawal filter
        let currentWithdrawalFilter = 'all';

        // Filter withdrawals by type
        function filterWithdrawals(type) {
            currentWithdrawalFilter = type;

            // Update tab buttons
            document.querySelectorAll('.withdrawal-tab').forEach(tab => {
                tab.style.color = 'var(--text-gray)';
                tab.style.borderBottom = 'none';
            });
            event.target.style.color = 'var(--accent-gold)';
            event.target.style.borderBottom = '3px solid var(--accent-gold)';

            // Re-render
            loadAdminStats();
        }

        // Render pending withdrawals
        function renderPendingWithdrawals(withdrawals) {
            const container = document.getElementById('pendingWithdrawalsList');

            // Filter by current tab
            let filtered = withdrawals;
            if (currentWithdrawalFilter === 'normal') {
                filtered = withdrawals.filter(w => w.requestType === 'normal');
            } else if (currentWithdrawalFilter === 'speed') {
                filtered = withdrawals.filter(w => w.requestType === 'speed');
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--accent-green); padding: 30px;">âœ… No pending withdrawals</div>';
                return;
            }

            container.innerHTML = filtered.map(wd => {
                const date = new Date(wd.date);
                const timeAgo = getTimeAgo(date);
                const typeIcon = wd.requestType === 'normal' ? 'ðŸš—' : 'âš¡';
                const typeBg = wd.requestType === 'normal' ? 'rgba(100, 180, 255, 0.2)' : 'rgba(255, 150, 0, 0.2)';
                const typeBorder = wd.requestType === 'normal' ? 'rgba(100, 180, 255, 0.4)' : 'rgba(255, 150, 0, 0.4)';

                return `
                    <div style="padding: 20px; background: ${typeBg}; border: 2px solid ${typeBorder}; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <div style="font-weight: 700; color: var(--accent-gold); font-size: 1.1em;">
                                    ${typeIcon} ${wd.requestType === 'normal' ? 'Normal' : 'Speed'} Withdrawal
                                </div>
                                <div style="font-size: 2em; font-weight: 900; color: var(--accent-gold); margin-top: 5px;">
                                    â‚¦${wd.amount.toLocaleString()}
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 0.9em;">
                                <div style="color: var(--accent-green); font-weight: 600;">Reference</div>
                                <div style="color: var(--text-white);">${wd.reference}</div>
                            </div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85em; line-height: 1.7;">
                            <div>ðŸ‘¤ User: <strong>${wd.userName}</strong></div>
                            <div>ðŸ“§ Email: <strong>${wd.userEmail}</strong></div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 8px 0;">
                                <div style="background: rgba(0,255,136,0.15); padding: 8px; border-radius: 5px;">
                                    <div style="font-size: 0.75em; color: var(--text-gray);">Balance at Request</div>
                                    <div style="color: var(--accent-green); font-weight: 600;">â‚¦${wd.userBalance ? wd.userBalance.toLocaleString() : '0'}</div>
                                </div>
                                <div style="background: rgba(255,215,0,0.15); padding: 8px; border-radius: 5px;">
                                    <div style="font-size: 0.75em; color: var(--text-gray);">Current Balance</div>
                                    <div style="color: var(--accent-gold); font-weight: 600;">â‚¦${wd.currentBalance ? wd.currentBalance.toLocaleString() : '0'}</div>
                                </div>
                            </div>
                            <div>ðŸ¦ Account: <strong>${wd.bankAccount}</strong></div>
                            <div>ðŸ’¸ Amount: â‚¦${wd.amount.toLocaleString()} | Fee: â‚¦${wd.fee.toLocaleString()} | Net: â‚¦${wd.net.toLocaleString()}</div>
                            <div>ðŸ“… ${date.toLocaleDateString()} at ${date.toLocaleTimeString()} (${timeAgo})</div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="approveWithdrawal('${wd.userId}', '${wd.reference}', ${wd.amount}, ${wd.fee})" style="flex: 1; padding: 10px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">âœ… Approve</button>
                            <button onclick="openRejectModal('${wd.userId}', '${wd.reference}', ${wd.amount})" style="flex: 1; padding: 10px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">âŒ Reject</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [name, value] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / value);
                if (interval >= 1) {
                    return interval === 1 ? `${interval} ${name} ago` : `${interval} ${name}s ago`;
                }
            }
            return 'just now';
        }

        // Close manage users modal
        function closeManageUsersModal() {
            document.getElementById('manageUsersModal').style.display = 'none';
            document.getElementById('userSearchInput').value = '';
        }

        // Filter users by search
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const filtered = allUsers.filter(user => {
                const name = (user.fullName || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });
            renderUserCards(filtered);
        }

        // Render user cards
        function renderUserCards(users) {
            const container = document.getElementById('usersGridContainer');

            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 30px; grid-column: 1 / -1;">No users found</div>';
                return;
            }

            container.innerHTML = users.map(user => {
                const isRemoved = user.removed === true;
                const isRestricted = user.restricted && new Date(user.restrictedUntil) > new Date();
                const restrictedTime = isRestricted ? new Date(user.restrictedUntil).toLocaleString() : null;

                // Get bank details from wallet object
                const walletObj = user.wallet || {};

                // Generate DLS account number if missing
                let dlsAccountNumber = walletObj.dlsAccountNumber;
                if (!dlsAccountNumber) {
                    const randomNum = Math.floor(Math.random() * 100000);
                    dlsAccountNumber = 'DLS' + String(randomNum).padStart(5, '0');
                    // Save generated DLS account to Firebase
                    db.collection('users').doc(user.id).set({ wallet: { dlsAccountNumber } }, { merge: true }).catch(e => console.error('Error saving DLS:', e));
                }

                const bankCode = walletObj.bankCode || null;
                const bankAccountNumber = walletObj.bankAccountNumber || null;
                const accountName = walletObj.accountName || null;
                const balance = walletObj.balance || 0;

                console.log(`User ${user.email}:`, {
                    dlsAccountNumber,
                    bankCode,
                    bankAccountNumber,
                    accountName,
                    balance,
                    rawWallet: walletObj
                });

                return `
                   <div style="background: var(--card-bg); border: 2px solid rgba(255,215,0,0.2); border-radius: 15px; padding: 20px; position: relative;">
                       ${isRemoved ? '<div style="position: absolute; top: 10px; right: 10px; background: rgba(255,107,107,0.3); color: #ff6b6b; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; font-weight: 600;">REMOVED</div>' : ''}
                       ${isRestricted ? `<div style="position: absolute; top: 10px; right: 10px; background: rgba(255,215,0,0.3); color: var(--accent-gold); padding: 5px 10px; border-radius: 5px; font-size: 0.8em; font-weight: 600;">RESTRICTED</div>` : ''}
                       
                       <div style="margin-bottom: 12px;">
                           <div style="font-weight: 700; color: var(--text-white); font-size: 1.1em;">${user.fullName || 'No Name'}</div>
                           <div style="font-size: 0.85em; color: var(--text-gray);">${user.email || 'No Email'}</div>
                       </div>

                       <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85em; line-height: 1.6;">
                           <div>ðŸ’° Balance: <strong style="color: var(--accent-gold);">â‚¦${balance ? balance.toLocaleString() : '0'}</strong></div>
                           <div>ðŸ¦ DLS Account: <strong style="color: ${dlsAccountNumber ? 'var(--accent-green)' : '#ff6b6b'}">${dlsAccountNumber ? dlsAccountNumber : 'âŒ Not Set'}</strong></div>
                           <div>ðŸ›ï¸ Bank: <strong style="color: ${bankCode ? 'var(--accent-green)' : '#ff6b6b'}">${bankCode ? bankCode : 'âŒ Not Set'}</strong></div>
                           <div>ðŸ“ Account #: <strong style="color: ${bankAccountNumber ? 'var(--accent-green)' : '#ff6b6b'}">${bankAccountNumber ? bankAccountNumber : 'âŒ Not Set'}</strong></div>
                           <div>ðŸ‘¤ A/C Name: <strong style="color: ${accountName ? 'var(--accent-green)' : '#ff6b6b'}">${accountName ? accountName : 'âŒ Not Set'}</strong></div>
                           ${isRestricted ? `<div style="color: var(--accent-gold); margin-top: 5px;">â³ Restricted until: ${restrictedTime}</div>` : ''}
                       </div>

                       <div style="display: flex; flex-direction: column; gap: 8px;">
                           <button onclick="openCreditModal('${user.id}', 'credit')" style="width: 100%; padding: 8px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">ðŸ’š Credit</button>
                           <button onclick="openCreditModal('${user.id}', 'takeback')" style="width: 100%; padding: 8px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">ðŸ“‰ Take Back</button>
                           ${!isRestricted ? `<button onclick="openRestrictModal('${user.id}')" style="width: 100%; padding: 8px; background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.4); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">â¸ï¸ Restrict</button>` : `<button onclick="unrestrict('${user.id}')" style="width: 100%; padding: 8px; background: rgba(100,200,100,0.2); border: 1px solid rgba(100,200,100,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">âœ… Unrestrict</button>`}
                           ${!isRemoved ? `<button onclick="removeUser('${user.id}')" style="width: 100%; padding: 8px; background: rgba(255,107,107,0.3); border: 1px solid rgba(255,107,107,0.6); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">ðŸ—‘ï¸ Remove</button>` : `<button onclick="retrieveUser('${user.id}')" style="width: 100%; padding: 8px; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">â†©ï¸ Retrieve</button>`}
                       </div>
                   </div>
               `;
            }).join('');
        }

        // Open credit/takeback modal
        function openCreditModal(userId, type) {
            db.collection('users').doc(userId).get().then(doc => {
                if (doc.exists) {
                    currentUserData = { id: userId, ...doc.data() };
                    currentOperationType = type;

                    const title = type === 'credit' ? 'Credit Account' : 'Take Back Funds';
                    document.getElementById('creditModalTitle').textContent = title;
                    document.getElementById('creditUserName').value = currentUserData.fullName || 'Unknown';
                    document.getElementById('creditWalletAccount').value = currentUserData.wallet?.dlsAccountNumber || 'Not Set';
                    document.getElementById('creditAmount').value = '';
                    document.getElementById('creditPassword').value = '';
                    document.getElementById('creditMessage').innerHTML = '';

                    document.getElementById('creditModal').style.display = 'flex';
                }
            });
        }

        // Close credit modal
        function closeCreditModal() {
            document.getElementById('creditModal').style.display = 'none';
            currentUserData = null;
        }

        // Process credit transaction
        async function processCreditTransaction() {
            const amount = parseFloat(document.getElementById('creditAmount').value);
            const password = document.getElementById('creditPassword').value;
            const msgDiv = document.getElementById('creditMessage');

            if (!amount || amount <= 0) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please enter a valid amount</div>';
                return;
            }

            if (password !== '1234ABCD') {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Invalid admin password</div>';
                return;
            }

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">â³ Processing...</div>';

                const newBalance = currentOperationType === 'credit'
                    ? (currentUserData.wallet?.balance || 0) + amount
                    : (currentUserData.wallet?.balance || 0) - amount;

                if (newBalance < 0 && currentOperationType === 'takeback') {
                    msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Insufficient balance</div>';
                    return;
                }

                // Update wallet balance
                await db.collection('users').doc(currentUserData.id).update({
                    'wallet.balance': newBalance
                });

                // Add transaction record
                const transaction = {
                    id: (currentOperationType === 'credit' ? 'ADM-CRE-' : 'ADM-TKB-') + Date.now(),
                    type: currentOperationType === 'credit' ? 'deposit' : 'withdrawal',
                    amount: amount,
                    status: 'successful',
                    date: new Date().toISOString(),
                    description: currentOperationType === 'credit' ? 'Admin Credit' : 'Admin Take Back',
                    adminCredited: true
                };

                await db.collection('users').doc(currentUserData.id).update({
                    transactions: firebase.firestore.FieldValue.arrayUnion(transaction)
                });

                msgDiv.innerHTML = `<div style="color: var(--accent-green); font-weight: 600;">âœ… ${currentOperationType === 'credit' ? 'Credited' : 'Taken back'} â‚¦${amount.toLocaleString()} successfully!</div>`;

                setTimeout(() => {
                    closeCreditModal();
                    loadManageUsersPage();
                    loadAdminStats();
                }, 1500);
            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">âŒ Error: ${error.message}</div>`;
            }
        }

        // Open restrict modal
        function openRestrictModal(userId) {
            db.collection('users').doc(userId).get().then(doc => {
                if (doc.exists) {
                    currentUserData = { id: userId, ...doc.data() };
                    document.getElementById('restrictUserName').value = currentUserData.fullName || 'Unknown';
                    document.getElementById('restrictDuration').value = '';
                    document.getElementById('restrictMessage').innerHTML = '';
                    document.getElementById('restrictModal').style.display = 'flex';
                }
            });
        }

        // Close restrict modal
        function closeRestrictModal() {
            document.getElementById('restrictModal').style.display = 'none';
            currentUserData = null;
        }

        // Process restriction
        async function processRestriction() {
            const duration = parseInt(document.getElementById('restrictDuration').value);
            const msgDiv = document.getElementById('restrictMessage');

            if (!duration) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please select a duration</div>';
                return;
            }

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">â³ Restricting...</div>';

                const restrictedUntil = new Date(Date.now() + duration * 60 * 60 * 1000).toISOString();

                await db.collection('users').doc(currentUserData.id).update({
                    restricted: true,
                    restrictedUntil: restrictedUntil
                });

                msgDiv.innerHTML = '<div style="color: var(--accent-green); font-weight: 600;">âœ… User restricted successfully!</div>';

                setTimeout(() => {
                    closeRestrictModal();
                    loadManageUsersPage();
                    loadAdminStats();
                }, 1500);
            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">âŒ Error: ${error.message}</div>`;
            }
        }

        // Unrestrict user
        async function unrestrict(userId) {
            showConfirmation({
                title: 'ðŸ”“ Remove Restriction',
                message: 'Remove the restriction from this user? They will regain access.',
                icon: 'ðŸ”“',
                messageType: 'info',
                confirmText: 'Remove',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        await db.collection('users').doc(userId).update({
                            restricted: false,
                            restrictedUntil: null
                        });
                        loadManageUsersPage();
                        loadAdminStats();
                    } catch (error) {
                        alert('Error unrestricting user: ' + error.message);
                    }
                }
            });
        }

        // Remove user
        async function removeUser(userId) {
            showConfirmation({
                title: 'âŒ Delete User',
                message: 'Permanently delete this user? They will never be able to sign in again. This cannot be undone.',
                icon: 'âŒ',
                messageType: 'warning',
                confirmText: 'Delete',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        await db.collection('users').doc(userId).update({
                            removed: true,
                            removedAt: new Date().toISOString()
                        });
                        loadManageUsersPage();
                        loadAdminStats();
                    } catch (error) {
                        alert('Error removing user: ' + error.message);
                    }
                }
            });
        }

        // Retrieve (restore) removed user
        async function retrieveUser(userId) {
            showConfirmation({
                title: 'âœ… Restore User',
                message: 'Restore this user and re-enable their access?',
                icon: 'âœ…',
                messageType: 'info',
                confirmText: 'Restore',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        await db.collection('users').doc(userId).update({
                            removed: false,
                            removedAt: null
                        });
                        loadManageUsersPage();
                        loadAdminStats();
                    } catch (error) {
                        alert('Error retrieving user: ' + error.message);
                    }
                }
            });
        }

        // Load manage users page
        async function loadManageUsersPage() {
            document.getElementById('manageUsersModal').style.display = 'block';
            const container = document.getElementById('usersGridContainer');
            container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 30px; grid-column: 1 / -1;">Loading users...</div>';

            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    // Ensure wallet object exists
                    if (!userData.wallet) {
                        userData.wallet = {
                            dlsAccountNumber: null,
                            bankCode: null,
                            bankAccountNumber: null,
                            accountName: null,
                            balance: 0
                        };
                    }
                    allUsers.push({
                        id: doc.id,
                        ...userData
                    });
                });

                console.log('Loaded users:', allUsers);
                renderUserCards(allUsers);
                document.getElementById('userSearchInput').value = '';
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 30px; grid-column: 1 / -1;">Error loading users</div>';
            }
        }

        // TEST FUNCTION: Add sample bank data to a user
        function addTestBankData(userId) {
            db.collection('users').doc(userId).set({
                wallet: {
                    dlsAccountNumber: 'DLS' + String(Math.floor(Math.random() * 100000)).padStart(5, '0'),
                    bankCode: 'GTB',
                    bankAccountNumber: '0123456789',
                    accountName: 'John Doe',
                    balance: 50000,
                    bankAddedDate: new Date().toISOString()
                }
            }, { merge: true }).then(() => {
                alert('Test bank data added successfully!');
                loadManageUsersPage();
            }).catch(error => {
                alert('Error adding test data: ' + error.message);
            });
        }

        // Approve withdrawal
        async function approveWithdrawal(userId, reference, amount, fee) {
            showConfirmation({
                title: 'ðŸ’° Approve Withdrawal',
                message: `Approve withdrawal of â‚¦${amount.toLocaleString()}?\n\nFee: â‚¦${fee.toLocaleString()}\nBalance will be deducted now.`,
                icon: 'ðŸ’°',
                messageType: 'warning',
                confirmText: 'Approve',
                cancelText: 'Reject',
                onConfirm: async () => {
                    try {
                        // Get user document
                        const userDoc = await db.collection('users').doc(userId).get();
                        if (!userDoc.exists) {
                            alert('User not found');
                            return;
                        }

                        const userData = userDoc.data();
                        const transactions = userData.transactions || [];
                        const currentBalance = (userData.wallet && userData.wallet.balance) || 0;

                        // Find and update the transaction
                        const txIndex = transactions.findIndex(tx => tx.id === reference);
                        if (txIndex !== -1) {
                            transactions[txIndex].status = 'successful';
                            transactions[txIndex].approvedAt = new Date().toISOString();
                            transactions[txIndex].approvedBy = 'admin';

                            // Deduct the amount from current balance
                            const newBalance = currentBalance - amount;

                            // Update user document with new balance and transaction
                            await db.collection('users').doc(userId).set({
                                wallet: {
                                    ...userData.wallet,
                                    balance: newBalance
                                },
                                transactions: transactions,
                                updatedAt: new Date().toISOString()
                            }, { merge: true });

                            alert('âœ… Withdrawal approved!\nBalance deducted: â‚¦' + amount.toLocaleString() + '\nNew balance: â‚¦' + newBalance.toLocaleString());
                            loadAdminStats();
                        }
                    } catch (error) {
                        alert('Error approving withdrawal: ' + error.message);
                    }
                }
            });
        }

        // Store withdrawal data for rejection
        let pendingReject = { userId: null, reference: null, amount: null };

        // Open rejection modal
        function openRejectModal(userId, reference, amount) {
            pendingReject = { userId, reference, amount };
            document.getElementById('rejectModal').style.display = 'flex';
            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectionNotes').value = '';
            document.getElementById('rejectMessage').innerHTML = '';
        }

        // Close rejection modal
        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
            pendingReject = { userId: null, reference: null, amount: null };
        }

        // Confirm rejection
        async function confirmReject() {
            const reason = document.getElementById('rejectionReason').value;
            const notes = document.getElementById('rejectionNotes').value;
            const msgDiv = document.getElementById('rejectMessage');

            if (!reason) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please select a rejection reason</div>';
                return;
            }

            const { userId, reference, amount } = pendingReject;

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">â³ Processing...</div>';

                // Get user document
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ User not found</div>';
                    return;
                }

                const userData = userDoc.data();
                const transactions = userData.transactions || [];

                // Find and update the transaction
                const txIndex = transactions.findIndex(tx => tx.id === reference);
                if (txIndex !== -1) {
                    transactions[txIndex].status = 'rejected';
                    transactions[txIndex].rejectedAt = new Date().toISOString();
                    transactions[txIndex].rejectedBy = 'admin';
                    transactions[txIndex].rejectionReason = reason;
                    transactions[txIndex].rejectionNotes = notes || null;

                    // NO balance change - user keeps their money

                    // Update user document
                    await db.collection('users').doc(userId).set({
                        transactions: transactions,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });

                    msgDiv.innerHTML = '<div style="color: var(--accent-green); font-weight: 600;">âœ… Withdrawal rejected!</div>';
                    setTimeout(() => {
                        closeRejectModal();
                        loadAdminStats();
                    }, 1500);
                }
            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">âŒ Error: ${error.message}</div>`;
            }
        }

        // ===== MATCH CREATION SYSTEM =====
        let isEditMode = false;
        let editingMatchId = null;

        let matchCreationData = {
            teamA: {
                name: '',
                logo: '',
                players: [],
                captain: '',
                clubOwner: '',
                dlsPlayer: ''
            },
            teamB: {
                name: '',
                logo: '',
                players: [],
                captain: '',
                clubOwner: '',
                dlsPlayer: ''
            },
            dlsPlayers: [],
            sponsors: [],
            matchDate: '',
            matchTime: '',
            stats: {
                score: true,
                corners: false,
                possession: false,
                passes: false,
                shotOnTarget: false,
                shots: false,
                shotsOffTarget: false,
                bookings: false
            },
            predictions: {
                enabled: false,
                scoreOnly: false,
                teamToScore: false,
                numberOfGoals: false
            },
            winningChances: {
                teamA: 0,
                teamB: 0
            },
            livestream: {
                enabled: false,
                isPaid: false,
                price: 0,
                maxViewers: 0
            }
        };

        // Open creation popup
        function openCreationPopup() {
            document.querySelector('.creation-popup-overlay').classList.add('active');
        }

        // Close creation popup
        function closeCreationPopup() {
            document.querySelector('.creation-popup-overlay').classList.remove('active');
        }

        // Select Single Match
        function selectSingleMatch() {
            closeCreationPopup();
            openMatchCreationModal();
        }

        // Select Tournament
        function selectTournament() {
            closeCreationPopup();
            openTournamentModal();
        }

        // Open match creation modal
        function openMatchCreationModal() {
            document.querySelector('.match-creation-overlay').classList.add('active');
            switchMatchTab('setMatch');
        }

        // Close match creation modal
        function closeMatchCreationModal() {
            document.querySelector('.match-creation-overlay').classList.remove('active');
        }

        // Switch match tabs
        function switchMatchTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.match-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.match-tab-content').forEach(content => content.style.display = 'none');

            const contentId = tabName + 'Content';
            const content = document.getElementById(contentId);
            if (content) {
                content.style.display = 'block';
            }
        }

        // Add player to team
        function addPlayerToTeam(team) {
            const playerNameInput = document.getElementById(team + 'PlayerName');
            const playerNumberInput = document.getElementById(team + 'PlayerNumber');
            const playerRoleInput = document.getElementById(team + 'PlayerRole');

            if (!playerNameInput.value || !playerNumberInput.value || !playerRoleInput.value) {
                alert('Please enter player name, number, and role');
                return;
            }

            if (matchCreationData[team].players.length >= 17) {
                alert('Maximum 17 players per team');
                return;
            }

            const player = {
                name: playerNameInput.value,
                number: playerNumberInput.value,
                role: playerRoleInput.value,
                id: Date.now()
            };

            matchCreationData[team].players.push(player);
            playerNameInput.value = '';
            playerNumberInput.value = '';
            playerRoleInput.value = '';

            updatePlayerList(team);
        }

        // Remove player from team
        function removePlayer(team, playerId) {
            matchCreationData[team].players = matchCreationData[team].players.filter(p => p.id !== playerId);
            updatePlayerList(team);
        }

        // Update player list display
        function updatePlayerList(team) {
            const listId = team + 'PlayerList';
            const playerList = document.getElementById(listId);
            const playerCount = document.getElementById(team + 'PlayerCount');

            playerCount.textContent = matchCreationData[team].players.length + '/17';

            playerList.innerHTML = matchCreationData[team].players.map(player => `
                <div class="player-item">
                    <span>${player.number} - ${player.name} (${player.role})</span>
                    <button class="remove-btn" onclick="removePlayer('${team}', ${player.id})">Remove</button>
                </div>
            `).join('');
        }

        // Add sponsor
        function addSponsor() {
            const nameInput = document.getElementById('sponsorName');
            const logoUrlInput = document.getElementById('sponsorLogo');
            const logoFileInput = document.getElementById('sponsorLogoFile');

            if (!nameInput.value) {
                alert('Please enter sponsor name');
                return;
            }

            // Check if either URL or file is provided
            if (!logoUrlInput.value && !logoFileInput.files.length) {
                alert('Please enter sponsor logo URL or upload a file');
                return;
            }

            const sponsor = {
                name: nameInput.value,
                logo: logoUrlInput.value || '',
                id: Date.now()
            };

            // Handle file upload if provided
            if (logoFileInput.files.length > 0) {
                const file = logoFileInput.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    sponsor.logo = e.target.result;
                    matchCreationData.sponsors.push(sponsor);
                    nameInput.value = '';
                    logoUrlInput.value = '';
                    logoFileInput.value = '';
                    updateSponsorList();
                };
                reader.readAsDataURL(file);
            } else {
                matchCreationData.sponsors.push(sponsor);
                nameInput.value = '';
                logoUrlInput.value = '';
                logoFileInput.value = '';
                updateSponsorList();
            }
        }

        // Remove sponsor
        function removeSponsor(sponsorId) {
            matchCreationData.sponsors = matchCreationData.sponsors.filter(s => s.id !== sponsorId);
            updateSponsorList();
        }

        // Update sponsor list display
        function updateSponsorList() {
            const sponsorList = document.getElementById('sponsorsList');
            const sponsorCount = document.getElementById('sponsorCount');

            sponsorCount.textContent = matchCreationData.sponsors.length;

            sponsorList.innerHTML = matchCreationData.sponsors.map(sponsor => `
                <div class="player-item">
                    <span>ðŸ¢ ${sponsor.name}</span>
                    <button class="remove-btn" onclick="removeSponsor(${sponsor.id})">Remove</button>
                </div>
            `).join('');
        }

        // Update stats selection
        function updateStats() {
            matchCreationData.stats.corners = document.getElementById('statCorners').checked;
            matchCreationData.stats.possession = document.getElementById('statPossession').checked;
            matchCreationData.stats.passes = document.getElementById('statPasses').checked;
            matchCreationData.stats.shotOnTarget = document.getElementById('statShotOnTarget').checked;
            matchCreationData.stats.shots = document.getElementById('statShots').checked;
            matchCreationData.stats.shotsOffTarget = document.getElementById('statShotsOffTarget').checked;
            matchCreationData.stats.bookings = document.getElementById('statBookings').checked;
        }

        // Update predictions
        function updatePredictions() {
            matchCreationData.predictions.enabled = document.getElementById('predictionsEnabled').checked;
            if (matchCreationData.predictions.enabled) {
                matchCreationData.predictions.scoreOnly = document.getElementById('predictScore').checked;
                matchCreationData.predictions.teamToScore = document.getElementById('predictTeamToScore').checked;
                matchCreationData.predictions.numberOfGoals = document.getElementById('predictNumberOfGoals').checked;
            }
        }

        // Update match livestream settings
        function updateMatchLivestream() {
            matchCreationData.livestream.enabled = document.getElementById('livestreamEnabled').checked;
            document.getElementById('livestreamOptions').style.display = matchCreationData.livestream.enabled ? 'block' : 'none';

            if (matchCreationData.livestream.enabled) {
                const type = document.getElementById('livestreamType').value;
                matchCreationData.livestream.isPaid = (type === 'paid');
                document.getElementById('livestreamPriceSection').style.display = (type === 'paid') ? 'block' : 'none';
            } else {
                document.getElementById('livestreamPriceSection').style.display = 'none';
            }
        }

        // Handle logo file upload
        function handleLogoUpload(team, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    matchCreationData[team].logo = e.target.result;
                    console.log(`Logo uploaded for ${team}`);
                };
                reader.readAsDataURL(file);
            }
        }



        // ===== MATCH PASS GENERATION SYSTEM =====
        function generateMatchPass(teamName, matchId) {
            // Generate unique match pass: TEAM-MATCHID-RANDOM
            const teamInitials = teamName.substring(0, 3).toUpperCase();
            const matchShort = matchId.substring(0, 6).toUpperCase();
            const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `${teamInitials}-${matchShort}-${randomCode}`;
        }

        // ===== NOTIFICATION SYSTEM =====
        let notificationCounter = 0;

        function showNotification(message, type = 'info', duration = 4000, icon = null) {
            const container = document.getElementById('notificationContainer') || createNotificationContainer();
            const notifId = `notif-${notificationCounter++}`;

            // Default icons
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                loading: '<div class="spinner"></div>'
            };

            const notif = document.createElement('div');
            notif.id = notifId;
            notif.className = `notification notification-${type}`;
            notif.innerHTML = `
                <span class="notification-icon">${icon || icons[type] || icons.info}</span>
                <span class="notification-text">${message}</span>
                <span class="notification-close" onclick="removeNotification('${notifId}')">Ã—</span>
            `;

            container.appendChild(notif);

            if (type !== 'loading' && duration > 0) {
                setTimeout(() => {
                    removeNotification(notifId);
                }, duration);
            }

            return notifId;
        }

        function createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'notificationContainer';
            container.className = 'notification-container';
            document.body.appendChild(container);
            return container;
        }

        function removeNotification(notifId) {
            const notif = document.getElementById(notifId);
            if (notif) {
                notif.classList.add('removing');
                setTimeout(() => {
                    notif.remove();
                }, 300);
            }
        }

        function resetMatchForm() {
            // Reset match creation data
            matchCreationData = {
                teamA: { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                teamB: { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                dlsPlayers: [],
                sponsors: [],
                matchDate: '',
                matchTime: '',
                stats: {
                    score: true, corners: false, possession: false, passes: false,
                    shotOnTarget: false, shots: false, shotsOffTarget: false, bookings: false
                },
                predictions: { enabled: false, scoreOnly: false, teamToScore: false, numberOfGoals: false },
                winningChances: { teamA: 0, teamB: 0 },
                livestream: { enabled: false, isPaid: false, price: 0, maxViewers: 0 }
            };

            // Reset all form inputs
            const inputs = document.querySelectorAll('.match-form-container input, .match-form-container select, .match-form-container textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });

            // Reset player lists
            document.getElementById('teamAPlayerList').innerHTML = '';
            document.getElementById('teamBPlayerList').innerHTML = '';
            document.getElementById('teamAPlayerCount').textContent = '0/17';
            document.getElementById('teamBPlayerCount').textContent = '0/17';

            // Reset sponsor list
            document.getElementById('sponsorsList').innerHTML = '';
            document.getElementById('sponsorCount').textContent = '0';

            // Reset checkbox states
            document.getElementById('predictionsEnabled').checked = false;
            document.getElementById('predictionsOptions').style.display = 'none';

            // Reset livestream states
            const livestreamEnabledElement = document.getElementById('livestreamEnabled');
            if (livestreamEnabledElement) {
                livestreamEnabledElement.checked = false;
            }
            const livestreamOptionsElement = document.getElementById('livestreamOptions');
            if (livestreamOptionsElement) {
                livestreamOptionsElement.style.display = 'none';
            }
            const livestreamPriceSectionElement = document.getElementById('livestreamPriceSection');
            if (livestreamPriceSectionElement) {
                livestreamPriceSectionElement.style.display = 'none';
            }
        }

        // Load matches for editing
        async function loadMatchesForEdit() {
            try {
                const matchesSnapshot = await db.collection('matches').where('status', 'in', ['upcoming', 'live']).get();
                const matches = [];

                matchesSnapshot.forEach(doc => {
                    matches.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Display matches in a selection modal
                showEditMatchSelector(matches);
            } catch (error) {
                showNotification(`âŒ Error loading matches: ${error.message}`, 'error', 4000);
            }
        }

        // Show match selector modal
        function showEditMatchSelector(matches) {
            if (matches.length === 0) {
                showNotification('âŒ No matches available to edit', 'error', 3000);
                return;
            }

            // Create simple selector
            let options = '<div style="display: grid; gap: 10px; max-height: 400px; overflow-y: auto;">';
            matches.forEach(match => {
                const matchDate = new Date(match.createdAt).toLocaleDateString();
                const matchTime = match.matchTime || 'TBD';
                options += `
                    <div onclick="editMatch('${match.id}')" style="padding: 12px; background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; cursor: pointer; color: var(--text-white); transition: all 0.3s;">
                        <strong>${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}</strong>
                        <div style="font-size: 0.85em; color: var(--text-gray); margin-top: 5px;">
                            ðŸ“… ${matchDate} | ðŸ• ${matchTime}
                        </div>
                    </div>
                `;
            });
            options += '</div>';

            // Simple prompt-like dialog
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 5000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            container.innerHTML = `
                <div style="background: var(--card-bg); border: 2px solid rgba(255,215,0,0.3); border-radius: 15px; padding: 30px; max-width: 500px; width: 100%;">
                    <h2 style="color: var(--accent-gold); margin-bottom: 20px;">ðŸ“‹ Select Match to Edit</h2>
                    ${options}
                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                </div>
            `;

            document.body.appendChild(container);
        }

        // Edit a specific match
        async function editMatch(matchId) {
            try {
                // Remove selector modal
                document.querySelector('div[style*="position: fixed"][style*="background: rgba(0,0,0,0.9)"]')?.remove();

                const matchDoc = await db.collection('matches').doc(matchId).get();
                if (!matchDoc.exists) {
                    showNotification('âŒ Match not found', 'error', 3000);
                    return;
                }

                // Load match data into form
                const data = matchDoc.data();
                isEditMode = true;
                editingMatchId = matchId;

                // Populate matchCreationData
                matchCreationData = {
                    teamA: data.teamA || { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                    teamB: data.teamB || { name: '', logo: '', players: [], captain: '', clubOwner: '', dlsPlayer: '' },
                    dlsPlayers: data.dlsPlayers || [],
                    sponsors: data.sponsors || [],
                    matchDate: data.matchDate || '',
                    matchTime: data.matchTime || '',
                    stats: data.stats || { score: true, corners: false, possession: false, passes: false, shotOnTarget: false, shots: false, shotsOffTarget: false, bookings: false },
                    predictions: data.predictions || { enabled: false, scoreOnly: false, teamToScore: false, numberOfGoals: false },
                    winningChances: data.winningChances || { teamA: 0, teamB: 0 }
                };

                // Open modal and populate form
                openMatchCreationModal();
                populateMatchFormWithData();

                showNotification('ðŸ“ Match loaded for editing', 'info', 2000);
            } catch (error) {
                showNotification(`âŒ Error loading match: ${error.message}`, 'error', 4000);
            }
        }

        // Populate form with existing match data
        function populateMatchFormWithData() {
            // Team names
            document.querySelectorAll('.match-form-container input[placeholder*="team name"]')[0].value = matchCreationData.teamA.name;
            document.querySelectorAll('.match-form-container input[placeholder*="team name"]')[1].value = matchCreationData.teamB.name;

            // DLS Players
            const dlsInputs = document.querySelectorAll('.match-form-container input[placeholder*="DLS"]');
            if (dlsInputs[0]) dlsInputs[0].value = matchCreationData.teamA.dlsPlayer;
            if (dlsInputs[1]) dlsInputs[1].value = matchCreationData.teamB.dlsPlayer;

            // Club Owners
            const clubInputs = document.querySelectorAll('.match-form-container input[placeholder*="club"]');
            if (clubInputs[0]) clubInputs[0].value = matchCreationData.teamA.clubOwner;
            if (clubInputs[1]) clubInputs[1].value = matchCreationData.teamB.clubOwner;

            // Captains
            const captainInputs = document.querySelectorAll('.match-form-container input[placeholder*="Captain"]');
            if (captainInputs[0]) captainInputs[0].value = matchCreationData.teamA.captain;
            if (captainInputs[1]) captainInputs[1].value = matchCreationData.teamB.captain;

            // Date and Time
            document.querySelector('input[type="date"]').value = matchCreationData.matchDate;
            document.querySelector('input[type="time"]').value = matchCreationData.matchTime;

            // Players - rebuild lists
            document.getElementById('teamAPlayerList').innerHTML = '';
            document.getElementById('teamBPlayerList').innerHTML = '';

            matchCreationData.teamA.players.forEach(() => updatePlayerList('teamA'));
            matchCreationData.teamB.players.forEach(() => updatePlayerList('teamB'));

            // Sponsors - rebuild list
            document.getElementById('sponsorsList').innerHTML = '';
            document.getElementById('sponsorCount').textContent = matchCreationData.sponsors.length;
            updateSponsorList();

            // Stats checkboxes
            Object.entries(matchCreationData.stats).forEach(([key, value]) => {
                const elem = document.getElementById('stat' + key.charAt(0).toUpperCase() + key.slice(1));
                if (elem) elem.checked = value;
            });

            // Predictions
            document.getElementById('predictionsEnabled').checked = matchCreationData.predictions.enabled;
            if (matchCreationData.predictions.enabled) {
                document.getElementById('predictionsOptions').style.display = 'block';
                document.getElementById('predictScore').checked = matchCreationData.predictions.scoreOnly;
                document.getElementById('predictTeamToScore').checked = matchCreationData.predictions.teamToScore;
                document.getElementById('predictNumberOfGoals').checked = matchCreationData.predictions.numberOfGoals;
            }

            // Winning chances
            document.querySelectorAll('input[placeholder*="0-100"]')[0].value = matchCreationData.winningChances.teamA;
            document.querySelectorAll('input[placeholder*="0-100"]')[1].value = matchCreationData.winningChances.teamB;
        }

        // Submit match creation
        async function submitMatchCreation() {
            // Validate required fields
            if (!matchCreationData.teamA.name || !matchCreationData.teamB.name) {
                showNotification('âŒ Please enter both team names', 'error', 3000);
                return;
            }

            if (matchCreationData.teamA.players.length === 0 || matchCreationData.teamB.players.length === 0) {
                showNotification('âŒ Please add at least one player to each team', 'error', 3000);
                return;
            }

            // Show loading notification
            const actionText = isEditMode ? 'Updating match' : 'Creating match';
            const loadingNotif = showNotification(`${actionText}...`, 'loading', 0, '<div class="spinner"></div>');

            try {
                // Get admin email from session or use default admin email
                const adminEmail = sessionStorage.getItem('adminEmail') || 'bashorunidris01@gmail.com';

                if (!adminEmail) {
                    removeNotification(loadingNotif);
                    showNotification('âŒ Admin user not logged in', 'error', 3000);
                    return;
                }

                // âœ… Upload team logos to Cloudinary
                const teamALogoUrl = matchCreationData.teamA.logo && matchCreationData.teamA.logo.startsWith('data:')
                    ? await uploadToCloudinary(matchCreationData.teamA.logo, 'single-match')
                    : matchCreationData.teamA.logo;

                const teamBLogoUrl = matchCreationData.teamB.logo && matchCreationData.teamB.logo.startsWith('data:')
                    ? await uploadToCloudinary(matchCreationData.teamB.logo, 'single-match')
                    : matchCreationData.teamB.logo;

                // âœ… Upload sponsor logos to Cloudinary
                const sponsorsWithUrls = await Promise.all(
                    matchCreationData.sponsors.map(async (sponsor) => ({
                        ...sponsor,
                        logo: sponsor.logo && sponsor.logo.startsWith('data:')
                            ? await uploadToCloudinary(sponsor.logo, 'sponsors')
                            : sponsor.logo
                    }))
                );

                if (isEditMode) {
                    // Update existing match
                    const updateData = {
                        ...matchCreationData,
                        teamA: {
                            ...matchCreationData.teamA,
                            logo: teamALogoUrl
                        },
                        teamB: {
                            ...matchCreationData.teamB,
                            logo: teamBLogoUrl
                        },
                        sponsors: sponsorsWithUrls,
                        stats: matchCreationData.stats || { score: true },
                        predictions: matchCreationData.predictions || { enabled: false },
                        winningChances: matchCreationData.winningChances || { teamA: 0, teamB: 0 },
                        matchDate: matchCreationData.matchDate || '',
                        matchTime: matchCreationData.matchTime || '',
                        livestream: matchCreationData.livestream || { enabled: false, isPaid: false, price: 0 },
                        livestreamCodes: matchCreationData.livestreamCodes || [],
                        updatedBy: adminEmail,
                        updatedAt: new Date().toISOString()
                    };

                    // Add tournamentId if editing from within a tournament
                    if (currentTournament && currentTournament.id) {
                        updateData.tournamentId = currentTournament.id;
                    }

                    await db.collection('matches').doc(editingMatchId).update(updateData);

                    removeNotification(loadingNotif);
                    showNotification('âœ… Match updated successfully!', 'success', 4000);
                } else {
                    // Create new match document in Firebase
                    const matchData = {
                        ...matchCreationData,
                        teamA: {
                            ...matchCreationData.teamA,
                            logo: teamALogoUrl,
                            matchPass: '' // Will be updated with ID below
                        },
                        teamB: {
                            ...matchCreationData.teamB,
                            logo: teamBLogoUrl,
                            matchPass: '' // Will be updated with ID below
                        },
                        sponsors: sponsorsWithUrls,
                        stats: matchCreationData.stats || { score: true },
                        predictions: matchCreationData.predictions || { enabled: false },
                        winningChances: matchCreationData.winningChances || { teamA: 0, teamB: 0 },
                        matchDate: matchCreationData.matchDate || '',
                        matchTime: matchCreationData.matchTime || '',
                        livestream: matchCreationData.livestream || { enabled: false, isPaid: false, price: 0 },
                        livestreamCodes: [],
                        createdBy: adminEmail,
                        createdByType: 'admin',
                        createdAt: new Date().toISOString(),
                        status: 'upcoming',
                        matchType: 'singleMatch'
                    };

                    // Add tournamentId if creating from within a tournament
                    if (currentTournament && currentTournament.id) {
                        matchData.tournamentId = currentTournament.id;
                    }

                    const matchRef = await db.collection('matches').add(matchData);

                    // Generate and add match passes for both teams
                    const matchId = matchRef.id;
                    const teamAPass = generateMatchPass(matchCreationData.teamA.name, matchId);
                    const teamBPass = generateMatchPass(matchCreationData.teamB.name, matchId);

                    await db.collection('matches').doc(matchId).update({
                        'teamA.matchPass': teamAPass,
                        'teamB.matchPass': teamBPass
                    });

                    removeNotification(loadingNotif);
                    showNotification('âœ… Match created successfully with passes!', 'success', 4000);
                }

                // Reset form and mode
                resetMatchForm();
                isEditMode = false;
                editingMatchId = null;

                // Close modal after short delay
                setTimeout(() => {
                    closeMatchCreationModal();
                }, 500);

            } catch (error) {
                console.error('Error with match:', error);
                removeNotification(loadingNotif);
                showNotification(`âŒ Error: ${error.message}`, 'error', 5000);
            }
        }

        // ===== DEVICE TRACKING SYSTEM =====
        let userDeviceInfo = {
            deviceType: 'Unknown',
            browser: 'Unknown',
            browserVersion: 'Unknown',
            operatingSystem: 'Unknown',
            osVersion: 'Unknown',
            screenResolution: '',
            screenWidth: 0,
            screenHeight: 0,
            userAgent: navigator.userAgent,
            lastActive: null,
            firstSeen: null
        };

        // Get device information
        function detectDeviceInfo() {
            const ua = navigator.userAgent;
            let browserName = 'Unknown';
            let browserVersion = 'Unknown';
            let osName = 'Unknown';
            let osVersion = 'Unknown';
            let deviceType = 'Desktop';

            // Detect Browser
            if (ua.indexOf('Firefox') > -1) browserName = 'Firefox';
            else if (ua.indexOf('SamsungBrowser') > -1) browserName = 'Samsung Internet';
            else if (ua.indexOf('Opera') > -1 || ua.indexOf('OPR') > -1) browserName = 'Opera';
            else if (ua.indexOf('Trident') > -1) browserName = 'Internet Explorer';
            else if (ua.indexOf('Edge') > -1) browserName = 'Edge';
            else if (ua.indexOf('Chrome') > -1) browserName = 'Chrome';
            else if (ua.indexOf('Safari') > -1) browserName = 'Safari';

            // Get Browser Version
            if (browserName === 'Chrome') {
                const match = ua.match(/Chrome\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            } else if (browserName === 'Firefox') {
                const match = ua.match(/Firefox\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            } else if (browserName === 'Safari') {
                const match = ua.match(/Version\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            } else if (browserName === 'Edge') {
                const match = ua.match(/Edge\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
            }

            // Detect OS
            if (ua.indexOf('Win') > -1) {
                osName = 'Windows';
                if (ua.indexOf('Windows NT 10.0') > -1) osVersion = '10';
                else if (ua.indexOf('Windows NT 6.3') > -1) osVersion = '8.1';
                else if (ua.indexOf('Windows NT 6.2') > -1) osVersion = '8';
                else if (ua.indexOf('Windows NT 6.1') > -1) osVersion = '7';
            } else if (ua.indexOf('Mac') > -1) {
                osName = 'macOS';
                const match = ua.match(/Mac OS X (\d+[._]\d+)/);
                osVersion = match ? match[1].replace('_', '.') : 'Unknown';
            } else if (ua.indexOf('Android') > -1) {
                osName = 'Android';
                const match = ua.match(/Android (\d+)/);
                osVersion = match ? match[1] : 'Unknown';
                deviceType = 'Mobile';
            } else if (ua.indexOf('iPhone') > -1 || ua.indexOf('iPad') > -1) {
                osName = 'iOS';
                const match = ua.match(/OS (\d+)_(\d+)/);
                osVersion = match ? `${match[1]}.${match[2]}` : 'Unknown';
                deviceType = ua.indexOf('iPad') > -1 ? 'Tablet' : 'Mobile';
            } else if (ua.indexOf('Linux') > -1) {
                osName = 'Linux';
            }

            // Check for tablet
            if ((ua.indexOf('iPad') > -1) || (ua.indexOf('Android') > -1 && ua.indexOf('Mobile') === -1)) {
                deviceType = 'Tablet';
            } else if (ua.indexOf('Mobile') > -1 || ua.indexOf('Android') > -1) {
                deviceType = 'Mobile';
            }

            // Get screen resolution
            const screenResolution = `${window.screen.width}x${window.screen.height}`;

            userDeviceInfo = {
                deviceType,
                browser: browserName,
                browserVersion,
                operatingSystem: osName,
                osVersion,
                screenResolution,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                userAgent: ua,
                lastActive: new Date().toISOString(),
                firstSeen: new Date().toISOString()
            };

            return userDeviceInfo;
        }

        // Save device info to Firebase
        async function saveDeviceInfoToFirebase() {
            try {
                const userId = auth.currentUser?.uid;
                if (!userId) return;

                const deviceInfo = detectDeviceInfo();

                await db.collection('users').doc(userId).update({
                    deviceInfo: deviceInfo,
                    lastDeviceUpdate: new Date().toISOString(),
                    devices: firebase.firestore.FieldValue.arrayUnion({
                        ...deviceInfo,
                        detectedAt: new Date().toISOString()
                    })
                });

                console.log('Device info saved:', deviceInfo);
            } catch (error) {
                console.error('Error saving device info:', error);
            }
        }

        // Track device on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (auth.currentUser?.uid) {
                    saveDeviceInfoToFirebase();
                }
            }, 2000);
        });

        // ===== LOCATION PERMISSION SYSTEM =====
        let userLocationPermission = false;
        let userLocationData = {
            country: 'Unknown',
            state: 'Unknown',
            lga: 'Unknown',
            latitude: null,
            longitude: null,
            permissionGranted: false,
            permissionDate: null
        };

        // Check location permission on page load
        async function checkLocationPermission() {
            try {
                const userId = auth.currentUser?.uid;
                if (!userId) return;

                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userLocationPermission = userData.locationPermissionGranted || false;

                    // If user already granted permission, load their location
                    if (userLocationPermission && userData.userLocation) {
                        userLocationData = userData.userLocation;
                    } else if (!userLocationPermission && !userData.locationPermissionRejected) {
                        // Show permission modal if not granted or rejected
                        setTimeout(() => showLocationPermissionModal(), 1000);
                    }
                }
            } catch (error) {
                console.error('Error checking location permission:', error);
            }
        }

        // Show location permission modal
        function showLocationPermissionModal() {
            const overlay = document.querySelector('.location-permission-overlay');
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        // Close location permission modal
        function closeLocationPermissionModal() {
            const overlay = document.querySelector('.location-permission-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // Allow location access
        async function allowLocationAccess() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'â³ Browser popup opening...';

            try {
                if (!navigator.geolocation) {
                    alert('âŒ Geolocation is not supported by your browser');
                    btn.disabled = false;
                    btn.textContent = 'ðŸ“ Enable Location (Browser Popup)';
                    return;
                }

                console.log('ðŸ“ Requesting geolocation from browser...');

                // This will trigger the browser's native location permission popup
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        console.log('âœ… Location permission granted by user');
                        const { latitude, longitude } = position.coords;

                        console.log(`ðŸ“ User coordinates: ${latitude}, ${longitude}`);

                        // Get location data from coordinates
                        const locationData = await reverseGeocodeLocation(latitude, longitude);
                        console.log('ðŸ“ Geocoded location:', locationData);

                        userLocationData = {
                            country: locationData.country,
                            state: locationData.state,
                            lga: locationData.lga,
                            latitude,
                            longitude,
                            permissionGranted: true,
                            permissionDate: new Date().toISOString()
                        };

                        // Save to Firebase
                        const userId = auth.currentUser?.uid;
                        console.log('ðŸ’¾ Saving location to Firebase for user:', userId);

                        if (userId) {
                            await db.collection('users').doc(userId).update({
                                locationPermissionGranted: true,
                                locationPermissionDate: new Date().toISOString(),
                                userLocation: userLocationData,
                                country: locationData.country,
                                state: locationData.state,
                                lga: locationData.lga
                            });
                            console.log('âœ… Location saved to Firebase successfully');
                        }

                        btn.textContent = 'âœ… Location Enabled!';
                        setTimeout(() => {
                            closeLocationPermissionModal();
                            btn.disabled = false;
                        }, 1500);
                    },
                    (error) => {
                        console.error('âŒ Location permission denied or error:', error);

                        if (error.code === error.PERMISSION_DENIED) {
                            console.log('User denied location permission in browser popup');
                            btn.textContent = 'âŒ Permission Denied';
                            btn.disabled = false;
                            setTimeout(() => {
                                btn.textContent = 'ðŸ“ Enable Location (Browser Popup)';
                            }, 2000);
                        } else {
                            btn.textContent = 'âŒ Error Getting Location';
                            btn.disabled = false;
                            alert('Error getting location: ' + error.message);
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (error) {
                console.error('âŒ Error in allowLocationAccess:', error);
                btn.disabled = false;
                btn.textContent = 'ðŸ“ Enable Location (Browser Popup)';
            }
        }

        // Skip location access
        async function skipLocationAccess() {
            const userId = auth.currentUser?.uid;
            if (userId) {
                try {
                    await db.collection('users').doc(userId).update({
                        locationPermissionRejected: true,
                        locationPermissionRejectedDate: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error saving location rejection:', error);
                }
            }
            closeLocationPermissionModal();
        }

        // Reverse geocode coordinates to get location data
        async function reverseGeocodeLocation(latitude, longitude) {
            try {
                // Using Open-Meteo API (free, no API key needed) for timezone and basic location
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
                );
                const data = await response.json();

                // Parse address components
                const address = data.address || {};

                // Try to get country
                const country = address.country || 'Nigeria';

                // Get state (admin_area or state)
                let state = address.state || address.admin_area || 'Unknown';

                // Get LGA (municipality or town)
                let lga = address.municipality || address.town || address.village || 'Unknown';

                // For Nigerian locations, try to map to proper state/LGA
                if (country.includes('Nigeria') || country.includes('NG')) {
                    // Use more detailed parsing for Nigeria
                    state = parseNigerianState(address);
                    lga = parseNigerianLGA(address, state);
                }

                return {
                    country: country,
                    state: state,
                    lga: lga
                };
            } catch (error) {
                console.error('Reverse geocode error:', error);
                return {
                    country: 'Nigeria',
                    state: 'Unknown',
                    lga: 'Unknown'
                };
            }
        }

        // Parse Nigerian state from address
        function parseNigerianState(address) {
            const stateNames = [
                'Abia', 'Adamawa', 'Akwa Ibom', 'Anambra', 'Bauchi', 'Bayelsa', 'Benue',
                'Borno', 'Cross River', 'Delta', 'Ebonyi', 'Edo', 'Ekiti', 'Enugu', 'FCT',
                'Gombe', 'Imo', 'Jigawa', 'Kaduna', 'Kano', 'Katsina', 'Kebbi', 'Kogi',
                'Kwara', 'Lagos', 'Nasarawa', 'Niger', 'Ogun', 'Ondo', 'Osun', 'Oyo',
                'Plateau', 'Rivers', 'Sokoto', 'Taraba', 'Yobe', 'Zamfara'
            ];

            const addressStr = JSON.stringify(address).toUpperCase();
            for (let state of stateNames) {
                if (addressStr.includes(state.toUpperCase())) {
                    return state;
                }
            }

            return address.state || address.admin_area || 'Unknown';
        }

        // Parse Nigerian LGA from address
        function parseNigerianLGA(address, state) {
            // Common LGA patterns
            let lga = address.municipality || address.town || address.village || '';

            if (lga) {
                // Remove state name if included
                lga = lga.replace(new RegExp(state, 'i'), '').trim();
                // Remove "LGA" suffix
                lga = lga.replace(/\s+LGA\s*/i, '').trim();
            }

            return lga || 'Unknown';
        }

        // ===== FINANCIAL REPORTS MODAL =====
        let currentReportTab = 'overview';
        let reportData = {
            overview: {},
            users: [],
            daily: [],
            hourly: [],
            geographic: {
                byCountry: {},
                byState: {},
                byLGA: {},
                locations: []
            },
            devices: {
                byType: {},
                byBrowser: {},
                byOS: {},
                byResolution: {},
                allDevices: []
            }
        };
        let charts = {};

        // Open financial reports modal
        function openFinancialReportsModal() {
            document.querySelector('.reports-modal-overlay').classList.add('active');
            currentReportTab = 'overview';
            loadFinancialReports();
        }

        // Close financial reports modal
        function closeFinancialReportsModal() {
            document.querySelector('.reports-modal-overlay').classList.remove('active');
        }

        // Load financial data
        async function loadFinancialReports() {
            try {
                const usersSnapshot = await db.collection('users').get();
                let allTx = [];
                let userStats = [];
                let depositsByType = { deposits: 0, withdrawals: 0 };
                let statusBreakdown = { successful: 0, pending: 0, rejected: 0 };
                let hourlyData = {};
                let byCountry = {};
                let byState = {};
                let byLGA = {};
                let byDeviceType = {};
                let byBrowser = {};
                let byOS = {};
                let byResolution = {};
                let allDevices = [];

                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userEmail = userData.email || 'N/A';
                    const userName = userData.name || 'N/A';
                    const transactions = userData.transactions || [];

                    // Geographic data from user profile
                    const userCountry = userData.country || 'Unknown';
                    const userState = userData.state || 'Unknown';
                    const userLGA = userData.lga || 'Unknown';

                    // Device data from user profile
                    const deviceInfo = userData.deviceInfo || {};
                    const deviceType = deviceInfo.deviceType || 'Unknown';
                    const browser = deviceInfo.browser || 'Unknown';
                    const os = deviceInfo.operatingSystem || 'Unknown';
                    const resolution = deviceInfo.screenResolution || 'Unknown';

                    // Track device info
                    if (deviceInfo && deviceInfo.deviceType) {
                        byDeviceType[deviceType] = (byDeviceType[deviceType] || 0) + 1;
                        byBrowser[browser] = (byBrowser[browser] || 0) + 1;
                        byOS[os] = (byOS[os] || 0) + 1;
                        byResolution[resolution] = (byResolution[resolution] || 0) + 1;

                        allDevices.push({
                            userName: userData.name || 'N/A',
                            userEmail: userData.email || 'N/A',
                            ...deviceInfo
                        });
                    }

                    let userDeposits = 0, userWithdrawals = 0, userFees = 0;

                    transactions.forEach(tx => {
                        allTx.push({
                            ...tx,
                            userCountry,
                            userState,
                            userLGA,
                            userName,
                            userEmail
                        });

                        if (tx.type === 'deposit') {
                            userDeposits += tx.amount;
                            depositsByType.deposits += tx.amount;
                        }
                        if (tx.type === 'withdrawal') {
                            userWithdrawals += tx.amount;
                            depositsByType.withdrawals += tx.amount;
                            userFees += tx.fee || 0;
                        }

                        // Track by hour
                        if (tx.date) {
                            const date = new Date(tx.date);
                            const hour = date.getHours() + ':00';
                            hourlyData[hour] = (hourlyData[hour] || 0) + 1;
                        }

                        // Track by geography
                        byCountry[userCountry] = (byCountry[userCountry] || 0) + tx.amount;
                        byState[userState] = (byState[userState] || 0) + tx.amount;
                        byLGA[userLGA] = (byLGA[userLGA] || 0) + tx.amount;

                        // Track status
                        if (tx.type === 'withdrawal') {
                            if (tx.status === 'successful') statusBreakdown.successful += tx.amount;
                            else if (tx.status === 'pending') statusBreakdown.pending += tx.amount;
                            else if (tx.status === 'rejected') statusBreakdown.rejected += tx.amount;
                        }
                    });

                    if (transactions.length > 0) {
                        userStats.push({
                            email: userEmail,
                            name: userName,
                            country: userCountry,
                            state: userState,
                            lga: userLGA,
                            deposits: userDeposits,
                            withdrawals: userWithdrawals,
                            fees: userFees,
                            netFlow: userDeposits - userWithdrawals,
                            txCount: transactions.length
                        });
                    }
                });

                // Calculate overview stats
                let totalDeposits = 0, totalWithdrawals = 0, totalFees = 0, totalApproved = 0, totalPending = 0, totalRejected = 0;

                allTx.forEach(tx => {
                    if (tx.type === 'deposit') totalDeposits += tx.amount;
                    if (tx.type === 'withdrawal') {
                        totalWithdrawals += tx.amount;
                        totalFees += tx.fee || 0;
                        if (tx.status === 'successful') totalApproved += tx.amount;
                        else if (tx.status === 'pending') totalPending += tx.amount;
                        else if (tx.status === 'rejected') totalRejected += tx.amount;
                    }
                });

                const netFlow = totalDeposits - totalWithdrawals;

                reportData.overview = {
                    totalDeposits,
                    totalWithdrawals,
                    totalFees,
                    netFlow,
                    totalApproved,
                    totalPending,
                    totalRejected,
                    totalTransactions: allTx.length,
                    uniqueUsers: usersSnapshot.size,
                    approvalRate: allTx.filter(tx => tx.type === 'withdrawal').length > 0
                        ? ((totalApproved / allTx.filter(tx => tx.type === 'withdrawal' && (tx.status === 'successful' || tx.status === 'pending' || tx.status === 'rejected')).reduce((sum, tx) => sum + tx.amount, 0)) * 100).toFixed(1)
                        : 0,
                    depositsByType,
                    statusBreakdown,
                    hourlyTransactions: hourlyData
                };

                reportData.users = userStats.sort((a, b) => b.netFlow - a.netFlow).slice(0, 20);

                // Process geographic data - sort by transaction volume
                reportData.geographic.byCountry = Object.entries(byCountry)
                    .map(([country, amount]) => ({ country, amount }))
                    .sort((a, b) => b.amount - a.amount);

                reportData.geographic.byState = Object.entries(byState)
                    .map(([state, amount]) => ({ state, amount }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 15);

                reportData.geographic.byLGA = Object.entries(byLGA)
                    .map(([lga, amount]) => ({ lga, amount }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 15);

                // Process device data
                reportData.devices.byType = Object.entries(byDeviceType)
                    .map(([type, count]) => ({ type, count }))
                    .sort((a, b) => b.count - a.count);

                reportData.devices.byBrowser = Object.entries(byBrowser)
                    .map(([browser, count]) => ({ browser, count }))
                    .sort((a, b) => b.count - a.count);

                reportData.devices.byOS = Object.entries(byOS)
                    .map(([os, count]) => ({ os, count }))
                    .sort((a, b) => b.count - a.count);

                reportData.devices.byResolution = Object.entries(byResolution)
                    .map(([resolution, count]) => ({ resolution, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);

                reportData.devices.allDevices = allDevices;

                renderReportsView();
            } catch (error) {
                console.error('Error loading financial reports:', error);
                alert('Error loading reports: ' + error.message);
            }
        }

        // Switch report tabs
        function switchReportTab(tab) {
            currentReportTab = tab;
            document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderReportsView();
        }

        // Render reports view
        function renderReportsView() {
            const container = document.getElementById('reportsContainer');

            if (currentReportTab === 'overview') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ“Š Overview Statistics</h3>
                        <div class="report-grid">
                            <div class="report-card">
                                <div class="report-card-label">Total Deposits</div>
                                <div class="report-card-value">â‚¦${reportData.overview.totalDeposits.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Total Withdrawals</div>
                                <div class="report-card-value">â‚¦${reportData.overview.totalWithdrawals.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Total Fees Collected</div>
                                <div class="report-card-value">â‚¦${reportData.overview.totalFees.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Net Flow</div>
                                <div class="report-card-value" style="color: ${reportData.overview.netFlow >= 0 ? 'var(--accent-green)' : '#ff6b6b'}">â‚¦${reportData.overview.netFlow.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ’³ Withdrawal Status</h3>
                        <div class="report-grid">
                            <div class="report-card">
                                <div class="report-card-label">âœ… Approved</div>
                                <div class="report-card-value">â‚¦${reportData.overview.totalApproved.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">â³ Pending</div>
                                <div class="report-card-value">â‚¦${reportData.overview.totalPending.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">âŒ Rejected</div>
                                <div class="report-card-value">â‚¦${reportData.overview.totalRejected.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Approval Rate</div>
                                <div class="report-card-value">${reportData.overview.approvalRate}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ“ˆ Platform Metrics</h3>
                        <div class="report-grid">
                            <div class="report-card">
                                <div class="report-card-label">Total Transactions</div>
                                <div class="report-card-value">${reportData.overview.totalTransactions}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Active Users</div>
                                <div class="report-card-value">${reportData.overview.uniqueUsers}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Avg per User</div>
                                <div class="report-card-value">â‚¦${(reportData.overview.totalTransactions > 0 ? (reportData.overview.netFlow / reportData.overview.uniqueUsers).toFixed(0) : 0).toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",")}</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ“Š Detailed Charts</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">Deposits vs Withdrawals</div>
                                <div class="small-chart-container">
                                    <canvas id="depositWithdrawalChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">Withdrawal Status Breakdown</div>
                                <div class="small-chart-container">
                                    <canvas id="statusBreakdownChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Transaction Volume by Hour</div>
                            <canvas id="hourlyVolumeChart"></canvas>
                        </div>
                    </div>
                `;

                // Render charts after content is loaded
                setTimeout(() => {
                    createDepositWithdrawalChart();
                    createStatusBreakdownChart();
                    createHourlyVolumeChart();
                }, 100);

            } else if (currentReportTab === 'users') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ‘¥ Top Users by Net Flow</h3>
                        <div class="chart-container">
                            <div class="chart-title">Top 10 Users Net Flow Comparison</div>
                            <canvas id="topUsersChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>User Name</th>
                                    <th>Email</th>
                                    <th>Location</th>
                                    <th>Deposits</th>
                                    <th>Withdrawals</th>
                                    <th>Net Flow</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.users.map(user => `
                                    <tr>
                                        <td>${user.name}</td>
                                        <td>${user.email}</td>
                                        <td>${user.state} ${user.lga !== 'Unknown' ? '- ' + user.lga : ''}</td>
                                        <td style="color: var(--accent-green);">â‚¦${user.deposits.toLocaleString()}</td>
                                        <td style="color: #ff6b6b;">â‚¦${user.withdrawals.toLocaleString()}</td>
                                        <td style="color: ${user.netFlow >= 0 ? 'var(--accent-green)' : '#ff6b6b'};">â‚¦${user.netFlow.toLocaleString()}</td>
                                        <td>${user.txCount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                setTimeout(() => {
                    createTopUsersChart();
                }, 100);

            } else if (currentReportTab === 'geographic') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">ðŸŒ Transactions by Country</h3>
                        <div class="chart-container">
                            <div class="chart-title">Distribution by Country</div>
                            <canvas id="countryChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>Total Amount</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.geographic.byCountry.map(item => {
                    const percentage = ((item.amount / reportData.overview.totalDeposits) * 100).toFixed(2);
                    return `
                                        <tr>
                                            <td>${item.country}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">â‚¦${item.amount.toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ›ï¸ Transactions by State/Region</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">Top States - Bar Chart</div>
                                <div class="chart-container">
                                    <canvas id="stateChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">State Distribution</div>
                                <div class="chart-container">
                                    <canvas id="stateDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>State/Region</th>
                                    <th>Total Amount</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.geographic.byState.map(item => {
                    const percentage = ((item.amount / reportData.overview.totalDeposits) * 100).toFixed(2);
                    return `
                                        <tr>
                                            <td>${item.state}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">â‚¦${item.amount.toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ˜ï¸ Transactions by Local Government Area (LGA)</h3>
                        <div class="chart-container">
                            <div class="chart-title">Top 15 LGAs</div>
                            <canvas id="lgaChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Local Government Area</th>
                                    <th>Total Amount</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.geographic.byLGA.map(item => {
                    const percentage = ((item.amount / reportData.overview.totalDeposits) * 100).toFixed(2);
                    return `
                                        <tr>
                                            <td>${item.lga}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">â‚¦${item.amount.toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                setTimeout(() => {
                    createCountryChart();
                    createStateChart();
                    createStateDistributionChart();
                    createLGAChart();
                }, 100);

            } else if (currentReportTab === 'devices') {
                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ“± Device Types Distribution</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">Device Type Pie Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="deviceTypeChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">Device Type Bar Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="deviceTypeBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Device Type</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byType.map(item => {
                    const total = reportData.devices.byType.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.type}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸŒ Browser Distribution</h3>
                        <div class="chart-container">
                            <div class="chart-title">Users by Browser</div>
                            <canvas id="browserChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Browser</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byBrowser.map(item => {
                    const total = reportData.devices.byBrowser.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.browser}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ’» Operating System Distribution</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">OS Doughnut Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="osChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">OS Bar Chart</div>
                                <div class="small-chart-container">
                                    <canvas id="osBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Operating System</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byOS.map(item => {
                    const total = reportData.devices.byOS.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.os}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ–¥ï¸ Screen Resolution Distribution</h3>
                        <div class="chart-container">
                            <div class="chart-title">Top 10 Screen Resolutions</div>
                            <canvas id="resolutionChart"></canvas>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Screen Resolution</th>
                                    <th>Users Count</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.devices.byResolution.map(item => {
                    const total = reportData.devices.byResolution.reduce((sum, d) => sum + d.count, 0);
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(2) : 0;
                    return `
                                        <tr>
                                            <td>${item.resolution}</td>
                                            <td style="color: var(--accent-green); font-weight: 600;">${item.count}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                setTimeout(() => {
                    createDeviceTypeChart();
                    createDeviceTypeBarChart();
                    createBrowserChart();
                    createOSChart();
                    createOSBarChart();
                    createResolutionChart();
                }, 100);
            } else if (currentReportTab === 'livestream') {
                loadLivestreamRevenueData();
            }
        }

        // Load livestream revenue data
        async function loadLivestreamRevenueData() {
            try {
                const container = document.getElementById('reportsContainer');
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">Loading livestream revenue data...</div>';

                const matchesSnapshot = await db.collection('matches').get();
                let totalPaidRevenue = 0;
                let totalFreeCodesIssued = 0;
                let totalPaidCodesIssued = 0;
                let matchRevenues = [];
                let hourlyRevenue = {};

                matchesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const livestream = data.livestream || {};
                    const livestreamCodes = data.livestreamCodes || [];

                    // Calculate revenue for this match
                    const revenue = livestream.totalRevenue || 0;
                    if (revenue > 0) {
                        totalPaidRevenue += revenue;
                    }

                    // Count codes by type
                    livestreamCodes.forEach(code => {
                        if (code.isPaid) {
                            totalPaidCodesIssued++;
                        } else {
                            totalFreeCodesIssued++;
                        }

                        // Track hourly revenue
                        if (code.createdAt) {
                            const hour = new Date(code.createdAt).toLocaleString('en-US', { hour: 'numeric', hour12: true });
                            hourlyRevenue[hour] = (hourlyRevenue[hour] || 0) + (code.amount || 0);
                        }
                    });

                    // Add match revenue for table
                    if (livestreamCodes.length > 0) {
                        matchRevenues.push({
                            matchId: doc.id,
                            matchName: `${data.teamA?.name || 'Team A'} vs ${data.teamB?.name || 'Team B'}`,
                            isPaid: livestream.isPaid || false,
                            price: livestream.price || 0,
                            totalRevenue: revenue,
                            codesIssued: livestreamCodes.length,
                            paidCodes: livestreamCodes.filter(c => c.isPaid).length,
                            freeCodes: livestreamCodes.filter(c => !c.isPaid).length
                        });
                    }
                });

                // Sort by revenue
                matchRevenues.sort((a, b) => b.totalRevenue - a.totalRevenue);

                // Calculate average
                const totalCodes = totalPaidCodesIssued + totalFreeCodesIssued;
                const averageRevenue = totalPaidCodesIssued > 0 ? (totalPaidRevenue / totalPaidCodesIssued).toFixed(0) : 0;

                container.innerHTML = `
                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ“¹ Livestream Revenue Summary</h3>
                        <div class="report-grid">
                            <div class="report-card">
                                <div class="report-card-label">Total Livestream Revenue</div>
                                <div class="report-card-value" style="color: var(--accent-green);">â‚¦${totalPaidRevenue.toLocaleString()}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Paid Codes Issued</div>
                                <div class="report-card-value">${totalPaidCodesIssued}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Free Codes Issued</div>
                                <div class="report-card-value">${totalFreeCodesIssued}</div>
                            </div>
                            <div class="report-card">
                                <div class="report-card-label">Avg per Paid Code</div>
                                <div class="report-card-value">â‚¦${averageRevenue.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ’° Revenue by Match</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Match Name</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Total Revenue</th>
                                    <th>Paid Codes</th>
                                    <th>Free Codes</th>
                                    <th>Total Codes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${matchRevenues.map(match => `
                                    <tr>
                                        <td>${match.matchName}</td>
                                        <td>${match.isPaid ? 'ðŸ’° PAID' : 'âœ… FREE'}</td>
                                        <td>â‚¦${match.price.toLocaleString()}</td>
                                        <td style="color: var(--accent-green); font-weight: 600;">â‚¦${match.totalRevenue.toLocaleString()}</td>
                                        <td>${match.paidCodes}</td>
                                        <td>${match.freeCodes}</td>
                                        <td>${match.codesIssued}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">ðŸ“Š Code Type Distribution</h3>
                        <div class="charts-grid">
                            <div>
                                <div class="chart-title">Paid vs Free Codes</div>
                                <div class="small-chart-container">
                                    <canvas id="livestreamCodesChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="chart-title">Revenue Sources</div>
                                <div class="small-chart-container">
                                    <canvas id="revenueSourceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Create charts
                setTimeout(() => {
                    createLivestreamCodesChart(totalPaidCodesIssued, totalFreeCodesIssued);
                    createRevenueSourceChart(totalPaidRevenue, totalPaidCodesIssued);
                }, 100);

            } catch (error) {
                console.error('Error loading livestream revenue:', error);
                document.getElementById('reportsContainer').innerHTML = '<div style="color: #ff6b6b; padding: 20px;">Error loading livestream revenue data</div>';
            }
        }

        // Create livestream codes pie chart
        function createLivestreamCodesChart(paid, free) {
            const ctx = document.getElementById('livestreamCodesChart');
            if (!ctx) return;

            const total = paid + free;
            const paidPercent = total > 0 ? ((paid / total) * 100).toFixed(1) : 0;
            const freePercent = total > 0 ? ((free / total) * 100).toFixed(1) : 0;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [`Paid Codes (${paid})`, `Free Codes (${free})`],
                    datasets: [{
                        data: [paidPercent, freePercent],
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.6)',
                            'rgba(0, 255, 136, 0.6)'
                        ],
                        borderColor: [
                            'var(--accent-gold)',
                            'var(--accent-green)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'var(--text-white)', font: { size: 12 } }
                        }
                    }
                }
            });
        }

        // Create revenue source chart
        function createRevenueSourceChart(revenue, codes) {
            const ctx = document.getElementById('revenueSourceChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total Revenue', 'Avg per Code'],
                    datasets: [{
                        label: 'Amount (â‚¦)',
                        data: [
                            revenue,
                            codes > 0 ? (revenue / codes).toFixed(0) : 0
                        ],
                        backgroundColor: [
                            'rgba(0, 255, 136, 0.6)',
                            'rgba(255, 215, 0, 0.6)'
                        ],
                        borderColor: [
                            'var(--accent-green)',
                            'var(--accent-gold)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            labels: { color: 'var(--text-white)' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'var(--text-gray)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'var(--text-gray)' }
                        }
                    }
                }
            });
        }

        // Chart creation functions
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#b8b8b8',
                        font: { family: "'Poppins', sans-serif", size: 12 }
                    }
                }
            },
            scales: {
                y: {
                    ticks: { color: '#b8b8b8' },
                    grid: { color: 'rgba(255, 215, 0, 0.1)' }
                },
                x: {
                    ticks: { color: '#b8b8b8' },
                    grid: { color: 'rgba(255, 215, 0, 0.1)' }
                }
            }
        };

        function createDepositWithdrawalChart() {
            const ctx = document.getElementById('depositWithdrawalChart');
            if (!ctx) return;

            if (charts.depositWithdrawal) charts.depositWithdrawal.destroy();

            charts.depositWithdrawal = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Deposits', 'Withdrawals'],
                    datasets: [{
                        data: [reportData.overview.depositsByType.deposits, reportData.overview.depositsByType.withdrawals],
                        backgroundColor: ['#00ff88', '#ff6b6b'],
                        borderColor: ['#00ff88', '#ff6b6b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => 'â‚¦' + context.parsed.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createStatusBreakdownChart() {
            const ctx = document.getElementById('statusBreakdownChart');
            if (!ctx) return;

            if (charts.statusBreakdown) charts.statusBreakdown.destroy();

            const statuses = reportData.overview.statusBreakdown;
            charts.statusBreakdown = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Approved', 'Pending', 'Rejected'],
                    datasets: [{
                        data: [statuses.successful || 0, statuses.pending || 0, statuses.rejected || 0],
                        backgroundColor: ['#00ff88', '#ffd700', '#ff6b6b'],
                        borderColor: ['#00ff88', '#ffd700', '#ff6b6b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => 'â‚¦' + (context.parsed || 0).toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createHourlyVolumeChart() {
            const ctx = document.getElementById('hourlyVolumeChart');
            if (!ctx) return;

            if (charts.hourlyVolume) charts.hourlyVolume.destroy();

            const hours = Object.keys(reportData.overview.hourlyTransactions).sort();
            const volumes = hours.map(h => reportData.overview.hourlyTransactions[h]);

            charts.hourlyVolume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Transactions',
                        data: volumes,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: '#ffd700',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createTopUsersChart() {
            const ctx = document.getElementById('topUsersChart');
            if (!ctx) return;

            if (charts.topUsers) charts.topUsers.destroy();

            const top10Users = reportData.users.slice(0, 10);
            const names = top10Users.map(u => u.name.substring(0, 15));
            const deposits = top10Users.map(u => u.deposits);
            const withdrawals = top10Users.map(u => u.withdrawals);

            charts.topUsers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [
                        {
                            label: 'Deposits',
                            data: deposits,
                            backgroundColor: 'rgba(0, 255, 136, 0.7)',
                            borderColor: '#00ff88',
                            borderWidth: 2
                        },
                        {
                            label: 'Withdrawals',
                            data: withdrawals,
                            backgroundColor: 'rgba(255, 107, 107, 0.7)',
                            borderColor: '#ff6b6b',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#b8b8b8' },
                            grid: { color: 'rgba(255, 215, 0, 0.1)' },
                            stacked: false
                        },
                        y: {
                            ticks: { color: '#b8b8b8' },
                            grid: { color: 'rgba(255, 215, 0, 0.1)' },
                            stacked: false
                        }
                    }
                }
            });
        }

        function createCountryChart() {
            const ctx = document.getElementById('countryChart');
            if (!ctx) return;

            if (charts.country) charts.country.destroy();

            const countries = reportData.geographic.byCountry.map(c => c.country);
            const amounts = reportData.geographic.byCountry.map(c => c.amount);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b', '#00d4ff', '#ff9f43'];

            charts.country = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: countries,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors.concat(['#8b5cf6', '#ec4899']),
                        borderColor: colors.concat(['#8b5cf6', '#ec4899']),
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => 'â‚¦' + (context.parsed || 0).toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createStateChart() {
            const ctx = document.getElementById('stateChart');
            if (!ctx) return;

            if (charts.state) charts.state.destroy();

            const states = reportData.geographic.byState.slice(0, 10).map(s => s.state);
            const amounts = reportData.geographic.byState.slice(0, 10).map(s => s.amount);

            charts.state = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: states,
                    datasets: [{
                        label: 'Transaction Amount',
                        data: amounts,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createStateDistributionChart() {
            const ctx = document.getElementById('stateDistributionChart');
            if (!ctx) return;

            if (charts.stateDistribution) charts.stateDistribution.destroy();

            const states = reportData.geographic.byState.slice(0, 8).map(s => s.state);
            const amounts = reportData.geographic.byState.slice(0, 8).map(s => s.amount);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b', '#00d4ff', '#ff9f43', '#8b5cf6', '#ec4899', '#14b8a6'];

            charts.stateDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: states,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => 'â‚¦' + (context.parsed || 0).toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function createLGAChart() {
            const ctx = document.getElementById('lgaChart');
            if (!ctx) return;

            if (charts.lga) charts.lga.destroy();

            const lgas = reportData.geographic.byLGA.map(l => l.lga.substring(0, 20));
            const amounts = reportData.geographic.byLGA.map(l => l.amount);

            charts.lga = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lgas,
                    datasets: [{
                        label: 'Transaction Amount',
                        data: amounts,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: '#ffd700',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createDeviceTypeChart() {
            const ctx = document.getElementById('deviceTypeChart');
            if (!ctx) return;

            if (charts.deviceType) charts.deviceType.destroy();

            const types = reportData.devices.byType.map(d => d.type);
            const counts = reportData.devices.byType.map(d => d.count);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b'];

            charts.deviceType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: types,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => (context.parsed || 0) + ' users'
                            }
                        }
                    }
                }
            });
        }

        function createDeviceTypeBarChart() {
            const ctx = document.getElementById('deviceTypeBarChart');
            if (!ctx) return;

            if (charts.deviceTypeBar) charts.deviceTypeBar.destroy();

            const types = reportData.devices.byType.map(d => d.type);
            const counts = reportData.devices.byType.map(d => d.count);

            charts.deviceTypeBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: types,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createBrowserChart() {
            const ctx = document.getElementById('browserChart');
            if (!ctx) return;

            if (charts.browser) charts.browser.destroy();

            const browsers = reportData.devices.byBrowser.map(b => b.browser);
            const counts = reportData.devices.byBrowser.map(b => b.count);

            charts.browser = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: browsers,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: '#ffd700',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createOSChart() {
            const ctx = document.getElementById('osChart');
            if (!ctx) return;

            if (charts.os) charts.os.destroy();

            const oses = reportData.devices.byOS.map(o => o.os);
            const counts = reportData.devices.byOS.map(o => o.count);
            const colors = ['#ffd700', '#00ff88', '#ff6b6b', '#00d4ff', '#ff9f43'];

            charts.os = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: oses,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: (context) => (context.parsed || 0) + ' users'
                            }
                        }
                    }
                }
            });
        }

        function createOSBarChart() {
            const ctx = document.getElementById('osBarChart');
            if (!ctx) return;

            if (charts.osBar) charts.osBar.destroy();

            const oses = reportData.devices.byOS.map(o => o.os);
            const counts = reportData.devices.byOS.map(o => o.count);

            charts.osBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: oses,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(0, 212, 255, 0.7)',
                        borderColor: '#00d4ff',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        function createResolutionChart() {
            const ctx = document.getElementById('resolutionChart');
            if (!ctx) return;

            if (charts.resolution) charts.resolution.destroy();

            const resolutions = reportData.devices.byResolution.map(r => r.resolution);
            const counts = reportData.devices.byResolution.map(r => r.count);

            charts.resolution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: resolutions,
                    datasets: [{
                        label: 'User Count',
                        data: counts,
                        backgroundColor: 'rgba(139, 92, 246, 0.7)',
                        borderColor: '#8b5cf6',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        ...chartOptions.plugins,
                        legend: { display: true, labels: { ...chartOptions.plugins.legend.labels } }
                    }
                }
            });
        }

        // ===== TRANSACTIONS VIEW MODAL =====
        let allTransactions = [];
        let currentStatusFilter = 'all';
        let currentTypeFilter = 'all';
        let currentDayFilter = '7days';
        let currentSearchQuery = '';

        // Open transactions modal
        function openTransactionsModal() {
            document.querySelector('.transactions-modal-overlay').classList.add('active');
            currentStatusFilter = 'all';
            currentTypeFilter = 'all';
            currentDayFilter = '7days';
            currentSearchQuery = '';
            document.getElementById('txSearchInput').value = '';
            loadAllTransactions();
        }

        // Close transactions modal
        function closeTransactionsModal() {
            document.querySelector('.transactions-modal-overlay').classList.remove('active');
        }

        // ========== WATCH FEE MANAGEMENT FUNCTIONS ==========
        let currentWatchFeeMatch = null;
        let paidViewersData = [];

        function openWatchFeeModal(matchId) {
            if (!matchId) {
                showNotification('No match selected', 'error');
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const matchData = doc.data();

                    // Check if livestream is paid
                    if (!matchData.livestream || !matchData.livestream.isPaid) {
                        showNotification('This match does not have a paid livestream', 'error');
                        return;
                    }

                    currentWatchFeeMatch = { id: doc.id, ...matchData };

                    // Display match info
                    const matchInfo = document.getElementById('watchFeeMatchInfo');
                    matchInfo.style.display = 'block';
                    document.getElementById('watchFeeMatchName').textContent =
                        `${matchData.teamA?.name || 'Team A'} vs ${matchData.teamB?.name || 'Team B'}`;
                    document.getElementById('watchFeePrice').textContent =
                        `â‚¦${matchData.livestream.price?.toLocaleString() || 'N/A'}`;

                    // Load paid viewers
                    loadPaidViewersData(matchId);

                    // Open modal
                    document.getElementById('watchFeeModal').classList.add('active');
                    switchWatchFeeTab('stats');
                }
            }).catch(err => showNotification('Error loading match: ' + err.message, 'error'));
        }

        function closeWatchFeeModal() {
            document.getElementById('watchFeeModal').classList.remove('active');
            currentWatchFeeMatch = null;
            paidViewersData = [];
        }

        function switchWatchFeeTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.watch-fee-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.watch-fee-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Mark clicked button as active
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // ===== TOURNAMENT MODAL FUNCTIONS =====
        let currentTournament = null;

        function openTournamentModal(tournamentId) {
            if (tournamentId) {
                // Load tournament data
                db.collection('tournaments').doc(tournamentId).get().then(doc => {
                    if (doc.exists) {
                        currentTournament = { id: doc.id, ...doc.data() };

                        // Show tournament info header (hidden by overlay but data stored)
                        const matchInfo = document.getElementById('tournamentMatchInfo');
                        matchInfo.style.display = 'block';
                        document.getElementById('tournamentName').textContent = currentTournament.name || 'Tournament';
                        document.getElementById('tournamentStatus').textContent = (currentTournament.status || 'upcoming').toUpperCase();

                        // Update overlay with tournament name
                        document.getElementById('overlayTournamentName').textContent = 'ðŸ† ' + (currentTournament.name || 'Tournament');

                        // Hide all sub-tabs and show overlay modal
                        document.getElementById('createTournamentSubTab').style.display = 'none';
                        document.getElementById('liveTournamentSubTab').style.display = 'none';
                        document.getElementById('upcomingTournamentSubTab').style.display = 'none';
                        document.getElementById('finishedTournamentSubTab').style.display = 'none';
                        document.getElementById('tournamentOverlayModal').classList.add('active');

                        // Open modal
                        document.getElementById('tournamentModal').classList.add('active');
                    }
                }).catch(err => showNotification('Error loading tournament: ' + err.message, 'error'));
            } else {
                // Open modal with create form
                currentTournament = null;
                document.getElementById('tournamentMatchInfo').style.display = 'none';
                document.getElementById('tournamentOverlayModal').classList.remove('active');

                // Show create tab
                document.getElementById('createTournamentSubTab').style.display = 'block';
                document.getElementById('liveTournamentSubTab').style.display = 'none';
                document.getElementById('upcomingTournamentSubTab').style.display = 'none';
                document.getElementById('finishedTournamentSubTab').style.display = 'none';

                // Reset form
                document.getElementById('createTournamentForm').reset();
                document.getElementById('hostsContainer').innerHTML = '<input type="text" class="hostInput" placeholder="Enter host name" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;">';

                // Update sub-tab buttons
                const matchTabButtons = document.querySelectorAll('#matchesTab .watch-fee-tabs .watch-fee-tab');
                matchTabButtons.forEach(btn => btn.classList.remove('active'));
                if (matchTabButtons.length > 0) {
                    matchTabButtons[0].classList.add('active');
                }

                // Open modal
                document.getElementById('tournamentModal').classList.add('active');
            }
        }

        function closeTournamentModal() {
            document.getElementById('tournamentModal').classList.remove('active');
            currentTournament = null;
        }

        function closeTournamentOverlay() {
            document.getElementById('tournamentOverlayModal').classList.remove('active');
        }

        // Delete tournament
        function deleteTournament(tournamentId) {
            showConfirmation({
                title: 'ðŸ—‘ï¸ Delete Tournament',
                message: 'Are you sure you want to delete this tournament?\n\nThis will also delete all matches and data associated with this tournament.',
                icon: 'âš ï¸',
                messageType: 'warning',
                confirmText: 'Delete',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        const loadingNotif = showNotification('â³ Deleting tournament...', 'loading', 0);

                        // Delete all matches associated with this tournament
                        const matchesSnapshot = await db.collection('matches')
                            .where('tournamentId', '==', tournamentId)
                            .get();

                        const batch = db.batch();

                        // Delete all matches
                        matchesSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        // Delete the tournament itself
                        batch.delete(db.collection('tournaments').doc(tournamentId));

                        // Commit batch
                        await batch.commit();

                        removeNotification(loadingNotif);
                        showNotification('âœ… Tournament deleted successfully!', 'success', 4000);

                        // Reload tournaments
                        setTimeout(() => {
                            loadLiveTournaments();
                            loadUpcomingTournaments();
                            loadFinishedTournaments();
                        }, 500);

                    } catch (error) {
                        console.error('Error deleting tournament:', error);
                        removeNotification(loadingNotif);
                        showNotification(`âŒ Error deleting tournament: ${error.message}`, 'error', 5000);
                    }
                }
            });
        }

        // ===== TOURNAMENT STANDINGS TABLE FUNCTIONS =====
        function openAddTeamsToStandingsModal() {
            loadTeamsForStandings();
            document.getElementById('addTeamsStandingsOverlay').style.display = 'flex';
        }

        function closeAddTeamsStandingsModal() {
            document.getElementById('addTeamsStandingsOverlay').style.display = 'none';
        }

        async function loadTeamsForStandings() {
            try {
                const container = document.getElementById('teamsForStandingsContainer');
                container.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 20px;">â³ Loading teams...</div>';

                // Get all unique teams from matches
                const snapshot = await db.collection('matches')
                    .where('matchType', '==', 'tournament')
                    .get();

                const teamsSet = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.teamA?.teamName) teamsSet.add(data.teamA.teamName);
                    if (data.teamB?.teamName) teamsSet.add(data.teamB.teamName);
                });

                const teams = Array.from(teamsSet).sort();

                if (teams.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 20px;">No teams found</div>';
                    return;
                }

                // Load current standings to see which teams are already added
                let currentTeams = [];
                const standingsRef = await db.collection('tournaments').doc(currentTournament).collection('standings').get();
                standingsRef.forEach(doc => {
                    currentTeams.push(doc.data().teamName);
                });

                let html = '';
                teams.forEach(teamName => {
                    const isChecked = currentTeams.includes(teamName);
                    html += `
                        <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255, 215, 0, 0.03); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                            <input type="checkbox" value="${teamName}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer; accent-color: rgba(0, 255, 136, 0.8);">
                            <span style="color: var(--text-white); flex: 1; font-weight: 500;">${teamName}</span>
                        </label>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('teamsForStandingsContainer').innerHTML = '<div style="color: red; text-align: center; padding: 20px;">âŒ Error loading teams</div>';
            }
        }

        async function saveTeamsToStandings() {
            try {
                const checkboxes = document.querySelectorAll('#teamsForStandingsContainer input[type="checkbox"]:checked');
                const selectedTeams = Array.from(checkboxes).map(cb => cb.value);

                if (selectedTeams.length === 0) {
                    showNotification('âš ï¸ Please select at least one team', 'error', 3000);
                    return;
                }

                const loadingNotifId = showNotification('ðŸ’¾ Saving teams to standings...', 'loading');

                const standingsRef = db.collection('tournaments').doc(currentTournament).collection('standings');

                // Get existing teams
                const existingDocs = await standingsRef.get();
                const existingTeams = [];
                existingDocs.forEach(doc => existingTeams.push(doc.data().teamName));

                // Remove teams that are no longer selected
                for (const existingTeam of existingTeams) {
                    if (!selectedTeams.includes(existingTeam)) {
                        const docRef = existingDocs.docs.find(doc => doc.data().teamName === existingTeam);
                        if (docRef) await docRef.ref.delete();
                    }
                }

                // Add new teams
                for (const teamName of selectedTeams) {
                    if (!existingTeams.includes(teamName)) {
                        await standingsRef.add({
                            teamName: teamName,
                            position: selectedTeams.indexOf(teamName) + 1,
                            played: 0,
                            won: 0,
                            drawn: 0,
                            lost: 0,
                            goalsFor: 0,
                            goalsAgainst: 0,
                            points: 0,
                            form: '',
                            lastUpdated: new Date()
                        });
                    }
                }

                removeNotification(loadingNotifId);
                showNotification('âœ… Teams saved to standings successfully', 'success', 3000);
                closeAddTeamsStandingsModal();
                refreshTournamentStandings();
            } catch (error) {
                console.error('Error saving teams:', error);
                showNotification('âŒ Error saving teams: ' + error.message, 'error', 4000);
            }
        }

        async function refreshTournamentStandings() {
            try {
                const container = document.getElementById('standingsTableBody');
                container.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-gray);">â³ Loading tournament standings...</td></tr>';

                // Verify tournament exists
                if (!currentTournament || !currentTournament.id) {
                    throw new Error('No tournament selected');
                }

                const standingsRef = await db.collection('tournaments').doc(currentTournament.id).collection('clubs').get();
                const standings = [];

                // Get all matches for stats calculation
                const matchesSnapshot = await db.collection('matches')
                    .where('matchType', '==', 'tournament')
                    .get();

                // Build standings data from clubs
                standingsRef.forEach(doc => {
                    const data = doc.data();
                    standings.push({
                        id: doc.id,
                        clubName: data.name || 'Unknown Club',
                        ownerName: data.ownerName || 'No Owner',
                        playersCount: data.playersCount || 0,
                        played: data.played || 0,
                        won: data.won || 0,
                        drawn: data.drawn || 0,
                        lost: data.lost || 0,
                        goalsFor: data.goalsFor || 0,
                        goalsAgainst: data.goalsAgainst || 0,
                        points: data.points || 0,
                        ...data
                    });
                });

                if (standings.length === 0) {
                    container.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-gray);">ðŸ“‹ No clubs added yet. Add clubs using the "âž• Add Club" button.</td></tr>';
                    return;
                }

                // Calculate stats from matches
                const statsMap = new Map();

                matchesSnapshot.forEach(matchDoc => {
                    const match = matchDoc.data();
                    if (match.status === 'finished' || match.status === 'live') {
                        const teamA = match.teamA?.teamName;
                        const teamB = match.teamB?.teamName;
                        const scoreA = match.finalScore?.teamA || 0;
                        const scoreB = match.finalScore?.teamB || 0;

                        // Initialize if not exists
                        if (!statsMap.has(teamA)) {
                            statsMap.set(teamA, { played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0, points: 0 });
                        }
                        if (!statsMap.has(teamB)) {
                            statsMap.set(teamB, { played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0, points: 0 });
                        }

                        const statsA = statsMap.get(teamA);
                        const statsB = statsMap.get(teamB);

                        statsA.played++;
                        statsB.played++;
                        statsA.goalsFor += scoreA;
                        statsA.goalsAgainst += scoreB;
                        statsB.goalsFor += scoreB;
                        statsB.goalsAgainst += scoreA;

                        if (scoreA > scoreB) {
                            statsA.won++;
                            statsA.points += 3;
                            statsB.lost++;
                        } else if (scoreB > scoreA) {
                            statsB.won++;
                            statsB.points += 3;
                            statsA.lost++;
                        } else {
                            statsA.drawn++;
                            statsB.drawn++;
                            statsA.points += 1;
                            statsB.points += 1;
                        }
                    }
                });

                // Merge calculated stats with standings data
                standings.forEach(team => {
                    const stats = statsMap.get(team.clubName) || {
                        played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0, points: 0
                    };
                    team.played = stats.played;
                    team.won = stats.won;
                    team.drawn = stats.drawn;
                    team.lost = stats.lost;
                    team.goalsFor = stats.goalsFor;
                    team.goalsAgainst = stats.goalsAgainst;
                    team.points = stats.points;
                    team.goalDifference = stats.goalsFor - stats.goalsAgainst;
                });

                // Sort by points (desc), goal difference (desc), goals for (desc)
                standings.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                    return b.goalsFor - a.goalsFor;
                });

                // Build table rows
                let html = '';
                standings.forEach((club, index) => {
                    const gd = club.goalDifference >= 0 ? '+' + club.goalDifference : club.goalDifference;
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255, 215, 0, 0.1);">
                            <td style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700;">${index + 1}</td>
                            <td style="padding: 12px; text-align: left; color: var(--text-white);">${club.clubName}</td>
                            <td style="padding: 12px; text-align: center; color: var(--text-white);">${club.played}</td>
                            <td style="padding: 12px; text-align: center; color: var(--accent-green);">${club.won}</td>
                            <td style="padding: 12px; text-align: center; color: var(--accent-gold);">${club.drawn}</td>
                            <td style="padding: 12px; text-align: center; color: var(--accent-red);">${club.lost}</td>
                            <td style="padding: 12px; text-align: center; color: var(--text-white);">${club.goalsFor}</td>
                            <td style="padding: 12px; text-align: center; color: var(--text-white);">${club.goalsAgainst}</td>
                            <td style="padding: 12px; text-align: center; color: ${club.goalDifference >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${gd}</td>
                            <td style="padding: 12px; text-align: center; color: var(--text-gray);">-</td>
                            <td style="padding: 12px; text-align: center; color: var(--accent-gold); font-weight: 700; font-size: 1.1em;">${club.points}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="openEditClubStatsModal('${club.id}', '${club.clubName}')" style="padding: 6px 12px; background: rgba(255,215,0,0.2); border: 1px solid rgba(255,215,0,0.4); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,215,0,0.3)'" onmouseout="this.style.background='rgba(255,215,0,0.2)'">âœï¸ Edit Stats</button>
                            </td>
                        </tr>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading standings:', error);
                document.getElementById('standingsTableBody').innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: red;">âŒ Error loading standings</td></tr>';
            }
        }

        // Switch between main overlay tabs (Create Match, Matches, Table, Overview)
        function switchTournamentOverlayTab(tabName) {
            // Hide all main overlay tabs
            document.getElementById('overlayCreateMatchTab').style.display = 'none';
            document.getElementById('overlayMatchesTab').style.display = 'none';
            document.getElementById('overlayTableTab').style.display = 'none';
            document.getElementById('overlayOverviewTab').style.display = 'none';

            // Remove active from all main overlay tab buttons
            const mainTabButtons = document.querySelectorAll('#tournamentOverlay > .watch-fee-tabs:first-of-type .watch-fee-tab');
            mainTabButtons.forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            if (tabName === 'createMatch') {
                document.getElementById('overlayCreateMatchTab').style.display = 'block';
            } else if (tabName === 'matches') {
                document.getElementById('overlayMatchesTab').style.display = 'block';
            } else if (tabName === 'table') {
                document.getElementById('overlayTableTab').style.display = 'block';
                refreshTournamentStandings();
            } else if (tabName === 'overview') {
                document.getElementById('overlayOverviewTab').style.display = 'block';
                loadTournamentFinances();
            }

            // Mark clicked button as active
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Switch between match status sub-tabs (Live, Upcoming, Finished, Cancelled)
        function switchTournamentMatchStatusTab(status) {
            document.getElementById('overlayLiveMatchesContent').style.display = 'none';
            document.getElementById('overlayUpcomingMatchesContent').style.display = 'none';
            document.getElementById('overlayFinishedMatchesContent').style.display = 'none';
            document.getElementById('overlayCancelledMatchesContent').style.display = 'none';

            const statusTabButtons = document.querySelectorAll('#overlayMatchesTab .watch-fee-tabs .watch-fee-tab');
            statusTabButtons.forEach(btn => btn.classList.remove('active'));

            if (status === 'live') {
                document.getElementById('overlayLiveMatchesContent').style.display = 'block';
                loadTournamentLiveMatches();
            } else if (status === 'upcoming') {
                document.getElementById('overlayUpcomingMatchesContent').style.display = 'block';
                loadTournamentUpcomingMatches();
            } else if (status === 'finished') {
                document.getElementById('overlayFinishedMatchesContent').style.display = 'block';
                loadTournamentFinishedMatches();
            } else if (status === 'cancelled') {
                document.getElementById('overlayCancelledMatchesContent').style.display = 'block';
                loadTournamentCancelledMatches();
            }

            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // ===== TOURNAMENT LIVE MATCHES FUNCTIONS =====
        async function loadTournamentLiveMatches() {
            try {
                const container = document.getElementById('overlayLiveMatchesContent');
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray);">â³ Loading live matches...</p>';

                let query = db.collection('matches')
                    .where('status', '==', 'live')
                    .where('matchType', '==', 'tournament');

                // Filter by current tournament
                if (currentTournament && currentTournament.id) {
                    query = query.where('tournamentId', '==', currentTournament.id);
                }

                const snapshot = await query.get();

                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">ðŸ”´ No live tournament matches</p>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 20px;">';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const matchId = doc.id;

                    // Safely extract team names
                    const teamAName = match.teamA && match.teamA.name ? match.teamA.name : 'Team A';
                    const teamBName = match.teamB && match.teamB.name ? match.teamB.name : 'Team B';
                    const teamALogo = match.teamA && match.teamA.logo ? match.teamA.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';
                    const teamBLogo = match.teamB && match.teamB.logo ? match.teamB.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';

                    html += `
                        <div style="background: rgba(21, 25, 48, 0.8); border: 2px solid rgba(255, 215, 0, 0.2); border-radius: 15px; padding: 20px;">
                            <!-- Match Header -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-gray);">Tournament: ${match.tournamentId || 'N/A'}</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-gold);">${match.name || 'Match'}</div>
                                </div>
                                <div style="background: rgba(255, 0, 0, 0.3); border: 1px solid #ff4444; color: #ff6b6b; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em;">ðŸ”´ LIVE</div>
                            </div>

                            <!-- Teams Score -->
                            <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; gap: 20px;">
                                <!-- Team A -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamALogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team A">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamAName}</div>
                                    ${match.teamA?.matchPass ? `<div style="font-size: 0.75em; color: var(--accent-green); background: rgba(0, 255, 136, 0.15); padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-weight: 600;">ðŸŽ« ${match.teamA.matchPass}</div>` : ''}
                                </div>

                                <!-- Score -->
                                <div style="text-align: center;">
                                    <div style="font-size: 2.5em; font-weight: 900; color: var(--accent-gold);">
                                        ${match.teamA?.goals || 0} - ${match.teamB?.goals || 0}
                                    </div>
                                </div>

                                <!-- Team B -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamBLogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team B">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamBName}</div>
                                    ${match.teamB?.matchPass ? `<div style="font-size: 0.75em; color: var(--accent-green); background: rgba(0, 255, 136, 0.15); padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-weight: 600;">ðŸŽ« ${match.teamB.matchPass}</div>` : ''}
                                </div>
                            </div>

                            <!-- Update Stats Section -->
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                <div style="font-weight: 600; color: var(--accent-gold); margin-bottom: 12px; font-size: 0.95em;">ðŸ“Š Update Live Statistics</div>
                                
                                <!-- Score (Always shown) -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">âš½ Team A Goals</label>
                                        <input type="number" id="liveScoreTeamA_${matchId}" value="${match.teamA?.goals || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; font-weight: 600;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">âš½ Team B Goals</label>
                                        <input type="number" id="liveScoreTeamB_${matchId}" value="${match.teamB?.goals || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; font-weight: 600;" min="0">
                                    </div>
                                </div>

                                <!-- Stats based on selected stats during match creation -->
                                ${match.stats?.corners ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸš© Team A Corners</label>
                                        <input type="number" id="liveCornerA_${matchId}" value="${match.liveStats?.corners?.teamA || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸš© Team B Corners</label>
                                        <input type="number" id="liveCornerB_${matchId}" value="${match.liveStats?.corners?.teamB || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                </div>
                                ` : ''}

                                ${match.stats?.possession ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸŽ¯ Team A Possession %</label>
                                        <input type="number" id="livePossessionA_${matchId}" value="${match.liveStats?.possession?.teamA || 50}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0" max="100">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸŽ¯ Team B Possession %</label>
                                        <input type="number" id="livePossessionB_${matchId}" value="${match.liveStats?.possession?.teamB || 50}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0" max="100">
                                    </div>
                                </div>
                                ` : ''}

                                ${match.stats?.shots ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">âš½ Team A Shots</label>
                                        <input type="number" id="liveShotsA_${matchId}" value="${match.liveStats?.shots?.teamA || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">âš½ Team B Shots</label>
                                        <input type="number" id="liveShotsB_${matchId}" value="${match.liveStats?.shots?.teamB || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                </div>
                                ` : ''}

                                ${match.stats?.shotOnTarget ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸŽ¯ Team A Shots on Target</label>
                                        <input type="number" id="liveShotOnTargetA_${matchId}" value="${match.liveStats?.shotOnTarget?.teamA || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸŽ¯ Team B Shots on Target</label>
                                        <input type="number" id="liveShotOnTargetB_${matchId}" value="${match.liveStats?.shotOnTarget?.teamB || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                </div>
                                ` : ''}

                                ${match.stats?.passes ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸ“‹ Team A Passes</label>
                                        <input type="number" id="livePassesA_${matchId}" value="${match.liveStats?.passes?.teamA || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">ðŸ“‹ Team B Passes</label>
                                        <input type="number" id="livePassesB_${matchId}" value="${match.liveStats?.passes?.teamB || 0}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;" min="0">
                                    </div>
                                </div>
                                ` : ''}

                                ${match.stats?.bookings ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 0.75em; color: var(--text-gray);">ðŸŸ¨ Team A Yellow</label>
                                        <input type="number" id="liveYellowA_${matchId}" value="${match.liveStats?.yellowCards?.teamA || 0}" 
                                            style="width: 100%; padding: 6px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; font-size: 0.9em;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.75em; color: var(--text-gray);">ðŸŸ¥ Team A Red</label>
                                        <input type="number" id="liveRedA_${matchId}" value="${match.liveStats?.redCards?.teamA || 0}" 
                                            style="width: 100%; padding: 6px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; font-size: 0.9em;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.75em; color: var(--text-gray);">ðŸŸ¨ Team B Yellow</label>
                                        <input type="number" id="liveYellowB_${matchId}" value="${match.liveStats?.yellowCards?.teamB || 0}" 
                                            style="width: 100%; padding: 6px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; font-size: 0.9em;" min="0">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.75em; color: var(--text-gray);">ðŸŸ¥ Team B Red</label>
                                        <input type="number" id="liveRedB_${matchId}" value="${match.liveStats?.redCards?.teamB || 0}" 
                                            style="width: 100%; padding: 6px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; font-size: 0.9em;" min="0">
                                    </div>
                                </div>
                                ` : ''}

                                <!-- Action Buttons -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                    <button onclick="updateTournamentLiveScore('${matchId}')" 
                                        style="padding: 10px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                        onmouseover="this.style.background='rgba(0, 255, 136, 0.3)'" onmouseout="this.style.background='rgba(0, 255, 136, 0.2)'">
                                        âœ… Update
                                    </button>
                                    <button onclick="cancelTournamentLiveUpdate('${matchId}')" 
                                        style="padding: 10px; background: rgba(0, 212, 255, 0.2); border: 1px solid rgba(0, 212, 255, 0.4); color: #00d4ff; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                        onmouseover="this.style.background='rgba(0, 212, 255, 0.3)'" onmouseout="this.style.background='rgba(0, 212, 255, 0.2)'">
                                        â†©ï¸ Cancel
                                    </button>
                                    <button onclick="deleteTournamentMatch('${matchId}')" 
                                        style="padding: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                        onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'">
                                        ðŸ—‘ï¸ Delete Match
                                    </button>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                <button onclick="openTournamentWatchFeeModal('${matchId}')" 
                                    style="padding: 10px; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                    onmouseover="this.style.background='rgba(255, 215, 0, 0.25)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'">
                                    ðŸ’³ Watch Fee
                                </button>
                                <button onclick="finishTournamentMatch('${matchId}')" 
                                    style="padding: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                    onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'">
                                    âœ… Finish
                                </button>
                                <button onclick="cancelTournamentMatchFromLive('${matchId}')" 
                                    style="padding: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                    onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'">
                                    âŒ Cancel Match
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading live matches:', error);
                document.getElementById('overlayLiveMatchesContent').innerHTML =
                    '<p style="text-align: center; color: #ff6b6b; padding: 40px;">âŒ Error loading matches: ' + error.message + '</p>';
            }
        }

        // ===== TOURNAMENT UPCOMING MATCHES FUNCTIONS =====
        async function loadTournamentUpcomingMatches() {
            try {
                const container = document.getElementById('overlayUpcomingMatchesContent');
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray);">â³ Loading upcoming matches...</p>';

                let query = db.collection('matches')
                    .where('status', '==', 'upcoming')
                    .where('matchType', '==', 'tournament');

                // Filter by current tournament
                if (currentTournament && currentTournament.id) {
                    query = query.where('tournamentId', '==', currentTournament.id);
                }

                const snapshot = await query.get();

                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">ðŸ“… No upcoming tournament matches</p>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 20px;">';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const matchId = doc.id;

                    // Safely extract team names
                    const teamAName = match.teamA && match.teamA.name ? match.teamA.name : 'Team A';
                    const teamBName = match.teamB && match.teamB.name ? match.teamB.name : 'Team B';
                    const teamALogo = match.teamA && match.teamA.logo ? match.teamA.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';
                    const teamBLogo = match.teamB && match.teamB.logo ? match.teamB.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';
                    const teamAPlayers = match.teamA && match.teamA.players ? match.teamA.players.length : 0;
                    const teamBPlayers = match.teamB && match.teamB.players ? match.teamB.players.length : 0;

                    html += `
                        <div style="background: rgba(21, 25, 48, 0.8); border: 2px solid rgba(0, 212, 255, 0.2); border-radius: 15px; padding: 20px;">
                            <!-- Match Header -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-gray);">Tournament: ${match.tournamentId || 'N/A'}</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-gold);">${match.name || 'Match'}</div>
                                </div>
                                <div style="background: rgba(0, 212, 255, 0.2); border: 1px solid rgba(0, 212, 255, 0.4); color: #00d4ff; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em;">ðŸ“… UPCOMING</div>
                            </div>

                            <!-- Teams -->
                            <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; gap: 20px;">
                                <!-- Team A -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamALogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team A">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamAName}</div>
                                    <div style="font-size: 0.8em; color: var(--text-gray);">Players: ${teamAPlayers}</div>
                                    ${match.teamA?.matchPass ? `<div style="font-size: 0.75em; color: var(--accent-green); background: rgba(0, 255, 136, 0.15); padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-weight: 600;">ðŸŽ« ${match.teamA.matchPass}</div>` : ''}
                                </div>

                                <!-- VS -->
                                <div style="text-align: center; color: var(--accent-gold); font-weight: 900; font-size: 1.2em;">VS</div>

                                <!-- Team B -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamBLogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team B">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamBName}</div>
                                    <div style="font-size: 0.8em; color: var(--text-gray);">Players: ${match.teamB?.players?.length || 0}</div>
                                    ${match.teamB?.matchPass ? `<div style="font-size: 0.75em; color: var(--accent-green); background: rgba(0, 255, 136, 0.15); padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-weight: 600;">ðŸŽ« ${match.teamB.matchPass}</div>` : ''}
                                </div>
                            </div>

                            <!-- Match Details -->
                            <div style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.85em;">ðŸ“… Date</div>
                                        <div style="color: var(--text-white); font-weight: 600;">${match.matchDate || 'TBD'}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.85em;">â° Time</div>
                                        <div style="color: var(--text-white); font-weight: 600;">${match.matchTime || 'TBD'}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                <button onclick="editTournamentMatch('${matchId}')" 
                                    style="padding: 10px; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                    onmouseover="this.style.background='rgba(255, 215, 0, 0.25)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'">
                                    âœï¸ Edit
                                </button>
                                <button onclick="startTournamentMatch('${matchId}')" 
                                    style="padding: 10px; background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                    onmouseover="this.style.background='rgba(255, 0, 0, 0.3)'" onmouseout="this.style.background='rgba(255, 0, 0, 0.2)'">
                                    ðŸ”´ Start
                                </button>
                                <button onclick="cancelTournamentMatchFromUpcoming('${matchId}')" 
                                    style="padding: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em;"
                                    onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'">
                                    âŒ Cancel
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading upcoming matches:', error);
                document.getElementById('overlayUpcomingMatchesContent').innerHTML =
                    '<p style="text-align: center; color: #ff6b6b; padding: 40px;">âŒ Error loading matches: ' + error.message + '</p>';
            }
        }

        // ===== TOURNAMENT FINISHED MATCHES FUNCTIONS =====
        async function loadTournamentFinishedMatches() {
            try {
                const container = document.getElementById('overlayFinishedMatchesContent');
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray);">â³ Loading finished matches...</p>';

                let query = db.collection('matches')
                    .where('status', '==', 'finished')
                    .where('matchType', '==', 'tournament');

                // Filter by current tournament
                if (currentTournament && currentTournament.id) {
                    query = query.where('tournamentId', '==', currentTournament.id);
                }

                const snapshot = await query.get();

                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">âœ… No finished tournament matches</p>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 20px;">';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const matchId = doc.id;

                    // Safely extract team names
                    const teamAName = match.teamA && match.teamA.name ? match.teamA.name : 'Team A';
                    const teamBName = match.teamB && match.teamB.name ? match.teamB.name : 'Team B';
                    const teamALogo = match.teamA && match.teamA.logo ? match.teamA.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';
                    const teamBLogo = match.teamB && match.teamB.logo ? match.teamB.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';

                    const teamAGoals = match.teamA?.goals || 0;
                    const teamBGoals = match.teamB?.goals || 0;
                    const winner = teamAGoals > teamBGoals ? teamAName : teamAGoals < teamBGoals ? teamBName : 'Draw';
                    const winnerStyle = winner === 'Draw'
                        ? 'color: var(--accent-gold);'
                        : winner === teamAName || winner === teamBName
                            ? 'color: var(--accent-green);'
                            : 'color: var(--accent-green);';

                    html += `
                        <div style="background: rgba(21, 25, 48, 0.8); border: 2px solid rgba(0, 255, 136, 0.2); border-radius: 15px; padding: 20px;">
                            <!-- Match Header -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-gray);">Tournament: ${match.tournamentId || 'N/A'}</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-gold);">${match.name || 'Match'}</div>
                                </div>
                                <div style="background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em;">âœ… FINISHED</div>
                            </div>

                            <!-- Final Score -->
                            <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; gap: 20px;">
                                <!-- Team A -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamALogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team A">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamAName}</div>
                                    <div style="font-size: 0.8em; color: var(--text-gray);">${teamAGoals} Goals</div>
                                    ${match.teamA?.matchPass ? `<div style="font-size: 0.75em; color: var(--accent-green); background: rgba(0, 255, 136, 0.15); padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-weight: 600;">ðŸŽ« ${match.teamA.matchPass}</div>` : ''}
                                </div>

                                <!-- Final Score (Large) -->
                                <div style="text-align: center;">
                                    <div style="font-size: 3em; font-weight: 900; color: var(--accent-gold); line-height: 1;">
                                        ${teamAGoals}
                                    </div>
                                    <div style="font-size: 1.5em; color: var(--text-gray);">-</div>
                                    <div style="font-size: 3em; font-weight: 900; color: var(--accent-gold); line-height: 1;">
                                        ${teamBGoals}
                                    </div>
                                </div>

                                <!-- Team B -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamBLogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team B">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamBName}</div>
                                    <div style="font-size: 0.8em; color: var(--text-gray);">${teamBGoals} Goals</div>
                                    ${match.teamB?.matchPass ? `<div style="font-size: 0.75em; color: var(--accent-green); background: rgba(0, 255, 136, 0.15); padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-weight: 600;">ðŸŽ« ${match.teamB.matchPass}</div>` : ''}
                                </div>
                            </div>

                            <!-- Winner -->
                            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                                <div style="font-size: 0.85em; color: var(--text-gray);">ðŸ† Result</div>
                                <div style="font-weight: 600; font-size: 1.1em; ${winnerStyle}">${winner}</div>
                            </div>

                            <!-- Actions -->
                            <button onclick="viewTournamentMatchStats('${matchId}')" 
                                style="width: 100%; padding: 10px; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                onmouseover="this.style.background='rgba(255, 215, 0, 0.25)'" onmouseout="this.style.background='rgba(255, 215, 0, 0.15)'">
                                ðŸ“Š View Stats
                            </button>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading finished matches:', error);
                document.getElementById('overlayFinishedMatchesContent').innerHTML =
                    '<p style="text-align: center; color: #ff6b6b; padding: 40px;">âŒ Error loading matches: ' + error.message + '</p>';
            }
        }

        async function loadTournamentCancelledMatches() {
            try {
                const container = document.getElementById('overlayCancelledMatchesContent');
                container.innerHTML = '<p style="text-align: center; color: var(--text-gray);">â³ Loading cancelled matches...</p>';

                let query = db.collection('matches')
                    .where('status', '==', 'cancelled')
                    .where('matchType', '==', 'tournament');

                // Filter by current tournament
                if (currentTournament && currentTournament.id) {
                    query = query.where('tournamentId', '==', currentTournament.id);
                }

                const snapshot = await query.get();

                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">âŒ No cancelled tournament matches</p>';
                    return;
                }

                let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 20px;">';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const matchId = doc.id;

                    // Safely extract team names
                    const teamAName = match.teamA && match.teamA.name ? match.teamA.name : 'Team A';
                    const teamBName = match.teamB && match.teamB.name ? match.teamB.name : 'Team B';
                    const teamALogo = match.teamA && match.teamA.logo ? match.teamA.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';
                    const teamBLogo = match.teamB && match.teamB.logo ? match.teamB.logo : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E';

                    html += `
                        <div style="background: rgba(21, 25, 48, 0.8); border: 2px solid rgba(255, 107, 107, 0.2); border-radius: 15px; padding: 20px; position: relative; opacity: 0.8;">
                            <!-- CANCELLED OVERLAY -->
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; pointer-events: none;">
                                <div style="background: rgba(255, 107, 107, 0.9); border: 3px solid #ff6b6b; padding: 20px 40px; border-radius: 15px; transform: rotate(-25deg);">
                                    <div style="font-size: 2.5em; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); letter-spacing: 2px;">CANCELLED</div>
                                </div>
                            </div>

                            <!-- Match Header -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 0.85em; color: var(--text-gray);">Tournament: ${match.tournamentId || 'N/A'}</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--text-gray);">${match.name || 'Match'}</div>
                                </div>
                                <div style="background: rgba(255, 107, 107, 0.3); border: 1px solid rgba(255, 107, 107, 0.5); color: #ff6b6b; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em;">âŒ CANCELLED</div>
                            </div>

                            <!-- Teams Info -->
                            <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; gap: 20px;">
                                <!-- Team A -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamALogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team A">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamAName}</div>
                                </div>

                                <!-- VS -->
                                <div style="text-align: center; color: var(--text-gray); font-weight: 600;">VS</div>

                                <!-- Team B -->
                                <div style="text-align: center; flex: 1;">
                                    <img src="${teamBLogo}" 
                                        style="width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; object-fit: cover;" alt="Team B">
                                    <div style="font-weight: 600; color: var(--text-white);">${teamBName}</div>
                                </div>
                            </div>

                            <!-- Cancellation Info -->
                            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                                <div style="font-size: 0.85em; color: var(--text-gray);">ðŸ“… Scheduled Date</div>
                                <div style="font-weight: 600; color: var(--text-white);">${match.matchDate || 'TBD'} ${match.matchTime || ''}</div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="reactivateTournamentMatch('${matchId}')" 
                                    style="padding: 10px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='rgba(0, 255, 136, 0.3)'" onmouseout="this.style.background='rgba(0, 255, 136, 0.2)'">
                                    â†©ï¸ Reactivate
                                </button>
                                <button onclick="deleteTournamentMatch('${matchId}')" 
                                    style="padding: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'">
                                    ðŸ—‘ï¸ Delete Permanently
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading cancelled matches:', error);
                document.getElementById('overlayCancelledMatchesContent').innerHTML =
                    '<p style="text-align: center; color: #ff6b6b; padding: 40px;">âŒ Error loading matches: ' + error.message + '</p>';
            }
        }

        // ===== TOURNAMENT MATCH ACTION FUNCTIONS =====

        async function updateTournamentLiveScore(matchId) {
            try {
                const doc = await db.collection('matches').doc(matchId).get();
                if (!doc.exists) {
                    showNotification('Match not found', 'error');
                    return;
                }

                const match = doc.data();
                const updateData = {
                    'teamA.goals': parseInt(document.getElementById(`liveScoreTeamA_${matchId}`).value) || 0,
                    'teamB.goals': parseInt(document.getElementById(`liveScoreTeamB_${matchId}`).value) || 0,
                    'updatedAt': new Date().toISOString()
                };

                // Build liveStats based on selected stats during creation
                let liveStatsUpdate = {};

                if (match.stats?.corners) {
                    liveStatsUpdate['liveStats.corners.teamA'] = parseInt(document.getElementById(`liveCornerA_${matchId}`)?.value) || 0;
                    liveStatsUpdate['liveStats.corners.teamB'] = parseInt(document.getElementById(`liveCornerB_${matchId}`)?.value) || 0;
                }

                if (match.stats?.possession) {
                    liveStatsUpdate['liveStats.possession.teamA'] = parseInt(document.getElementById(`livePossessionA_${matchId}`)?.value) || 50;
                    liveStatsUpdate['liveStats.possession.teamB'] = parseInt(document.getElementById(`livePossessionB_${matchId}`)?.value) || 50;
                }

                if (match.stats?.shots) {
                    liveStatsUpdate['liveStats.shots.teamA'] = parseInt(document.getElementById(`liveShotsA_${matchId}`)?.value) || 0;
                    liveStatsUpdate['liveStats.shots.teamB'] = parseInt(document.getElementById(`liveShotsB_${matchId}`)?.value) || 0;
                }

                if (match.stats?.shotOnTarget) {
                    liveStatsUpdate['liveStats.shotOnTarget.teamA'] = parseInt(document.getElementById(`liveShotOnTargetA_${matchId}`)?.value) || 0;
                    liveStatsUpdate['liveStats.shotOnTarget.teamB'] = parseInt(document.getElementById(`liveShotOnTargetB_${matchId}`)?.value) || 0;
                }

                if (match.stats?.passes) {
                    liveStatsUpdate['liveStats.passes.teamA'] = parseInt(document.getElementById(`livePassesA_${matchId}`)?.value) || 0;
                    liveStatsUpdate['liveStats.passes.teamB'] = parseInt(document.getElementById(`livePassesB_${matchId}`)?.value) || 0;
                }

                if (match.stats?.bookings) {
                    liveStatsUpdate['liveStats.yellowCards.teamA'] = parseInt(document.getElementById(`liveYellowA_${matchId}`)?.value) || 0;
                    liveStatsUpdate['liveStats.yellowCards.teamB'] = parseInt(document.getElementById(`liveYellowB_${matchId}`)?.value) || 0;
                    liveStatsUpdate['liveStats.redCards.teamA'] = parseInt(document.getElementById(`liveRedA_${matchId}`)?.value) || 0;
                    liveStatsUpdate['liveStats.redCards.teamB'] = parseInt(document.getElementById(`liveRedB_${matchId}`)?.value) || 0;
                }

                // Merge all updates
                const finalUpdate = { ...updateData, ...liveStatsUpdate };

                await db.collection('matches').doc(matchId).update(finalUpdate);

                showNotification('âœ… Match statistics updated successfully!', 'success');
                loadTournamentLiveMatches();
            } catch (error) {
                console.error('Error updating statistics:', error);
                showNotification(`âŒ Error: ${error.message}`, 'error');
            }
        }

        function cancelTournamentLiveUpdate(matchId) {
            // Reload to reset form values
            loadTournamentLiveMatches();
            showNotification('Update cancelled', 'info');
        }

        async function deleteTournamentMatch(matchId) {
            showConfirmation({
                title: 'ðŸ—‘ï¸ Delete Match',
                message: 'Delete this match? This action cannot be undone!',
                icon: 'ðŸ—‘ï¸',
                messageType: 'warning',
                confirmText: 'Delete',
                cancelText: 'Keep',
                onConfirm: async () => {

                    try {
                        const loadingNotifId = showNotification('ðŸ—‘ï¸ Deleting match...', 'loading', 0);

                        // Delete the match document
                        await db.collection('matches').doc(matchId).delete();

                        removeNotification(loadingNotifId);
                        showNotification('âœ… Match deleted successfully!', 'success', 4000);
                        loadTournamentLiveMatches();
                        loadTournamentUpcomingMatches();
                        loadTournamentFinishedMatches();
                        loadTournamentCancelledMatches();
                    } catch (error) {
                        console.error('Error deleting match:', error);
                        showNotification(`âŒ Error: ${error.message}`, 'error', 4000);
                    }
                }
            });
        }

        async function cancelTournamentMatchFromUpcoming(matchId) {
            showConfirmation({
                title: 'â¸ï¸ Cancel Match',
                message: 'Cancel this match? Players will be notified.',
                icon: 'â¸ï¸',
                messageType: 'warning',
                confirmText: 'Cancel Match',
                cancelText: 'Keep',
                onConfirm: async () => {
                    try {
                        const loadingNotifId = showNotification('â³ Cancelling match...', 'loading', 0);

                        await db.collection('matches').doc(matchId).update({
                            status: 'cancelled',
                            cancelledAt: new Date().toISOString()
                        });

                        removeNotification(loadingNotifId);
                        showNotification('âœ… Match cancelled successfully!', 'success', 4000);
                        loadTournamentUpcomingMatches();
                        loadTournamentCancelledMatches();
                    } catch (error) {
                        console.error('Error cancelling match:', error);
                        showNotification(`âŒ Error: ${error.message}`, 'error', 4000);
                    }
                }
            });
        }

        async function reactivateTournamentMatch(matchId) {
            showConfirmation({
                title: 'ðŸ”„ Reactivate Match',
                message: 'Reactivate this match? Players will be notified.',
                icon: 'ðŸ”„',
                messageType: 'info',
                confirmText: 'Reactivate',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        const loadingNotifId = showNotification('â³ Reactivating match...', 'loading', 0);

                        await db.collection('matches').doc(matchId).update({
                            status: 'upcoming',
                            reactivatedAt: new Date().toISOString()
                        });

                        removeNotification(loadingNotifId);
                        showNotification('âœ… Match reactivated successfully!', 'success', 4000);
                        loadTournamentUpcomingMatches();
                        loadTournamentCancelledMatches();
                    } catch (error) {
                        console.error('Error reactivating match:', error);
                        showNotification(`âŒ Error: ${error.message}`, 'error', 4000);
                    }
                }
            });
        }

        async function cancelTournamentMatchFromLive(matchId) {
            showConfirmation({
                title: 'âŒ Cancel Live Match',
                message: 'Cancel this live match? It will be moved to cancelled status and players notified.',
                icon: 'âŒ',
                messageType: 'warning',
                confirmText: 'Cancel',
                cancelText: 'Keep',
                onConfirm: async () => {
                    try {
                        const loadingNotifId = showNotification('â³ Cancelling live match...', 'loading', 0);

                        await db.collection('matches').doc(matchId).update({
                            status: 'cancelled',
                            cancelledAt: new Date().toISOString()
                        });

                        removeNotification(loadingNotifId);
                        showNotification('âœ… Match cancelled successfully!', 'success', 4000);
                        loadTournamentLiveMatches();
                        loadTournamentCancelledMatches();
                    } catch (error) {
                        console.error('Error cancelling live match:', error);
                        showNotification(`âŒ Error: ${error.message}`, 'error', 4000);
                    }
                }
            });
        }

        async function finishTournamentMatch(matchId) {
            showConfirmation({
                title: 'âœ… Finish Match',
                message: 'Mark this match as finished?',
                icon: 'âœ…',
                messageType: 'info',
                confirmText: 'Finish',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        await db.collection('matches').doc(matchId).update({
                            status: 'finished',
                            finishedAt: new Date().toISOString()
                        });

                        showNotification('âœ… Match finished successfully!', 'success');
                        loadTournamentLiveMatches();
                        loadTournamentFinishedMatches();
                    } catch (error) {
                        console.error('Error finishing match:', error);
                        showNotification(`âŒ Error: ${error.message}`, 'error');
                    }
                }
            });
        }

        async function startTournamentMatch(matchId) {
            showConfirmation({
                title: 'ðŸš€ Start Match',
                message: 'Start this tournament match now?',
                icon: 'ðŸš€',
                messageType: 'info',
                confirmText: 'Start',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        await db.collection('matches').doc(matchId).update({
                            status: 'live',
                            startedAt: new Date().toISOString()
                        });

                        showNotification('âœ… Match started!', 'success');
                        loadTournamentUpcomingMatches();
                        loadTournamentLiveMatches();
                    } catch (error) {
                        console.error('Error starting match:', error);
                        showNotification(`âŒ Error: ${error.message}`, 'error');
                    }
                }
            });
        }

        // ===== TOURNAMENT MATCH EDIT & DETAILED STATS =====
        let currentTournamentLiveMatch = null;
        let editModalSponsors = [];

        async function editTournamentMatch(matchId) {
            try {
                const doc = await db.collection('matches').doc(matchId).get();
                if (!doc.exists) {
                    showNotification('Match not found', 'error');
                    return;
                }

                const match = doc.data();
                currentTournamentLiveMatch = { id: matchId, ...match };
                editModalSponsors = JSON.parse(JSON.stringify(match.sponsors || []));

                // Create edit modal HTML
                const editHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="closeTournamentEditModal()">
                        <div style="background: rgba(21, 25, 48, 0.95); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 30px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation();">
                            <!-- Header -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                                <h2 style="font-size: 1.5em; font-weight: 900; color: var(--accent-gold);">âœï¸ Edit Match Details</h2>
                                <button onclick="closeTournamentEditModal()" style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                            </div>

                            <!-- Match Basic Info -->
                            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="font-weight: 600; color: var(--accent-green); margin-bottom: 15px; font-size: 1.1em;">ðŸ“‹ Match Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Match Name</label>
                                        <input type="text" id="editTournamentMatchName" value="${match.name || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Match Time</label>
                                        <input type="time" id="editTournamentMatchTime" value="${match.matchTime || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Match Date</label>
                                        <input type="date" id="editTournamentMatchDate" value="${match.matchDate || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Team A Section -->
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="font-weight: 600; color: var(--accent-gold); margin-bottom: 15px; font-size: 1.1em;">ðŸ‘¥ Team A Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Team Name</label>
                                        <input type="text" id="editTeamAName" value="${match.teamA?.name || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Logo URL</label>
                                        <input type="text" id="editTeamALogo" value="${match.teamA?.logo || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px; font-size: 0.8em;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Captain Name</label>
                                        <input type="text" id="editTeamACaptain" value="${match.teamA?.captain || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">DLS Player</label>
                                        <input type="text" id="editTeamADLS" value="${match.teamA?.dlsPlayer || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Club Owner</label>
                                        <input type="text" id="editTeamAOwner" value="${match.teamA?.clubOwner || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Team B Section -->
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="font-weight: 600; color: var(--accent-gold); margin-bottom: 15px; font-size: 1.1em;">ðŸ‘¥ Team B Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Team Name</label>
                                        <input type="text" id="editTeamBName" value="${match.teamB?.name || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Logo URL</label>
                                        <input type="text" id="editTeamBLogo" value="${match.teamB?.logo || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px; font-size: 0.8em;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Captain Name</label>
                                        <input type="text" id="editTeamBCaptain" value="${match.teamB?.captain || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">DLS Player</label>
                                        <input type="text" id="editTeamBDLS" value="${match.teamB?.dlsPlayer || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Club Owner</label>
                                        <input type="text" id="editTeamBOwner" value="${match.teamB?.clubOwner || ''}" 
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Winning Chances -->
                            <div style="background: rgba(100, 200, 255, 0.1); border: 1px solid rgba(100, 200, 255, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="font-weight: 600; color: #64c8ff; margin-bottom: 15px; font-size: 1.1em;">ðŸ† Winning Chances (Optional)</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Team A Winning %</label>
                                        <input type="number" id="editWinChanceA" value="${match.winningChances?.teamA || 0}" min="0" max="100"
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(100, 200, 255, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Team B Winning %</label>
                                        <input type="number" id="editWinChanceB" value="${match.winningChances?.teamB || 0}" min="0" max="100"
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(100, 200, 255, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Livestream Settings -->
                            <div style="background: rgba(200, 100, 255, 0.1); border: 1px solid rgba(200, 100, 255, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="font-weight: 600; color: #c864ff; margin-bottom: 15px; font-size: 1.1em;">ðŸ“¹ Livestream Settings</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray); display: block;">Enable Livestream</label>
                                        <input type="checkbox" id="editLiveStreamEnabled" ${match.livestream?.enabled ? 'checked' : ''} 
                                            style="margin-top: 5px; cursor: pointer; width: 20px; height: 20px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Livestream Type</label>
                                        <select id="editLiveStreamType" style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(200, 100, 255, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                            <option value="free" ${match.livestream?.isPaid === false ? 'selected' : ''}>âœ… Free</option>
                                            <option value="paid" ${match.livestream?.isPaid === true ? 'selected' : ''}>ðŸ’° Paid</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Watch Fee (â‚¦)</label>
                                        <input type="number" id="editLiveStreamPrice" value="${match.livestream?.price || 0}" min="0"
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(200, 100, 255, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-gray);">Max Viewers</label>
                                        <input type="number" id="editMaxViewers" value="${match.livestream?.maxViewers || 0}" min="0"
                                            style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(200, 100, 255, 0.3); color: var(--text-white); border-radius: 6px; margin-top: 5px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Sponsors Section -->
                            <div style="background: rgba(0, 200, 100, 0.1); border: 1px solid rgba(0, 200, 100, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="font-weight: 600; color: #00c864; margin-bottom: 15px; font-size: 1.1em;">ðŸ¢ Sponsors (${(match.sponsors || []).length})</h3>
                                <div id="editSponsorsList" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;">
                                    ${(match.sponsors || []).map((s, idx) => `
                                        <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
                                            <img src="${s.logo || ''}" style="width: 30px; height: 30px; border-radius: 3px; object-fit: cover;">
                                            <span style="flex: 1; color: var(--text-white);">${s.name}</span>
                                            <button onclick="removeEditSponsor(${idx})" style="background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">Ã—</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                                    <input type="text" id="editSponsorName" placeholder="Sponsor name" 
                                        style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 200, 100, 0.3); color: var(--text-white); border-radius: 6px;">
                                    <input type="text" id="editSponsorLogo" placeholder="Logo URL" 
                                        style="width: 100%; padding: 8px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 200, 100, 0.3); color: var(--text-white); border-radius: 6px; font-size: 0.8em;">
                                </div>
                                <button onclick="addEditSponsor()" style="width: 100%; padding: 8px; margin-top: 8px; background: rgba(0, 200, 100, 0.2); border: 1px solid rgba(0, 200, 100, 0.4); color: #00c864; border-radius: 6px; cursor: pointer; font-weight: 600;">+ Add Sponsor</button>
                            </div>

                            <!-- Players Section -->
                            <div style="background: rgba(200, 150, 100, 0.1); border: 1px solid rgba(200, 150, 100, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="font-weight: 600; color: #c89664; margin-bottom: 15px; font-size: 1.1em;">âš½ Players (Team A: ${(match.teamA?.players || []).length}/17 | Team B: ${(match.teamB?.players || []).length}/17)</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-size: 0.9em; color: #c89664; font-weight: 600;">Team A Players</label>
                                        <div id="editTeamAPlayersList" style="max-height: 120px; overflow-y: auto; border: 1px solid rgba(200, 150, 100, 0.2); border-radius: 5px; padding: 8px;">
                                            ${(match.teamA?.players || []).map((p, idx) => `
                                                <div style="background: rgba(0,0,0,0.2); padding: 5px; border-radius: 3px; margin-bottom: 3px; font-size: 0.85em; color: var(--text-white);">
                                                    #${p.number} ${p.name} <span style="color: var(--text-gray);">(${p.role})</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.9em; color: #c89664; font-weight: 600;">Team B Players</label>
                                        <div id="editTeamBPlayersList" style="max-height: 120px; overflow-y: auto; border: 1px solid rgba(200, 150, 100, 0.2); border-radius: 5px; padding: 8px;">
                                            ${(match.teamB?.players || []).map((p, idx) => `
                                                <div style="background: rgba(0,0,0,0.2); padding: 5px; border-radius: 3px; margin-bottom: 3px; font-size: 0.85em; color: var(--text-white);">
                                                    #${p.number} ${p.name} <span style="color: var(--text-gray);">(${p.role})</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                <p style="color: var(--text-gray); font-size: 0.8em; margin-top: 10px;">ðŸ“ To edit players, please use the match creation form. Max 17 players per team.</p>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                                <button onclick="saveTournamentMatchEdits()" 
                                    style="padding: 12px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.95em;"
                                    onmouseover="this.style.background='rgba(0, 255, 136, 0.3)'" onmouseout="this.style.background='rgba(0, 255, 136, 0.2)'">
                                    âœ… Save Changes
                                </button>
                                <button onclick="closeTournamentEditModal()" 
                                    style="padding: 12px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.95em;"
                                    onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'">
                                    âŒ Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Remove old modal if exists
                const oldModal = document.getElementById('tournamentEditModal');
                if (oldModal) oldModal.remove();

                // Create and add modal
                const modal = document.createElement('div');
                modal.id = 'tournamentEditModal';
                modal.innerHTML = editHTML;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error opening edit modal:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function closeTournamentEditModal() {
            const modal = document.getElementById('tournamentEditModal');
            if (modal) modal.remove();
        }

        async function saveTournamentMatchEdits() {
            try {
                if (!currentTournamentLiveMatch?.id) {
                    showNotification('Match not found', 'error');
                    return;
                }

                const updatedData = {
                    name: document.getElementById('editTournamentMatchName').value,
                    matchDate: document.getElementById('editTournamentMatchDate').value,
                    matchTime: document.getElementById('editTournamentMatchTime').value,
                    teamA: {
                        ...currentTournamentLiveMatch.teamA,
                        name: document.getElementById('editTeamAName').value,
                        logo: document.getElementById('editTeamALogo').value,
                        captain: document.getElementById('editTeamACaptain').value,
                        dlsPlayer: document.getElementById('editTeamADLS').value,
                        clubOwner: document.getElementById('editTeamAOwner').value
                    },
                    teamB: {
                        ...currentTournamentLiveMatch.teamB,
                        name: document.getElementById('editTeamBName').value,
                        logo: document.getElementById('editTeamBLogo').value,
                        captain: document.getElementById('editTeamBCaptain').value,
                        dlsPlayer: document.getElementById('editTeamBDLS').value,
                        clubOwner: document.getElementById('editTeamBOwner').value
                    },
                    winningChances: {
                        teamA: parseFloat(document.getElementById('editWinChanceA').value) || 0,
                        teamB: parseFloat(document.getElementById('editWinChanceB').value) || 0
                    },
                    livestream: {
                        enabled: document.getElementById('editLiveStreamEnabled').checked,
                        isPaid: document.getElementById('editLiveStreamType').value === 'paid',
                        price: parseFloat(document.getElementById('editLiveStreamPrice').value) || 0,
                        maxViewers: parseInt(document.getElementById('editMaxViewers').value) || 0
                    },
                    sponsors: editModalSponsors,
                    updatedAt: new Date().toISOString()
                };

                await db.collection('matches').doc(currentTournamentLiveMatch.id).update(updatedData);
                showNotification('âœ… Changes saved successfully!', 'success', 4000);
                closeTournamentEditModal();
                loadTournamentUpcomingMatches();
                loadTournamentLiveMatches();
            } catch (error) {
                console.error('Error saving edits:', error);
                showNotification(`âŒ Error: ${error.message}`, 'error', 4000);
            }
        }

        function addEditSponsor() {
            const name = document.getElementById('editSponsorName').value.trim();
            const logo = document.getElementById('editSponsorLogo').value.trim();

            if (!name) {
                showNotification('âŒ Sponsor name is required', 'error', 3000);
                return;
            }

            editModalSponsors.push({ name, logo });
            document.getElementById('editSponsorName').value = '';
            document.getElementById('editSponsorLogo').value = '';

            // Refresh sponsors display
            refreshEditSponsorsDisplay();
            showNotification('âœ… Sponsor added', 'success', 2000);
        }

        function removeEditSponsor(index) {
            editModalSponsors.splice(index, 1);
            refreshEditSponsorsDisplay();
            showNotification('âœ… Sponsor removed', 'success', 2000);
        }

        function refreshEditSponsorsDisplay() {
            const container = document.getElementById('editSponsorsList');
            if (!container) return;

            container.innerHTML = editModalSponsors.map((s, idx) => `
                <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
                    <img src="${s.logo || ''}" style="width: 30px; height: 30px; border-radius: 3px; object-fit: cover;">
                    <span style="flex: 1; color: var(--text-white);">${s.name}</span>
                    <button onclick="removeEditSponsor(${idx})" style="background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.4); color: #ff6b6b; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">Ã—</button>
                </div>
            `).join('');
        }

        async function viewTournamentMatchStats(matchId) {
            try {
                const doc = await db.collection('matches').doc(matchId).get();
                if (!doc.exists) {
                    showNotification('Match not found', 'error');
                    return;
                }

                const match = doc.data();
                const stats = match.liveStats || {};
                const teamAGoals = match.teamA?.goals || 0;
                const teamBGoals = match.teamB?.goals || 0;

                // Create stats modal
                const statsHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="closeMatchStatsModal()">
                        <div style="background: rgba(21, 25, 48, 0.95); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 30px; max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation();">
                            <!-- Header -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                                <h2 style="font-size: 1.5em; font-weight: 900; color: var(--accent-gold);">ðŸ“Š Match Statistics</h2>
                                <button onclick="closeMatchStatsModal()" style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                            </div>

                            <!-- Match Info -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                                <div style="text-align: center; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">${match.teamA?.name || 'Team A'}</div>
                                    <div style="font-size: 2.5em; font-weight: 900; color: var(--accent-gold);">${teamAGoals}</div>
                                </div>
                                <div style="text-align: center; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">Final Score</div>
                                    <div style="font-size: 1.2em; font-weight: 600; color: var(--text-white);">${match.matchDate || 'TBD'}</div>
                                </div>
                                <div style="text-align: center; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">${match.teamB?.name || 'Team B'}</div>
                                    <div style="font-size: 2.5em; font-weight: 900; color: var(--accent-gold);">${teamBGoals}</div>
                                </div>
                            </div>

                            <!-- Stats Display -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <!-- Corners -->
                                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 10px;">ðŸš© Corners</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.corners?.teamA || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team A</div>
                                        </div>
                                        <div style="width: 30%; height: 30px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; overflow: hidden; position: relative;">
                                            <div style="width: ${Math.round((stats.corners?.teamA || 0) / (((stats.corners?.teamA || 0) + (stats.corners?.teamB || 0)) || 1) * 100)}%; height: 100%; background: rgba(255, 215, 0, 0.5);"></div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.corners?.teamB || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team B</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Possession -->
                                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 10px;">ðŸŽ¯ Possession</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.possession?.teamA || 50}%</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team A</div>
                                        </div>
                                        <div style="width: 30%; height: 30px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; overflow: hidden; position: relative;">
                                            <div style="width: ${stats.possession?.teamA || 50}%; height: 100%; background: rgba(255, 215, 0, 0.5);"></div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.possession?.teamB || 50}%</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team B</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shots -->
                                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 10px;">âš½ Shots</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.shots?.teamA || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team A</div>
                                        </div>
                                        <div style="width: 30%; height: 30px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; overflow: hidden; position: relative;">
                                            <div style="width: ${Math.round((stats.shots?.teamA || 0) / (((stats.shots?.teamA || 0) + (stats.shots?.teamB || 0)) || 1) * 100)}%; height: 100%; background: rgba(255, 215, 0, 0.5);"></div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.shots?.teamB || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team B</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Yellow Cards -->
                                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 10px;">ðŸŸ¨ Yellow Cards</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.yellowCards?.teamA || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team A</div>
                                        </div>
                                        <div style="text-align: center; flex: 1;"></div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.yellowCards?.teamB || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team B</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Red Cards -->
                                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px;">
                                    <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 10px;">ðŸŸ¥ Red Cards</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.redCards?.teamA || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team A</div>
                                        </div>
                                        <div style="text-align: center; flex: 1;"></div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.8em; font-weight: 900; color: var(--text-white);">${stats.redCards?.teamB || 0}</div>
                                            <div style="font-size: 0.8em; color: var(--text-gray);">Team B</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Close Button -->
                            <button onclick="closeMatchStatsModal()" style="width: 100%; padding: 12px; margin-top: 20px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                âŒ Close
                            </button>
                        </div>
                    </div>
                `;

                const oldModal = document.getElementById('matchStatsModal');
                if (oldModal) oldModal.remove();

                const modal = document.createElement('div');
                modal.id = 'matchStatsModal';
                modal.innerHTML = statsHTML;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing stats:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function closeMatchStatsModal() {
            const modal = document.getElementById('matchStatsModal');
            if (modal) modal.remove();
        }

        // ===== TOURNAMENT WATCH FEE MODAL FUNCTIONS =====
        let currentTournamentWatchFeeMatch = null;
        let tournamentPaidViewersData = [];

        function openTournamentWatchFeeModal(matchId) {
            if (!matchId) {
                showNotification('No match selected', 'error');
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const matchData = doc.data();

                    // Check if livestream is paid
                    if (!matchData.livestream || !matchData.livestream.isPaid) {
                        showNotification('This match does not have a paid livestream', 'error');
                        return;
                    }

                    currentTournamentWatchFeeMatch = { id: doc.id, ...matchData };

                    // Create watch fee modal HTML
                    const modalHTML = `
                        <div id="tournamentWatchFeeOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 7000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="if(event.target.id === 'tournamentWatchFeeOverlay') closeTournamentWatchFeeModal();">
                            <div style="background: var(--card-bg); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 20px; max-width: 900px; width: 100%; max-height: 85vh; overflow-y: auto; padding: 30px;" onclick="event.stopPropagation();">
                                <!-- Header -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid rgba(255, 215, 0, 0.2);">
                                    <h2 style="font-size: 1.8em; font-weight: 900; color: var(--accent-gold); text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);">ðŸ’° Watch Fee Management</h2>
                                    <button onclick="closeTournamentWatchFeeModal()" style="background: none; border: none; font-size: 2em; color: var(--text-gray); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 215, 0, 0.1)'; this.style.color='var(--accent-gold)';" onmouseout="this.style.background='none'; this.style.color='var(--text-gray)';">Ã—</button>
                                </div>

                                <!-- Match Info -->
                                <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                        <div style="text-align: center;">
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">Match Name</div>
                                            <div style="font-size: 1.3em; font-weight: 700; color: var(--text-white);" id="tournamentWatchFeeMatchName">${matchData.teamA?.name || 'Team A'} vs ${matchData.teamB?.name || 'Team B'}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">Watch Fee Price</div>
                                            <div style="font-size: 1.3em; font-weight: 700; color: var(--accent-gold);" id="tournamentWatchFeePrice">â‚¦${matchData.livestream.price?.toLocaleString() || 'N/A'}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">Total Revenue</div>
                                            <div style="font-size: 1.3em; font-weight: 700; color: var(--accent-green);" id="tournamentWatchFeeTotalRevenue">â‚¦0</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabs -->
                                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(255, 215, 0, 0.1); padding-bottom: 0;">
                                    <button onclick="switchTournamentWatchFeeTab('stats')" style="padding: 12px 20px; background: rgba(255, 215, 0, 0.2); border: none; color: var(--accent-gold); cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0; transition: all 0.3s ease;" class="tournament-watch-fee-tab active" data-tab="stats">ðŸ“Š Stats & Analytics</button>
                                    <button onclick="switchTournamentWatchFeeTab('viewers')" style="padding: 12px 20px; background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0; transition: all 0.3s ease;" class="tournament-watch-fee-tab" data-tab="viewers">ðŸ‘¥ Paid Viewers</button>
                                    <button onclick="switchTournamentWatchFeeTab('settings')" style="padding: 12px 20px; background: transparent; border: none; color: var(--text-gray); cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0; transition: all 0.3s ease;" class="tournament-watch-fee-tab" data-tab="settings">âš™ï¸ Settings</button>
                                </div>

                                <!-- Stats Tab -->
                                <div id="tournamentWatchFeeStatsTab" style="display: block;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                        <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); padding: 15px; border-radius: 10px;">
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 10px;">Total Paid Views</div>
                                            <div style="font-size: 2em; font-weight: 900; color: var(--accent-green);" id="tournamentTotalPaidViews">0</div>
                                        </div>
                                        <div style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.2); padding: 15px; border-radius: 10px;">
                                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 10px;">Average Watch Time</div>
                                            <div style="font-size: 2em; font-weight: 900; color: #00d4ff;" id="tournamentAvgWatchTime">0 min</div>
                                        </div>
                                    </div>
                                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.2); padding: 20px; border-radius: 10px;">
                                        <h3 style="color: var(--accent-gold); font-weight: 600; margin-bottom: 15px;">Viewer Distribution</h3>
                                        <div id="tournamentWatchFeeViewersList" style="max-height: 300px; overflow-y: auto;">
                                            <div style="text-align: center; color: var(--text-gray); padding: 20px;">Loading viewer data...</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Viewers Tab -->
                                <div id="tournamentWatchFeeViewersTab" style="display: none;">
                                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.2); padding: 20px; border-radius: 10px;">
                                        <h3 style="color: var(--accent-gold); font-weight: 600; margin-bottom: 15px;">ðŸ’³ Paid Viewers List</h3>
                                        <div id="tournamentPaidViewersList" style="max-height: 400px; overflow-y: auto;">
                                            <div style="text-align: center; color: var(--text-gray); padding: 20px;">Loading paid viewers...</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Tab -->
                                <div id="tournamentWatchFeeSettingsTab" style="display: none;">
                                    <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 215, 0, 0.2); padding: 20px; border-radius: 10px;">
                                        <h3 style="color: var(--accent-gold); font-weight: 600; margin-bottom: 15px;">âš™ï¸ Watch Fee Settings</h3>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                            <div>
                                                <label style="display: block; color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">Current Price (â‚¦)</label>
                                                <input type="number" id="tournamentWatchFeePrice" value="${matchData.livestream.price || 0}" min="0" step="100" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;">
                                            </div>
                                            <div>
                                                <label style="display: block; color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">Max Concurrent Viewers</label>
                                                <input type="number" id="tournamentMaxViewers" value="${matchData.livestream.maxViewers || 1000}" min="1" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 215, 0, 0.3); color: var(--text-white); border-radius: 6px;">
                                            </div>
                                        </div>
                                        <button onclick="saveTournamentWatchFeeSettings()" style="width: 100%; padding: 12px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 0.95em;" onmouseover="this.style.background='rgba(0, 255, 136, 0.3)'" onmouseout="this.style.background='rgba(0, 255, 136, 0.2)'">âœ… Save Settings</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove old modal if exists
                    const oldModal = document.getElementById('tournamentWatchFeeOverlay');
                    if (oldModal) oldModal.remove();

                    // Create and add modal
                    const modalDiv = document.createElement('div');
                    modalDiv.innerHTML = modalHTML;
                    document.body.appendChild(modalDiv.firstElementChild);

                    // Load data
                    loadTournamentWatchFeeData(matchId);
                }
            }).catch(err => showNotification('Error loading match: ' + err.message, 'error'));
        }

        function closeTournamentWatchFeeModal() {
            const modal = document.getElementById('tournamentWatchFeeOverlay');
            if (modal) modal.remove();
            currentTournamentWatchFeeMatch = null;
            tournamentPaidViewersData = [];
        }

        function switchTournamentWatchFeeTab(tabName) {
            // Hide all tabs
            document.getElementById('tournamentWatchFeeStatsTab').style.display = 'none';
            document.getElementById('tournamentWatchFeeViewersTab').style.display = 'none';
            document.getElementById('tournamentWatchFeeSettingsTab').style.display = 'none';

            // Remove active from all buttons
            document.querySelectorAll('.tournament-watch-fee-tab').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = 'var(--text-gray)';
            });

            // Show selected tab
            if (tabName === 'stats') {
                document.getElementById('tournamentWatchFeeStatsTab').style.display = 'block';
            } else if (tabName === 'viewers') {
                document.getElementById('tournamentWatchFeeViewersTab').style.display = 'block';
            } else if (tabName === 'settings') {
                document.getElementById('tournamentWatchFeeSettingsTab').style.display = 'block';
            }

            // Mark clicked button as active
            if (event && event.target) {
                event.target.style.background = 'rgba(255, 215, 0, 0.2)';
                event.target.style.color = 'var(--accent-gold)';
            }
        }

        function loadTournamentWatchFeeData(matchId) {
            // Load paid viewers
            db.collection('matches').doc(matchId).collection('paidViewers').get().then(snapshot => {
                tournamentPaidViewersData = [];
                let totalRevenue = 0;
                let totalWatchTime = 0;

                snapshot.forEach(doc => {
                    const viewerData = doc.data();
                    tournamentPaidViewersData.push({
                        id: doc.id,
                        ...viewerData
                    });
                    totalRevenue += viewerData.amountPaid || 0;
                    totalWatchTime += viewerData.watchDuration || 0;
                });

                // Update stats
                document.getElementById('tournamentWatchFeeTotalRevenue').textContent = 'â‚¦' + totalRevenue.toLocaleString();
                document.getElementById('tournamentTotalPaidViews').textContent = tournamentPaidViewersData.length;
                document.getElementById('tournamentAvgWatchTime').textContent = tournamentPaidViewersData.length > 0 ? Math.round(totalWatchTime / tournamentPaidViewersData.length) + ' min' : '0 min';

                // Update viewers list
                displayTournamentViewers();
            }).catch(err => {
                console.error('Error loading paid viewers:', err);
                document.getElementById('tournamentWatchFeeViewersList').innerHTML = '<div style="color: #ff6b6b; padding: 20px;">Error loading viewer data</div>';
            });
        }

        function displayTournamentViewers() {
            const container = document.getElementById('tournamentWatchFeeViewersList');
            const paidContainer = document.getElementById('tournamentPaidViewersList');

            if (tournamentPaidViewersData.length === 0) {
                container.innerHTML = '<div style="color: var(--text-gray); padding: 20px; text-align: center;">No paid viewers yet</div>';
                paidContainer.innerHTML = '<div style="color: var(--text-gray); padding: 20px; text-align: center;">No paid viewers yet</div>';
                return;
            }

            // Display distribution for stats tab
            let distributionHTML = '';
            tournamentPaidViewersData.forEach(viewer => {
                distributionHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; margin-bottom: 10px;">
                        <div>
                            <div style="color: var(--text-white); font-weight: 600;">${viewer.userName || 'Anonymous'}</div>
                            <div style="color: var(--text-gray); font-size: 0.85em;">Watch: ${viewer.watchDuration || 0} min</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--accent-gold); font-weight: 600;">â‚¦${(viewer.amountPaid || 0).toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = distributionHTML;

            // Display full list for viewers tab
            let listHTML = '';
            tournamentPaidViewersData.forEach(viewer => {
                listHTML += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; margin-bottom: 10px; align-items: center;">
                        <div>
                            <div style="color: var(--text-white); font-weight: 600;">${viewer.userName || 'Anonymous'}</div>
                            <div style="color: var(--text-gray); font-size: 0.8em;">${viewer.userEmail || 'N/A'}</div>
                        </div>
                        <div style="color: var(--text-gray);">${new Date(viewer.purchaseDate).toLocaleDateString()}</div>
                        <div style="color: var(--accent-gold); font-weight: 600;">â‚¦${(viewer.amountPaid || 0).toLocaleString()}</div>
                        <div style="color: var(--accent-green);">${viewer.watchDuration || 0} min</div>
                    </div>
                `;
            });
            paidContainer.innerHTML = listHTML;
        }

        function saveTournamentWatchFeeSettings() {
            try {
                const newPrice = parseInt(document.getElementById('tournamentWatchFeePrice').value) || 0;
                const maxViewers = parseInt(document.getElementById('tournamentMaxViewers').value) || 1000;

                if (!currentTournamentWatchFeeMatch?.id) {
                    showNotification('Match not found', 'error');
                    return;
                }

                db.collection('matches').doc(currentTournamentWatchFeeMatch.id).update({
                    'livestream.price': newPrice,
                    'livestream.maxViewers': maxViewers,
                    updatedAt: new Date().toISOString()
                }).then(() => {
                    showNotification('âœ… Settings updated successfully!', 'success');
                }).catch(err => {
                    showNotification('Error updating settings: ' + err.message, 'error');
                });
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Switch between analysis sub-tabs (Finances, Matches, Livestreams, Viewers)
        function switchTournamentAnalysisTab(tab) {
            document.getElementById('overlayFinancesContent').style.display = 'none';
            document.getElementById('overlayMatchesAnalysisContent').style.display = 'none';
            document.getElementById('overlayLivestreamsContent').style.display = 'none';
            document.getElementById('overlayViewersContent').style.display = 'none';

            const analysisTabButtons = document.querySelectorAll('#overlayOverviewTab > .watch-fee-tabs .watch-fee-tab');
            analysisTabButtons.forEach(btn => btn.classList.remove('active'));

            if (tab === 'finances') {
                document.getElementById('overlayFinancesContent').style.display = 'block';
                loadTournamentFinances();
            } else if (tab === 'matches') {
                document.getElementById('overlayMatchesAnalysisContent').style.display = 'block';
                loadTournamentMatchesAnalysis();
            } else if (tab === 'livestreams') {
                document.getElementById('overlayLivestreamsContent').style.display = 'block';
                loadTournamentLivestreams();
            } else if (tab === 'viewers') {
                document.getElementById('overlayViewersContent').style.display = 'block';
                loadTournamentViewers();
            }

            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // ===== TOURNAMENT OVERVIEW ANALYSIS FUNCTIONS =====
        async function loadTournamentFinances() {
            try {
                if (!currentTournament || !currentTournament.id) {
                    return;
                }

                // Get all matches for this tournament
                const matchesSnapshot = await db.collection('matches')
                    .where('tournamentId', '==', currentTournament.id)
                    .get();

                let totalWatchFeeRevenue = 0;
                let totalRevenue = 0;
                const matchRevenueData = [];

                matchesSnapshot.forEach(matchDoc => {
                    const match = matchDoc.data();

                    // Calculate watch fee revenue
                    if (match.watchFeeAmount && match.viewers) {
                        const matchRevenue = match.watchFeeAmount * match.viewers;
                        totalWatchFeeRevenue += matchRevenue;
                        totalRevenue += matchRevenue;
                        matchRevenueData.push({
                            name: `${match.teamA?.teamName || 'Team A'} vs ${match.teamB?.teamName || 'Team B'}`,
                            revenue: matchRevenue
                        });
                    }
                });

                // Update cards
                document.querySelector('#overlayFinancesContent [style*="Total Revenue"]').parentElement.querySelector('div:nth-child(2)').textContent = '$' + totalRevenue.toFixed(2);
                document.querySelector('#overlayFinancesContent [style*="Watch Fee"]').parentElement.querySelector('div:nth-child(2)').textContent = '$' + totalWatchFeeRevenue.toFixed(2);

                // Draw income graph
                drawIncomeGraph(matchRevenueData);
            } catch (error) {
                console.error('Error loading finances:', error);
            }
        }

        function drawIncomeGraph(matchData) {
            const container = document.getElementById('incomeGraphContainer');
            if (!container) return;

            if (matchData.length === 0) {
                container.innerHTML = '<div style="color: var(--text-gray); text-align: center; width: 100%;">No revenue data yet</div>';
                return;
            }

            const maxRevenue = Math.max(...matchData.map(m => m.revenue));
            const barWidth = Math.max(30, 100 / matchData.length);

            let html = '';
            matchData.forEach(match => {
                const height = (match.revenue / maxRevenue) * 250;
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <div style="background: linear-gradient(180deg, var(--accent-gold) 0%, rgba(255, 215, 0, 0.6) 100%); width: ${barWidth}px; height: ${height}px; border-radius: 4px; cursor: pointer;" title="$${match.revenue.toFixed(2)}"></div>
                        <div style="color: var(--text-gray); font-size: 0.75em; max-width: ${barWidth + 20}px; word-break: break-word; text-align: center;">$${(match.revenue / 1000).toFixed(1)}k</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function loadTournamentMatchesAnalysis() {
            try {
                const container = document.getElementById('overlayMatchesAnalysisContent');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">â³ Loading match statistics...</div>';

                if (!currentTournament || !currentTournament.id) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">âŒ No tournament selected</div>';
                    return;
                }

                // Get all matches for this tournament
                const matchesSnapshot = await db.collection('matches')
                    .where('tournamentId', '==', currentTournament.id)
                    .get();

                let totalMatches = 0;
                let liveMatches = 0;
                let finishedMatches = 0;
                let upcomingMatches = 0;
                let cancelledMatches = 0;
                let totalGoals = 0;
                let wins = 0, draws = 0, losses = 0;
                let highestScoringMatch = null;
                let maxGoals = 0;

                const matchesList = [];

                matchesSnapshot.forEach(doc => {
                    const match = doc.data();
                    totalMatches++;

                    if (match.status === 'live') liveMatches++;
                    else if (match.status === 'finished') finishedMatches++;
                    else if (match.status === 'upcoming') upcomingMatches++;
                    else if (match.status === 'cancelled') cancelledMatches++;

                    if (match.status === 'finished') {
                        const scoreA = match.finalScore?.teamA || 0;
                        const scoreB = match.finalScore?.teamB || 0;
                        const matchTotal = scoreA + scoreB;
                        totalGoals += matchTotal;

                        if (scoreA > scoreB) wins++;
                        else if (scoreB > scoreA) losses++;
                        else draws++;

                        if (matchTotal > maxGoals) {
                            maxGoals = matchTotal;
                            highestScoringMatch = {
                                name: `${match.teamA?.teamName} ${scoreA}-${scoreB} ${match.teamB?.teamName}`,
                                goals: matchTotal
                            };
                        }

                        matchesList.push({
                            name: `${match.teamA?.teamName} vs ${match.teamB?.teamName}`,
                            score: `${scoreA}-${scoreB}`,
                            date: match.date ? new Date(match.date.toDate()).toLocaleDateString() : 'Unknown'
                        });
                    }
                });

                const avgGoalsPerMatch = finishedMatches > 0 ? (totalGoals / finishedMatches).toFixed(2) : 0;

                const html = `
                    <div style="padding: 25px;">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <!-- Total Matches Card -->
                            <div style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Total Matches</div>
                                <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">${totalMatches}</div>
                            </div>

                            <!-- Live Matches Card -->
                            <div style="background: rgba(255, 100, 100, 0.08); border: 2px solid rgba(255, 100, 100, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">ðŸ”´ Live</div>
                                <div style="font-size: 2.2em; color: rgba(255, 100, 100, 0.8); font-weight: 700;">${liveMatches}</div>
                            </div>

                            <!-- Finished Matches Card -->
                            <div style="background: rgba(0, 255, 136, 0.08); border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">âœ… Finished</div>
                                <div style="font-size: 2.2em; color: var(--accent-green); font-weight: 700;">${finishedMatches}</div>
                            </div>

                            <!-- Upcoming Matches Card -->
                            <div style="background: rgba(100, 200, 255, 0.08); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">â° Upcoming</div>
                                <div style="font-size: 2.2em; color: rgba(100, 200, 255, 0.8); font-weight: 700;">${upcomingMatches}</div>
                            </div>

                            <!-- Cancelled Matches Card -->
                            <div style="background: rgba(255, 107, 107, 0.08); border: 2px solid rgba(255, 107, 107, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">âŒ Cancelled</div>
                                <div style="font-size: 2.2em; color: rgba(255, 107, 107, 0.8); font-weight: 700;">${cancelledMatches}</div>
                            </div>
                        </div>

                        <!-- Performance Stats -->
                        <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">âš½ Performance Statistics</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Total Goals</div>
                                    <div style="color: var(--accent-green); font-weight: 700; font-size: 1.6em;">${totalGoals}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Avg Goals/Match</div>
                                    <div style="color: var(--accent-green); font-weight: 700; font-size: 1.6em;">${avgGoalsPerMatch}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Wins</div>
                                    <div style="color: rgba(0, 255, 136, 0.8); font-weight: 700; font-size: 1.6em;">${wins}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Draws</div>
                                    <div style="color: var(--accent-gold); font-weight: 700; font-size: 1.6em;">${draws}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Losses</div>
                                    <div style="color: rgba(255, 100, 100, 0.8); font-weight: 700; font-size: 1.6em;">${losses}</div>
                                </div>
                                ${highestScoringMatch ? `
                                <div>
                                    <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Highest Scoring</div>
                                    <div style="color: var(--accent-gold); font-weight: 700; font-size: 1em;">${highestScoringMatch.name}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Match Results -->
                        <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px;">
                            <div style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">ðŸ“‹ Match Results</div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${matchesList.length > 0 ? matchesList.map(m => `
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(255, 215, 0, 0.1); align-items: center;">
                                        <div style="color: var(--text-white); font-weight: 500; font-size: 0.9em;">${m.name}</div>
                                        <div style="text-align: center; color: var(--accent-gold); font-weight: 700; font-size: 1.1em;">${m.score}</div>
                                        <div style="text-align: right; color: var(--text-gray); font-size: 0.85em;">${m.date}</div>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No finished matches yet</div>'}
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading matches analysis:', error);
                document.getElementById('overlayMatchesAnalysisContent').innerHTML = '<div style="text-align: center; padding: 40px; color: red;">âŒ Error loading match statistics</div>';
            }
        }

        async function loadTournamentLivestreams() {
            try {
                const container = document.getElementById('overlayLivestreamsContent');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">â³ Loading livestream data...</div>';

                if (!currentTournament || !currentTournament.id) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">âŒ No tournament selected</div>';
                    return;
                }

                // Get all matches with livestream data
                const matchesSnapshot = await db.collection('matches')
                    .where('tournamentId', '==', currentTournament.id)
                    .get();

                let totalLivestreams = 0;
                let totalLiveViewers = 0;
                let peakViewers = 0;
                let avgViewers = 0;
                let totalDuration = 0;
                const livestreamsList = [];

                matchesSnapshot.forEach(doc => {
                    const match = doc.data();
                    if (match.livestreamEnabled) {
                        totalLivestreams++;
                        const viewers = match.viewers || 0;
                        totalLiveViewers += viewers;
                        peakViewers = Math.max(peakViewers, viewers);

                        const duration = match.duration || 0;
                        totalDuration += duration;

                        livestreamsList.push({
                            name: `${match.teamA?.teamName} vs ${match.teamB?.teamName}`,
                            viewers: viewers,
                            duration: duration,
                            status: match.status === 'live' ? 'ðŸ”´ LIVE' : 'âœ… Finished'
                        });
                    }
                });

                avgViewers = totalLivestreams > 0 ? (totalLiveViewers / totalLivestreams).toFixed(0) : 0;
                const avgDuration = totalLivestreams > 0 ? (totalDuration / totalLivestreams).toFixed(0) : 0;

                const html = `
                    <div style="padding: 25px;">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <!-- Total Livestreams Card -->
                            <div style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Total Livestreams</div>
                                <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">${totalLivestreams}</div>
                            </div>

                            <!-- Total Viewers Card -->
                            <div style="background: rgba(100, 200, 255, 0.08); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Total Viewers</div>
                                <div style="font-size: 2.2em; color: rgba(100, 200, 255, 0.8); font-weight: 700;">${totalLiveViewers.toLocaleString()}</div>
                            </div>

                            <!-- Peak Viewers Card -->
                            <div style="background: rgba(255, 100, 100, 0.08); border: 2px solid rgba(255, 100, 100, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Peak Viewers</div>
                                <div style="font-size: 2.2em; color: rgba(255, 100, 100, 0.8); font-weight: 700;">${peakViewers.toLocaleString()}</div>
                            </div>

                            <!-- Average Viewers Card -->
                            <div style="background: rgba(0, 255, 136, 0.08); border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Avg Viewers</div>
                                <div style="font-size: 2.2em; color: var(--accent-green); font-weight: 700;">${avgViewers.toLocaleString()}</div>
                            </div>

                            <!-- Average Duration Card -->
                            <div style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Avg Duration</div>
                                <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">${avgDuration} min</div>
                            </div>
                        </div>

                        <!-- Livestream Details -->
                        <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px;">
                            <div style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">ðŸ“¹ Livestream Details</div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${livestreamsList.length > 0 ? livestreamsList.map(ls => `
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(255, 215, 0, 0.1); align-items: center;">
                                        <div style="color: var(--text-white); font-weight: 500; font-size: 0.9em;">${ls.name}</div>
                                        <div style="text-align: center; color: var(--text-gray); font-size: 0.9em;">${ls.viewers} viewers</div>
                                        <div style="text-align: center; color: var(--text-gray); font-size: 0.9em;">${ls.duration} min</div>
                                        <div style="text-align: right; color: var(--accent-gold); font-weight: 600; font-size: 0.9em;">${ls.status}</div>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No livestream data yet</div>'}
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading livestreams:', error);
                document.getElementById('overlayLivestreamsContent').innerHTML = '<div style="text-align: center; padding: 40px; color: red;">âŒ Error loading livestream data</div>';
            }
        }

        async function loadTournamentViewers() {
            try {
                const container = document.getElementById('overlayViewersContent');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">â³ Loading viewer analytics...</div>';

                if (!currentTournament || !currentTournament.id) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: red;">âŒ No tournament selected</div>';
                    return;
                }

                // Get all matches with viewer data
                const matchesSnapshot = await db.collection('matches')
                    .where('tournamentId', '==', currentTournament.id)
                    .get();

                let totalUniqueViewers = new Set();
                let repeatViewers = 0;
                let avgViewerEngagement = 0;
                let totalViewersAcrossMatches = 0;
                let highestViewedMatch = null;
                let maxViewers = 0;

                const matchViewers = [];

                matchesSnapshot.forEach(doc => {
                    const match = doc.data();
                    if (match.viewers) {
                        const viewers = match.viewers;
                        totalViewersAcrossMatches += viewers;
                        totalUniqueViewers.add(doc.id);

                        if (viewers > maxViewers) {
                            maxViewers = viewers;
                            highestViewedMatch = {
                                name: `${match.teamA?.teamName} vs ${match.teamB?.teamName}`,
                                viewers: viewers
                            };
                        }

                        matchViewers.push({
                            name: `${match.teamA?.teamName} vs ${match.teamB?.teamName}`,
                            viewers: viewers,
                            engagement: match.comments ? match.comments.length : 0
                        });
                    }
                });

                totalUniqueViewers = totalUniqueViewers.size;
                avgViewerEngagement = matchViewers.length > 0 ? (matchViewers.reduce((sum, m) => sum + m.engagement, 0) / matchViewers.length).toFixed(1) : 0;

                const html = `
                    <div style="padding: 25px;">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <!-- Total Unique Viewers Card -->
                            <div style="background: rgba(100, 200, 255, 0.08); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Unique Viewers</div>
                                <div style="font-size: 2.2em; color: rgba(100, 200, 255, 0.8); font-weight: 700;">${totalUniqueViewers.toLocaleString()}</div>
                            </div>

                            <!-- Total Viewership Card -->
                            <div style="background: rgba(255, 215, 0, 0.08); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Total Viewership</div>
                                <div style="font-size: 2.2em; color: var(--accent-gold); font-weight: 700;">${totalViewersAcrossMatches.toLocaleString()}</div>
                            </div>

                            <!-- Peak Viewers Card -->
                            <div style="background: rgba(255, 100, 100, 0.08); border: 2px solid rgba(255, 100, 100, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Peak Single Match</div>
                                <div style="font-size: 2.2em; color: rgba(255, 100, 100, 0.8); font-weight: 700;">${maxViewers.toLocaleString()}</div>
                            </div>

                            <!-- Engagement Card -->
                            <div style="background: rgba(0, 255, 136, 0.08); border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 0.8em; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Avg Engagement</div>
                                <div style="font-size: 2.2em; color: var(--accent-green); font-weight: 700;">${avgViewerEngagement}</div>
                                <div style="font-size: 0.75em; color: var(--text-gray);">Comments per Match</div>
                            </div>
                        </div>

                        <!-- Most Viewed Match -->
                        ${highestViewedMatch ? `
                        <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="color: var(--accent-gold); font-weight: 700; margin-bottom: 12px; font-size: 1.1em;">ðŸŒŸ Most Viewed Match</div>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: center;">
                                <div style="color: var(--text-white); font-weight: 600; font-size: 1.1em;">${highestViewedMatch.name}</div>
                                <div style="text-align: right; color: var(--accent-gold); font-weight: 700; font-size: 1.5em;">${highestViewedMatch.viewers.toLocaleString()} viewers</div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Viewer Distribution -->
                        <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px;">
                            <div style="color: var(--accent-gold); font-weight: 700; margin-bottom: 15px; font-size: 1.1em;">ðŸ‘¥ Viewer Distribution by Match</div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${matchViewers.length > 0 ? matchViewers.map(m => `
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(255, 215, 0, 0.1); align-items: center;">
                                        <div style="color: var(--text-white); font-weight: 500; font-size: 0.9em;">${m.name}</div>
                                        <div style="text-align: center;">
                                            <div style="color: var(--accent-gold); font-weight: 600; font-size: 1em;">${m.viewers}</div>
                                            <div style="color: var(--text-gray); font-size: 0.75em;">viewers</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: var(--text-gray); font-size: 0.9em;">${m.engagement}</div>
                                            <div style="color: var(--text-gray); font-size: 0.75em;">comments</div>
                                        </div>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No viewer data yet</div>'}
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading viewers:', error);
                document.getElementById('overlayViewersContent').innerHTML = '<div style="text-align: center; padding: 40px; color: red;">âŒ Error loading viewer analytics</div>';
            }
        }

        // Tournament match data object
        let tournamentMatchData = {
            name: '',
            teamA: {
                name: '',
                logo: '',
                dlsPlayer: '',
                clubOwner: '',
                captain: '',
                players: []
            },
            teamB: {
                name: '',
                logo: '',
                dlsPlayer: '',
                clubOwner: '',
                captain: '',
                players: []
            },
            sponsors: [],
            stats: {
                score: true,
                corners: false,
                possession: false,
                passes: false,
                shotOnTarget: false,
                shots: false,
                shotsOffTarget: false,
                bookings: false
            },
            predictions: {
                enabled: false,
                scoreOnly: false,
                teamToScore: false,
                numberOfGoals: false
            },
            winningChances: {
                teamA: 0,
                teamB: 0
            },
            matchDate: '',
            matchTime: '',
            livestream: {
                enabled: false,
                isPaid: false,
                price: 0,
                maxViewers: 0
            }
        };

        // Add player to tournament team
        function addPlayerToTournamentTeam(team) {
            const teamCapitalized = team === 'teamA' ? 'TeamA' : 'TeamB';
            const nameInput = document.getElementById('tournament' + teamCapitalized + 'PlayerName');
            const numberInput = document.getElementById('tournament' + teamCapitalized + 'PlayerNumber');
            const roleInput = document.getElementById('tournament' + teamCapitalized + 'PlayerRole');

            const name = nameInput.value.trim();
            const number = numberInput.value;
            const role = roleInput.value;

            if (!name || !number || !role) {
                showNotification('Please fill all player fields', 'error');
                return;
            }

            const maxPlayers = 17;
            const players = tournamentMatchData[team].players;

            if (players.length >= maxPlayers) {
                showNotification('Maximum players reached for ' + team, 'error');
                return;
            }

            const player = {
                name: name,
                number: parseInt(number),
                role: role,
                id: Date.now().toString()
            };

            players.push(player);
            nameInput.value = '';
            numberInput.value = '';
            roleInput.value = '';

            updateTournamentPlayerList(team);
        }

        // Update tournament player list display
        function updateTournamentPlayerList(team) {
            const listId = 'tournament' + team.charAt(0).toUpperCase() + team.slice(1) + 'PlayerList';
            const countId = 'tournament' + team.charAt(0).toUpperCase() + team.slice(1) + 'PlayerCount';
            const container = document.getElementById(listId);
            const players = tournamentMatchData[team].players;

            document.getElementById(countId).textContent = players.length + '/17';

            container.innerHTML = players.map(p => `
                <div class="player-item" style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${p.name}</strong><br>
                        <small>#${p.number} - ${p.role}</small>
                    </div>
                    <button type="button" onclick="removeTournamentPlayer('${team}', '${p.id}')" style="background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; padding: 6px 12px; border-radius: 6px; cursor: pointer;">Remove</button>
                </div>
            `).join('');
        }

        // Remove tournament player
        function removeTournamentPlayer(team, playerId) {
            tournamentMatchData[team].players = tournamentMatchData[team].players.filter(p => p.id !== playerId);
            updateTournamentPlayerList(team);
        }

        // Handle tournament logo upload
        function handleTournamentLogoUpload(team, fileInput) {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    tournamentMatchData[team].logo = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Create tournament match
        async function createTournamentMatch() {
            if (!currentTournament) {
                showNotification('No tournament selected', 'error');
                return;
            }
            if (!tournamentMatchData.name) {
                showNotification('Please enter match name', 'error');
                return;
            }
            if (!tournamentMatchData.teamA.name || !tournamentMatchData.teamB.name) {
                showNotification('Please enter both team names', 'error');
                return;
            }
            if (tournamentMatchData.teamA.players.length === 0 || tournamentMatchData.teamB.players.length === 0) {
                showNotification('Please add at least 1 player per team', 'error');
                return;
            }

            const loadingNotif = showNotification('â³ Uploading images...', 'loading', 0);

            try {
                // Upload team logos to Cloudinary
                const teamALogoUrl = tournamentMatchData.teamA.logo && tournamentMatchData.teamA.logo.startsWith('data:')
                    ? await uploadToCloudinary(tournamentMatchData.teamA.logo, 'tournament-match')
                    : tournamentMatchData.teamA.logo;

                const teamBLogoUrl = tournamentMatchData.teamB.logo && tournamentMatchData.teamB.logo.startsWith('data:')
                    ? await uploadToCloudinary(tournamentMatchData.teamB.logo, 'tournament-match')
                    : tournamentMatchData.teamB.logo;

                // Upload sponsor logos to Cloudinary
                const sponsorsWithUrls = await Promise.all(
                    tournamentMatchData.sponsors.map(async (sponsor) => ({
                        ...sponsor,
                        logo: sponsor.logo && sponsor.logo.startsWith('data:')
                            ? await uploadToCloudinary(sponsor.logo, 'sponsors')
                            : sponsor.logo
                    }))
                );

                // Create temporary match to get ID for pass generation
                const tempMatchRef = await db.collection('matches').add({
                    tournamentId: currentTournament.id,
                    name: tournamentMatchData.name,
                    teamA: {
                        ...tournamentMatchData.teamA,
                        logo: teamALogoUrl,
                        goals: 0,
                        matchPass: '' // Will be updated
                    },
                    teamB: {
                        ...tournamentMatchData.teamB,
                        logo: teamBLogoUrl,
                        goals: 0,
                        matchPass: '' // Will be updated
                    },
                    sponsors: sponsorsWithUrls,
                    stats: tournamentMatchData.stats,
                    predictions: tournamentMatchData.predictions,
                    winningChances: tournamentMatchData.winningChances,
                    matchDate: tournamentMatchData.matchDate,
                    matchTime: tournamentMatchData.matchTime,
                    livestream: tournamentMatchData.livestream,
                    livestreamCodes: [],
                    status: 'upcoming',
                    matchType: 'tournament',
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser?.email || 'admin'
                });

                // Generate and add match passes for both teams
                const matchId = tempMatchRef.id;
                const teamAPass = generateMatchPass(tournamentMatchData.teamA.name, matchId);
                const teamBPass = generateMatchPass(tournamentMatchData.teamB.name, matchId);

                await db.collection('matches').doc(matchId).update({
                    'teamA.matchPass': teamAPass,
                    'teamB.matchPass': teamBPass
                });

                removeNotification(loadingNotif);
                const savingNotif = showNotification('ðŸ’¾ Saving to database...', 'loading', 0);

                removeNotification(savingNotif);
                showNotification('âœ… Tournament match created with passes!', 'success');
                resetTournamentMatchForm();

            } catch (error) {
                console.error('Tournament match creation error:', error);
                removeNotification(loadingNotif);
                showNotification(`âŒ Error: ${error.message}`, 'error', 5000);
            }
        }

        // ===== CLOUDINARY CONFIG =====
        const CLOUDINARY_CLOUD_NAME = 'dzhdgxjhl';
        const CLOUDINARY_UPLOAD_PRESET = 'posepreset';

        // Upload image to Cloudinary
        async function uploadToCloudinary(imageData, folder = 'general') {
            try {
                const formData = new FormData();

                let blob;

                // Convert data URL to blob
                if (imageData.startsWith('data:')) {
                    const arr = imageData.split(',');
                    const mime = arr[0].match(/:(.*?);/)[1];
                    const bstr = atob(arr[1]);
                    const n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    for (let i = 0; i < n; i++) {
                        u8arr[i] = bstr.charCodeAt(i);
                    }
                    blob = new Blob([u8arr], { type: mime });
                } else {
                    // If it's a URL, fetch it
                    const response = await fetch(imageData);
                    blob = await response.blob();
                }

                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', folder);

                const result = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await result.json();

                if (!result.ok) {
                    console.error('Cloudinary error:', data);
                    throw new Error(data.error?.message || 'Cloudinary upload failed');
                }

                if (data.secure_url) {
                    return data.secure_url;
                } else {
                    throw new Error('No secure URL in response');
                }
            } catch (error) {
                console.error('Upload to Cloudinary failed:', error);
                showNotification(`Upload error: ${error.message}`, 'error', 4000);
                throw error;
            }
        }

        // Reset tournament match form
        function resetTournamentMatchForm() {
            document.getElementById('createTournamentMatchForm').reset();
            tournamentMatchData = {
                name: '',
                teamA: {
                    name: '',
                    logo: '',
                    dlsPlayer: '',
                    clubOwner: '',
                    captain: '',
                    players: []
                },
                teamB: {
                    name: '',
                    logo: '',
                    dlsPlayer: '',
                    clubOwner: '',
                    captain: '',
                    players: []
                },
                sponsors: [],
                stats: {
                    score: true,
                    corners: false,
                    possession: false,
                    passes: false,
                    shotOnTarget: false,
                    shots: false,
                    shotsOffTarget: false,
                    bookings: false
                },
                predictions: {
                    enabled: false,
                    scoreOnly: false,
                    teamToScore: false,
                    numberOfGoals: false
                },
                winningChances: {
                    teamA: 0,
                    teamB: 0
                },
                matchDate: '',
                matchTime: '',
                livestream: {
                    enabled: false,
                    isPaid: false,
                    price: 0,
                    maxViewers: 0
                }
            };
            updateTournamentPlayerList('teamA');
            updateTournamentPlayerList('teamB');
            updateTournamentSponsorList();
        }

        // Add tournament sponsor
        function addTournamentSponsor() {
            try {
                const nameInput = document.getElementById('tournamentSponsorName');
                const logoInput = document.getElementById('tournamentSponsorLogo');

                if (!nameInput || !logoInput) {
                    showNotification('Sponsor form fields not found', 'error');
                    return;
                }

                const name = nameInput.value.trim();
                const logoURL = logoInput.value.trim();

                if (!name) {
                    showNotification('Please enter sponsor name', 'error');
                    return;
                }

                const sponsor = {
                    name: name,
                    logo: logoURL,
                    id: Date.now().toString()
                };

                if (!tournamentMatchData.sponsors) {
                    tournamentMatchData.sponsors = [];
                }

                tournamentMatchData.sponsors.push(sponsor);
                nameInput.value = '';
                logoInput.value = '';

                showNotification('âœ… Sponsor added successfully', 'success');
                updateTournamentSponsorList();
            } catch (error) {
                console.error('Error adding sponsor:', error);
                showNotification('Error adding sponsor: ' + error.message, 'error');
            }
        }

        // Handle tournament sponsor logo upload
        function handleTournamentSponsorLogoUpload(fileInput) {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('tournamentSponsorLogo').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Update tournament sponsor list display
        function updateTournamentSponsorList() {
            const container = document.getElementById('tournamentSponsorsList');
            const countSpan = document.getElementById('tournamentSponsorCount');

            countSpan.textContent = tournamentMatchData.sponsors.length;

            if (tournamentMatchData.sponsors.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No sponsors added yet</p>';
                return;
            }

            container.innerHTML = tournamentMatchData.sponsors.map(sponsor => `
                <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: var(--text-white);">${sponsor.name}</strong>
                    </div>
                    <button type="button" onclick="removeTournamentSponsor('${sponsor.id}')" style="background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; padding: 6px 12px; border-radius: 6px; cursor: pointer;">Remove</button>
                </div>
            `).join('');
        }

        // Remove tournament sponsor
        function removeTournamentSponsor(sponsorId) {
            tournamentMatchData.sponsors = tournamentMatchData.sponsors.filter(s => s.id !== sponsorId);
            updateTournamentSponsorList();
        }

        // Update tournament stats
        function updateTournamentStats() {
            tournamentMatchData.stats.corners = document.getElementById('tournamentStatCorners').checked;
            tournamentMatchData.stats.possession = document.getElementById('tournamentStatPossession').checked;
            tournamentMatchData.stats.passes = document.getElementById('tournamentStatPasses').checked;
            tournamentMatchData.stats.shotOnTarget = document.getElementById('tournamentStatShotOnTarget').checked;
            tournamentMatchData.stats.shots = document.getElementById('tournamentStatShots').checked;
            tournamentMatchData.stats.shotsOffTarget = document.getElementById('tournamentStatShotsOffTarget').checked;
            tournamentMatchData.stats.bookings = document.getElementById('tournamentStatBookings').checked;
        }

        // Update tournament predictions
        function updateTournamentPredictions() {
            const enabled = document.getElementById('tournamentPredictionsEnabled').checked;
            document.getElementById('tournamentPredictionsOptions').style.display = enabled ? 'block' : 'none';

            tournamentMatchData.predictions.enabled = enabled;
            if (enabled) {
                tournamentMatchData.predictions.scoreOnly = document.getElementById('tournamentPredictScore').checked;
                tournamentMatchData.predictions.teamToScore = document.getElementById('tournamentPredictTeamToScore').checked;
                tournamentMatchData.predictions.numberOfGoals = document.getElementById('tournamentPredictNumberOfGoals').checked;
            }
        }

        // Update tournament livestream
        function updateTournamentLivestream() {
            if (!tournamentMatchData) return;

            const checkbox = document.getElementById('tournamentLivestreamsEnabled');
            const optionsDiv = document.getElementById('tournamentLivestreamOptions');
            const priceDiv = document.getElementById('tournamentLivestreamPriceSection');
            const typeSelect = document.getElementById('tournamentLivestreamType');

            if (!checkbox || !optionsDiv || !priceDiv || !typeSelect) return;

            tournamentMatchData.livestream.enabled = checkbox.checked;
            optionsDiv.style.display = tournamentMatchData.livestream.enabled ? 'block' : 'none';

            if (tournamentMatchData.livestream.enabled) {
                const type = typeSelect.value;
                tournamentMatchData.livestream.isPaid = (type === 'paid');
                priceDiv.style.display = (type === 'paid') ? 'block' : 'none';
            } else {
                priceDiv.style.display = 'none';
            }
        }



        function switchTournamentTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('#tournamentModal > .watch-fee-content > .watch-fee-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('#tournamentModal > .watch-fee-content > .watch-fee-tabs > .watch-fee-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Mark clicked button as active
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function switchTournamentMatchTab(subTabName) {
            // Hide all sub-tabs
            document.getElementById('createTournamentSubTab').style.display = 'none';
            document.getElementById('liveTournamentSubTab').style.display = 'none';
            document.getElementById('upcomingTournamentSubTab').style.display = 'none';
            document.getElementById('finishedTournamentSubTab').style.display = 'none';

            // Remove active from all sub-tab buttons
            const matchTabButtons = document.querySelectorAll('#matchesTab .watch-fee-tabs .watch-fee-tab');
            matchTabButtons.forEach(btn => btn.classList.remove('active'));

            // Show selected sub-tab and load data
            if (subTabName === 'create') {
                document.getElementById('createTournamentSubTab').style.display = 'block';
            } else if (subTabName === 'live') {
                document.getElementById('liveTournamentSubTab').style.display = 'block';
                loadLiveTournaments();
            } else if (subTabName === 'upcoming') {
                document.getElementById('upcomingTournamentSubTab').style.display = 'block';
                loadUpcomingTournaments();
            } else if (subTabName === 'finished') {
                document.getElementById('finishedTournamentSubTab').style.display = 'block';
                loadFinishedTournaments();
            }

            // Mark clicked button as active
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Add host input field
        function addHostInput() {
            const container = document.getElementById('hostsContainer');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'hostInput';
            input.placeholder = 'Enter host name';
            input.style.cssText = 'width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;';
            container.appendChild(input);
        }

        // Create tournament function
        function createTournament() {
            const name = document.getElementById('tournamentNameInput').value.trim();
            const color = document.getElementById('tournamentColor').value;
            const startDate = document.getElementById('tournamentStartDate').value;
            const teamsAllowed = parseInt(document.getElementById('teamsAllowedInput').value);
            const sponsorName = document.getElementById('sponsorNameInput').value.trim();

            // Get all hosts
            const hostInputs = document.querySelectorAll('#hostsContainer .hostInput');
            const hosts = Array.from(hostInputs).map(input => input.value.trim()).filter(val => val);

            // Validation
            if (!name) {
                showNotification('Please enter tournament name', 'error');
                return;
            }
            if (hosts.length === 0) {
                showNotification('Please add at least one host', 'error');
                return;
            }
            if (!startDate) {
                showNotification('Please select tournament start date', 'error');
                return;
            }
            if (!teamsAllowed || teamsAllowed < 2) {
                showNotification('Please enter valid number of teams (minimum 2)', 'error');
                return;
            }

            // Get logo files
            const logoFile = document.getElementById('tournamentLogoInput').files[0];
            const sponsorLogoFile = document.getElementById('sponsorLogoInput').files[0];

            // Create tournament object
            const tournamentData = {
                name: name,
                color: color,
                hosts: hosts,
                teamsAllowed: teamsAllowed,
                sponsor: {
                    name: sponsorName || '',
                    logo: sponsorLogoFile ? sponsorLogoFile.name : ''
                },
                status: 'upcoming',
                createdAt: new Date().toISOString(),
                matches: [],
                totalRevenue: 0
            };

            // Save to Firebase (without images for now)
            db.collection('tournaments').add(tournamentData).then(docRef => {
                showNotification('âœ… Tournament created successfully!', 'success');

                // Clear form
                document.getElementById('createTournamentForm').reset();
                document.getElementById('hostsContainer').innerHTML = '<input type="text" class="hostInput" placeholder="Enter host name" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: var(--text-white); font-family: inherit;">';

                console.log('Tournament created with ID:', docRef.id);
            }).catch(error => {
                showNotification('Error creating tournament: ' + error.message, 'error');
                console.error('Error:', error);
            });
        }

        // Load live tournaments
        async function loadLiveTournaments() {
            try {
                const container = document.getElementById('liveTournamentContent');
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">Loading live tournaments...</div>';

                const snapshot = await db.collection('tournaments').where('status', '==', 'live').get();

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-gray);">
                            <div style="font-size: 2em; margin-bottom: 15px;">ðŸ”´</div>
                            <p>No live tournaments at the moment</p>
                        </div>
                    `;
                    return;
                }

                const tournaments = [];
                snapshot.forEach(doc => {
                    tournaments.push({ id: doc.id, ...doc.data() });
                });

                const html = `
                    <div>
                        ${tournaments.map(t => `
                            <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; position: relative;" onclick="openTournamentModal('${t.id}')">
                                <button onclick="event.stopPropagation(); deleteTournament('${t.id}')" style="position: absolute; top: 10px; right: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; color: #ff6b6b; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'; this.style.borderColor='#ff4444';" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'; this.style.borderColor='#ff6b6b';">
                                    ðŸ—‘ï¸ Delete
                                </button>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Tournament</div>
                                        <div style="color: var(--text-white); font-weight: 600; font-size: 1.1em;">${t.name}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Status</div>
                                        <div style="color: #ff6b6b; font-weight: 700;">ðŸ”´ LIVE</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading live tournaments:', error);
                document.getElementById('liveTournamentContent').innerHTML = '<div style="color: #ff6b6b; padding: 20px;">Error loading tournaments</div>';
            }
        }

        // Load upcoming tournaments
        async function loadUpcomingTournaments() {
            try {
                const container = document.getElementById('upcomingTournamentContent');
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">Loading upcoming tournaments...</div>';

                const snapshot = await db.collection('tournaments').where('status', '==', 'upcoming').get();

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-gray);">
                            <div style="font-size: 2em; margin-bottom: 15px;">â°</div>
                            <p>No upcoming tournaments</p>
                        </div>
                    `;
                    return;
                }

                const tournaments = [];
                snapshot.forEach(doc => {
                    tournaments.push({ id: doc.id, ...doc.data() });
                });

                const html = `
                    <div>
                        ${tournaments.map(t => `
                            <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; position: relative;" onclick="openTournamentModal('${t.id}')">
                                <button onclick="event.stopPropagation(); deleteTournament('${t.id}')" style="position: absolute; top: 10px; right: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; color: #ff6b6b; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'; this.style.borderColor='#ff4444';" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'; this.style.borderColor='#ff6b6b';">
                                    ðŸ—‘ï¸ Delete
                                </button>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Tournament</div>
                                        <div style="color: var(--text-white); font-weight: 600; font-size: 1.1em;">${t.name}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Status</div>
                                        <div style="color: var(--accent-gold); font-weight: 700;">â° UPCOMING</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading upcoming tournaments:', error);
                document.getElementById('upcomingTournamentContent').innerHTML = '<div style="color: #ff6b6b; padding: 20px;">Error loading tournaments</div>';
            }
        }

        // Load finished tournaments
        async function loadFinishedTournaments() {
            try {
                const container = document.getElementById('finishedTournamentContent');
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">Loading finished tournaments...</div>';

                const snapshot = await db.collection('tournaments').where('status', '==', 'finished').get();

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-gray);">
                            <div style="font-size: 2em; margin-bottom: 15px;">âœ…</div>
                            <p>No finished tournaments yet</p>
                        </div>
                    `;
                    return;
                }

                const tournaments = [];
                snapshot.forEach(doc => {
                    tournaments.push({ id: doc.id, ...doc.data() });
                });

                const html = `
                    <div>
                        ${tournaments.map(t => `
                            <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; position: relative;" onclick="openTournamentModal('${t.id}')">
                                <button onclick="event.stopPropagation(); deleteTournament('${t.id}')" style="position: absolute; top: 10px; right: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; color: #ff6b6b; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'; this.style.borderColor='#ff4444';" onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'; this.style.borderColor='#ff6b6b';">
                                    ðŸ—‘ï¸ Delete
                                </button>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Tournament</div>
                                        <div style="color: var(--text-white); font-weight: 600; font-size: 1.1em;">${t.name}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 5px;">Status</div>
                                        <div style="color: var(--accent-green); font-weight: 700;">âœ… FINISHED</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading finished tournaments:', error);
                document.getElementById('finishedTournamentContent').innerHTML = '<div style="color: #ff6b6b; padding: 20px;">Error loading tournaments</div>';
            }
        }

        async function loadPaidViewersData(matchId) {
            try {
                paidViewersData = [];

                // Get fresh match document to access livestreamCodes and totalRevenue
                const matchDoc = await db.collection('matches').doc(matchId).get();
                if (!matchDoc.exists) {
                    console.error('Match not found:', matchId);
                    updateWatchFeeStatistics();
                    displayPaidViewers();
                    return;
                }

                const matchData = matchDoc.data();

                // Update currentWatchFeeMatch with fresh data
                currentWatchFeeMatch = { id: matchDoc.id, ...matchData };

                console.log('Match data:', matchData);
                console.log('Total Revenue:', matchData.livestream?.totalRevenue);

                const livestreamCodes = matchData.livestreamCodes || [];

                // For each code, get user data
                for (const code of livestreamCodes) {
                    if (code.isPaid) {  // Only paid codes
                        const userDoc = await db.collection('users').doc(code.userId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            paidViewersData.push({
                                userId: code.userId,
                                name: code.userName || userData.name || 'Unknown',
                                email: userData.email || 'N/A',
                                amount: code.amount || 0,
                                code: code.code,
                                purchaseDate: code.createdAt || new Date().toISOString(),
                                watchTime: 0,
                                status: 'active'
                            });
                        }
                    }
                }

                console.log('Paid viewers data:', paidViewersData);
                updateWatchFeeStatistics();
                displayPaidViewers();
            } catch (err) {
                console.error('Error loading paid viewers:', err);
                showNotification('Error loading paid viewers: ' + err.message, 'error');
            }
        }

        function updateWatchFeeStatistics() {
            if (!currentWatchFeeMatch) return;

            const totalViewers = paidViewersData.length;
            const totalLivestreamRevenue = currentWatchFeeMatch.livestream?.totalRevenue || 0;
            const avgWatchTime = totalViewers > 0
                ? Math.round(paidViewersData.reduce((sum, v) => sum + v.watchTime, 0) / totalViewers)
                : 0;

            document.getElementById('totalViewers').textContent = totalViewers.toString();
            document.getElementById('totalLivestreamRevenue').textContent = `â‚¦${totalLivestreamRevenue.toLocaleString()}`;
            document.getElementById('paidViewersCount').textContent = totalViewers.toString();
            document.getElementById('avgWatchTime').textContent = `${avgWatchTime}m`;
            document.getElementById('peakViewers').textContent = totalViewers.toString();

            // Calculate stream duration if match is live/finished
            const duration = currentWatchFeeMatch.timeElapsed || currentWatchFeeMatch.duration || 90;
            document.getElementById('streamDuration').textContent = `${duration}m`;
        }

        function displayPaidViewers() {
            const container = document.getElementById('paidViewersList');

            if (paidViewersData.length === 0) {
                container.innerHTML = '<div class="no-viewers-message">No paid viewers yet</div>';
                return;
            }

            container.innerHTML = paidViewersData.map(viewer => `
                <div class="viewer-item">
                    <div class="viewer-info">
                        <div class="viewer-name">${viewer.name}</div>
                        <div class="viewer-detail">${viewer.email || 'N/A'}</div>
                        <div class="viewer-detail" style="margin-top: 5px;">Purchased: ${viewer.purchaseDate ? new Date(viewer.purchaseDate).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: var(--accent-gold); font-weight: 600; font-size: 1.1em;">â‚¦${(viewer.amount || 0).toLocaleString()}</div>
                        <div style="color: var(--text-gray); font-size: 0.8em; margin-top: 5px;">${viewer.watchTime || 0}m watched</div>
                    </div>
                </div>
            `).join('');
        }

        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Access code copied to clipboard', 'success');
            }).catch(err => {
                showNotification('Failed to copy: ' + err.message, 'error');
            });
        }

        function removeViewer(userId) {
            showConfirmation({
                title: 'ðŸ—‘ï¸ Remove Viewer',
                message: 'Remove this viewer from the paid list? They will be refunded.',
                icon: 'ðŸ—‘ï¸',
                messageType: 'warning',
                confirmText: 'Remove',
                cancelText: 'Keep',
                onConfirm: () => {
                    paidViewersData = paidViewersData.filter(v => v.userId !== userId);
                    displayPaidViewers();
                    showNotification('Viewer removed', 'success');
                }
            });
        }

        // Load all transactions from Firebase
        async function loadAllTransactions() {
            try {
                allTransactions = [];
                const usersSnapshot = await db.collection('users').get();

                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userId = userDoc.id;
                    const userEmail = userData.email || 'N/A';
                    const userName = userData.name || 'N/A';
                    const dlsAccount = userData.wallet?.dlsAccountNumber || 'N/A';
                    const userTransactions = userData.transactions || [];

                    userTransactions.forEach(tx => {
                        allTransactions.push({
                            ...tx,
                            userId: userId,
                            userEmail: userEmail,
                            userName: userName,
                            dlsAccount: dlsAccount
                        });
                    });
                });

                // Sort by date, newest first
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderTransactionsTable();
            } catch (error) {
                console.error('Error loading transactions:', error);
                alert('Error loading transactions: ' + error.message);
            }
        }

        // Filter transactions
        function filterTransactionsByDate(days) {
            currentDayFilter = days;
            renderTransactionsTable();
        }

        function filterTransactionsByStatus(status) {
            currentStatusFilter = status;
            renderTransactionsTable();
        }

        function filterTransactionsByType(type) {
            currentTypeFilter = type;
            renderTransactionsTable();
        }

        function searchTransactions(query) {
            currentSearchQuery = query.toLowerCase();
            renderTransactionsTable();
        }

        // Get filtered transactions
        function getFilteredTransactions() {
            let filtered = allTransactions;

            // Date filter
            if (currentDayFilter !== 'all') {
                const now = new Date();
                let filterDate;

                switch (currentDayFilter) {
                    case '1hr':
                        filterDate = new Date(now.getTime() - 60 * 60 * 1000);
                        break;
                    case '2hrs':
                        filterDate = new Date(now.getTime() - 2 * 60 * 60 * 1000);
                        break;
                    case '3days':
                        filterDate = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
                        break;
                    case '7days':
                        filterDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '30days':
                        filterDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                }

                filtered = filtered.filter(tx => new Date(tx.date) >= filterDate);
            }

            // Status filter
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(tx => {
                    // Handle 'failed' tab showing both 'failed' and 'rejected' statuses
                    if (currentStatusFilter === 'failed') {
                        return tx.status === 'failed' || tx.status === 'rejected';
                    }
                    return tx.status === currentStatusFilter;
                });
            }

            // Type filter
            if (currentTypeFilter !== 'all') {
                filtered = filtered.filter(tx => tx.type === currentTypeFilter);
            }

            // Search filter
            if (currentSearchQuery) {
                filtered = filtered.filter(tx =>
                    tx.userName.toLowerCase().includes(currentSearchQuery) ||
                    tx.userEmail.toLowerCase().includes(currentSearchQuery) ||
                    tx.dlsAccount.toLowerCase().includes(currentSearchQuery)
                );
            }

            return filtered;
        }

        // Render transactions table
        function renderTransactionsTable() {
            const filtered = getFilteredTransactions();
            const container = document.getElementById('transactionsListContainer');

            if (filtered.length === 0) {
                container.innerHTML = '<div class="tx-no-results">No transactions found</div>';
                return;
            }

            container.innerHTML = filtered.map(tx => {
                const date = new Date(tx.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const amountClass = tx.type === 'deposit' ? '' : 'red';
                const typeIcon = tx.type === 'deposit' ? 'ðŸ“¥' : 'ðŸ“¤';
                const statusIcon = tx.status === 'successful' ? 'âœ…' : tx.status === 'pending' ? 'â³' : tx.status === 'rejected' ? 'âŒ' : 'â“';

                return `
                     <div class="tx-item">
                         <div class="tx-info-group">
                             <span class="tx-label">User</span>
                             <span class="tx-value">${tx.userName}</span>
                         </div>
                         <div class="tx-info-group">
                             <span class="tx-label">Email</span>
                             <span class="tx-value">${tx.userEmail}</span>
                         </div>
                         <div class="tx-info-group">
                             <span class="tx-label">DLS Account</span>
                             <span class="tx-value">${tx.dlsAccount}</span>
                         </div>
                         <div class="tx-info-group">
                             <span class="tx-label">${tx.type === 'deposit' ? 'Deposit' : 'Withdrawal'}</span>
                             <span class="tx-amount ${amountClass}">${typeIcon} â‚¦${tx.amount.toLocaleString()}</span>
                         </div>
                         <div class="tx-info-group" style="text-align: right;">
                             <span class="tx-label">Status</span>
                             <span class="tx-status-badge ${tx.status}">${statusIcon} ${tx.status.toUpperCase()}</span>
                             <span class="tx-label" style="margin-top: 5px; font-size: 0.7em;">${dateStr}</span>
                         </div>
                     </div>
                 `;
            }).join('');
        }

        // ===== MATCH TABS FUNCTIONALITY =====

        let liveMatchData = {};
        let activeMatches = [];
        let finishedMatches = [];
        let upcomingMatches = [];

        // Switch between tabs in match creation modal
        function switchMatchTab(tab) {
            document.querySelectorAll('.match-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.match-tab').forEach(el => el.classList.remove('active'));

            if (tab === 'setMatch') {
                document.getElementById('setMatchContent').style.display = 'block';
            } else if (tab === 'liveMatch') {
                document.getElementById('liveMatchContent').style.display = 'block';
                loadLiveMatchesDropdown();
            } else if (tab === 'finishedMatch') {
                document.getElementById('finishedMatchContent').style.display = 'block';
                loadFinishedMatchesDropdown();
            } else if (tab === 'upcomingMatch') {
                document.getElementById('upcomingMatchContent').style.display = 'block';
                loadUpcomingMatchesDropdown();
            }

            event.target.classList.add('active');
        }

        // Load active matches for live match dropdown
        function loadLiveMatchesDropdown() {
            db.collection('matches').where('status', '==', 'live').get().then(snapshot => {
                const select = document.getElementById('liveMatchSelect');
                select.innerHTML = '<option value="">-- Select a match --</option>';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}`;
                    select.appendChild(option);
                });

                activeMatches = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }

        // Load a live match
        function loadLiveMatch(matchId) {
            loadLiveMatchWithData(matchId);

            // Show watch fee button if livestream is paid
            if (matchId) {
                db.collection('matches').doc(matchId).get().then(doc => {
                    if (doc.exists) {
                        const matchData = doc.data();
                        const watchFeeBtn = document.getElementById('watchFeeButton');
                        if (matchData.livestream && matchData.livestream.isPaid) {
                            watchFeeBtn.style.display = 'block';
                        } else {
                            watchFeeBtn.style.display = 'none';
                        }
                    }
                });
            } else {
                document.getElementById('watchFeeButton').style.display = 'none';
            }
        }

        // Update live score
        function updateLiveScore(team, change) {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const currentScore = liveMatchData.currentScore || { teamA: 0, teamB: 0 };
            currentScore[team] = Math.max(0, (currentScore[team] || 0) + change);

            // Update display
            document.getElementById('live' + (team === 'teamA' ? 'TeamA' : 'TeamB') + 'Score').textContent = currentScore[team];

            // Update Firebase
            db.collection('matches').doc(liveMatchData.id).update({
                currentScore: currentScore
            }).catch(err => showNotification('Error updating score: ' + err.message, 'error'));
        }

        // Update live stats
        function updateLiveStat(statType, team, value) {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const liveStats = liveMatchData.liveStats || {};
            if (!liveStats[statType]) liveStats[statType] = {};
            liveStats[statType][team] = parseFloat(value) || 0;

            db.collection('matches').doc(liveMatchData.id).update({
                liveStats: liveStats
            }).catch(err => showNotification('Error updating stats: ' + err.message, 'error'));
        }

        // Update live match minute
        function updateLiveMinute(minute) {
            if (!liveMatchData.id) return;
            db.collection('matches').doc(liveMatchData.id).update({
                timeElapsed: parseInt(minute)
            }).catch(err => showNotification('Error updating minute: ' + err.message, 'error'));
        }

        // Update live match status
        function updateLiveStatus(status) {
            if (!liveMatchData.id) return;
            db.collection('matches').doc(liveMatchData.id).update({
                status: status
            }).catch(err => showNotification('Error updating status: ' + err.message, 'error'));
        }

        // Finish live match and move to finished
        function finishLiveMatch() {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            // Collect all stats including cards
            const finalStats = liveMatchData.liveStats || {};
            finalStats.corners = finalStats.corners || { teamA: 0, teamB: 0 };
            finalStats.possession = finalStats.possession || { teamA: 50, teamB: 50 };
            finalStats.shots = finalStats.shots || { teamA: 0, teamB: 0 };
            finalStats.yellowCards = finalStats.yellowCards || { teamA: 0, teamB: 0 };
            finalStats.redCards = finalStats.redCards || { teamA: 0, teamB: 0 };

            db.collection('matches').doc(liveMatchData.id).update({
                status: 'finished',
                finishedAt: new Date().toISOString(),
                finalScore: liveMatchData.currentScore || { teamA: 0, teamB: 0 },
                finalStats: finalStats,
                goalScorers: currentLiveGoalScorers,
                events: matchEvents,
                substitutions: matchSubstitutions
            }).then(() => {
                showNotification('Match finished successfully!', 'success');
                loadLiveMatchesDropdown();
                document.getElementById('liveMatchSelect').value = '';
                document.getElementById('liveMatchContainer').style.display = 'none';
            }).catch(err => showNotification('Error finishing match: ' + err.message, 'error'));
        }

        // Load finished matches dropdown
        function loadFinishedMatchesDropdown() {
            let query = db.collection('matches').where('status', '==', 'finished');

            // Filter by tournament if one is currently selected
            if (currentTournament && currentTournament.id) {
                query = query.where('tournamentId', '==', currentTournament.id);
            }

            query.get().then(snapshot => {
                const select = document.getElementById('finishedMatchSelect');
                select.innerHTML = '<option value="">-- Select a match --</option>';

                snapshot.forEach(doc => {
                    const match = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}`;
                    select.appendChild(option);
                });

                finishedMatches = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        }

        // Load finished match details
        function loadFinishedMatchDetails(matchId) {
            if (!matchId) {
                document.getElementById('finishedMatchContainer').style.display = 'none';
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const match = doc.data();
                    document.getElementById('finishedMatchContainer').style.display = 'block';

                    // Update header
                    document.getElementById('finishedTeamAName').textContent = match.teamA?.name || 'Team A';
                    document.getElementById('finishedTeamBName').textContent = match.teamB?.name || 'Team B';
                    const scoreA = match.finalScore?.teamA || 0;
                    const scoreB = match.finalScore?.teamB || 0;
                    document.getElementById('finishedScore').textContent = `${scoreA} - ${scoreB}`;
                    document.getElementById('finishedMatchDate').textContent = match.matchDate || '';

                    // Display stats
                    const statsHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Corners:</strong> ${match.finalStats?.corners?.teamA || 0} - ${match.finalStats?.corners?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Possession:</strong> ${match.finalStats?.possession?.teamA || 50}% - ${match.finalStats?.possession?.teamB || 50}%
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Shots:</strong> ${match.finalStats?.shots?.teamA || 0} - ${match.finalStats?.shots?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>ðŸŸ¨ Yellow:</strong> ${match.finalStats?.yellowCards?.teamA || 0} - ${match.finalStats?.yellowCards?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>ðŸŸ¥ Red:</strong> ${match.finalStats?.redCards?.teamA || 0} - ${match.finalStats?.redCards?.teamB || 0}
                            </div>
                            <div style="padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
                                <strong>Status:</strong> FINISHED âœ…
                            </div>
                        </div>
                    `;
                    document.getElementById('finishedStatsContainer').innerHTML = statsHtml;

                    // Display goal scorers (placeholder - add actual data structure)
                    document.getElementById('finishedGoalScorersContainer').innerHTML = '<p style="color: var(--text-gray);">Goal scorers data coming soon</p>';
                }
            });
        }

        // Download match report as PDF
        let editingUpcomingId = null;

        function downloadMatchReportPDF() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const match = doc.data();
                    generatePDF(match, matchId);
                }
            }).catch(err => showNotification('Error generating report: ' + err.message, 'error'));
        }

        function generatePDF(match, matchId) {
            showNotification('Generating PDF report...', 'loading');

            try {
                // Check if jsPDF is available
                if (!window.jspdf) {
                    throw new Error('jsPDF library not loaded. Please refresh the page.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPosition = 20;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);

                // ========== BACKGROUND ==========
                doc.setFillColor(10, 14, 39); // Dark blue #0a0e27
                doc.rect(0, 0, pageWidth, pageHeight, 'F');

                // ========== HEADER ==========
                doc.setFillColor(255, 215, 0); // Gold
                doc.rect(0, 0, pageWidth, 35, 'F');

                // Title
                doc.setTextColor(10, 14, 39); // Dark blue
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('DLS DRAFT LEAGUE', pageWidth / 2, 15, { align: 'center' });

                // Subtitle
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('MATCH REPORT', pageWidth / 2, 25, { align: 'center' });

                yPosition = 45;

                // ========== MATCH DETAILS ==========
                doc.setTextColor(255, 215, 0); // Gold
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('MATCH DETAILS', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                doc.setTextColor(255, 255, 255); // White
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');

                const matchDate = match.matchDate ? new Date(match.matchDate).toLocaleDateString() : 'N/A';
                doc.text(`Date: ${matchDate}`, margin, yPosition + 5);
                doc.text(`Time: ${match.matchTime || 'N/A'}`, margin, yPosition + 12);
                doc.text(`Status: FINISHED âœ“`, margin, yPosition + 19);

                yPosition += 30;

                // ========== TEAMS ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('TEAMS', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                doc.setTextColor(255, 255, 255); // White
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');

                const teamAName = match.teamA?.name || 'Team A';
                const teamBName = match.teamB?.name || 'Team B';
                doc.text(`Team A: ${teamAName}`, margin, yPosition + 5);
                doc.text(`Team B: ${teamBName}`, margin, yPosition + 12);

                yPosition += 25;

                // ========== FINAL SCORE ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('FINAL SCORE', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                // Large score display - use finalScore or currentScore as fallback
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                const scoreA = match.finalScore?.teamA || match.currentScore?.teamA || 0;
                const scoreB = match.finalScore?.teamB || match.currentScore?.teamB || 0;
                const scoreText = `${scoreA} - ${scoreB}`;
                doc.text(scoreText, pageWidth / 2, yPosition + 12, { align: 'center' });

                doc.setTextColor(255, 255, 255); // White
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold'); // Bold
                doc.text(`${teamAName} vs ${teamBName}`, pageWidth / 2, yPosition + 22, { align: 'center' });

                yPosition += 35;

                // ========== FINAL STATISTICS ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('FINAL STATISTICS', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                // Stats table
                const statsTableData = [
                    ['Statistic', 'Team A', 'Team B'],
                    ['Corners', `${match.finalStats?.corners?.teamA || 0}`, `${match.finalStats?.corners?.teamB || 0}`],
                    ['Possession', `${match.finalStats?.possession?.teamA || 50}%`, `${match.finalStats?.possession?.teamB || 50}%`],
                    ['Shots', `${match.finalStats?.shots?.teamA || 0}`, `${match.finalStats?.shots?.teamB || 0}`],
                    ['Yellow Cards', `${match.finalStats?.yellowCards?.teamA || 0}`, `${match.finalStats?.yellowCards?.teamB || 0}`],
                    ['Red Cards', `${match.finalStats?.redCards?.teamA || 0}`, `${match.finalStats?.redCards?.teamB || 0}`]
                ];

                try {
                    if (doc.autoTable) {
                        doc.autoTable({
                            head: [statsTableData[0]],
                            body: statsTableData.slice(1),
                            startY: yPosition + 5,
                            margin: { left: margin, right: margin },
                            headStyles: {
                                fillColor: [255, 215, 0],
                                textColor: [10, 14, 39],
                                fontStyle: 'bold',
                                fontSize: 10
                            },
                            bodyStyles: {
                                textColor: [255, 255, 255], // White
                                fontSize: 10
                            },
                            alternateRowStyles: {
                                fillColor: [21, 25, 48]
                            },
                            columnStyles: {
                                0: { cellWidth: contentWidth * 0.5 },
                                1: { cellWidth: contentWidth * 0.25, halign: 'center' },
                                2: { cellWidth: contentWidth * 0.25, halign: 'center' }
                            }
                        });

                        yPosition = doc.lastAutoTable.finalY + 15;
                    } else {
                        console.warn('autoTable plugin not loaded, skipping table');
                        yPosition += 30;
                    }
                } catch (tableError) {
                    console.warn('Table generation error:', tableError);
                    yPosition += 30;
                }

                // ========== WATCH FEE & VIEWERS STATS ==========
                if (match.livestream && match.livestream.isPaid) {
                    yPosition += 5;
                    doc.setTextColor(255, 215, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('WATCH FEE & VIEWERS', margin, yPosition);
                    yPosition += 8;

                    doc.setDrawColor(255, 215, 0);
                    doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');

                    const watchPrice = match.livestream?.price || 0;
                    const watchViewers = match.livestreamViewers || 0;
                    const watchRevenue = watchViewers * watchPrice;

                    doc.text(`Fee: â‚¦${watchPrice.toLocaleString()}`, margin, yPosition + 5);
                    doc.text(`Viewers: ${watchViewers}`, margin, yPosition + 12);
                    doc.text(`Revenue: â‚¦${watchRevenue.toLocaleString()}`, margin, yPosition + 19);

                    yPosition += 30;
                }

                // ========== MAN OF THE MATCH ==========
                if (match.manOfMatch) {
                    doc.setTextColor(255, 215, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('â­ MAN OF THE MATCH', margin, yPosition);
                    yPosition += 8;

                    doc.setDrawColor(255, 215, 0);
                    doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                    doc.setTextColor(255, 255, 255); // White
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');

                    const teamName = match.manOfMatch.team === 'teamA' ? match.teamA?.name : match.teamB?.name;
                    doc.text(`Player: ${match.manOfMatch.playerName}`, margin, yPosition + 5);
                    doc.text(`Team: ${teamName}`, margin, yPosition + 12);
                    doc.text(`Rating: ${match.manOfMatch.rating}/10`, margin, yPosition + 19);
                    if (match.manOfMatch.notes) {
                        doc.text(`Notes: ${match.manOfMatch.notes}`, margin, yPosition + 26);
                    }

                    yPosition += 35;
                }

                // ========== FOOTER ==========
                try {
                    // Handle both old and new jsPDF API
                    let pageCount = 1;
                    if (doc.internal.pages) {
                        pageCount = doc.internal.pages.length - 1; // -1 because pages array has null at index 0
                    } else if (doc.getPages) {
                        pageCount = doc.getPages().length;
                    }

                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);

                        // Bottom line
                        doc.setDrawColor(255, 215, 0);
                        doc.line(margin, pageHeight - 20, pageWidth - margin, pageHeight - 20);

                        // Footer text
                        doc.setTextColor(255, 255, 255); // White
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Generated: ${new Date().toLocaleString()}`, margin, pageHeight - 13);

                        // Powered by iSmart DC - Bold, Yellow, Center
                        doc.setTextColor(255, 215, 0); // Gold/Yellow
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.text('Powered by iSmart DC', pageWidth / 2, pageHeight - 13, { align: 'center' });
                    }
                } catch (footerError) {
                    console.warn('Footer generation skipped:', footerError);
                }

                // ========== SAVE PDF ==========
                const pdfTeamA = match.teamA?.name || 'TeamA';
                const pdfTeamB = match.teamB?.name || 'TeamB';
                const timestamp = new Date().getTime();
                const filename = `Match_Report_${pdfTeamA}_vs_${pdfTeamB}_${timestamp}.pdf`;

                doc.save(filename);

                showNotification('PDF report downloaded successfully!', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                console.error('Match data:', match);
                showNotification('Error generating PDF: ' + error.message, 'error');
            }
        }

        // Download user-friendly report (stats-focused with teams & score)
        function downloadUserReportPDF() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const match = doc.data();
                    generateUserReportPDF(match, matchId);
                }
            }).catch(err => showNotification('Error generating report: ' + err.message, 'error'));
        }

        function generateUserReportPDF(match, matchId) {
            showNotification('Generating user report...', 'loading');

            try {
                if (!window.jspdf) {
                    throw new Error('jsPDF library not loaded. Please refresh the page.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPosition = 20;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);

                // ========== BACKGROUND ==========
                doc.setFillColor(10, 14, 39);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');

                // ========== HEADER ==========
                doc.setFillColor(255, 215, 0);
                doc.rect(0, 0, pageWidth, 35, 'F');

                doc.setTextColor(10, 14, 39);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('MATCH STATISTICS', pageWidth / 2, 15, { align: 'center' });

                doc.setFontSize(10);
                doc.text('Official Match Report', pageWidth / 2, 25, { align: 'center' });

                yPosition = 50;

                // ========== TEAMS WITH SCORE (MAIN FOCUS) ==========
                const teamAName = match.teamA?.name || 'Team A';
                const teamBName = match.teamB?.name || 'Team B';
                const scoreA = match.finalScore?.teamA || match.currentScore?.teamA || 0;
                const scoreB = match.finalScore?.teamB || match.currentScore?.teamB || 0;

                // Large centered score section
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(teamAName, pageWidth / 3, yPosition);

                doc.setFontSize(36);
                doc.setFont(undefined, 'bold');
                doc.text(scoreA.toString(), pageWidth / 3, yPosition + 12, { align: 'center' });

                // Center text
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'normal');
                doc.text('vs', pageWidth / 2, yPosition + 20, { align: 'center' });

                // Right side team
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(teamBName, (pageWidth / 3) * 2, yPosition);

                doc.setFontSize(36);
                doc.setFont(undefined, 'bold');
                doc.text(scoreB.toString(), (pageWidth / 3) * 2, yPosition + 12, { align: 'center' });

                yPosition += 50;

                // ========== MATCH INFO ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('MATCH INFORMATION', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');

                const matchDate = match.matchDate ? new Date(match.matchDate).toLocaleDateString() : 'N/A';
                doc.text(`Date: ${matchDate}`, margin, yPosition + 5);
                doc.text(`Time: ${match.matchTime || 'N/A'}`, margin, yPosition + 12);
                doc.text(`Status: FINISHED âœ“`, margin, yPosition + 19);

                yPosition += 35;

                // ========== STATISTICS ONLY ==========
                doc.setTextColor(255, 215, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('MATCH STATISTICS', margin, yPosition);
                yPosition += 8;

                doc.setDrawColor(255, 215, 0);
                doc.line(margin, yPosition - 2, pageWidth - margin, yPosition - 2);

                // Simple stats display (not table)
                const stats = [
                    ['Corners', match.finalStats?.corners?.teamA || 0, match.finalStats?.corners?.teamB || 0],
                    ['Possession', `${match.finalStats?.possession?.teamA || 50}%`, `${match.finalStats?.possession?.teamB || 50}%`],
                    ['Shots', match.finalStats?.shots?.teamA || 0, match.finalStats?.shots?.teamB || 0],
                    ['Yellow Cards', match.finalStats?.yellowCards?.teamA || 0, match.finalStats?.yellowCards?.teamB || 0],
                    ['Red Cards', match.finalStats?.redCards?.teamA || 0, match.finalStats?.redCards?.teamB || 0]
                ];

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');

                yPosition += 8;
                const statLabelWidth = contentWidth * 0.4;
                const statValueWidth = contentWidth * 0.3;

                stats.forEach((stat, index) => {
                    const rowY = yPosition + (index * 8);

                    // Stat label
                    doc.text(stat[0], margin, rowY);

                    // Team A value (right aligned)
                    doc.text(stat[1].toString(), margin + statLabelWidth, rowY, { align: 'right' });

                    // Team B value (right aligned)
                    doc.text(stat[2].toString(), pageWidth - margin, rowY, { align: 'right' });
                });

                yPosition += 50;

                // ========== FOOTER ==========
                doc.setDrawColor(255, 215, 0);
                doc.line(margin, pageHeight - 20, pageWidth - margin, pageHeight - 20);

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, margin, pageHeight - 13);

                doc.setTextColor(255, 215, 0);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text('Powered by iSmart DC', pageWidth / 2, pageHeight - 13, { align: 'center' });

                // ========== SAVE PDF ==========
                const pdfTeamA = match.teamA?.name || 'TeamA';
                const pdfTeamB = match.teamB?.name || 'TeamB';
                const timestamp = new Date().getTime();
                const filename = `User_Report_${pdfTeamA}_vs_${pdfTeamB}_${timestamp}.pdf`;

                doc.save(filename);

                showNotification('User report downloaded successfully!', 'success');
            } catch (error) {
                console.error('User report generation error:', error);
                console.error('Match data:', match);
                showNotification('Error generating report: ' + error.message, 'error');
            }
        }

        // Archive finished match
        function archiveFinishedMatch() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            showConfirmation({
                title: 'ðŸ“¦ Archive Match',
                message: 'Archive this match? It will be hidden from active lists.',
                icon: 'ðŸ“¦',
                messageType: 'info',
                confirmText: 'Archive',
                cancelText: 'Cancel',
                onConfirm: () => {
                    db.collection('matches').doc(matchId).update({
                        archived: true
                    }).then(() => {
                        showNotification('Match archived successfully', 'success');
                        loadFinishedMatchesDropdown();
                        document.getElementById('finishedMatchSelect').value = '';
                        document.getElementById('finishedMatchContainer').style.display = 'none';
                    }).catch(err => showNotification('Error archiving match: ' + err.message, 'error'));
                }
            });
        }

        // Load upcoming matches dropdown
        function loadUpcomingMatchesDropdown() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            db.collection('matches').where('status', '==', 'upcoming').get().then(snapshot => {
                const select = document.getElementById('upcomingFilterFrom');

                upcomingMatches = snapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => new Date(a.matchDate) - new Date(b.matchDate));

                filterUpcomingMatches();
            });
        }

        // Filter upcoming matches
        function filterUpcomingMatches() {
            const fromDate = document.getElementById('upcomingFilterFrom').value;
            const toDate = document.getElementById('upcomingFilterTo').value;
            const searchTeam = document.getElementById('upcomingSearchTeam').value.toLowerCase();

            let filtered = upcomingMatches;

            if (fromDate) {
                filtered = filtered.filter(m => new Date(m.matchDate) >= new Date(fromDate));
            }
            if (toDate) {
                filtered = filtered.filter(m => new Date(m.matchDate) <= new Date(toDate));
            }
            if (searchTeam) {
                filtered = filtered.filter(m =>
                    (m.teamA?.name || '').toLowerCase().includes(searchTeam) ||
                    (m.teamB?.name || '').toLowerCase().includes(searchTeam)
                );
            }

            const container = document.getElementById('upcomingMatchesContainer');
            if (filtered.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-gray);">No matches found</div>';
                return;
            }

            container.innerHTML = filtered.map(match => `
                <div style="background: var(--card-bg); border: 1px solid rgba(255,215,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: var(--text-white);">${match.teamA?.name || 'Team A'} vs ${match.teamB?.name || 'Team B'}</div>
                            <div style="color: var(--text-gray); font-size: 0.9em; margin-top: 5px;">ðŸ“… ${match.matchDate} ${match.matchTime || ''}</div>
                            ${match.livestream?.isPaid ? `<div style="color: var(--accent-gold); font-size: 0.85em; margin-top: 5px;">ðŸ’³ Paid Livestream: â‚¦${match.livestream.price?.toLocaleString() || 'N/A'}</div>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 8px;">
                                <button class="add-btn" onclick="editUpcomingMatch('${match.id}')" style="padding: 8px 12px; background: rgba(255,215,0,0.2);">âœï¸ Edit</button>
                                <button class="add-btn" onclick="startUpcomingMatch('${match.id}')" style="padding: 8px 12px;">â–¶ï¸ Start</button>
                            </div>
                            ${match.livestream?.isPaid ? `<button class="watch-fee-btn" onclick="openWatchFeeModal('${match.id}')" style="padding: 8px 12px; font-size: 0.8em; margin-top: 0;">ðŸ’³ Watch Fee</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Start upcoming match (move to live)
        function startUpcomingMatch(matchId) {
            showConfirmation({
                title: 'ðŸš€ Start Match',
                message: 'Start this match now?',
                icon: 'ðŸš€',
                messageType: 'info',
                confirmText: 'Start',
                cancelText: 'Cancel',
                onConfirm: () => {
                    db.collection('matches').doc(matchId).update({
                        status: 'live',
                        startedAt: new Date().toISOString(),
                        currentScore: { teamA: 0, teamB: 0 },
                        timeElapsed: 0,
                        liveStats: {}
                    }).then(() => {
                        showNotification('Match started!', 'success');
                        loadUpcomingMatchesDropdown();
                    }).catch(err => showNotification('Error starting match: ' + err.message, 'error'));
                }
            });
        }

        // Edit upcoming match
        function editUpcomingMatch(matchId) {
            const match = upcomingMatches.find(m => m.id === matchId);
            if (!match) {
                showNotification('Match not found', 'error');
                return;
            }

            editingUpcomingId = matchId;
            document.getElementById('upcomingMatchesContainer').style.display = 'none';
            document.getElementById('editUpcomingSection').style.display = 'block';

            // Populate form with existing data
            document.getElementById('editUpcomingDate').value = match.matchDate || '';
            document.getElementById('editUpcomingTime').value = match.matchTime || '';
            document.getElementById('editTeamAName').value = match.teamA?.name || '';
            document.getElementById('editTeamBName').value = match.teamB?.name || '';
            document.getElementById('editWinChanceA').value = match.winningChances?.teamA || 50;
            document.getElementById('editWinChanceB').value = match.winningChances?.teamB || 50;
        }

        // Save upcoming match edits
        function saveUpcomingMatchEdit() {
            if (!editingUpcomingId) {
                showNotification('No match selected', 'error');
                return;
            }

            const updates = {
                matchDate: document.getElementById('editUpcomingDate').value,
                matchTime: document.getElementById('editUpcomingTime').value,
                'teamA.name': document.getElementById('editTeamAName').value,
                'teamB.name': document.getElementById('editTeamBName').value,
                'winningChances.teamA': parseFloat(document.getElementById('editWinChanceA').value) || 50,
                'winningChances.teamB': parseFloat(document.getElementById('editWinChanceB').value) || 50
            };

            db.collection('matches').doc(editingUpcomingId).update(updates).then(() => {
                showNotification('Match updated successfully!', 'success');
                editingUpcomingId = null;
                cancelUpcomingMatchEdit();
                loadUpcomingMatchesDropdown();
            }).catch(err => showNotification('Error updating match: ' + err.message, 'error'));
        }

        // Cancel upcoming match edit
        function cancelUpcomingMatchEdit() {
            editingUpcomingId = null;
            document.getElementById('editUpcomingSection').style.display = 'none';
            document.getElementById('upcomingMatchesContainer').style.display = 'block';
        }

        // Save Man of the Match
        function saveManOfMatch() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const playerName = document.getElementById('manOfMatchName').value.trim();
            const team = document.getElementById('manOfMatchTeam').value;
            const rating = parseFloat(document.getElementById('manOfMatchRating').value);
            const notes = document.getElementById('manOfMatchNotes').value.trim();

            if (!playerName || !team || !rating) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (rating < 1 || rating > 10) {
                showNotification('Rating must be between 1 and 10', 'error');
                return;
            }

            db.collection('matches').doc(matchId).update({
                manOfMatch: {
                    playerName: playerName,
                    team: team,
                    rating: rating,
                    notes: notes
                }
            }).then(() => {
                showNotification('Man of the Match saved!', 'success');
                displayManOfMatch(playerName, team, rating, notes);
            }).catch(err => showNotification('Error saving: ' + err.message, 'error'));
        }

        // Display Man of the Match
        function displayManOfMatch(playerName, team, rating, notes) {
            const teamName = team === 'teamA' ?
                (document.getElementById('finishedTeamAName').textContent) :
                (document.getElementById('finishedTeamBName').textContent);

            const display = `
                <div style="background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.4); border-radius: 10px; padding: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2em;">â­</div>
                        <div>
                            <div style="font-size: 1.1em; font-weight: bold; color: var(--accent-gold);">${playerName}</div>
                            <div style="color: var(--text-gray); font-size: 0.9em;">Team: ${teamName}</div>
                            <div style="color: var(--accent-gold); font-weight: 600;">Rating: ${rating}/10</div>
                            ${notes ? `<div style="color: var(--text-gray); font-size: 0.85em; margin-top: 5px;">ðŸ“ ${notes}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('manOfMatchDisplay').innerHTML = display;
        }

        // Load finished match and display Man of the Match
        function loadFinishedMatchDetailsWithManOfMatch(matchId) {
            loadFinishedMatchDetails(matchId);

            if (matchId) {
                db.collection('matches').doc(matchId).get().then(doc => {
                    if (doc.exists && doc.data().manOfMatch) {
                        const mom = doc.data().manOfMatch;
                        document.getElementById('manOfMatchName').value = mom.playerName || '';
                        document.getElementById('manOfMatchTeam').value = mom.team || '';
                        document.getElementById('manOfMatchRating').value = mom.rating || '';
                        document.getElementById('manOfMatchNotes').value = mom.notes || '';
                        displayManOfMatch(mom.playerName, mom.team, mom.rating, mom.notes);
                    }
                    // Load goal scorers
                    if (doc.exists && doc.data().goalScorers) {
                        displayFinishedGoalScorers(doc.data().goalScorers);
                    }
                    // Show/hide watch fee button for paid livestreams
                    const watchFeeBtn = document.getElementById('finishedWatchFeeButton');
                    const matchData = doc.data();
                    if (matchData.livestream && matchData.livestream.isPaid) {
                        watchFeeBtn.style.display = 'block';
                    } else {
                        watchFeeBtn.style.display = 'none';
                    }
                });
            } else {
                document.getElementById('finishedWatchFeeButton').style.display = 'none';
            }
        }

        // ===== GOAL SCORERS FUNCTIONALITY =====
        let currentLiveGoalScorers = [];
        let currentFinishedGoalScorers = [];

        // Add goal scorer to finished match
        function addGoalScorer() {
            const matchId = document.getElementById('finishedMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const name = document.getElementById('goalScorerName').value.trim();
            const team = document.getElementById('goalScorerTeam').value;
            const minute = parseInt(document.getElementById('goalScorerMinute').value);

            if (!name || !team || !minute && minute !== 0) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const goalScorer = {
                playerName: name,
                team: team,
                minute: minute,
                id: Date.now()
            };

            currentFinishedGoalScorers.push(goalScorer);
            displayFinishedGoalScorers(currentFinishedGoalScorers);

            // Save to Firebase
            db.collection('matches').doc(matchId).update({
                goalScorers: currentFinishedGoalScorers
            }).catch(err => showNotification('Error saving goal scorer: ' + err.message, 'error'));

            // Clear inputs
            document.getElementById('goalScorerName').value = '';
            document.getElementById('goalScorerTeam').value = '';
            document.getElementById('goalScorerMinute').value = '';
        }

        // Display finished match goal scorers
        function displayFinishedGoalScorers(scorers) {
            const container = document.getElementById('goalScorersList');
            if (!scorers || scorers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No goal scorers added yet</p>';
                return;
            }

            const sortedScorers = [...scorers].sort((a, b) => a.minute - b.minute);
            container.innerHTML = sortedScorers.map(scorer => `
                 <div class="goal-list-item">
                     <div>
                         <strong>${scorer.playerName}</strong>
                         <div style="font-size: 0.8em; color: var(--text-gray);">
                             ${scorer.team === 'teamA' ? document.getElementById('goalTeamAOption')?.textContent || 'Team A' : document.getElementById('goalTeamBOption')?.textContent || 'Team B'} | ${scorer.minute}'
                         </div>
                     </div>
                     <button class="remove-btn" onclick="removeGoalScorer(${scorer.id})">Delete</button>
                 </div>
             `).join('');
        }

        // Remove goal scorer
        function removeGoalScorer(id) {
            currentFinishedGoalScorers = currentFinishedGoalScorers.filter(g => g.id !== id);
            displayFinishedGoalScorers(currentFinishedGoalScorers);
        }

        // Add live goal scorer
        function addLiveGoalScorer() {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const name = document.getElementById('liveGoalScorerName').value.trim();
            const team = document.getElementById('liveGoalScorerTeam').value;
            const minute = parseInt(document.getElementById('liveGoalScorerMinute').value);

            if (!name || !team || !minute && minute !== 0) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const goalScorer = {
                playerName: name,
                team: team,
                minute: minute,
                id: Date.now()
            };

            currentLiveGoalScorers.push(goalScorer);
            addEventToTimeline(`âš½ Goal: ${name} (${minute}')`, 'goal');
            displayLiveGoalScorers();

            // Save to Firebase
            db.collection('matches').doc(liveMatchData.id).update({
                goalScorers: firebase.firestore.FieldValue.arrayUnion(goalScorer)
            }).catch(err => showNotification('Error saving goal: ' + err.message, 'error'));

            // Clear inputs
            document.getElementById('liveGoalScorerName').value = '';
            document.getElementById('liveGoalScorerTeam').value = '';
            document.getElementById('liveGoalScorerMinute').value = '';
        }

        // Display live goal scorers
        function displayLiveGoalScorers() {
            const container = document.getElementById('liveGoalScorersList');
            if (!currentLiveGoalScorers || currentLiveGoalScorers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No goals scored yet</p>';
                return;
            }

            const sortedScorers = [...currentLiveGoalScorers].sort((a, b) => a.minute - b.minute);
            container.innerHTML = sortedScorers.map(scorer => `
                 <div class="goal-list-item">
                     <div>
                         <strong>âš½ ${scorer.playerName}</strong>
                         <div style="font-size: 0.8em; color: var(--text-gray);">
                             ${scorer.team === 'teamA' ? 'Team A' : 'Team B'} | ${scorer.minute}'
                         </div>
                     </div>
                     <button class="remove-btn" onclick="removeLiveGoalScorer(${scorer.id})">Delete</button>
                 </div>
             `).join('');
        }

        // Remove live goal scorer
        function removeLiveGoalScorer(id) {
            currentLiveGoalScorers = currentLiveGoalScorers.filter(g => g.id !== id);
            displayLiveGoalScorers();
        }

        // ===== MATCH EVENTS TIMELINE =====
        let matchEvents = [];

        function addEventToTimeline(eventText, eventType) {
            const minute = parseInt(document.getElementById('liveMinute').value) || 0;
            const event = {
                text: eventText,
                type: eventType,
                minute: minute,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                id: Date.now()
            };

            matchEvents.push(event);
            displayTimeline();

            // Save to Firebase
            if (liveMatchData.id) {
                db.collection('matches').doc(liveMatchData.id).update({
                    events: firebase.firestore.FieldValue.arrayUnion(event)
                }).catch(err => console.error('Error saving event:', err));
            }
        }

        function displayTimeline() {
            const container = document.getElementById('liveEventsTimeline');
            if (!matchEvents || matchEvents.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; margin: 0;">No events recorded yet</p>';
                return;
            }

            const eventIcons = {
                goal: 'âš½',
                yellowCard: 'ðŸŸ¨',
                redCard: 'ðŸŸ¥',
                substitution: 'ðŸ”„',
                default: 'ðŸ“Œ'
            };

            container.innerHTML = matchEvents.map(event => `
                 <div class="timeline-event">
                     <div class="event-icon">${eventIcons[event.type] || eventIcons.default}</div>
                     <div class="event-details">
                         <div style="font-weight: 600; color: var(--text-white);">${event.text}</div>
                         <div class="event-time">${event.minute}' | ${event.timestamp}</div>
                     </div>
                 </div>
             `).join('');
        }

        // ===== PLAYER SUBSTITUTIONS =====
        let matchSubstitutions = [];

        function addSubstitution() {
            if (!liveMatchData.id) {
                showNotification('Please select a match first', 'error');
                return;
            }

            const playerOut = document.getElementById('playerOut').value.trim();
            const playerIn = document.getElementById('playerIn').value.trim();
            const team = document.getElementById('substitutionTeam').value;
            const minute = parseInt(document.getElementById('substitutionMinute').value);

            if (!playerOut || !playerIn || !team || !minute && minute !== 0) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const substitution = {
                playerOut: playerOut,
                playerIn: playerIn,
                team: team,
                minute: minute,
                id: Date.now()
            };

            matchSubstitutions.push(substitution);
            addEventToTimeline(`ðŸ”„ Sub: ${playerOut} â†’ ${playerIn} (${minute}')`, 'substitution');
            displaySubstitutions();

            // Save to Firebase
            db.collection('matches').doc(liveMatchData.id).update({
                substitutions: firebase.firestore.FieldValue.arrayUnion(substitution)
            }).catch(err => showNotification('Error saving substitution: ' + err.message, 'error'));

            // Clear inputs
            document.getElementById('playerOut').value = '';
            document.getElementById('playerIn').value = '';
            document.getElementById('substitutionTeam').value = '';
            document.getElementById('substitutionMinute').value = '';
        }

        function displaySubstitutions() {
            const container = document.getElementById('substitutionsList');
            if (!matchSubstitutions || matchSubstitutions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em; text-align: center;">No substitutions yet</p>';
                return;
            }

            const sortedSubs = [...matchSubstitutions].sort((a, b) => a.minute - b.minute);
            container.innerHTML = `
                 <div class="substitutions-list">
                     ${sortedSubs.map(sub => `
                         <div class="substitution-item">
                             <div style="font-weight: 600; color: var(--text-white); margin-bottom: 8px;">
                                 ${sub.team === 'teamA' ? 'Team A' : 'Team B'} | ${sub.minute}'
                             </div>
                             <div class="player-in-out">
                                 <div style="text-align: right;">
                                     <div style="font-size: 0.9em; color: var(--text-white);">${sub.playerOut}</div>
                                     <span class="player-label">OUT</span>
                                 </div>
                                 <div style="text-align: center; color: var(--text-gray);">â‡„</div>
                                 <div>
                                     <div style="font-size: 0.9em; color: var(--text-white);">${sub.playerIn}</div>
                                     <span class="player-label in">IN</span>
                                 </div>
                             </div>
                             <button class="remove-btn" onclick="removeSubstitution(${sub.id})" style="margin-top: 8px; width: 100%;">Delete</button>
                         </div>
                     `).join('')}
                 </div>
             `;
        }

        function removeSubstitution(id) {
            matchSubstitutions = matchSubstitutions.filter(s => s.id !== id);
            displaySubstitutions();
        }

        // Load live match with all data
        function loadLiveMatchWithData(matchId) {
            if (!matchId) {
                document.getElementById('liveMatchContainer').style.display = 'none';
                return;
            }

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    liveMatchData = { id: doc.id, ...data };

                    document.getElementById('liveMatchContainer').style.display = 'block';

                    // Populate basic info
                    document.getElementById('liveTeamAName').textContent = liveMatchData.teamA?.name || 'Team A';
                    document.getElementById('liveTeamBName').textContent = liveMatchData.teamB?.name || 'Team B';
                    document.getElementById('liveTeamAScore').textContent = liveMatchData.currentScore?.teamA || 0;
                    document.getElementById('liveTeamBScore').textContent = liveMatchData.currentScore?.teamB || 0;

                    // Populate stats
                    document.getElementById('liveCornerA').value = liveMatchData.liveStats?.corners?.teamA || 0;
                    document.getElementById('liveCornerB').value = liveMatchData.liveStats?.corners?.teamB || 0;
                    document.getElementById('livePossessionA').value = liveMatchData.liveStats?.possession?.teamA || 50;
                    document.getElementById('livePossessionB').value = liveMatchData.liveStats?.possession?.teamB || 50;
                    document.getElementById('liveShotsA').value = liveMatchData.liveStats?.shots?.teamA || 0;
                    document.getElementById('liveShotsB').value = liveMatchData.liveStats?.shots?.teamB || 0;
                    document.getElementById('liveYellowA').value = liveMatchData.liveStats?.yellowCards?.teamA || 0;
                    document.getElementById('liveYellowB').value = liveMatchData.liveStats?.yellowCards?.teamB || 0;
                    document.getElementById('liveRedA').value = liveMatchData.liveStats?.redCards?.teamA || 0;
                    document.getElementById('liveRedB').value = liveMatchData.liveStats?.redCards?.teamB || 0;

                    // Load goal scorers
                    currentLiveGoalScorers = data.goalScorers || [];
                    displayLiveGoalScorers();

                    // Load events
                    matchEvents = data.events || [];
                    displayTimeline();

                    // Load substitutions
                    matchSubstitutions = data.substitutions || [];
                    displaySubstitutions();

                    // Populate match control
                    document.getElementById('liveMinute').value = liveMatchData.timeElapsed || '0';
                    document.getElementById('liveStatus').value = liveMatchData.status || 'live';
                }
            });
        }

        // ===== PREDICTIONS FUNCTIONALITY =====
        let currentPredictions = {
            scorePredictions: [],
            teamPredictions: [],
            goalsPredictions: []
        };

        // Open predictions modal
        function openPredictionsModal() {
            document.getElementById('predictionsModalOverlay').classList.add('active');
            loadMatchesForPredictions();
        }

        // Close predictions modal
        function closePredictionsModal() {
            document.getElementById('predictionsModalOverlay').classList.remove('active');
        }

        // Load matches for predictions dropdown
        function loadMatchesForPredictions() {
            db.collection('matches').where('status', 'in', ['upcoming', 'live']).get().then(snapshot => {
                const select = document.getElementById('predictionsMatchSelect');
                select.innerHTML = '<option value="">-- Select a match --</option>';

                snapshot.docs.forEach(doc => {
                    const match = doc.data();
                    const teamA = match.teamA?.name || 'Team A';
                    const teamB = match.teamB?.name || 'Team B';
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${teamA} vs ${teamB} (${match.matchDate})`;
                    select.appendChild(option);
                });
            });
        }

        // Load predictions for selected match
        function loadPredictionsForMatch(matchId) {
            if (!matchId) {
                document.getElementById('predictionsContainer').style.display = 'none';
                return;
            }

            document.getElementById('predictionsContainer').style.display = 'block';

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists && doc.data().predictions) {
                    currentPredictions = doc.data().predictions;
                    displayAllPredictions();
                } else {
                    currentPredictions = {
                        scorePredictions: [],
                        teamPredictions: [],
                        goalsPredictions: []
                    };
                }
            });
        }

        // Update prediction types visibility
        function updatePredictionTypes() {
            const scoreEnabled = document.getElementById('pred_scoreEnabled').checked;
            const teamEnabled = document.getElementById('pred_teamEnabled').checked;
            const goalsEnabled = document.getElementById('pred_goalsEnabled').checked;

            document.getElementById('pred_scoreOptions').style.display = scoreEnabled ? 'block' : 'none';
            document.getElementById('pred_teamOptions').style.display = teamEnabled ? 'block' : 'none';
            document.getElementById('pred_goalsOptions').style.display = goalsEnabled ? 'block' : 'none';
        }

        // Add score prediction
        function addScorePrediction() {
            const scoreA = parseInt(document.getElementById('predTeamAScore').value);
            const scoreB = parseInt(document.getElementById('predTeamBScore').value);

            if (isNaN(scoreA) || isNaN(scoreB)) {
                showNotification('Please enter valid scores', 'error');
                return;
            }

            const prediction = { scoreA, scoreB, id: Date.now() };
            currentPredictions.scorePredictions.push(prediction);
            displayScorePredictions();

            document.getElementById('predTeamAScore').value = '';
            document.getElementById('predTeamBScore').value = '';
        }

        // Display score predictions
        function displayScorePredictions() {
            const container = document.getElementById('scorePredictionsList');
            if (currentPredictions.scorePredictions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No predictions added</p>';
                return;
            }

            container.innerHTML = currentPredictions.scorePredictions.map(pred => `
                <div style="background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-white); font-weight: 600;">${pred.scoreA} - ${pred.scoreB}</span>
                    <button class="remove-btn" onclick="removeScorePrediction(${pred.id})" style="padding: 5px 10px;">Remove</button>
                </div>
            `).join('');
        }

        // Remove score prediction
        function removeScorePrediction(id) {
            currentPredictions.scorePredictions = currentPredictions.scorePredictions.filter(p => p.id !== id);
            displayScorePredictions();
        }

        // Add team prediction
        function addTeamPrediction(team) {
            const prediction = { team, id: Date.now() };
            currentPredictions.teamPredictions.push(prediction);
            displayTeamPredictions();
        }

        // Display team predictions
        function displayTeamPredictions() {
            const container = document.getElementById('teamPredictionsList');
            if (currentPredictions.teamPredictions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No predictions added</p>';
                return;
            }

            container.innerHTML = currentPredictions.teamPredictions.map(pred => `
                <div style="background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-white); font-weight: 600;">${pred.team === 'teamA' ? 'Team A' : 'Team B'} Will Score</span>
                    <button class="remove-btn" onclick="removeTeamPrediction(${pred.id})" style="padding: 5px 10px;">Remove</button>
                </div>
            `).join('');
        }

        // Remove team prediction
        function removeTeamPrediction(id) {
            currentPredictions.teamPredictions = currentPredictions.teamPredictions.filter(p => p.id !== id);
            displayTeamPredictions();
        }

        // Add goals prediction
        function addGoalsPrediction() {
            const goals = parseInt(document.getElementById('predTotalGoals').value);

            if (isNaN(goals)) {
                showNotification('Please enter a valid number of goals', 'error');
                return;
            }

            const prediction = { goals, id: Date.now() };
            currentPredictions.goalsPredictions.push(prediction);
            displayGoalsPredictions();

            document.getElementById('predTotalGoals').value = '';
        }

        // Display goals predictions
        function displayGoalsPredictions() {
            const container = document.getElementById('goalsPredictionsList');
            if (currentPredictions.goalsPredictions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); font-size: 0.9em;">No predictions added</p>';
                return;
            }

            container.innerHTML = currentPredictions.goalsPredictions.map(pred => `
                <div style="background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-white); font-weight: 600;">Total Goals: ${pred.goals}</span>
                    <button class="remove-btn" onclick="removeGoalsPrediction(${pred.id})" style="padding: 5px 10px;">Remove</button>
                </div>
            `).join('');
        }

        // Remove goals prediction
        function removeGoalsPrediction(id) {
            currentPredictions.goalsPredictions = currentPredictions.goalsPredictions.filter(p => p.id !== id);
            displayGoalsPredictions();
        }

        // Display all predictions
        function displayAllPredictions() {
            displayScorePredictions();
            displayTeamPredictions();
            displayGoalsPredictions();
        }

        // Save predictions to Firebase
        function savePredictions() {
            const matchId = document.getElementById('predictionsMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            db.collection('matches').doc(matchId).update({
                predictions: currentPredictions,
                predictionsUpdatedAt: new Date().toISOString()
            }).then(() => {
                showNotification('Predictions saved successfully!', 'success');
                closePredictionsModal();
            }).catch(err => showNotification('Error saving predictions: ' + err.message, 'error'));
        }

        // ===== GOAL SCORERS MODAL FUNCTIONS =====
        // Open goal scorers modal
        function openGoalScorersModal() {
            document.getElementById('goalScorersModalOverlay').classList.add('active');
            loadMatchesForGoalScorers();
        }

        // Close goal scorers modal
        function closeGoalScorersModal() {
            document.getElementById('goalScorersModalOverlay').classList.remove('active');
        }

        // Load matches for goal scorers
        function loadMatchesForGoalScorers() {
            db.collection('matches').where('status', 'in', ['live', 'finished']).get().then(snapshot => {
                const select = document.getElementById('goalScorersMatchSelect');
                select.innerHTML = '<option value="">-- Select a match --</option>';

                snapshot.docs.forEach(doc => {
                    const match = doc.data();
                    const teamA = match.teamA?.name || 'Team A';
                    const teamB = match.teamB?.name || 'Team B';
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${teamA} vs ${teamB}`;
                    select.appendChild(option);
                });
            });
        }

        // Load goal scorers for match
        function loadGoalScorersForMatch(matchId) {
            if (!matchId) {
                document.getElementById('goalScorersContainer').style.display = 'none';
                return;
            }

            document.getElementById('goalScorersContainer').style.display = 'block';

            db.collection('matches').doc(matchId).get().then(doc => {
                if (doc.exists && doc.data().goalScorers) {
                    currentFinishedGoalScorers = doc.data().goalScorers;
                    displayFinishedGoalScorers(currentFinishedGoalScorers);
                } else {
                    currentFinishedGoalScorers = [];
                    displayFinishedGoalScorers([]);
                }
            });
        }

        // Save goal scorers
        function saveGoalScorers() {
            const matchId = document.getElementById('goalScorersMatchSelect').value;
            if (!matchId) {
                showNotification('Please select a match first', 'error');
                return;
            }

            db.collection('matches').doc(matchId).update({
                goalScorers: currentFinishedGoalScorers
            }).then(() => {
                showNotification('Goal scorers saved successfully!', 'success');
                closeGoalScorersModal();
            }).catch(err => showNotification('Error saving: ' + err.message, 'error'));
        }



        function switchWatchFeeTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.watch-fee-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.watch-fee-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Mark clicked button as active
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }



        // Load livestream revenue for watch fee modal
        let currentWatchFeeMatchId = null;
        function loadWatchFeeeLivestreamRevenue() {
            if (!currentWatchFeeMatchId) return;

            const container = document.getElementById('livestreamRevenueContent');
            container.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 20px;">Loading livestream revenue data...</div>';

            db.collection('matches').doc(currentWatchFeeMatchId).get().then(doc => {
                if (!doc.exists) {
                    container.innerHTML = '<div style="color: #ff6b6b; padding: 20px;">No match found</div>';
                    return;
                }

                const data = doc.data();
                const livestream = data.livestream || {};
                const livestreamCodes = data.livestreamCodes || [];

                // Calculate metrics
                const totalRevenue = livestream.totalRevenue || 0;
                const paidCodes = livestreamCodes.filter(c => c.isPaid).length;
                const freeCodes = livestreamCodes.filter(c => !c.isPaid).length;
                const totalCodes = livestreamCodes.length;
                const avgRevenue = paidCodes > 0 ? (totalRevenue / paidCodes).toFixed(0) : 0;
                const price = livestream.price || 0;

                container.innerHTML = `
                    <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: var(--accent-green); margin-bottom: 10px;">ðŸ’° Revenue Summary</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="color: var(--text-gray); font-size: 0.9em;">Total Revenue</div>
                                <div style="color: var(--accent-green); font-weight: 600; font-size: 1.3em;">â‚¦${totalRevenue.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-gray); font-size: 0.9em;">Code Price</div>
                                <div style="color: var(--accent-gold); font-weight: 600; font-size: 1.3em;">â‚¦${price.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-gray); font-size: 0.9em;">Paid Codes Sold</div>
                                <div style="color: var(--text-white); font-weight: 600; font-size: 1.3em;">${paidCodes}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-gray); font-size: 0.9em;">Free Codes Issued</div>
                                <div style="color: var(--text-white); font-weight: 600; font-size: 1.3em;">${freeCodes}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-gray); font-size: 0.9em;">Avg per Code</div>
                                <div style="color: var(--accent-gold); font-weight: 600; font-size: 1.3em;">â‚¦${avgRevenue.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-gray); font-size: 0.9em;">Total Codes</div>
                                <div style="color: var(--text-white); font-weight: 600; font-size: 1.3em;">${totalCodes}</div>
                            </div>
                        </div>
                    </div>

                    <h4 style="color: var(--accent-gold); margin-bottom: 15px; margin-top: 20px;">ðŸ“‹ Recent Code Purchases</h4>
                    ${livestreamCodes.length === 0 ?
                        '<div style="color: var(--text-gray); padding: 20px; text-align: center;">No codes issued yet</div>' :
                        `
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${livestreamCodes.slice().reverse().slice(0, 10).map((code, idx) => `
                                <div style="background: rgba(255, 215, 0, 0.05); border-left: 3px solid ${code.isPaid ? 'var(--accent-gold)' : 'var(--accent-green)'}; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: var(--text-white); font-weight: 600;">Code: ${code.code}</div>
                                            <div style="color: var(--text-gray); font-size: 0.85em; margin-top: 3px;">User: ${code.userName || 'Unknown'}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: ${code.isPaid ? 'var(--accent-gold)' : 'var(--accent-green)'}; font-weight: 600;">
                                                ${code.isPaid ? 'ðŸ’° â‚¦' + (code.amount || 0).toLocaleString() : 'âœ… FREE'}
                                            </div>
                                            <div style="color: var(--text-gray); font-size: 0.8em; margin-top: 3px;">${new Date(code.createdAt).toLocaleDateString()}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        `
                    }
                `;
            }).catch(error => {
                console.error('Error loading livestream revenue:', error);
                container.innerHTML = '<div style="color: #ff6b6b; padding: 20px;">Error loading data</div>';
            });
        }

        // ===== CUSTOM CONFIRMATION MODAL SYSTEM =====
        let confirmationCallback = null;

        function showConfirmation(options = {}) {
            const {
                title = 'Confirm Action',
                message = 'Are you sure you want to proceed?',
                icon = 'âš ï¸',
                messageType = 'warning', // 'warning', 'info', 'error'
                confirmText = 'Confirm',
                cancelText = 'Cancel',
                onConfirm = null
            } = options;

            // Set modal content
            document.getElementById('confirmationIcon').textContent = icon;
            document.getElementById('confirmationTitle').textContent = title;
            const msgElement = document.getElementById('confirmationMessage');
            msgElement.textContent = message;
            msgElement.className = 'confirmation-message ' + messageType;

            // Set button text
            const confirmBtn = document.querySelector('.confirmation-btn-confirm');
            const cancelBtn = document.querySelector('.confirmation-btn-cancel');
            confirmBtn.textContent = 'âœ… ' + confirmText;
            cancelBtn.textContent = 'ðŸ”™ ' + cancelText;

            // Store callback
            confirmationCallback = onConfirm;

            // Show modal
            document.getElementById('confirmationOverlay').classList.add('active');
        }

        function submitConfirmation() {
            if (confirmationCallback && typeof confirmationCallback === 'function') {
                confirmationCallback();
            }
            cancelConfirmation();
        }

        function cancelConfirmation() {
            document.getElementById('confirmationOverlay').classList.remove('active');
            confirmationCallback = null;
        }

        // Close confirmation on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('confirmationOverlay').classList.contains('active')) {
                cancelConfirmation();
            }
        });

        // ===== LIVESTREAM VIEWER FUNCTIONS =====
        let currentLivestream = null;
        let livestreamChunks = [];
        let currentChunkIndex = 0;
        let isPlayingLivestream = false;
        const DELAY_MS = 5000; // 5 second delay

        function openLivestreamsModal() {
            document.getElementById('livestreamViewerModal').style.display = 'flex';
            loadLivestreams();
        }

        function closeLivestreamsModal() {
            document.getElementById('livestreamViewerModal').style.display = 'none';
            stopLivestream();
        }

        // ===== REGISTER PLAYERS FUNCTIONS =====
        let registersData = [];

        function openRegisterPlayersModal() {
            document.getElementById('registerPlayersModal').style.display = 'flex';
            loadRegisters();
        }

        function closeRegisterPlayersModal() {
            document.getElementById('registerPlayersModal').style.display = 'none';
        }

        function switchRegisterTab(tab) {
            // Hide all tabs
            document.getElementById('registerCreateTab').style.display = 'none';
            document.getElementById('registerViewTab').style.display = 'none';

            // Update button styles
            document.querySelectorAll('.register-tab').forEach(btn => {
                btn.style.color = 'var(--text-gray)';
                btn.style.borderBottom = 'none';
            });

            // Show selected tab and update button
            if (tab === 'create') {
                document.getElementById('registerCreateTab').style.display = 'block';
                event.target.style.color = 'var(--accent-gold)';
                event.target.style.borderBottom = '3px solid var(--accent-gold)';
            } else if (tab === 'view') {
                document.getElementById('registerViewTab').style.display = 'block';
                event.target.style.color = 'var(--accent-gold)';
                event.target.style.borderBottom = '3px solid var(--accent-gold)';
                loadRegisters();
            }
        }

        // Update register type display (show/hide amount or code section)
        function updateRegisterTypeDisplay() {
            const registerType = document.querySelector('input[name="registerType"]:checked').value;
            const amountSection = document.getElementById('amountSection');
            const codeSection = document.getElementById('codeSection');

            if (registerType === 'free') {
                amountSection.style.display = 'none';
                codeSection.style.display = 'none';
            } else if (registerType === 'paid') {
                amountSection.style.display = 'block';
                codeSection.style.display = 'none';
            } else if (registerType === 'code') {
                amountSection.style.display = 'none';
                codeSection.style.display = 'block';
            }
        }

        async function createRegister() {
            const name = document.getElementById('registerName').value.trim();
            const maxPlayers = parseInt(document.getElementById('maxPlayersAllowed').value);
            const registerType = document.querySelector('input[name="registerType"]:checked').value;
            const amount = registerType === 'paid' ? parseInt(document.getElementById('registrationAmount').value) : null;
            const code = registerType === 'code' ? document.getElementById('registrationCode').value.trim() : null;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            const msgDiv = document.getElementById('createRegisterMessage');

            // Validation
            if (!name) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please enter register name</div>';
                return;
            }
            if (!maxPlayers || maxPlayers < 1) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please enter valid number of players</div>';
                return;
            }
            if (registerType === 'paid' && (!amount || amount < 0)) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please enter valid registration amount</div>';
                return;
            }
            if (registerType === 'code' && !code) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please enter registration code</div>';
                return;
            }
            if (!startTime || !endTime) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please select start and end times</div>';
                return;
            }

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">â³ Creating register...</div>';

                const registerId = Date.now().toString();
                const registerData = {
                    id: registerId,
                    name: name,
                    maxPlayers: maxPlayers,
                    currentPlayers: 0,
                    registerType: registerType,
                    amount: amount,
                    code: code,
                    startTime: startTime,
                    endTime: endTime,
                    createdAt: new Date().toISOString(),
                    userInfoRequired: {
                        name: document.getElementById('needName').checked,
                        teamName: document.getElementById('needTeamName').checked,
                        playerList: document.getElementById('needPlayerList').checked
                    },
                    joinedPlayers: [],
                    shareCode: generateShareCode(),
                    totalRevenue: 0
                };

                // Save to Firebase
                await db.collection('playerRegisters').doc(registerId).set(registerData);

                // Clear form
                document.getElementById('registerName').value = '';
                document.getElementById('maxPlayersAllowed').value = '';
                document.getElementById('registrationAmount').value = '';
                document.getElementById('registrationCode').value = '';
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';

                msgDiv.innerHTML = '<div style="color: var(--accent-green); font-weight: 600;">âœ… Register created successfully!</div>';

                setTimeout(() => {
                    loadRegisters();
                    switchRegisterTab('view');
                }, 1500);

            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">âŒ Error: ${error.message}</div>`;
                console.error('Error creating register:', error);
            }
        }

        async function loadRegisters() {
            const container = document.getElementById('registersGrid');
            container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 40px 20px;">Loading registers...</div>';

            try {
                const snapshot = await db.collection('playerRegisters').get();
                registersData = [];

                snapshot.forEach(doc => {
                    registersData.push({ id: doc.id, ...doc.data() });
                });

                if (registersData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 40px 20px; grid-column: 1/-1;">No registers created yet</div>';
                    return;
                }

                renderRegisterCards();
            } catch (error) {
                container.innerHTML = `<div style="color: #ff6b6b; padding: 20px; grid-column: 1/-1;">âŒ Error: ${error.message}</div>`;
                console.error('Error loading registers:', error);
            }
        }

        function renderRegisterCards() {
            const container = document.getElementById('registersGrid');
            container.innerHTML = '';

            registersData.forEach(register => {
                const startDate = new Date(register.startTime).toLocaleString();
                const endDate = new Date(register.endTime).toLocaleString();
                const playerCount = register.joinedPlayers?.length || 0;
                const spotsLeft = register.maxPlayers - playerCount;

                const card = document.createElement('div');
                card.style.cssText = `
                    background: var(--card-bg);
                    border: 2px solid rgba(255, 215, 0, 0.2);
                    border-radius: 15px;
                    padding: 25px;
                    transition: all 0.3s ease;
                    cursor: pointer;
                `;

                const getTypeDisplay = (type, amount) => {
                    if (type === 'free') return { icon: 'âœ…', label: 'Free', bg: 'rgba(0, 255, 136, 0.2)', color: 'var(--accent-green)' };
                    if (type === 'paid') return { icon: 'ðŸ’³', label: `Paid (â‚¦${amount})`, bg: 'rgba(255, 215, 0, 0.2)', color: 'var(--accent-gold)' };
                    if (type === 'code') return { icon: 'ðŸ”', label: 'Code Required', bg: 'rgba(0, 212, 255, 0.2)', color: '#00d4ff' };
                };
                const typeDisplay = getTypeDisplay(register.registerType, register.amount || 0);

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <h3 style="color: var(--accent-gold); margin: 0; font-size: 1.2em;">${register.name}</h3>
                        <span style="background: ${typeDisplay.bg}; padding: 6px 12px; border-radius: 6px; color: ${typeDisplay.color}; font-weight: 600; font-size: 0.85em;">
                            ${typeDisplay.icon} ${typeDisplay.label}
                        </span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: rgba(255, 215, 0, 0.1); padding: 12px; border-radius: 8px;">
                            <div style="color: var(--text-gray); font-size: 0.85em; margin-bottom: 4px;">Players Registered</div>
                            <div style="color: var(--accent-gold); font-weight: 700; font-size: 1.3em;">${playerCount}/${register.maxPlayers}</div>
                        </div>
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 12px; border-radius: 8px;">
                            <div style="color: var(--text-gray); font-size: 0.85em; margin-bottom: 4px;">Spots Left</div>
                            <div style="color: var(--accent-green); font-weight: 700; font-size: 1.3em;">${spotsLeft}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 8px;">
                            ðŸ“… <strong>Start:</strong> ${startDate}
                        </div>
                        <div style="color: var(--text-gray); font-size: 0.9em;">
                            ðŸ“… <strong>End:</strong> ${endDate}
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="viewRegisterDetails('${register.id}')" 
                            style="flex: 1; padding: 10px; background: rgba(0, 212, 255, 0.2); border: 1px solid rgba(0, 212, 255, 0.4); color: #00d4ff; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.3s ease;"
                            onmouseover="this.style.background='rgba(0, 212, 255, 0.3)'"
                            onmouseout="this.style.background='rgba(0, 212, 255, 0.2)'">ðŸ‘ï¸ View</button>
                        <button onclick="shareRegister('${register.id}')" 
                            style="flex: 1; padding: 10px; background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.4); color: var(--accent-gold); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.3s ease;"
                            onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'"
                            onmouseout="this.style.background='rgba(255, 215, 0, 0.2)'">ðŸ“¤ Share</button>
                        <button onclick="deleteRegister('${register.id}')" 
                            style="flex: 1; padding: 10px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.4); color: #ff6b6b; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.3s ease;"
                            onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'"
                            onmouseout="this.style.background='rgba(255, 107, 107, 0.2)'">ðŸ—‘ï¸ Delete</button>
                    </div>
                `;

                card.onmouseover = () => {
                    card.style.borderColor = 'var(--accent-gold)';
                    card.style.boxShadow = '0 10px 30px var(--hover-glow)';
                    card.style.transform = 'translateY(-5px)';
                };

                card.onmouseout = () => {
                    card.style.borderColor = 'rgba(255, 215, 0, 0.2)';
                    card.style.boxShadow = 'none';
                    card.style.transform = 'translateY(0)';
                };

                container.appendChild(card);
            });
        }

        function viewRegisterDetails(registerId) {
            const register = registersData.find(r => r.id === registerId);
            if (!register) return;

            const players = register.joinedPlayers || [];
            let html = `
                <div style="background: rgba(10, 14, 39, 0.95); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 15px; padding: 30px; max-width: 700px; margin: 0 auto;">
                    <h2 style="color: var(--accent-gold); margin-bottom: 25px; text-align: center;">${register.name} - Participants</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: var(--text-gray); font-size: 0.9em;">Total Joined</div>
                            <div style="color: var(--accent-gold); font-size: 2em; font-weight: 700;">${players.length}</div>
                        </div>
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: var(--text-gray); font-size: 0.9em;">Max Players</div>
                            <div style="color: var(--accent-green); font-size: 2em; font-weight: 700;">${register.maxPlayers}</div>
                        </div>
                    </div>

                    <h3 style="color: var(--accent-gold); margin-bottom: 15px;">ðŸ“‹ Joined Players</h3>
                    <div style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
            `;

            if (players.length === 0) {
                html += '<div style="text-align: center; color: var(--text-gray); padding: 30px;">No players joined yet</div>';
            } else {
                players.forEach((player, index) => {
                    html += `
                        <div style="background: rgba(255, 215, 0, 0.08); border: 1px solid rgba(255, 215, 0, 0.3); padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;"
                            onmouseover="this.style.background='rgba(255, 215, 0, 0.15)'"
                            onmouseout="this.style.background='rgba(255, 215, 0, 0.08)'"
                            onclick="viewPlayerDetails('${registerId}', ${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: var(--accent-gold); font-weight: 600; margin-bottom: 4px;">${player.name || 'N/A'}</div>
                                    <div style="color: var(--text-gray); font-size: 0.9em;">${player.teamName || 'No team'}</div>
                                    <div style="color: var(--text-gray); font-size: 0.85em; margin-top: 4px;">Joined: ${new Date(player.joinedAt).toLocaleDateString()}</div>
                                </div>
                                <div style="background: rgba(0, 212, 255, 0.2); padding: 8px 12px; border-radius: 6px; color: #00d4ff; font-weight: 600; font-size: 0.85em;">View</div>
                            </div>
                        </div>
                    `;
                });
            }

            html += `
                    </div>
                    <button onclick="closeRegisterDetailsModal()" style="width: 100%; margin-top: 25px; padding: 12px; background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.4); color: var(--accent-gold); border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                </div>
            `;

            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'registerDetailsModal';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 6000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 40px 20px;';
            overlay.innerHTML = html;
            overlay.onclick = (e) => {
                if (e.target === overlay) closeRegisterDetailsModal();
            };

            document.body.appendChild(overlay);
        }

        function closeRegisterDetailsModal() {
            const modal = document.getElementById('registerDetailsModal');
            if (modal) modal.remove();
        }

        function viewPlayerDetails(registerId, playerIndex) {
            const register = registersData.find(r => r.id === registerId);
            const player = register.joinedPlayers[playerIndex];

            if (!player) return;

            let html = `
                <div style="background: rgba(10, 14, 39, 0.95); border: 2px solid rgba(0, 212, 255, 0.3); border-radius: 15px; padding: 30px; max-width: 500px;">
                    <h2 style="color: #00d4ff; margin-bottom: 25px; text-align: center;">Player Details</h2>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 4px;">Full Name</div>
                            <div style="color: var(--text-white); font-weight: 600; font-size: 1.1em;">${player.name || 'N/A'}</div>
                        </div>

                        ${player.teamName ? `
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 4px;">DLS Team Name</div>
                            <div style="color: var(--accent-green); font-weight: 600; font-size: 1.1em;">${player.teamName}</div>
                        </div>
                        ` : ''}

                        ${player.playerList ? `
                        <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 4px;">Player List</div>
                            <div style="color: #00d4ff; font-weight: 600; word-break: break-word;">${player.playerList}</div>
                        </div>
                        ` : ''}

                        <div style="background: rgba(100, 100, 100, 0.1); padding: 15px; border-radius: 8px;">
                            <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 4px;">Joined Date</div>
                            <div style="color: var(--text-white); font-weight: 600;">${new Date(player.joinedAt).toLocaleString()}</div>
                        </div>
                    </div>

                    <button onclick="closeRegisterDetailsModal()" style="width: 100%; margin-top: 25px; padding: 12px; background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.4); color: var(--accent-gold); border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                </div>
            `;

            const overlay = document.createElement('div');
            overlay.id = 'playerDetailsModal';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 6000; display: flex; align-items: center; justify-content: center; padding: 40px 20px;';
            overlay.innerHTML = html;
            overlay.onclick = (e) => {
                if (e.target === overlay) closeRegisterDetailsModal();
            };

            // Remove previous modals first
            const existing = document.getElementById('playerDetailsModal');
            if (existing) existing.remove();
            document.body.appendChild(overlay);
        }

        function shareRegister(registerId) {
            const register = registersData.find(r => r.id === registerId);
            if (!register) return;

            const shareUrl = `${window.location.origin}/register?code=${register.shareCode}&id=${registerId}`;

            const html = `
                <div style="background: rgba(10, 14, 39, 0.95); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 15px; padding: 30px; max-width: 500px;">
                    <h2 style="color: var(--accent-gold); margin-bottom: 25px; text-align: center;">ðŸ“¤ Share Register</h2>
                    
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: var(--text-gray); font-size: 0.9em; margin-bottom: 10px;">Share Link</div>
                        <div style="display: flex; gap: 10px;">
                            <input id="shareInput" type="text" value="${shareUrl}" readonly style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.3); border-radius: 6px; color: var(--text-white);">
                            <button onclick="copyShareLink()" style="padding: 10px 15px; background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.4); color: var(--accent-green); border-radius: 6px; cursor: pointer; font-weight: 600;">ðŸ“‹ Copy</button>
                        </div>
                    </div>

                    <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: #00d4ff; font-weight: 600; margin-bottom: 5px;">Share Code</div>
                        <div style="color: var(--text-white); font-weight: 700; font-size: 1.3em; word-break: break-all;">${register.shareCode}</div>
                    </div>

                    <div style="background: rgba(100, 100, 100, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: var(--text-gray); font-size: 0.9em;">Players can use this link or code to join the register</div>
                    </div>

                    <button onclick="closeRegisterDetailsModal()" style="width: 100%; padding: 12px; background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.4); color: var(--accent-gold); border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
                </div>
            `;

            const overlay = document.createElement('div');
            overlay.id = 'shareRegisterModal';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 6000; display: flex; align-items: center; justify-content: center; padding: 40px 20px;';
            overlay.innerHTML = html;
            overlay.onclick = (e) => {
                if (e.target === overlay) closeRegisterDetailsModal();
            };

            const existing = document.getElementById('shareRegisterModal');
            if (existing) existing.remove();
            document.body.appendChild(overlay);
        }

        function copyShareLink() {
            const input = document.getElementById('shareInput');
            input.select();
            document.execCommand('copy');
            alert('Share link copied to clipboard!');
        }

        async function deleteRegister(registerId) {
            if (!confirm('Are you sure you want to delete this register?')) return;

            try {
                await db.collection('playerRegisters').doc(registerId).delete();
                registersData = registersData.filter(r => r.id !== registerId);
                renderRegisterCards();
                showNotification('âœ… Register deleted successfully', 'success', 2000);
            } catch (error) {
                showNotification(`âŒ Error: ${error.message}`, 'error', 2000);
                console.error('Error deleting register:', error);
            }
        }

        function generateShareCode() {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        // ===== ADD CLUB WITH PLAYERS FUNCTIONS =====
        let currentClubLogo = null;
        let tempPlayersList = [];
        let currentTournamentId = null;

        function openAddClubModal() {
            try {
                const modal = document.getElementById('addClubModal');
                if (!modal) {
                    console.error('Modal element not found');
                    return;
                }

                // Get current tournament ID from global currentTournament
                if (!currentTournament || !currentTournament.id) {
                    alert('Please select a tournament first');
                    return;
                }

                currentTournamentId = currentTournament.id;
                console.log('Opening modal with tournament ID:', currentTournamentId);

                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 5000; display: flex !important; flex-direction: column; overflow-y: auto;';
                tempPlayersList = [];
                clearClubForm();
            } catch (error) {
                console.error('Error opening modal:', error);
            }
        }

        function closeAddClubModal() {
            const modal = document.getElementById('addClubModal');
            if (modal) {
                modal.style.display = 'none';
            }
            clearClubForm();
            tempPlayersList = [];
        }

        function clearClubForm() {
            document.getElementById('clubOwnerName').value = '';
            document.getElementById('clubName').value = '';
            document.getElementById('clubLogoInput').value = '';
            document.getElementById('playerName').value = '';
            document.getElementById('playerRole').value = '';
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('logoPreviewImg').src = '';
            document.getElementById('clubMessage').innerHTML = '';
            currentClubLogo = null;
            renderPlayersList();
        }

        // Handle logo file upload and preview
        document.addEventListener('change', function (e) {
            if (e.target.id === 'clubLogoInput') {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        currentClubLogo = event.target.result;
                        document.getElementById('logoPreviewImg').src = currentClubLogo;
                        document.getElementById('logoPreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        function addPlayerToClub() {
            const playerName = document.getElementById('playerName').value.trim();
            const playerRole = document.getElementById('playerRole').value;

            if (!playerName) {
                alert('âŒ Please enter player name');
                return;
            }
            if (!playerRole) {
                alert('âŒ Please select player role');
                return;
            }

            // Add to temp list
            tempPlayersList.push({
                id: Date.now().toString(),
                name: playerName,
                role: playerRole
            });

            // Clear inputs
            document.getElementById('playerName').value = '';
            document.getElementById('playerRole').value = '';

            renderPlayersList();
        }

        function renderPlayersList() {
            const container = document.getElementById('playersList');

            if (tempPlayersList.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px; font-size: 0.9em;">No players added yet</div>';
                return;
            }

            container.innerHTML = tempPlayersList.map((player, index) => `
                <div style="background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="color: #00d4ff; font-weight: 600; font-size: 0.95em;">${player.name}</div>
                        <div style="color: var(--text-gray); font-size: 0.85em;">${player.role}</div>
                    </div>
                    <button onclick="removePlayer(${index})" style="padding: 6px 10px; background: rgba(255,107,107,0.2); border: 1px solid rgba(255,107,107,0.3); color: #ff6b6b; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8em;">Remove</button>
                </div>
            `).join('');
        }

        function removePlayer(index) {
            tempPlayersList.splice(index, 1);
            renderPlayersList();
        }

        async function createClubWithPlayers() {
            const clubOwnerName = document.getElementById('clubOwnerName').value.trim();
            const clubName = document.getElementById('clubName').value.trim();
            const msgDiv = document.getElementById('clubMessage');

            // Validation
            if (!clubOwnerName) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please enter club owner name</div>';
                return;
            }
            if (!clubName) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please enter club name</div>';
                return;
            }
            if (!currentClubLogo) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please upload club logo</div>';
                return;
            }
            if (tempPlayersList.length === 0) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Please add at least one player</div>';
                return;
            }

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">â³ Creating club and saving...</div>';

                const clubId = Date.now().toString();
                const clubData = {
                    id: clubId,
                    ownerName: clubOwnerName,
                    name: clubName,
                    logo: currentClubLogo,
                    players: tempPlayersList,
                    playersCount: tempPlayersList.length,
                    createdAt: new Date().toISOString(),
                    // Initialize default stats
                    won: 0,
                    drawn: 0,
                    lost: 0,
                    played: 0,
                    goalsFor: 0,
                    goalsAgainst: 0,
                    points: 0
                };

                // Save to Firebase under tournament
                await db.collection('tournaments').doc(currentTournamentId)
                    .collection('clubs').doc(clubId).set(clubData);

                msgDiv.innerHTML = '<div style="color: var(--accent-green); font-weight: 600;">âœ… Club created and saved successfully!</div>';

                setTimeout(() => {
                    closeAddClubModal();
                    showNotification('âœ… Club added to tournament', 'success', 2000);
                    loadTournamentClubs(currentTournamentId);
                    refreshTournamentStandings();
                }, 1500);

            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">âŒ Error: ${error.message}</div>`;
                console.error('Error creating club:', error);
            }
        }

        async function loadTournamentClubs(tournamentId) {
            try {
                const snapshot = await db.collection('tournaments').doc(tournamentId)
                    .collection('clubs').get();

                let clubs = [];
                snapshot.forEach(doc => {
                    clubs.push({ id: doc.id, ...doc.data() });
                });

                return clubs;
            } catch (error) {
                console.error('Error loading clubs:', error);
                return [];
            }
        }

        // Global variables for edit modal
        let editingClubId = null;
        let editingClubStats = {
            won: 0,
            drawn: 0,
            lost: 0,
            goalsFor: 0,
            goalsAgainst: 0
        };

        function openEditClubStatsModal(clubId, clubName) {
            editingClubId = clubId;
            document.getElementById('editClubNameDisplay').textContent = clubName;
            document.getElementById('editClubMessage').innerHTML = '';

            // Load current stats from the table
            loadEditClubStats(clubId);

            const modal = document.getElementById('editClubStatsModal');
            modal.style.display = 'flex';
        }

        function closeEditClubStatsModal() {
            const modal = document.getElementById('editClubStatsModal');
            modal.style.display = 'none';
            editingClubId = null;
        }

        function loadEditClubStats(clubId) {
            // Find the club in the standings
            const standingsRef = db.collection('tournaments').doc(currentTournament.id)
                .collection('clubs').doc(clubId);

            standingsRef.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    editingClubStats = {
                        won: data.won || 0,
                        drawn: data.drawn || 0,
                        lost: data.lost || 0,
                        goalsFor: data.goalsFor || 0,
                        goalsAgainst: data.goalsAgainst || 0
                    };
                    updateEditStatsDisplay();
                }
            });
        }

        function adjustStat(stat, change) {
            editingClubStats[stat] = Math.max(0, editingClubStats[stat] + change);
            updateEditStatsDisplay();
        }

        function updateEditStatsDisplay() {
            document.getElementById('editWins').value = editingClubStats.won;
            document.getElementById('editDraws').value = editingClubStats.drawn;
            document.getElementById('editLosses').value = editingClubStats.lost;
            document.getElementById('editGoalsFor').value = editingClubStats.goalsFor;
            document.getElementById('editGoalsAgainst').value = editingClubStats.goalsAgainst;
        }

        async function saveClubStatsChanges() {
            const msgDiv = document.getElementById('editClubMessage');

            if (!editingClubId || !currentTournament) {
                msgDiv.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">âŒ Error: Missing required data</div>';
                return;
            }

            try {
                msgDiv.innerHTML = '<div style="color: var(--accent-gold); font-weight: 600;">â³ Saving changes...</div>';

                // Calculate played matches
                const played = editingClubStats.won + editingClubStats.drawn + editingClubStats.lost;

                // Calculate points
                const points = (editingClubStats.won * 3) + (editingClubStats.drawn * 1);

                // Update club stats in Firestore
                await db.collection('tournaments').doc(currentTournament.id)
                    .collection('clubs').doc(editingClubId).update({
                        won: editingClubStats.won,
                        drawn: editingClubStats.drawn,
                        lost: editingClubStats.lost,
                        played: played,
                        goalsFor: editingClubStats.goalsFor,
                        goalsAgainst: editingClubStats.goalsAgainst,
                        points: points,
                        updatedAt: new Date().toISOString()
                    });

                msgDiv.innerHTML = '<div style="color: var(--accent-green); font-weight: 600;">âœ… Stats updated successfully!</div>';

                setTimeout(() => {
                    closeEditClubStatsModal();
                    showNotification('âœ… Club stats updated', 'success', 2000);
                    refreshTournamentStandings();
                }, 1500);

            } catch (error) {
                msgDiv.innerHTML = `<div style="color: #ff6b6b; font-weight: 600;">âŒ Error: ${error.message}</div>`;
                console.error('Error saving club stats:', error);
            }
        }

        async function loadLivestreams() {
            try {
                const container = document.getElementById('livestreamsList');
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 40px 20px;"><p>Loading livestreams...</p><div class="spinner" style="margin-top: 15px; display: inline-block;"></div></div>';

                // Try to get livestream chunks
                let snapshot = await db.collection('livestreamChunks').get();
                console.log('livestreamChunks query result:', snapshot.docs.length, 'documents');

                // If no chunks, also check livestreamSessions
                if (snapshot.empty) {
                    console.log('No livestreamChunks found, checking livestreamSessions...');
                    const sessionsSnapshot = await db.collection('livestreamSessions').get();
                    console.log('livestreamSessions query result:', sessionsSnapshot.docs.length, 'documents');

                    if (sessionsSnapshot.empty) {
                        container.innerHTML = `
                            <div style="text-align: center; color: var(--text-gray); padding: 40px 20px;">
                                <p>No livestreams available</p>
                                <p style="font-size: 0.85em; margin-top: 10px; color: #ff6b6b;">ðŸ’¡ Tip: Start recording a livestream and wait for chunks to upload (every 5 seconds)</p>
                            </div>
                        `;
                        return;
                    }

                    // Render from sessions instead of chunks
                    let html = '';
                    sessionsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const createdDate = data.createdAt ? (data.createdAt.toDate?.() || new Date(data.createdAt)) : new Date();
                        const matchInfo = `${data.teamA || 'Team A'} vs ${data.teamB || 'Team B'}`;

                        html += `
                            <div onclick="selectLivestream('${data.sessionId}')" style="padding: 20px; background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.2); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h4 style="color: var(--accent-gold); margin: 0 0 8px 0;">${matchInfo}</h4>
                                        <p style="color: var(--text-gray); margin: 0 0 5px 0; font-size: 0.9em;">ðŸ“… ${createdDate.toLocaleString()}</p>
                                        <p style="color: var(--text-gray); margin: 0; font-size: 0.9em;">ðŸŽ¬ ${data.totalChunks || 0} chunks</p>
                                        <p style="color: var(--accent-green); margin: 0; font-size: 0.85em;">âœ… ${data.status}</p>
                                    </div>
                                    <div style="background: rgba(0,255,136,0.2); padding: 8px 12px; border-radius: 6px; color: var(--accent-green); font-weight: 600; font-size: 0.85em;">
                                        Ready to Play
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                    return;
                }

                // Group chunks by livestream session
                const livestreams = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const sessionId = data.sessionId || data.matchId || 'unknown';
                    if (!livestreams[sessionId]) {
                        livestreams[sessionId] = {
                            id: sessionId,
                            chunks: [],
                            createdAt: data.recordingStartTime || data.timestamp || data.createdAt || new Date(),
                            matchId: data.matchId,
                            teamA: data.teamA,
                            teamB: data.teamB
                        };
                    }
                    livestreams[sessionId].chunks.push({
                        id: doc.id,
                        url: data.url,
                        timestamp: data.timestamp,
                        chunkIndex: data.chunkIndex
                    });
                });

                console.log('Grouped livestreams:', Object.keys(livestreams).length);

                // Sort chunks by index and render livestreams
                let html = '';
                Object.values(livestreams).forEach(stream => {
                    stream.chunks.sort((a, b) => (a.chunkIndex || 0) - (b.chunkIndex || 0));
                    const createdDate = stream.createdAt.toDate?.() || new Date(stream.createdAt);
                    const matchInfo = stream.teamA && stream.teamB ? `${stream.teamA} vs ${stream.teamB}` : `Session: ${stream.id}`;

                    html += `
                        <div onclick="selectLivestream('${stream.id}')" style="padding: 20px; background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.2); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h4 style="color: var(--accent-gold); margin: 0 0 8px 0;">${matchInfo}</h4>
                                    <p style="color: var(--text-gray); margin: 0 0 5px 0; font-size: 0.9em;">ðŸ“… ${createdDate.toLocaleString()}</p>
                                    <p style="color: var(--text-gray); margin: 0; font-size: 0.9em;">ðŸŽ¬ ${stream.chunks.length} chunks</p>
                                </div>
                                <div style="background: rgba(0,255,136,0.2); padding: 8px 12px; border-radius: 6px; color: var(--accent-green); font-weight: 600; font-size: 0.85em;">
                                    Ready to Play
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (html === '') {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 40px 20px;">No livestreams available</div>';
                } else {
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading livestreams:', error);
                document.getElementById('livestreamsList').innerHTML = `
                    <div style="color: #ff6b6b; padding: 20px;">
                        <p>Error loading livestreams: ${error.message}</p>
                        <p style="font-size: 0.85em; margin-top: 10px;">Check browser console for details</p>
                    </div>
                `;
            }
        }

        function selectLivestream(sessionId) {
            // Find the selected livestream by sessionId or matchId
            db.collection('livestreamChunks').where('sessionId', '==', sessionId).get().then(snapshot => {
                currentLivestream = {
                    sessionId: sessionId,
                    chunks: []
                };

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    currentLivestream.chunks.push({
                        id: doc.id,
                        url: data.url,
                        timestamp: data.timestamp,
                        chunkIndex: data.chunkIndex || 0
                    });
                });

                // If no chunks found by sessionId, try matchId
                if (currentLivestream.chunks.length === 0) {
                    return db.collection('livestreamChunks').where('matchId', '==', sessionId).get();
                }
                return Promise.resolve(null);
            }).then(snapshot => {
                if (snapshot) {
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        currentLivestream.chunks.push({
                            id: doc.id,
                            url: data.url,
                            timestamp: data.timestamp,
                            chunkIndex: data.chunkIndex || 0
                        });
                    });
                }

                currentLivestream.chunks.sort((a, b) => (a.chunkIndex || 0) - (b.chunkIndex || 0));
                currentChunkIndex = 0;

                // Update UI to show selected livestream
                document.querySelectorAll('#livestreamsList > div').forEach(el => {
                    el.style.borderColor = 'rgba(255,215,0,0.2)';
                    el.style.background = 'rgba(255,215,0,0.1)';
                });
                if (event && event.currentTarget) {
                    event.currentTarget.style.borderColor = 'var(--accent-gold)';
                    event.currentTarget.style.background = 'rgba(255,215,0,0.25)';
                }

                showNotification(`âœ… Livestream selected: ${currentLivestream.chunks.length} chunks ready`, 'success', 2000);
            }).catch(error => {
                console.error('Error selecting livestream:', error);
                showNotification('Error selecting livestream: ' + error.message, 'error', 3000);
            });
        }

        function playLivestream() {
            if (!currentLivestream || currentLivestream.chunks.length === 0) {
                showNotification('âŒ Please select a livestream first', 'error', 3000);
                return;
            }

            isPlayingLivestream = true;
            currentChunkIndex = 0;
            playNextChunk();
        }

        function playNextChunk() {
            if (!isPlayingLivestream || currentChunkIndex >= currentLivestream.chunks.length) {
                if (currentChunkIndex >= currentLivestream.chunks.length) {
                    isPlayingLivestream = false;
                    showNotification('âœ… Livestream playback finished', 'success', 3000);
                }
                return;
            }

            const chunk = currentLivestream.chunks[currentChunkIndex];
            const container = document.getElementById('livestreamVideoContainer');

            // Create video element
            const video = document.createElement('video');
            video.src = chunk.url;
            video.autoplay = true;
            video.controls = false;
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.objectFit = 'cover';

            container.innerHTML = '';
            container.appendChild(video);

            // Wait for video to end then play next chunk with 5s delay
            video.onended = () => {
                currentChunkIndex++;
                setTimeout(() => {
                    playNextChunk();
                }, DELAY_MS);
            };

            video.onerror = () => {
                showNotification(`âš ï¸ Error loading chunk ${currentChunkIndex + 1}`, 'error', 2000);
                currentChunkIndex++;
                playNextChunk();
            };
        }

        function stopLivestream() {
            isPlayingLivestream = false;
            currentChunkIndex = 0;
            const container = document.getElementById('livestreamVideoContainer');
            const video = container.querySelector('video');
            if (video) {
                video.pause();
                video.src = '';
            }
            container.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3em; margin-bottom: 15px;">ðŸ“º</div>
                    <p style="color: var(--text-gray);">Livestream stopped</p>
                </div>
            `;
        }

    </script>


</body>

</html>
